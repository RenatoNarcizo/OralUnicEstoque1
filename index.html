<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* ========================= VARI√ÅVEIS DE CORES ========================= */
    :root {
      --azul: #0d6efd;
      --azul-escuro: #003b88;
      --cinza-fundo: #f4f6f9;
      --branco: #ffffff;
      --cinza: #e0e0e0;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #222;
    }
    
    /* üîπ Centraliza√ß√£o est√°vel da tela de login */
    #loginView {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      overflow: hidden;
      z-index: 1000;
    }
    
    .login-card {
      background: var(--branco);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      text-align: center;
      width: 320px;
    }

    .login-card h2 {
      color: var(--azul-escuro);
      margin-bottom: 20px;
    }

    .login-card input {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .login-card button {
      width: 100%;
      margin-top: 10px;
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 8px;
      border-radius: 5px;
      font-size: 15px;
      cursor: pointer;
    }

    .login-card button:hover {
      background: var(--azul-escuro);
    }
    
    #loginMsg {
      background: #f8d7da;
      border-radius: 5px;
      padding: 8px;
      font-weight: bold;
      margin-top: 10px;
    }
    #loginMsg[style*="green"] {
      background: #d4edda;
    }


    /* ========================= HEADER ========================= */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--azul);
      color: var(--branco);
      padding: 12px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 900;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header button {
      background: none;
      border: none;
      color: var(--branco);
      cursor: pointer;
      font-size: 1.3rem;
    }

    header button:hover {
      color: #e2e2e2;
    }

   /* ========================= MENU LATERAL ========================= */
    #sidebar {
      position: fixed;
      top: 0;
      left: -260px; /* escondido */
      width: 250px;
      height: 100%;
      background: var(--azul-escuro);
      color: var(--branco);
      overflow-y: auto;
      transition: left 0.3s ease;
      z-index: 800;
      padding-top: 60px;
      border-right: none;
      box-shadow: none;
    }

    /* Quando ativo (aberto) */
    #sidebar.active {
      left: 0;
    }

    #sidebar button {
      display: block;
      width: 100%;
      border: none;
      background: none;
      color: var(--branco);
      text-align: left;
      padding: 14px 18px;
      font-size: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      transition: background 0.2s;
    }

    #sidebar button i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
    }

    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* ========================= √ÅREA PRINCIPAL ========================= */
    main {
      margin: 20px;
      padding-left: 0;
      transition: margin-left 0.3s ease;
      overflow-x: hidden; /* impede overflow lateral */
    }

    @media (min-width: 900px) {
      #sidebar.active + main {
        margin-left: 250px;
      }
    }

    /* ========================= SE√á√ïES ========================= */
    .section {
      display: none;
      max-height: calc(100vh - 140px); /* altura vis√≠vel abaixo do cabe√ßalho */
      overflow-y: auto; /* ativa rolagem vertical */
      overflow-x: hidden; /* evita rolagem lateral */
      padding-bottom: 20px; /* espa√ßamento inferior */
      scroll-behavior: smooth; /* rolagem suave */
    }

    .section h2 {
      color: var(--azul-escuro);
      border-left: 5px solid var(--azul);
      padding-left: 10px;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========================= DASHBOARD ========================= */
    .dash-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .dash-card {
      background: var(--branco);
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      padding: 15px 20px;
      transition: transform 0.2s ease;
    }

    .dash-card:hover {
      transform: scale(1.02);
    }

    .dash-card h3 {
      color: var(--azul-escuro);
      margin-bottom: 10px;
      border-bottom: 2px solid var(--azul);
      padding-bottom: 5px;
      font-size: 16px;
    }

    .dash-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dash-card ul li {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .dash-card ul li:last-child {
      border-bottom: none;
    }

    /* ========================= TABELAS ========================= */
    .table-wrap {
      max-height: 60vh; /* altura m√°xima vis√≠vel */
      overflow-y: auto;          /* rolagem vertical */
      overflow-x: auto; /* rolagem horizontal se necess√°rio */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: #888 #f0f0f0;
    }

    .table-wrap table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* evita desalinhamento */
    }

    .table-wrap table thead th {
      position: sticky;
      top: 0;
      background: var(--azul);
      color: #fff;
      z-index: 10;
      text-align: left;
      padding: 10px 12px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
    }

    .table-wrap table td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      font-size: 14px;
    }

    .table-wrap table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    /* üîπ Scrollbar estilizada */
    .table-wrap::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .table-wrap::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 8px;
    }
    .table-wrap::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 8px;
    }
    .table-wrap::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* ========================= BOT√ïES ========================= */
    button {
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    button:hover {
      background: var(--azul-escuro);
    }

    /* ========================= INPUTS E SELECTS ========================= */
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .input-row .flex {
      flex: 1; /* Faz o input expandir o m√°ximo poss√≠vel */
      min-width: 150px;
    }

    input, select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin: 3px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--azul);
    }

    /* ========================= IMAGENS ========================= */
    .thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .thumb:hover {
      transform: scale(1.08);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
    }

    #imagemAmpliada {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #imagemAmpliada img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      cursor: pointer;
    }
    
    /* TOAST MESSAGE */
    #toastMessage {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.4s, transform 0.4s;
      pointer-events: none; /* N√£o impede cliques */
      font-family: "Segoe UI, sans-serif";
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <div id="imagemAmpliada" onclick="this.style.display='none'">
    <img src="" alt="Imagem ampliada">
  </div>
  
  <div id="toastMessage" style="background:#0d6efd;"></div>

  <div id="loginView" class="login-container">
    <div class="login-card">
      <h2><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque</h2>
      <input id="usuarioLogin" type="text" placeholder="E-mail de Usu√°rio" />
      <input id="senhaLogin" type="password" placeholder="Senha" />
      <button onclick="fazerLogin()"><i class="fa fa-right-to-bracket"></i> Entrar</button>
	  <p id="loginMsg" style="display:none; color:red; font-weight:bold; text-align:center;"></p>
    </div>
  </div>

  <div id="mainApp" style="display:none;">

    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="menuToggle" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <h1><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
     
        <div id="userName" style="font-weight:700">Visitante</div>
        <div id="perfilBadge" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;font-size:13px;">PERFIL</div>
        <button onclick="logout()" title="Sair"><i class="fa fa-sign-out-alt"></i></button>
      </div>
    </header>

    <aside id="sidebar" aria-hidden="true">
	  <button onclick="showSection('boasVindas')"><i class="fa fa-home"></i> In√≠cio</button>
	  <button onclick="showSection('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</button>
      <button onclick="showSection('cadastro')"><i class="fa fa-box"></i> Cadastro de Produtos</button>
      <button onclick="showSection('entrada')"><i class="fa fa-arrow-down"></i> Entrada de Materiais</button>
      <button onclick="showSection('saida')"><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</button>
      <button onclick="showSection('estoque')"><i class="fa fa-warehouse"></i> Estoque Atual</button>
      <button onclick="showSection('limites')"><i class="fa fa-sliders-h"></i> Estoque M√≠n/M√°x</button>
      <button onclick="showSection('financeiro')"><i class="fa fa-coins"></i> Financeiro</button>
      <button onclick="showSection('relatorios')"><i class="fa fa-file-excel"></i> Relat√≥rios</button>
      <button onclick="showSection('usuarios')"><i class="fa fa-users"></i> Usu√°rios e Perfis</button>

    </aside>

    <main>
		<section id="boasVindas" class="section active" style="text-align:center; padding:100px 20px;">
		  <h1 style="color:#003b88;">üëã Bem-vindo(a) <span id="nomeUsuarioBemVindo"></span>!</h1>
		  <h2 style="color:#0d6efd;">ao Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h2>
		  <p style="margin-top:20px; color:#555;">Use o menu lateral para iniciar suas atividades.</p>
		</section>
		
		<section id="dashboard" class="section">
		  <h2>üìä Dashboard do Sistema</h2>
		  <div class="dash-container">
		
		    <div class="dash-card">
		      <h3>üö® Valor Total em Estoque</h3>
		      <div id="valorEstoque" style="font-size:24px; font-weight:bold; color:#003b88;">R$ 0.00</div>
		    </div>
		
		    <div class="dash-card">
		      <h3>üí∞ Custo Total de Sa√≠das</h3>
		      <div id="valorSaidas" style="font-size:24px; font-weight:bold; color:#d9534f;">R$ 0.00</div>
		    </div>
		    
		    <div class="dash-card">
		      <h3>‚ö†Ô∏è Estoque Cr√≠tico</h3>
		      <ul id="listaEstoqueCritico" style="color:red;"></ul>
		    </div>
		
		    <div class="dash-card">
		      <h3>üïí Produtos Pr√≥ximos do Vencimento</h3>
		      <ul id="listaProximosVencer"></ul>
		    </div>
		
		    <div class="dash-card">
		      <h3>üì¶ Produtos Mais Utilizados (Sa√≠das)</h3>
		      <ul id="listaMaisSaidas"></ul>
		    </div>
		
		    <div class="dash-card">
		      <h3>üí§ Produtos com Menos Sa√≠das</h3>
		      <ul id="listaMenosSaidas"></ul>
		    </div>
		    
		    <div class="dash-card">
		      <h3>üí∞ Produtos Mais Caros (Custo Unit√°rio)</h3>
		      <ul id="listaMaisCaros"></ul>
		    </div>
		
		    <div class="dash-card">
		      <h3>üìà Resumo Geral</h3>
		      <div id="resumoGeral"></div>
		    </div>
		
		  </div>
		</section>
      
      <section id="cadastro" class="section">
        <h2><i class="fa fa-box"></i> Cadastro de Produtos</h2>

        <div class="input-row" style="margin-bottom:10px;gap:8px;">
          <input id="produtoNome" type="text" placeholder="Nome do produto" class="flex" />

          <select id="produtoCategoria">
            <option value="">Selecione a categoria</option>
            <option>Material de Uso e Consumo</option>
            <option>Copa e Cozinha</option>
            <option>Escrit√≥rio</option>
            <option>Implante e Componentes</option>
            <option>Insumo Dental</option>
            <option>Insumo Laborat√≥rio</option>
            <option>Medicamentos</option>
            <option>Material de Limpeza</option>
          </select>

          <select id="produtoEmbalagem">
            <option value="">Selecione o tipo de embalagem</option>
            <option>Ampola</option>
            <option>Caixa</option>
            <option>Fardo</option>
            <option>Frasco</option>
            <option>Garrafa</option>
            <option>Gramas</option>
            <option>Litro</option>
            <option>Pacote</option>
            <option>Pe√ßa</option>
            <option>Quilogramas (KG)</option>
            <option>Saco</option>
            <option>Unidade</option>
          </select>
          
          <input id="produtoQtdEmbalagem" type="number" placeholder="Qtd por embalagem" style="width:140px" />
		      <input id="produtoCodigoBarras" type="text" placeholder="üì∑C√≥digo de Barras (opcional)" style="width:220px" />

          <input id="produtoFoto" type="file" accept="image/*" />
          <button onclick="cadastrarProduto()"><i class="fa fa-save"></i> Cadastrar</button>
  
        </div>

        <div style="margin-bottom:10px;">
          <input id="filtroProduto" type="text" placeholder="üîç Filtrar por nome ou categoria" style="width:98%" oninput="filtrarProdutos()" />
        </div>

        <div class="table-wrap">
          <table id="tabelaProdutos">
            <thead>
              <tr>
                <th>#</th>
                <th>Foto</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Embalagem</th>
                <th>Qtd/Emb.</th>
				        <th>C√≥d. Barras</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

     <section id="entrada" class="section">
      <h2><i class="fa fa-arrow-down"></i> Entrada de Materiais</h2>
      <div class="input-row" style="margin-bottom:10px;gap:8px;">
      
        <input id="entradaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" style="min-width:200px;" oninput="buscarProdutoPorCodigo('entrada')" />
        
        <input id="entradaProduto" type="text" placeholder="Nome do produto" list="listaProdutos" style="min-width:220px" />
        <datalist id="listaProdutos"></datalist>
        
        <input id="entradaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
        <input id="entradaValor" type="number" placeholder="Valor Unit√°rio (R$)" step="0.01" style="width:150px" />
        <input id="entradaData" type="date" style="width:160px" />
        <input id="entradaNota" type="text" placeholder="Nota Fiscal" />
        <input id="entradaFornecedor" type="text" placeholder="Fornecedor" />
        <input id="entradaCNPJ" type="text" placeholder="CNPJ" />
        <input id="entradaLote" type="text" placeholder="Lote" />
        <input id="entradaValidade" type="date" placeholder="Validade" />

        <select id="entradaSetor">
          <option value="">Selecione o Setor Utilizado</option>
          <option>Limpeza da Cl√≠nica</option>
          <option>Laborat√≥rio</option>
          <option>Escrit√≥rio</option>
          <option>Copa e Cozinha</option>
          <option>Cl√≠nico Geral</option>
          <option>Centro Cir√∫rgico</option>
        </select>

        <button onclick="registrarEntrada()"><i class="fa fa-save"></i> Registrar Entrada</button>
      </div>

      <div style="margin-bottom:10px;">
        <input id="filtroEntrada" type="text" placeholder="üîç Buscar por produto, fornecedor ou NF" style="width:98%" oninput="filtrarEntradas()" />
      </div>

      <div class="table-wrap">
        <table id="tabelaEntradas">
          <thead>
            <tr>
              <th>#</th>
              <th>Produto</th>
              <th>C√≥d. Barras</th>
              <th>Qtd</th>
              <th>Valor (R$)</th>
              <th>Data</th>
              <th>NF</th>
              <th>Fornecedor</th>
              <th>CNPJ</th>
              <th>Lote</th>
              <th>Validade</th>
              <th>Setor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </section>

     <section id="saida" class="section">
      <h2><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</h2>
      <div class="input-row" style="margin-bottom:10px;gap:8px;">
        <input id="saidaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" oninput="buscarProdutoPorCodigo('saida'); atualizarSetorAutomatico()" />
        
        <input id="saidaProduto" type="text" placeholder="Nome do produto" list="listaProdutos" style="min-width:220px" oninput="atualizarSetorAutomatico()" />
        
        <input id="saidaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
        <input id="saidaResponsavel" type="text" placeholder="Respons√°vel" />
        <input id="saidaObservacao" type="text" placeholder="Observa√ß√£o (opcional)" />
        <select id="saidaSetor">
          <option value="">Selecione o Setor</option>
          </select>
        <input id="saidaData" type="date" style="width:160px" />
        <button onclick="registrarSaida()"><i class="fa fa-save"></i> Registrar Sa√≠da</button>
      </div>

      <div style="margin-bottom:10px;">
        <input id="filtroSaida" type="text" placeholder="üîç Buscar por produto, respons√°vel ou setor" style="width:98%" oninput="filtrarSaidas()" />
      </div>

      <div class="table-wrap">
        <table id="tabelaSaidas">
          <thead>
            <tr>
              <th>#</th>
              <th>Produto</th>
              <th>C√≥d. Barras</th>
              <th>Qtd</th>
              <th>Data</th>
              <th>Setor</th>
              <th>Respons√°vel</th>
              <th>Observa√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
    <section id="estoque" class="section">
      <h2><i class="fa fa-warehouse"></i> Estoque Atual</h2>
      
      <div style="margin-bottom:10px;">
        <input id="filtroEstoque" type="text" placeholder="üîç Filtrar por produto ou categoria" style="width:98%" oninput="filtrarEstoque()" />
      </div>

      <div class="table-wrap">
        <table id="tabelaEstoque">
          <thead>
            <tr>
              <th>#</th>
              <th>Foto</th>
              <th>Nome</th>
              <th>Categoria</th>
              <th>C√≥d. Barras</th>
              <th>Qtd. Atual</th>
              <th>√öltimo Valor (R$)</th>
              <th>Validade</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="resumoEstoque" style="margin-top:10px; padding:10px; background:#fff; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        </div>
    </section>
    
    <section id="limites" class="section">
      <h2><i class="fa fa-sliders-h"></i> Estoque M√≠nimo/M√°ximo</h2>
      
      <div style="margin-bottom:10px;">
        <input id="filtroLimites" type="text" placeholder="üîç Filtrar por produto" style="width:calc(100% - 300px); margin-right:10px;" oninput="filtrarLimites()" />
        <button onclick="abrirPopupLimites()">Definir Limites em Massa</button>
        </div>

      <div class="input-row">
        <select id="filtroCategoria" onchange="gerarListaCompra()">
          <option value="">Filtrar por Categoria (Lista de Compra)</option>
          <option>Material de Uso e Consumo</option>
          <option>Copa e Cozinha</option>
          <option>Escrit√≥rio</option>
          <option>Implante e Componentes</option>
          <option>Insumo Dental</option>
          <option>Insumo Laborat√≥rio</option>
          <option>Medicamentos</option>
          <option>Material de Limpeza</option>
        </select>
        <button onclick="gerarListaCompra()"><i class="fa fa-list"></i> Gerar Lista de Compra</button>
        <button onclick="limparListaCompra()"><i class="fa fa-trash"></i> Limpar Lista</button>
      </div>
      

      <div class="table-wrap">
        <table id="tabelaLimites">
          <thead>
            <tr>
              <th>#</th>
              <th>Produto</th>
              <th>C√≥d. Barras</th>
              <th>Categoria</th>
              <th>Qtd Atual</th>
              <th>M√≠nimo</th>
              <th>M√°ximo</th>
              <th>Status</th>
              <th>Recomenda√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="listaCompraContainer" style="display:none; margin-top:20px;">
        <h3><i class="fa fa-shopping-cart"></i> Lista de Compra Gerada</h3>
        <div class="table-wrap" style="max-height:400px; overflow-y:auto; overflow-x:auto;">
          <table id="tabelaListaCompra">
            <thead>
              <tr>
                <th>#</th>
                <th>Produto</th>
                <th>C√≥d. Barras</th>
                <th>Categoria</th>
                <th>Qtd Atual</th>
                <th>M√≠n.</th>
                <th>Recomenda√ß√£o</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="6" style="text-align:right; font-weight:bold;">Total de Itens:</td>
                <td id="totalItensCompra" style="font-weight:bold;">0</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div style="margin-top:10px;">
          <button onclick="exportarListaExcel()">
            <i class="fa fa-file-excel"></i> Exportar para Excel
          </button>
          <button onclick="gerarPedidoPDF()">
            <i class="fa fa-file-pdf"></i> Gerar Pedido de Or√ßamento (PDF)
          </button>
        </div>
      </div>
    </section>
    
    <section id="financeiro" class="section">
      <h2><i class="fa fa-coins"></i> Painel Financeiro</h2>
      
      <div class="dash-container" style="margin-top:0; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="dash-card">
          <h3>Total Entrada (Notas)</h3>
          <div id="totalEntradaNotas" style="font-size:1.2rem; font-weight:bold; color:#28a745;">R$ 0.00</div>
        </div>
        <div class="dash-card">
          <h3>Total Sa√≠da (Custo)</h3>
          <div id="totalSaidaCusto" style="font-size:1.2rem; font-weight:bold; color:#dc3545;">R$ 0.00</div>
        </div>
        <div class="dash-card">
          <h3>Valor Cont√°bil Estoque</h3>
          <div id="valorEstoqueContabil" style="font-size:1.2rem; font-weight:bold; color:#0d6efd;">R$ 0.00</div>
        </div>
        <div class="dash-card">
          <h3>Custo M√©dio Ponderado Total</h3>
          <div id="custoMedioTotal" style="font-size:1.2rem; font-weight:bold; color:#ffc107;">R$ 0.00</div>
        </div>
      </div>
      
      <h3 style="margin-top:20px; border-left:none; border-bottom:1px solid #ccc; padding-bottom:5px;">Detalhe Financeiro por Nota</h3>
      
      <div class="table-wrap">
        <table id="tabelaFinanceiro">
          <thead>
            <tr>
              <th>Fornecedor</th>
              <th>Nota Fiscal</th>
              <th>Data</th>
              <th>Valor Total Nota</th>
              <th>Custo Sa√≠das Relacionadas</th>
              <th>Saldo (Estoque Restante)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
    <section id="relatorios" class="section">
      <h2><i class="fa fa-file-excel"></i> Gera√ß√£o de Relat√≥rios</h2>
      
      <div class="input-row">
        <label for="dataInicioRelatorio">De:</label>
        <input type="date" id="dataInicioRelatorio" style="width:150px;" />
        <label for="dataFimRelatorio">At√©:</label>
        <input type="date" id="dataFimRelatorio" style="width:150px;" />
        <button onclick="definirPeriodoRapido('7dias')">√öltimos 7 dias</button>
        <button onclick="definirPeriodoRapido('30dias')">√öltimos 30 dias</button>
        <button onclick="definirPeriodoRapido('mes')">M√™s Atual</button>
        <button onclick="limparPeriodo()">Limpar</button>
      </div>

      <div class="input-row" style="margin-top:10px;">
        <button onclick="exportarTabelaExcel('tabelaEntradas', 'Entradas', 'Entradas_')" style="background:#28a745;">
          <i class="fa fa-file-excel"></i> Exportar Entradas
        </button>
        <button onclick="exportarTabelaExcel('tabelaSaidas', 'Sa√≠das', 'Saidas_')" style="background:#dc3545;">
          <i class="fa fa-file-excel"></i> Exportar Sa√≠das
        </button>
        <button onclick="exportarTabelaExcel('tabelaEstoque', 'Estoque', 'Estoque_')" style="background:#0d6efd;">
          <i class="fa fa-file-excel"></i> Exportar Estoque Atual
        </button>
        <button onclick="exportarTabelaExcel('tabelaFinanceiro', 'Financeiro', 'Financeiro_')" style="background:#ffc107;">
          <i class="fa fa-file-excel"></i> Exportar Financeiro
        </button>
      </div>

      <div style="background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-top:20px;">
        <p>Os relat√≥rios em Excel (.csv) consideram o per√≠odo de data selecionado para Entradas e Sa√≠das. Os relat√≥rios de Estoque e Financeiro consideram o estado atual.</p>
      </div>
    </section>
    
    <section id="usuarios" class="section">
      <h2><i class="fa fa-users"></i> Gerenciar Usu√°rios e Perfis</h2>
      <p>‚ö†Ô∏è **Funcionalidade Firebase:** A cria√ß√£o e gest√£o de usu√°rios (e-mail/senha) √© feita diretamente pelo painel de controle do Firebase. Aqui, gerenciamos apenas os perfis e metadados locais (localStorage/Firestore).</p>
      
      <div class="input-row" style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
  <input id="usuarioNome" type="text" placeholder="Nome Completo" class="flex" />
  <input id="usuarioEmail" type="email" placeholder="E-mail (ID do Firebase)" class="flex" />
  <input id="usuarioSenha" type="password" placeholder="Definir Senha (M√≠n. 6 caracteres)" class="flex" style="min-width: 200px;" /> <select id="usuarioPerfil" style="width:200px;">
        <select id="usuarioPerfil" style="width:200px;">
          <option value="">Selecione o Perfil</option>
          <option>ADMIN</option>
          <option>GERENTE</option>
          <option>ESTOQUISTA</option>
        </select>
        <button onclick="salvarUsuarioLocal()"><i class="fa fa-user-plus"></i> Salvar/Atualizar Perfil</button>
      </div>
      
      <div style="margin-bottom:10px; margin-top:10px;">
        <input id="filtroUsuarios" type="text" placeholder="üîç Filtrar por nome ou e-mail" style="width:98%" oninput="filtrarUsuarios()" />
      </div>
      
      <div class="table-wrap">
        <table id="tabelaUsuarios">
          <thead>
            <tr>
              <th>#</th>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Perfil</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    </main>
  </div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


  // Configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCxhDaVIiLuNCagXOkyOSYC0El8KzbGfDw", // ‚ö†Ô∏è MANTENHA ESTA CHAVE PRIVADA
    authDomain: "oralunicestoque.firebaseapp.com",
    projectId: "oralunicestoque",
    storageBucket: "oralunicestoque.firebasestorage.app",
    messagingSenderId: "660233908877",
    appId: "1:660233908877:web:2a6c9cd10b056b41bde8c4"
  };
  
  // Inicializa√ß√£o
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Vari√°veis globais para dados
  window.produtos = JSON.parse(localStorage.getItem("produtos")) || [];
  window.entradas = JSON.parse(localStorage.getItem("entradas")) || [];
  window.saidas = JSON.parse(localStorage.getItem("saidas")) || [];
  window.usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
  
  // === FUN√á√ïES DE PERSIST√äNCIA (Firestore/Local) ===
  
  // üîπ Salva dados globais no localStorage (fallback)
  function salvarTodosLocal() {
      localStorage.setItem("produtos", JSON.stringify(window.produtos));
      localStorage.setItem("entradas", JSON.stringify(window.entradas));
      localStorage.setItem("saidas", JSON.stringify(window.saidas));
      localStorage.setItem("usuarios", JSON.stringify(window.usuarios));
  }
  
  // üîπ Salva/Busca no Firestore (Mais robusto para multiusu√°rio)
  async function salvarDadosNoFirestore(nomeColecao, dados) {
      if (!auth.currentUser) return;
      try {
          // Usa o UID do usu√°rio para criar uma subcole√ß√£o √∫nica para os dados
          const docRef = doc(db, "estoqueData", auth.currentUser.uid);
          await setDoc(docRef, { [nomeColecao]: dados }, { merge: true });
          // console.log("Dados salvos no Firestore:", nomeColecao);
      } catch (e) {
          console.error("Erro ao salvar no Firestore: ", e);
      }
  }

  async function carregarDadosDoFirestore() {
      if (!auth.currentUser) return;
      try {
          const docRef = doc(db, "estoqueData", auth.currentUser.uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
              const data = docSnap.data();
              // Atualiza as vari√°veis globais e o localStorage com os dados do Firestore
              window.produtos = data.produtos || [];
              window.entradas = data.entradas || [];
              window.saidas = data.saidas || [];
              window.usuarios = data.usuarios || [];
              salvarTodosLocal();
              // console.log("Dados carregados do Firestore.");
          } else {
              // console.log("Nenhum dado encontrado no Firestore para este usu√°rio, usando localStorage.");
              // Se n√£o houver dados no Firestore, salva o que est√° no localStorage para come√ßar
              salvarDadosNoFirestore("produtos", window.produtos);
              salvarDadosNoFirestore("entradas", window.entradas);
              salvarDadosNoFirestore("saidas", window.saidas);
              salvarDadosNoFirestore("usuarios", window.usuarios);
          }
          
          // Re-renderiza todas as tabelas e dashboard ap√≥s carregar os dados
          if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
          if (typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
          if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
          if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
          if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
          if (typeof atualizarDashboard === "function") atualizarDashboard();
          if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
          if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();
          if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
          if (typeof ordenarListasAlfabeticamente === "function") ordenarListasAlfabeticamente();
          
      } catch (e) {
          console.error("Erro ao carregar do Firestore: ", e);
      }
  }
  
  // üîπ Wrappers para usar o Firestore
  window.salvarProdutosNoFirebase = (dados) => salvarDadosNoFirestore("produtos", dados);
  window.salvarEntradasNoFirebase = (dados) => salvarDadosNoFirestore("entradas", dados);
  window.salvarSaidasNoFirebase = (dados) => salvarDadosNoFirestore("saidas", dados);
  window.salvarUsuariosNoFirebase = (dados) => salvarDadosNoFirestore("usuarios", dados);
// === CRIA√á√ÉO DE USU√ÅRIO (FIREBASE AUTH) ===

  window.criarUsuarioNoFirebase = async function(email, senha) {
    if (!auth.currentUser) {
        mostrarMensagem("Apenas usu√°rios logados podem criar novas contas.", "erro");
        return false;
    }
    
    // Para criar um novo usu√°rio com senha, √© necess√°rio usar a fun√ß√£o de cria√ß√£o
    // Lembre-se que o usu√°rio logado (Admin) precisa ter permiss√£o no Firebase para isso (geralmente ele tem)
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
        // N√£o √© necess√°rio fazer login com esta nova conta, apenas a cria√ß√£o
        return userCredential.user;
    } catch (error) {
        let msg = "Erro ao criar usu√°rio: " + error.code;
        if (error.code === 'auth/weak-password') {
            msg = "A senha deve ter pelo menos 6 caracteres.";
        } else if (error.code === 'auth/email-already-in-use') {
            msg = "O e-mail j√° est√° em uso por outra conta.";
        } else if (error.code === 'auth/invalid-email') {
            msg = "E-mail inv√°lido.";
        }
        mostrarMensagem(msg, "erro");
        console.error("Erro ao criar usu√°rio:", error.code, error.message);
        return false;
    }
  }
  // === LOGIN E SESS√ÉO ===
  
  function mostrarSistema(user) {
    const loginView = document.getElementById("loginView");
    const mainApp = document.getElementById("mainApp");
    const userNameEl = document.getElementById("userName");
    const perfilBadgeEl = document.getElementById("perfilBadge");
    const nomeBemVindoEl = document.getElementById("nomeUsuarioBemVindo");

    if (loginView && mainApp) {
        loginView.style.display = "none";
        mainApp.style.display = "block";
    }

    // Tenta encontrar o perfil do usu√°rio logado
    const usuarioLogado = window.usuarios.find(u => u.email.toLowerCase() === user.email.toLowerCase());
    const nome = usuarioLogado ? usuarioLogado.nome : user.email.split('@')[0];
    const perfil = usuarioLogado ? usuarioLogado.perfil : "DESCONHECIDO";

    if (userNameEl) userNameEl.textContent = nome;
    if (perfilBadgeEl) perfilBadgeEl.textContent = "Perfil: " + perfil.toUpperCase();
    if (nomeBemVindoEl) nomeBemVindoEl.textContent = nome;
  }
  
  window.fazerLogin = async function() {
    // CORRE√á√ÉO: Usar os IDs corretos do HTML de login
    const usuario = document.getElementById("usuarioLogin").value.trim(); 
    const senha = document.getElementById("senhaLogin").value.trim();

    if (!usuario || !senha) {
      alert("Preencha e-mail e senha!");
      return;
    }

    const email = usuario.trim();
    try {
      await signInWithEmailAndPassword(auth, email, senha);
      // O onAuthStateChanged cuidar√° da transi√ß√£o da tela
      // alert("‚úÖ Login realizado com sucesso!");
    } catch (error) {
      console.error(error.code, error.message);
      mostrarMensagem(`Erro de login: ${error.code}`, "erro");
    }
  };

  // === MONITORAR LOGIN ===
  onAuthStateChanged(auth, (user) => {
    const login = document.getElementById("loginView");
    const appDiv = document.getElementById("mainApp");
    if (user) {
        // Logado
        login.style.display = "none";
        appDiv.style.display = "block";
        carregarDadosDoFirestore().then(() => {
             mostrarSistema(user); // Garante que a interface √© atualizada ap√≥s carregar os dados
        });
        
    } else {
        // Deslogado
        login.style.display = "flex";
        appDiv.style.display = "none";
        
        // Limpa campos e dados (opcional, mas recomendado)
        if (typeof limparCampos === "function") {
            limparCampos("loginView");
        }
        document.getElementById("userName").innerText = "Visitante";
        document.getElementById("perfilBadge").innerText = "PERFIL";
    }
  });

  // === LOGOUT ===
  window.logout = async function() {
    await signOut(auth);
    mostrarMensagem("Sess√£o encerrada!", "info");
  };
  
  // Expor Firestore para uso em outras fun√ß√µes, se necess√°rio
  window.db = db;
  window.auth = auth;
  
 </script>

<script>
// --- VARI√ÅVEIS GLOBAIS ---
// Elas s√£o inicializadas no script type="module" acima, mas devem ser declaradas aqui para o escopo global.
if (typeof produtos === "undefined") window.produtos = [];
if (typeof entradas === "undefined") window.entradas = [];
if (typeof saidas === "undefined") window.saidas = [];
if (typeof usuarios === "undefined") window.usuarios = [];

// --- FUN√á√ïES GERAIS DE UI ---

/**
 * üîπ Mostra/Esconde a sidebar
 */
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const main = document.querySelector("main");
  const isActive = sidebar.classList.toggle("active");
  
  // Ajusta a margem da √°rea principal para dar espa√ßo √† sidebar no desktop
  if (window.innerWidth >= 900) {
      main.style.marginLeft = isActive ? "270px" : "20px";
  }
}
// ... (ap√≥s a defini√ß√£o de showSection, logout, etc.)

// === FUN√á√ÉO PARA ABRIR/FECHAR MENU LATERAL COM CORRE√á√ÉO ARIA ===
window.toggleSidebar = function() {
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.querySelector("main");
    
    // Se o estilo 'left' for vazio (padr√£o) ou '0px', esconde
    if (sidebar.style.left === '0px' || sidebar.style.left === '') {
        // Esconder
        sidebar.style.left = '-220px'; 
        mainContent.style.marginLeft = '20px'; 
        
        // CORRE√á√ÉO ARIA: Esconde a sidebar de leitores de tela
        sidebar.setAttribute('aria-hidden', 'true'); 
    } else {
        // Mostrar
        sidebar.style.left = '0px'; 
        mainContent.style.marginLeft = '240px'; 
        
        // CORRE√á√ÉO ARIA: Torna a sidebar acess√≠vel a leitores de tela
        sidebar.setAttribute('aria-hidden', 'false'); 
    }
}
/**
 * üîπ Alterna a se√ß√£o vis√≠vel
 */
function showSection(id) {
  document.querySelectorAll(".section").forEach(s => {
    s.classList.remove("active");
  });
  const newSection = document.getElementById(id);
  if (newSection) {
    newSection.classList.add("active");
    // Garante que o menu lateral feche no mobile
    if (window.innerWidth < 900) {
      document.getElementById("sidebar").classList.remove("active");
      document.querySelector("main").style.marginLeft = "20px";
    }
    // Rola para o topo da se√ß√£o
    newSection.scrollTo(0, 0);
  }
  // Atualiza o dashboard sempre que a se√ß√£o for aberta
  if (id === "dashboard") atualizarDashboard();
  if (id === "estoque") atualizarTabelaEstoque();
  if (id === "limites") atualizarTabelaLimites();
  if (id === "financeiro") atualizarPainelFinanceiro();
  if (id === "cadastro") atualizarTabelaProdutos();
  if (id === "entrada") atualizarTabelaEntradas();
  if (id === "saida") atualizarTabelaSaidas();
  if (id === "usuarios") atualizarTabelaUsuarios();
}

/**
 * üîπ Exibe uma notifica√ß√£o de "toast" no rodap√©
 */
function mostrarMensagem(texto, tipo = "info") {
  const box = document.getElementById("toastMessage");
  if (!box) {
      // Cria a caixa se n√£o existir
      const newBox = document.createElement("div");
      newBox.id = "toastMessage";
      document.body.appendChild(newBox);
      // Reaplica a vari√°vel box
      box = document.getElementById("toastMessage");
  }

  box.textContent = texto;
  box.style.background = tipo === "erro" ? "#dc3545" : tipo === "sucesso" ? "#28a745" : "#0d6efd";
  box.style.opacity = "1";
  box.style.transform = "translateX(-50%) translateY(0)"; // Move para cima

  setTimeout(() => {
      box.style.opacity = "0";
      box.style.transform = "translateX(-50%) translateY(20px)"; // Move para baixo
  }, 4000);
}

/**
 * üîπ Destaca o campo com erro
 */
function destacarErro(el, msg) {
  el.style.border = "2px solid red";
  el.focus();
  mostrarMensagem(msg, "erro");
}

/**
 * üîπ Remove marca√ß√µes de erro
 */
function limparErros(secaoId) {
    document.querySelectorAll(`#${secaoId} input, #${secaoId} select`).forEach(el => {
        el.style.border = "1px solid #ccc";
        el.title = "";
    });
}

/**
 * üîπ Fun√ß√£o gen√©rica ‚Äî limpa todos os inputs e selects dentro de uma se√ß√£o
 */
function limparCampos(secaoId) {
  const secao = document.getElementById(secaoId);
  if (!secao) return;
  secao.querySelectorAll("input, select").forEach(el => {
    if (el.type === "file") {
      el.value = "";
    } else if (el.tagName === "SELECT") {
      el.selectedIndex = 0;
    } else {
      el.value = "";
    }
  });
}

/**
 * üîπ Amplia a imagem do produto no modal
 */
function ampliarImagem(src) {
  const modal = document.getElementById("imagemAmpliada");
  modal.querySelector("img").src = src;
  modal.style.display = "flex";
}

/**
 * üîπ Fun√ß√£o utilit√°ria: busca c√≥digo de barras do produto
 */
function buscarCodigoBarrasDoProduto(nome) {
    const p = produtos.find(p => p.nome === nome);
    return p ? p.codigoBarras : "-";
}

/**
 * üîπ Atualiza o campo 'quantidade' no estoque global
 */
function atualizarEstoque(nomeProduto, quantidadeDelta) {
  const produtoRef = produtos.find(p => p.nome.trim().toLowerCase() === nomeProduto.trim().toLowerCase());
  
  if (produtoRef) {
    // Garante que quantidade √© num√©rica e trata o caso de ser undefined/null
    let qtdAtual = Number(produtoRef.quantidade || 0); 
    qtdAtual += quantidadeDelta;
    
    // Evita estoque negativo (se for sa√≠da)
    produtoRef.quantidade = Math.max(0, qtdAtual);
    
    // Salva e atualiza
    salvarProdutosNoFirebase(produtos); 
    atualizarTabelaEstoque();
    atualizarDashboard();
    atualizarPainelFinanceiro();
  }
}

// --- PADRONIZA√á√ÉO DE DADOS ---

/**
 * üîπ Formata o texto para padr√£o (Primeira Letra Mai√∫scula)
 */
function formatarTextoPadrao(texto) {
  if (!texto) return "";
  return texto
    .toLowerCase()
    .split(" ")
    .filter(p => p.trim() !== "")
    .map(p => p.charAt(0).toUpperCase() + p.slice(1))
    .join(" ");
}

/**
 * üî∏ Aplica automaticamente a padroniza√ß√£o ao sair de campos de texto
 */
document.addEventListener("blur", (e) => {
  const el = e.target;
  if (el.tagName === "INPUT" && el.type === "text") {
    // Ignora campos que n√£o devem ser alterados (ex: c√≥digos, e-mail)
    if (
      el.id.toLowerCase().includes("cnpj") ||
      el.id.toLowerCase().includes("email") ||
      el.id.toLowerCase().includes("login") ||
      el.id.toLowerCase().includes("lote") ||
      el.id.toLowerCase().includes("barras")
    ) return;
    el.value = formatarTextoPadrao(el.value);
  }
}, true);

/**
 * üî∏ Garante padroniza√ß√£o em todos os campos antes de salvar/cadastrar
 */
function padronizarCamposAntesDeSalvar() {
  document.querySelectorAll('input[type="text"]').forEach(el => {
    // Mesma l√≥gica de ignorar campos espec√≠ficos
    if (
      el.id.toLowerCase().includes("cnpj") ||
      el.id.toLowerCase().includes("email") ||
      el.id.toLowerCase().includes("login") ||
      el.id.toLowerCase().includes("lote") ||
      el.id.toLowerCase().includes("barras")
    ) return;
    el.value = formatarTextoPadrao(el.value);
  });
}

// --- CADASTRO DE PRODUTOS ---

function cadastrarProduto() {
  padronizarCamposAntesDeSalvar();
  limparErros("cadastro");
  
  const nomeEl = document.getElementById("produtoNome");
  const categoriaEl = document.getElementById("produtoCategoria");
  const embalagemEl = document.getElementById("produtoEmbalagem");
  const qtdEl = document.getElementById("produtoQtdEmbalagem");
  const fotoInput = document.getElementById("produtoFoto");
  const codigoBarrasEl = document.getElementById("produtoCodigoBarras");
  const codigoBarras = codigoBarrasEl ? codigoBarrasEl.value.trim() : "";

  // üîπ Valida√ß√µes
  if (!nomeEl.value.trim()) return destacarErro(nomeEl, "Informe o nome do produto!");
  if (!categoriaEl.value.trim()) return destacarErro(categoriaEl, "Selecione a categoria!");
  if (!embalagemEl.value.trim()) return destacarErro(embalagemEl, "Selecione a embalagem!");
  if (!qtdEl.value || Number(qtdEl.value) <= 0) return destacarErro(qtdEl, "Informe a Qtd. por Embalagem (maior que zero)!");
  
  // Verifica se o produto j√° existe
  const nome = nomeEl.value.trim();
  if (produtos.some(p => p.nome.toLowerCase() === nome.toLowerCase())) {
    return destacarErro(nomeEl, "Produto com este nome j√° cadastrado!");
  }
  
  // Verifica se o c√≥digo de barras j√° existe
  if (codigoBarras && produtos.some(p => p.codigoBarras === codigoBarras)) {
    return destacarErro(codigoBarrasEl, "J√° existe um produto cadastrado com este c√≥digo de barras!");
  }

  // ‚úÖ Leitura de imagem e salvamento
  return new Promise((resolve) => {
    if (fotoInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            const foto = e.target.result;
            produtos.push({ 
                nome, 
                categoria: categoriaEl.value.trim(), 
                embalagem: embalagemEl.value.trim(), 
                qtdEmbalagem: Number(qtdEl.value), 
                foto, 
                quantidade: 0, 
                codigoBarras: codigoBarras || "",
                minimo: 0,
                maximo: 0
            });
            await salvarProdutosNoFirebase(produtos);
            atualizarTabelaProdutos();
            atualizarSelectProdutos();
            ordenarListasAlfabeticamente();
            limparCampos("cadastro");
            mostrarMensagem("Produto cadastrado com sucesso!", "sucesso");
            resolve(true);
        };
        reader.readAsDataURL(fotoInput.files[0]);
    } else {
        // Sem foto
        produtos.push({ 
            nome, 
            categoria: categoriaEl.value.trim(), 
            embalagem: embalagemEl.value.trim(), 
            qtdEmbalagem: Number(qtdEl.value), 
            foto: "", 
            quantidade: 0, 
            codigoBarras: codigoBarras || "",
            minimo: 0,
            maximo: 0
        });
        salvarProdutosNoFirebase(produtos);
        atualizarTabelaProdutos();
        atualizarSelectProdutos();
        ordenarListasAlfabeticamente();
        limparCampos("cadastro");
        mostrarMensagem("Produto cadastrado com sucesso (sem foto).", "sucesso");
        resolve(true);
    }
  });
}

function atualizarTabelaProdutos() {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  const filtro = document.getElementById("filtroProduto").value.toLowerCase();
  tbody.innerHTML = "";

  produtos.forEach((p, i) => {
    const nome = (p.nome || "").toLowerCase();
    const categoria = (p.categoria || "").toLowerCase();
    
    if (filtro && !nome.includes(filtro) && !categoria.includes(filtro)) return;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.foto ? `<img src="${p.foto}" class="thumb" onclick="ampliarImagem('${p.foto}')">` : "-"}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.embalagem}</td>
      <td>${p.qtdEmbalagem}</td>
      <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
      <td>
        <button onclick="editarProduto(${i})"><i class="fa fa-edit"></i></button>
        <button onclick="excluirProduto(${i})"><i class="fa fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function editarProduto(i) {
  // L√≥gica de edi√ß√£o completa (popup/modal ou preenchimento de campos)
  mostrarMensagem("Funcionalidade de Edi√ß√£o em constru√ß√£o. Por favor, edite manualmente no console (temporariamente).", "info");
}

function excluirProduto(i) {
  if (!confirm(`Excluir o produto "${produtos[i].nome}"? Todas as entradas e sa√≠das relacionadas ser√£o mantidas, mas o estoque ser√° recontado.`)) return;
  
  const nomeProduto = produtos[i].nome;
  
  // Remove o produto da lista principal
  produtos.splice(i, 1);
  salvarProdutosNoFirebase(produtos);

  // Recalcula o estoque de todos os produtos (apenas para seguran√ßa, embora o estoque deva estar correto)
  // Nota: Em um sistema robusto, isso deveria recalcular a Qtd atual = Soma Entradas - Soma Sa√≠das para este produto.
  // Por simplicidade, assumimos que as entradas/sa√≠das guardam a hist√≥ria.
  
  atualizarTabelaProdutos();
  atualizarTabelaEstoque();
  atualizarSelectProdutos();
  ordenarListasAlfabeticamente();
  mostrarMensagem(`Produto "${nomeProduto}" exclu√≠do.`, "sucesso");
}

function filtrarProdutos() {
    atualizarTabelaProdutos();
}

// --- ENTRADA DE MATERIAIS ---

function atualizarSelectProdutos() {
  const selectEntrada = document.getElementById("listaProdutos");
  
  if (!selectEntrada) return;
  
  // limpa todas as op√ß√µes
  selectEntrada.innerHTML = "";

  // garante que a lista esteja ordenada
  const listaOrdenada = [...produtos].sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR", { sensitivity: 'base' }));

  listaOrdenada.forEach(p => {
    const option = document.createElement("option");
    option.value = p.nome;
    selectEntrada.appendChild(option);
  });
}

function buscarProdutoPorCodigo(contexto) {
  const campoCodigo = document.getElementById(`${contexto}CodigoBarras`);
  const campoProduto = document.getElementById(`${contexto}Produto`);
  
  if (!campoCodigo || !campoProduto) return;
  
  const codigo = campoCodigo.value.trim();
  
  // Limpa o erro anterior
  campoCodigo.style.border = "1px solid #ccc";
  campoCodigo.title = "";
  campoProduto.value = "";
  
  if (!codigo) return;
  
  const produto = produtos.find(p => p.codigoBarras === codigo);
  
  if (!produto) {
    campoCodigo.style.border = "2px solid red";
    campoCodigo.title = "C√≥digo de barras n√£o encontrado.";
    mostrarMensagem("C√≥digo de barras n√£o encontrado!", "erro");
    return;
  }
  
  // Preenche o campo do nome automaticamente
  campoProduto.value = produto.nome;
  mostrarMensagem(`Produto "${produto.nome}" encontrado.`, "info");
}


function registrarEntrada() {
  padronizarCamposAntesDeSalvar();
  limparErros("entrada");
  
  const produtoEl = document.getElementById("entradaProduto");
  const qtdEl = document.getElementById("entradaQuantidade");
  const valorEl = document.getElementById("entradaValor");
  const dataEl = document.getElementById("entradaData");
  const notaEl = document.getElementById("entradaNota");
  const fornecedorEl = document.getElementById("entradaFornecedor");
  const cnpjEl = document.getElementById("entradaCNPJ");
  const loteEl = document.getElementById("entradaLote");
  const validadeEl = document.getElementById("entradaValidade");
  const setorEl = document.getElementById("entradaSetor");
  const codigoBarrasEl = document.getElementById("entradaCodigoBarras");
  
  const nomeProduto = produtoEl.value.trim();

  // üîπ Valida√ß√£o simples
  if (!nomeProduto) return destacarErro(produtoEl, "Informe o nome do produto!");
  if (!qtdEl.value || Number(qtdEl.value) <= 0) return destacarErro(qtdEl, "Informe a quantidade (maior que zero)!");
  if (!valorEl.value || Number(valorEl.value) <= 0) return destacarErro(valorEl, "Informe o Valor Unit√°rio (maior que zero)!");
  if (!dataEl.value) return destacarErro(dataEl, "Informe a data da entrada!");
  if (!notaEl.value.trim()) return destacarErro(notaEl, "Informe a Nota Fiscal!");
  if (!fornecedorEl.value.trim()) return destacarErro(fornecedorEl, "Informe o Fornecedor!");
  if (!setorEl.value.trim()) return destacarErro(setorEl, "Selecione o Setor Utilizado!");
  
  // Garante que o produto existe (n√£o pode ser uma entrada para um produto n√£o cadastrado)
  const produtoExiste = produtos.some(p => p.nome.toLowerCase() === nomeProduto.toLowerCase());
  if (!produtoExiste) {
      return destacarErro(produtoEl, "Produto n√£o encontrado no Cadastro de Produtos!");
  }

  // Tudo ok -> registra a entrada
  const novaEntrada = {
    produto: nomeProduto,
    qtd: Number(qtdEl.value),
    valor: Number(valorEl.value),
    data: dataEl.value,
    nota: notaEl.value.trim(),
    fornecedor: fornecedorEl.value.trim(),
    cnpj: cnpjEl.value.trim(),
    lote: loteEl.value.trim(),
    validade: validadeEl.value,
    setor: setorEl.value.trim(),
    codigoBarras: codigoBarrasEl.value.trim() || buscarCodigoBarrasDoProduto(nomeProduto),
    usuario: auth.currentUser ? auth.currentUser.email : "desconhecido",
    timestamp: new Date().toISOString()
  };

  // üîπ Salva no Firebase
  entradas.push(novaEntrada);
  salvarEntradasNoFirebase(entradas); 

  // üîπ Atualiza produto relacionado no estoque global
  atualizarEstoque(novaEntrada.produto, novaEntrada.qtd);
  
  // üîπ Limpa e atualiza
  atualizarTabelaEntradas();
  limparCampos("entrada");
  mostrarMensagem("Entrada registrada com sucesso!", "sucesso");
  return true;
}

function atualizarTabelaEntradas() {
  const tbody = document.querySelector("#tabelaEntradas tbody");
  const filtro = document.getElementById("filtroEntrada").value.toLowerCase();
  tbody.innerHTML = "";

  entradas.slice().reverse().forEach((e, i) => { // Inverte para mostrar as mais recentes primeiro
    const idxOriginal = entradas.length - 1 - i;
    const produto = (e.produto || "").toLowerCase();
    const fornecedor = (e.fornecedor || "").toLowerCase();
    const nota = (e.nota || "").toLowerCase();
    
    if (filtro && !produto.includes(filtro) && !fornecedor.includes(filtro) && !nota.includes(filtro)) return;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${idxOriginal + 1}</td>
      <td>${e.produto || "-"}</td>
      <td style="font-size:12px; color:#555;">${e.codigoBarras || "-"}</td>
      <td>${e.qtd || 0}</td>
      <td>${(e.valor || 0).toFixed(2)}</td>
      <td>${e.data || "-"}</td>
      <td>${e.nota || "-"}</td>
      <td>${e.fornecedor || "-"}</td>
      <td>${e.cnpj || "-"}</td>
      <td>${e.lote || "-"}</td>
      <td>${e.validade || "-"}</td>
      <td>${e.setor || "-"}</td>
      <td>
        <button onclick="editarEntrada(${idxOriginal})" title="Editar Entrada"><i class="fa fa-edit"></i></button>
        <button onclick="excluirEntrada(${idxOriginal})" title="Excluir Entrada"><i class="fa fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function excluirEntrada(i) {
  const entrada = entradas[i];
  if (!confirm(`Excluir a entrada do produto "${entrada.produto}" (Qtd: ${entrada.qtd})? O estoque ser√° ajustado.`)) return;

  // üîπ Diminui a quantidade no estoque global
  atualizarEstoque(entrada.produto, -entrada.qtd); 
  
  // üîπ Remove a entrada
  entradas.splice(i, 1);
  salvarEntradasNoFirebase(entradas); 
  
  // üîπ Atualiza
  atualizarTabelaEntradas();
  atualizarTabelaEstoque();
  atualizarPainelFinanceiro();
  mostrarMensagem("Entrada exclu√≠da e estoque ajustado.", "sucesso");
}

function filtrarEntradas() {
    atualizarTabelaEntradas();
}

// --- SA√çDA DE MATERIAIS ---

function atualizarSetorAutomatico() {
  const produtoInput = document.getElementById("saidaProduto");
  const setorSelect = document.getElementById("saidaSetor");
  const codigoInput = document.getElementById("saidaCodigoBarras");
  
  if (!produtoInput || !setorSelect) return;

  const nomeProduto = produtoInput.value.trim();
  const codigo = codigoInput ? codigoInput.value.trim() : "";
  let entradaEncontrada = null;

  // 1. Tenta achar pela leitura do c√≥digo de barras
  if (codigo && Array.isArray(produtos)) {
    const produto = produtos.find(p => p.codigoBarras === codigo);
    if (produto) {
        // Se achou o produto, tenta achar a √∫ltima entrada dele para o setor
        entradaEncontrada = entradas.slice().reverse().find(e => e.produto === produto.nome);
    }
  }

  // 2. Se n√£o achou pelo c√≥digo ou se n√£o tem c√≥digo, tenta pelo nome do produto
  if (!entradaEncontrada && nomeProduto) {
    // Tenta achar a √∫ltima entrada para este produto
    entradaEncontrada = entradas.slice().reverse().find(e => e.produto.toLowerCase() === nomeProduto.toLowerCase());
  }

  // 3. Preenche as op√ß√µes do select de Setor
  const setoresUnicos = Array.from(new Set(entradas.map(e => e.setor).filter(s => s)));
  setorSelect.innerHTML = '<option value="">Selecione o Setor</option>';
  setoresUnicos.forEach(setor => {
    const option = document.createElement("option");
    option.value = setor;
    option.textContent = setor;
    setorSelect.appendChild(option);
  });
  
  // 4. Se encontrou uma entrada, sugere o setor
  if (entradaEncontrada && entradaEncontrada.setor) {
      setorSelect.value = entradaEncontrada.setor;
  }
}

function registrarSaida() {
  padronizarCamposAntesDeSalvar();
  limparErros("saida");
  
  const produtoEl = document.getElementById("saidaProduto");
  const qtdEl = document.getElementById("saidaQuantidade");
  const dataEl = document.getElementById("saidaData");
  const setorEl = document.getElementById("saidaSetor");
  const responsavelEl = document.getElementById("saidaResponsavel");
  const observacaoEl = document.getElementById("saidaObservacao");

  const produto = produtoEl.value.trim();
  const qtd = Number(qtdEl.value);

  // üîπ Valida√ß√µes
  if (!produto) return destacarErro(produtoEl, "Informe o nome do produto!");
  if (!qtd || qtd <= 0) return destacarErro(qtdEl, "Informe a quantidade da sa√≠da (maior que zero)!");
  if (!setorEl.value.trim()) return destacarErro(setorEl, "Selecione o setor!");
  if (!dataEl.value) return destacarErro(dataEl, "Informe a data da sa√≠da!");
  if (!responsavelEl.value.trim()) return destacarErro(responsavelEl, "Informe o respons√°vel!");

  // Garante que o produto existe (n√£o pode ser uma sa√≠da para um produto n√£o cadastrado)
  const produtoRef = produtos.find(p => p.nome.toLowerCase() === produto.toLowerCase());
  if (!produtoRef) {
      return destacarErro(produtoEl, "Produto n√£o encontrado no Cadastro de Produtos!");
  }
  
  // üîπ Valida√ß√£o de Estoque
  const estoqueAtual = Number(produtoRef.quantidade || 0);
  if (qtd > estoqueAtual) {
    return destacarErro(qtdEl, `Estoque insuficiente: h√° ${estoqueAtual} unidade(s) dispon√≠veis.`);
  }

  // Tudo ok -> registra a sa√≠da
  saidas.push({
    produto,
    qtd,
    data: dataEl.value,
    setor: setorEl.value.trim(),
    responsavel: responsavelEl.value.trim(),
    observacao: observacaoEl.value.trim(),
    codigoBarras: produtoRef.codigoBarras || "",
    usuario: auth.currentUser ? auth.currentUser.email : "desconhecido",
    timestamp: new Date().toISOString()
  });
  salvarSaidasNoFirebase(saidas); 

  // Atualiza estoque (subtrai) e tabelas
  atualizarEstoque(produto, -qtd);
  atualizarTabelaSaidas();
  limparCampos("saida");
  mostrarMensagem("Sa√≠da registrada com sucesso!", "sucesso");
  return true;
}

function atualizarTabelaSaidas() {
  const tbody = document.querySelector("#tabelaSaidas tbody");
  const filtro = document.getElementById("filtroSaida").value.toLowerCase();
  tbody.innerHTML = "";
  
  saidas.slice().reverse().forEach((s, i) => { // Inverte para mostrar as mais recentes primeiro
    const idxOriginal = saidas.length - 1 - i;
    const produto = (s.produto || "").toLowerCase();
    const responsavel = (s.responsavel || "").toLowerCase();
    const setor = (s.setor || "").toLowerCase();
    
    if (filtro && !produto.includes(filtro) && !responsavel.includes(filtro) && !setor.includes(filtro)) return;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${idxOriginal + 1}</td>
      <td>${s.produto || "-"}</td>
      <td style="font-size:12px; color:#555;">${s.codigoBarras || "-"}</td>
      <td>${s.qtd || 0}</td>
      <td>${s.data || "-"}</td>
      <td>${s.setor || "-"}</td>
      <td>${s.responsavel || "-"}</td>
      <td>${s.observacao || "-"}</td>
      <td>
        <button onclick="editarSaida(${idxOriginal})"><i class="fa fa-edit"></i></button>
        <button onclick="excluirSaida(${idxOriginal})"><i class="fa fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function excluirSaida(i) {
  const saida = saidas[i];
  if (!confirm(`Excluir a sa√≠da do produto "${saida.produto}" (Qtd: ${saida.qtd})? O estoque ser√° ajustado.`)) return;

  // üîπ Aumenta a quantidade no estoque global
  atualizarEstoque(saida.produto, +saida.qtd); 
  
  // üîπ Remove a sa√≠da
  saidas.splice(i, 1);
  salvarSaidasNoFirebase(saidas); 
  
  // üîπ Atualiza
  atualizarTabelaSaidas();
  atualizarTabelaEstoque();
  atualizarPainelFinanceiro();
  mostrarMensagem("Sa√≠da exclu√≠da e estoque ajustado.", "sucesso");
}

function filtrarSaidas() {
    atualizarTabelaSaidas();
}

// --- ESTOQUE ATUAL ---

function atualizarTabelaEstoque() {
  const tbody = document.querySelector("#tabelaEstoque tbody");
  const filtro = document.getElementById("filtroEstoque").value.toLowerCase();
  const resumoDiv = document.getElementById("resumoEstoque");
  tbody.innerHTML = "";
  let totalItens = 0;
  let totalQuantidade = 0;
  let valorTotal = 0;

  produtos.forEach((p, i) => {
    const nome = (p.nome || "").toLowerCase();
    const categoria = (p.categoria || "").toLowerCase();
    const qtd = Number(p.quantidade) || 0;
    
    if (filtro && !nome.includes(filtro) && !categoria.includes(filtro)) return;
    
    // üîπ Busca a √∫ltima entrada para obter o valor e validade
    const entradasDoProduto = entradas.filter(e => e.produto === p.nome);
    const ultimaEntrada = entradasDoProduto.length > 0 ? entradasDoProduto.slice(-1)[0] : {};
    const valorUnitario = ultimaEntrada.valor || 0;
    const validade = ultimaEntrada.validade || "-";
    
    // üîπ C√°lculos de resumo
    totalItens++;
    totalQuantidade += qtd;
    valorTotal += qtd * valorUnitario;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.foto ? `<img src="${p.foto}" class="thumb" onclick="ampliarImagem('${p.foto}')">` : "-"}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
      <td style="font-weight:bold;">${qtd}</td>
      <td>R$ ${(valorUnitario || 0).toFixed(2)}</td>
      <td style="color:${validade && new Date(validade) < new Date() ? 'red' : 'inherit'}; font-weight:${validade && new Date(validade) < new Date() ? 'bold' : 'normal'};">
        ${validade}
      </td>
      <td>
        <button onclick="editarProduto(${i})"><i class="fa fa-edit"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // üîπ Atualiza o resumo
  resumoDiv.innerHTML = `
    <strong>Total de Produtos Cadastrados:</strong> ${produtos.length} | 
    <strong>Total de Itens em Estoque:</strong> ${totalQuantidade} | 
    <strong>Valor Total do Estoque (√öltimo Custo):</strong> <span style="color:#003b88; font-weight:bold;">R$ ${valorTotal.toFixed(2)}</span>
  `;
}

function filtrarEstoque() {
    atualizarTabelaEstoque();
}

// --- LIMITES E LISTA DE COMPRA ---

function atualizarTabelaLimites() {
  const tbody = document.querySelector("#tabelaLimites tbody");
  const filtro = document.getElementById("filtroLimites").value.toLowerCase();
  tbody.innerHTML = "";
  
  produtos.forEach((p, i) => {
    const nome = (p.nome || "").toLowerCase();
    
    if (filtro && !nome.includes(filtro)) return;

    const minimo = Number(p.minimo) || 0;
    const maximo = Number(p.maximo) || 0;
    const qtd = Number(p.quantidade) || 0;
    
    // calcula status e recomenda√ß√£o
    let statusTexto = "";
    let statusCor = "";
    let recomendacao = "";

    if (qtd < minimo) {
      statusTexto = "‚ö†Ô∏è Abaixo do m√≠nimo";
      statusCor = "red";
      recomendacao = `Comprar ${minimo - qtd} unidade(s)`;
    } else if (maximo && qtd > maximo) {
      statusTexto = "üì¶ Acima do m√°ximo";
      statusCor = "orange";
      recomendacao = "Reduzir estoque";
    } else {
      statusTexto = "‚úÖ Dentro do limite";
      statusCor = "green";
      recomendacao = "-";
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome}</td>
      <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
      <td>${p.categoria}</td>
      <td>${qtd}</td>
      <td><input type="number" value="${minimo}" onchange="salvarLimite('${p.nome}', this.value, 'minimo')" style="width:70px;"></td>
      <td><input type="number" value="${maximo}" onchange="salvarLimite('${p.nome}', this.value, 'maximo')" style="width:70px;"></td>
      <td style="color:${statusCor}; font-weight:bold;">${statusTexto}</td>
      <td>${recomendacao}</td>
      <td>
        <button onclick="removerLimites('${p.nome}')" title="Remover Limites"><i class="fa fa-times"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function salvarLimite(nome, valor, tipo) {
    const produtoRef = produtos.find(p => p.nome === nome);
    if (produtoRef) {
        produtoRef[tipo] = Number(valor);
        salvarProdutosNoFirebase(produtos);
        atualizarTabelaLimites(); // Recarrega para atualizar o status/recomenda√ß√£o
        mostrarMensagem(`Limite ${tipo} de ${nome} salvo.`, "sucesso");
    }
}

function removerLimites(nome) {
    const produtoRef = produtos.find(p => p.nome === nome);
    if (produtoRef && confirm(`Remover limites de estoque (m√≠nimo e m√°ximo) para "${nome}"?`)) {
        produtoRef.minimo = 0;
        produtoRef.maximo = 0;
        salvarProdutosNoFirebase(produtos);
        atualizarTabelaLimites();
        mostrarMensagem(`Limites de ${nome} removidos.`, "sucesso");
    }
}

function filtrarLimites() {
    atualizarTabelaLimites();
}

function gerarListaCompra() {
    const container = document.getElementById("listaCompraContainer");
    const tabela = document.getElementById("tabelaListaCompra");
    const tbody = tabela ? tabela.querySelector("tbody") : null;
    const totalSpan = document.getElementById("totalItensCompra");
    
    if (!container || !tabela || !tbody || !totalSpan) {
        console.error("‚ö†Ô∏è Elementos da lista de compra n√£o encontrados no DOM.");
        mostrarMensagem("Erro: tabela da lista de compra n√£o encontrada.", "erro");
        return;
    }

    const filtroCategoria = (document.getElementById("filtroCategoria")?.value || "").toLowerCase();
    
    // üîπ Filtra produtos abaixo do m√≠nimo
    const produtosAbaixo = produtos.filter(p => {
        const categoria = (p.categoria || "").toLowerCase();
        const qtd = Number(p.quantidade) || 0;
        const minimo = Number(p.minimo) || 0;

        if (filtroCategoria && filtroCategoria !== "" && categoria !== filtroCategoria) return false;
        
        return qtd < minimo;
    }).sort((a, b) => a.nome.localeCompare(b.nome)); // Ordena alfabeticamente
    
    tbody.innerHTML = "";
    if (!produtosAbaixo.length) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#777;">Nenhum item abaixo do estoque m√≠nimo.</td></tr>`;
        totalSpan.textContent = "0";
        container.style.display = "block";
        container.scrollIntoView({ behavior: "smooth" });
        return;
    }

    let contador = 0;
    produtosAbaixo.forEach((p, i) => {
        contador++;
        const minimo = Number(p.minimo) || 0;
        const qtd = Number(p.quantidade) || 0;
        const recomendacao = minimo - qtd;
        
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${contador}</td>
            <td>${p.nome}</td>
            <td>${p.codigoBarras || "-"}</td>
            <td>${p.categoria}</td>
            <td>${qtd}</td>
            <td>${minimo}</td>
            <td style="font-weight:bold; color:blue;">${recomendacao}</td>
            <td>
                <button onclick="removerItemListaCompra(this)"><i class="fa fa-times"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });

    totalSpan.textContent = contador;
    container.style.display = "block";
    container.scrollIntoView({ behavior: "smooth" });
    mostrarMensagem(`Lista de Compra gerada com ${contador} itens.`, "info");
}

function removerItemListaCompra(btn) {
    const row = btn.closest("tr");
    if (row) {
        row.remove();
        // Atualiza a contagem total
        const totalSpan = document.getElementById("totalItensCompra");
        if (totalSpan) {
            totalSpan.textContent = Number(totalSpan.textContent) - 1;
        }
        mostrarMensagem("Item removido da lista temporariamente.", "info");
    }
}

function limparListaCompra() {
    const container = document.getElementById("listaCompraContainer");
    const tbody = document.querySelector("#tabelaListaCompra tbody");
    const totalSpan = document.getElementById("totalItensCompra");
    
    if (tbody) tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#777;">Nenhum item abaixo do estoque m√≠nimo.</td></tr>`;
    if (totalSpan) totalSpan.textContent = "0";
    if (container) container.style.display = "none";
    
    // Limpa tamb√©m o filtro de categoria
    limparCampos("limites");
    mostrarMensagem("Lista de Compra limpa.", "info");
}


// --- PAINEL FINANCEIRO ---

function calcularValorSaida(saida) {
    // Tenta encontrar o valor unit√°rio da √∫ltima entrada para o produto
    const entradasDoProduto = entradas.filter(e => e.produto.toLowerCase() === saida.produto.toLowerCase());
    
    // 1. Usa o valor da √∫ltima entrada se existir
    if (entradasDoProduto.length > 0) {
        const ultimaEntrada = entradasDoProduto.slice(-1)[0];
        return (ultimaEntrada.valor || 0) * (saida.qtd || 0);
    }
    
    // 2. Se n√£o houver entrada, o custo de sa√≠da √© 0 (ou pode-se tentar um custo m√©dio se implementado)
    return 0;
}

function atualizarPainelFinanceiro() {
    let valorTotalEntradas = 0;
    let valorTotalSaidas = 0;
    let totalCustoMedioPonderado = 0;
    
    // üîπ 1. Calcular Entradas Totais e Custos de Sa√≠da
    entradas.forEach(e => {
        valorTotalEntradas += (e.valor || 0) * (e.qtd || 0);
    });
    
    saidas.forEach(s => {
        valorTotalSaidas += calcularValorSaida(s);
    });
    
    // üîπ 2. Calcular Valor Cont√°bil
    const valorEstoqueContabil = valorTotalEntradas - valorTotalSaidas;
    
    // üîπ 3. Calcular Custo M√©dio Ponderado Total
    let somaProdutosPorCustoMedio = 0;
    let somaTotalItensEstoque = 0;
    
    produtos.forEach(p => {
        const qtdAtual = Number(p.quantidade || 0);
        if (qtdAtual > 0) {
            const entradasDoProduto = entradas.filter(e => e.produto === p.nome);
            const totalQtdEntradas = entradasDoProduto.reduce((s, e) => s + Number(e.qtd || 0), 0);
            const totalValorEntradas = entradasDoProduto.reduce((s, e) => s + (Number(e.qtd || 0) * Number(e.valor || 0)), 0);
            const custoMedio = totalQtdEntradas > 0 ? totalValorEntradas / totalQtdEntradas : 0;
            
            somaProdutosPorCustoMedio += qtdAtual * custoMedio;
            somaTotalItensEstoque += qtdAtual;
        }
    });
    
    totalCustoMedioPonderado = somaTotalItensEstoque > 0 ? somaProdutosPorCustoMedio / somaTotalItensEstoque : 0;

    // üîπ 4. Atualiza os indicadores
    document.getElementById("totalEntradaNotas").textContent = `R$ ${valorTotalEntradas.toFixed(2)}`;
    document.getElementById("totalSaidaCusto").textContent = `R$ ${valorTotalSaidas.toFixed(2)}`;
    document.getElementById("valorEstoqueContabil").textContent = `R$ ${valorEstoqueContabil.toFixed(2)}`;
    document.getElementById("custoMedioTotal").textContent = `R$ ${totalCustoMedioPonderado.toFixed(2)}`;
    
    // üîπ 5. Detalhe Financeiro por Nota (Tabela Agrupada)
    const agrupadas = {}; // chave: fornecedor + nota
    entradas.forEach(e => {
        const chave = `${e.fornecedor}|${e.nota}`;
        
        if (!agrupadas[chave]) {
            agrupadas[chave] = {
                fornecedor: e.fornecedor,
                nota: e.nota,
                data: e.data,
                valorNota: 0,
                valorSaida: 0
            };
        }
        // Soma o valor do produto na nota (precisa de uma l√≥gica mais robusta se uma NF tiver mais de um item)
        // Por simplicidade: soma o custo total do item nesta entrada
        agrupadas[chave].valorNota += (e.valor || 0) * (e.qtd || 0);
    });
    
    // Distribui o custo das sa√≠das nas notas
    saidas.forEach(s => {
        // Encontra a entrada mais recente (ou a que deu origem ao estoque)
        const entradaRelacionado = entradas.slice().reverse().find(e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase());
        
        if (entradaRelacionado) {
            const chave = `${entradaRelacionado.fornecedor}|${entradaRelacionado.nota}`;
            const valorSaida = (entradaRelacionado.valor || 0) * (s.qtd || 0);
            
            if (agrupadas[chave]) {
                agrupadas[chave].valorSaida += valorSaida;
            } else {
                // Caso a sa√≠da tenha sido registrada antes da entrada, ou a NF n√£o tenha sido agrupada
                // Cria um item tempor√°rio para esta sa√≠da (Nota "Desconhecida")
                const chaveDesconhecida = "Desconhecido|N/A";
                if (!agrupadas[chaveDesconhecida]) {
                    agrupadas[chaveDesconhecida] = {
                        fornecedor: "Desconhecido",
                        nota: "N/A",
                        data: s.data,
                        valorNota: 0,
                        valorSaida: 0
                    };
                }
                agrupadas[chaveDesconhecida].valorSaida += valorSaida;
            }
        }
    });

    // Renderizar tabela agrupada
    const tbody = document.querySelector("#tabelaFinanceiro tbody");
    tbody.innerHTML = "";

    Object.values(agrupadas).forEach(a => {
        const saldo = a.valorNota - a.valorSaida;
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${a.fornecedor}</td>
            <td>${a.nota}</td>
            <td>${a.data}</td>
            <td style="color:#28a745; font-weight:bold;">R$ ${a.valorNota.toFixed(2)}</td>
            <td style="color:#dc3545; font-weight:bold;">R$ ${a.valorSaida.toFixed(2)}</td>
            <td style="color:${saldo < 0 ? 'red' : '#0d6efd'}; font-weight:bold;">R$ ${saldo.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });
}

// --- DASHBOARD ---

function calcularFrequenciaSaida() {
    const frequencia = {};
    const hoje = new Date();
    const trintaDiasAtras = new Date(hoje);
    trintaDiasAtras.setDate(hoje.getDate() - 30);

    saidas.forEach(s => {
        const dataSaida = new Date(s.data);
        if (dataSaida >= trintaDiasAtras) {
            frequencia[s.produto] = (frequencia[s.produto] || 0) + (s.qtd || 0);
        }
    });

    // Converte para array para ordenar
    return Object.entries(frequencia)
        .map(([produto, qtd]) => ({ produto, qtd }))
        .sort((a, b) => b.qtd - a.qtd); // Mais sa√≠das primeiro
}

function atualizarDashboard() {
  const listaProximosVencer = document.getElementById("listaProximosVencer");
  const listaMaisCaros = document.getElementById("listaMaisCaros");
  const listaMaisSaidas = document.getElementById("listaMaisSaidas");
  const listaMenosSaidas = document.getElementById("listaMenosSaidas");
  const listaEstoqueCritico = document.getElementById("listaEstoqueCritico");
  const resumoGeral = document.getElementById("resumoGeral");
  
  // Limpa listas
  [listaProximosVencer, listaMaisCaros, listaMaisSaidas, listaMenosSaidas, listaEstoqueCritico].forEach(el => el.innerHTML = "");

  // --- Estoque Cr√≠tico (Qtd < M√≠nimo) ---
  const criticos = produtos.filter(p => p.minimo && Number(p.quantidade || 0) <= Number(p.minimo));
  listaEstoqueCritico.innerHTML = criticos.length > 0 ? criticos.map(p => 
      `<li>${p.nome} - Estoque: ${p.quantidade || 0} (M√≠n: ${p.minimo})</li>`
  ).join("") : "<li>Nenhum produto cr√≠tico no momento.</li>";

  // --- Pr√≥ximos do Vencimento (Pr√≥ximos 60 dias) ---
  const hoje = new Date();
  const limiteValidade = new Date();
  limiteValidade.setDate(hoje.getDate() + 60);
  
  const proximosVencer = entradas
    .filter(e => e.validade && new Date(e.validade) > hoje && new Date(e.validade) <= limiteValidade)
    .sort((a, b) => new Date(a.validade) - new Date(b.validade)); // Mais pr√≥ximos primeiro

  listaProximosVencer.innerHTML = proximosVencer.length > 0 ? proximosVencer.map(e => {
    const validade = new Date(e.validade).toLocaleDateString('pt-BR');
    return `<li>${e.produto} - Lote: ${e.lote} (Validade: ${validade})</li>`;
  }).join("") : "<li>Nenhum produto pr√≥ximo do vencimento nos pr√≥ximos 60 dias.</li>";

  // --- Produtos Mais Caros (Custo Unit√°rio da √öltima Entrada) ---
  const produtosComCusto = produtos.map(p => {
    const entradasDoProduto = entradas.filter(e => e.produto === p.nome);
    const ultimoValor = entradasDoProduto.length > 0 ? entradasDoProduto.slice(-1)[0].valor || 0 : 0;
    return { nome: p.nome, custo: ultimoValor };
  }).sort((a, b) => b.custo - a.custo).slice(0, 5);
  
  listaMaisCaros.innerHTML = produtosComCusto.map(p => 
      `<li>${p.nome} - R$ ${p.custo.toFixed(2)}</li>`
  ).join("");
  
  // --- Frequ√™ncia de Sa√≠da (√öltimos 30 dias) ---
  const frequenciaSaidas = calcularFrequenciaSaida();
  
  const maisSaidas = frequenciaSaidas.slice(0, 5);
  listaMaisSaidas.innerHTML = maisSaidas.length > 0 ? maisSaidas.map(f => 
      `<li>${f.produto} - Qtd: ${f.qtd}</li>`
  ).join("") : "<li>Sem sa√≠das recentes.</li>";
  
  // Produtos com Menos Sa√≠das (Produtos que tiveram zero ou poucas sa√≠das)
  const produtosComSaida = new Set(frequenciaSaidas.map(f => f.produto));
  const menosSaidas = produtos
    .filter(p => !produtosComSaida.has(p.nome))
    .slice(0, 5); // Pega os 5 primeiros que n√£o tiveram sa√≠da
  
  listaMenosSaidas.innerHTML = menosSaidas.length > 0 ? menosSaidas.map(p => 
      `<li>${p.nome}</li>`
  ).join("") : "<li>Todos os produtos tiveram sa√≠das.</li>";
  
  // --- Resumo Geral ---
  let qtdTotal = produtos.reduce((soma, p) => soma + (Number(p.quantidade) || 0), 0);
  resumoGeral.innerHTML = `
      <p>üßæ Total de Produtos Cadastrados: <strong>${produtos.length}</strong></p>
      <p>üì¶ Total de Itens em Estoque: <strong>${qtdTotal}</strong></p>
      <p>‚ö†Ô∏è Produtos em Estoque Cr√≠tico: <strong style="color:red;">${criticos.length}</strong></p>
      <p>üìà Total de Entradas Registradas: <strong>${entradas.length}</strong></p>
      <p>üìâ Total de Sa√≠das Registradas: <strong>${saidas.length}</strong></p>
  `;
  
  // Atualiza indicadores do Financeiro no Dashboard (se implementados)
  atualizarPainelFinanceiro();
}


// --- RELAT√ìRIOS ---

function definirPeriodoRapido(tipo) {
  const hoje = new Date();
  let dataInicio, dataFim;

  if (tipo === '7dias') {
    dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - 7);
  } else if (tipo === '30dias') {
    dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - 30);
  } else if (tipo === 'mes') {
    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  } else {
    return; // N√£o faz nada se o tipo for inv√°lido
  }
  
  dataFim = hoje;
  
  document.getElementById("dataInicioRelatorio").value = dataInicio.toISOString().split('T')[0];
  document.getElementById("dataFimRelatorio").value = dataFim.toISOString().split('T')[0];
  mostrarMensagem(`Per√≠odo definido para: ${tipo}.`, "info");
}

function limparPeriodo() {
  document.getElementById("dataInicioRelatorio").value = "";
  document.getElementById("dataFimRelatorio").value = "";
  mostrarMensagem("Filtro de per√≠odo limpo.", "info");
}

/**
 * üîπ Fun√ß√£o gen√©rica para exportar qualquer tabela para Excel (CSV)
 */
function exportarTabelaExcel(idTabela, nomeArquivoBase, prefixo) {
  const tabela = document.getElementById(idTabela);
  if (!tabela) return alert("Tabela n√£o encontrada.");
  
  const dataInicio = document.getElementById("dataInicioRelatorio").value;
  const dataFim = document.getElementById("dataFimRelatorio").value;
  
  let dadosFiltrados = [];
  let cabecalho = [];

  // 1. Obt√©m o cabe√ßalho
  tabela.querySelectorAll('thead th').forEach(th => {
    // Ignora colunas de A√ß√µes e Foto para um CSV mais limpo
    if (th.textContent.trim() !== "A√ß√µes" && th.textContent.trim() !== "Foto") {
      cabecalho.push(th.textContent.trim());
    }
  });

  // 2. Obt√©m os dados e filtra por data (se for tabela de Entradas ou Sa√≠das)
  const isEntradaOuSaida = idTabela === 'tabelaEntradas' || idTabela === 'tabelaSaidas';
  const dataColuna = isEntradaOuSaida ? 5 : -1; // Coluna 5 √© a 'Data' em Entradas e Sa√≠das (√≠ndice 0)

  tabela.querySelectorAll('tbody tr').forEach(row => {
    let rowData = [];
    let shouldInclude = true;
    let dataDaLinha = "";
    
    row.querySelectorAll('td').forEach((td, index) => {
      // Ignora a √∫ltima coluna (A√ß√µes) e a segunda (Foto)
      if (index === row.cells.length - 1 || td.querySelector('.thumb')) return;
      
      const texto = td.textContent.trim();
      rowData.push(texto);
      
      if (isEntradaOuSaida && index === dataColuna) {
        dataDaLinha = texto;
      }
    });
    
    // Filtra por data se aplic√°vel
    if (isEntradaOuSaida && dataDaLinha && dataInicio && dataFim) {
        const dataLinha = new Date(dataDaLinha);
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        // Adiciona um dia ao fim para incluir a data final
        fim.setDate(fim.getDate() + 1); 

        if (dataLinha < inicio || dataLinha >= fim) {
            shouldInclude = false;
        }
    }

    if (shouldInclude && rowData.length > 0) {
      dadosFiltrados.push(rowData);
    }
  });
  
  if (dadosFiltrados.length === 0) {
      alert("Nenhum dado encontrado para exportar com base nos filtros (se houver).");
      return;
  }

  // 3. Cria o conte√∫do CSV
  let csvContent = cabecalho.join(";") + "\n";
  dadosFiltrados.forEach(row => {
    // Substitui v√≠rgulas por pontos e v√≠rgulas para evitar problemas de formata√ß√£o em Excel
    csvContent += row.map(item => item.replace(/;/g, ",").replace(/\r?\n|\r/g, " ")).join(";") + "\n";
  });

  // 4. Cria o Blob e baixa o arquivo
  const nomeCompleto = `${prefixo || ""}${nomeArquivoBase}_${new Date().toISOString().split('T')[0]}.csv`;
  const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // \uFEFF for BOM (UTF-8 encoding in Excel)
  const link = document.createElement("a");
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", nomeCompleto);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    mostrarMensagem(`Relat√≥rio '${nomeArquivoBase}' exportado com sucesso!`, "sucesso");
  }
}

function exportarListaExcel() {
    exportarTabelaExcel('tabelaListaCompra', 'Lista_de_Compra', 'Compra_');
}

/**
 * üîπ Fun√ß√£o para gerar Pedido de Or√ßamento em PDF (usando jspdf e autotable)
 */
function gerarPedidoPDF() {
    if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        alert("Erro: Biblioteca jsPDF n√£o carregada. Verifique as tags <script> no final do arquivo.");
        return;
    }
    
    // Pega os dados da lista de compra ATUAL (o que est√° na tela)
    const tabela = document.getElementById("tabelaListaCompra");
    const tbody = tabela ? tabela.querySelector("tbody") : null;
    if (!tbody || tbody.textContent.includes("Nenhum item abaixo")) {
        alert("‚ö†Ô∏è Nenhuma Lista de Compra gerada para exportar!");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Paisagem, mil√≠metros, A4
    const larguraPagina = doc.internal.pageSize.getWidth();
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    
    // --- CABE√áALHO ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("ORAL UNIC CAMPO GRANDE", larguraPagina / 2, 20, { align: "center" });
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.text("Pedido de Or√ßamento", larguraPagina / 2, 28, { align: "center" });
    
    doc.setFontSize(10);
    doc.text(`Data: ${dataAtual}`, 14, 38);
    doc.text(`Solicitante: ${document.getElementById("userName").textContent}`, 14, 44);

    // --- LINHA SEPARADORA ---
    doc.setDrawColor(180);
    doc.line(14, 48, larguraPagina - 14, 48);
    
    // --- TABELA ---
    const headers = [
        ['#', 'Produto', 'C√≥d. Barras', 'Categoria', 'Qtd Atual', 'M√≠nimo', 'Recomenda√ß√£o', 'Observa√ß√£o']
    ];
    
    const body = [];
    tbody.querySelectorAll("tr").forEach(tr => {
        const cols = tr.querySelectorAll("td");
        if (cols.length > 1) { // Ignora linha de rodap√© e linha de erro
            body.push([
                cols[0].textContent.trim(),
                cols[1].textContent.trim(),
                cols2.textContent.trim(), // C√≥d. Barras
                cols[3].textContent.trim(),
                cols[4].textContent.trim(),
                cols[5].textContent.trim(),
                cols[6].textContent.trim(),
                '' // Coluna vazia para observa√ß√£o manual do fornecedor
            ]);
        }
    });

    doc.autoTable({
        head: headers,
        body: body,
        startY: 55,
        theme: 'striped',
        headStyles: { fillColor: [13, 110, 253] }, // Azul
        columnStyles: {
            0: { cellWidth: 10 },
            1: { cellWidth: 40 },
            2: { cellWidth: 25 },
            6: { fontStyle: 'bold' },
        },
        styles: { fontSize: 8, overflow: 'linebreak' },
    });
    
    // --- RODAP√â ---
    const finalY = doc.autoTable.previous.finalY;
    doc.setFontSize(10);
    doc.setFont("helvetica", "italic");
    doc.text("Este documento n√£o √© um pedido oficial de compra, mas um pedido de or√ßamento.", 14, finalY + 10);
    
    doc.save(`Pedido_Orcamento_${new Date().toISOString().split('T')[0]}.pdf`);
    mostrarMensagem("Pedido de Or√ßamento exportado para PDF.", "sucesso");
}

// --- USU√ÅRIOS E PERFIS ---

async function salvarUsuarioLocal() { // üëà Tornada ass√≠ncrona
    padronizarCamposAntesDeSalvar();
    limparErros("usuarios");
    
    const nomeEl = document.getElementById("usuarioNome");
    const emailEl = document.getElementById("usuarioEmail");
    const perfilEl = document.getElementById("usuarioPerfil");
    const senhaEl = document.getElementById("usuarioSenha"); // üëà Novo

    // 1. Valida√ß√µes
    if (!nomeEl.value.trim()) return destacarErro(nomeEl, "Informe o nome!");
    if (!emailEl.value.trim().includes("@")) return destacarErro(emailEl, "Informe um e-mail v√°lido!");
    if (!perfilEl.value.trim()) return destacarErro(perfilEl, "Selecione o perfil!");
    
    const email = emailEl.value.trim().toLowerCase();
    const nome = nomeEl.value.trim();
    const perfil = perfilEl.value.trim();
    const senha = senhaEl.value.trim(); // üëà Novo

    const index = usuarios.findIndex(u => u.email.toLowerCase() === email);
    
    let isNovoUsuario = index === -1;

    if (isNovoUsuario) {
        // 2. Tenta criar o usu√°rio no FIREBASE AUTH se for um novo usu√°rio
        if (!senha || senha.length < 6) return destacarErro(senhaEl, "A senha √© obrigat√≥ria (m√≠n. 6 caracteres) para um novo usu√°rio.");
        
        const usuarioCriado = await criarUsuarioNoFirebase(email, senha);
        
        if (usuarioCriado === false) {
             // O erro j√° foi exibido pela fun√ß√£o criarUsuarioNoFirebase
             return; 
        }
        
        // 3. Salva o Perfil no Firestore/Local
        usuarios.push({ nome, email, perfil });
        mostrarMensagem(`‚úÖ Usu√°rio "${nome}" criado no Firebase Auth e perfil salvo!`, "sucesso");

    } else {
        // Se for edi√ß√£o de perfil (n√£o de senha)
        usuarios[index].nome = nome;
        usuarios[index].perfil = perfil;
        
        // Se houver senha preenchida, √© uma troca de senha (opcional, precisa de mais tratamento)
        if (senha) {
            // Nota: Trocar a senha de outro usu√°rio √© um processo mais complexo no Firebase e
            // exige a fun√ß√£o "Admin SDK". Para simplificar, o admin deve resetar a senha
            // diretamente no painel do Firebase ou fazer o usu√°rio editar a pr√≥pria senha.
            // Aqui, vamos apenas atualizar o perfil local e ignorar a senha.
            mostrarMensagem("‚ö†Ô∏è Senha n√£o alterada. Use o painel do Firebase para alterar senhas de outros usu√°rios.", "info");
        } else {
            mostrarMensagem(`‚úÖ Perfil de ${nome} atualizado.`, "sucesso");
        }
} 
	
	// Limpa o campo de senha ap√≥s a opera√ß√£o
    document.getElementById("usuarioSenha").value = ""; 
} // üëà ESTA CHAVE FECHA A FUN√á√ÉO 'salvarUsuarioLocal'

function atualizarTabelaUsuarios() {
    const tbody = document.querySelector("#tabelaUsuarios tbody");
    const filtro = document.getElementById("filtroUsuarios").value.toLowerCase();
    tbody.innerHTML = "";
    
    usuarios.forEach((u, i) => {
        const nome = (u.nome || "").toLowerCase();
        const email = (u.email || "").toLowerCase();
        
        if (filtro && !nome.includes(filtro) && !email.includes(filtro)) return;
        
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${i + 1}</td>
            <td>${u.nome}</td>
            <td>${u.email}</td>
            <td>${u.perfil}</td>
            <td>
                <button onclick="preencherParaEdicao('${u.email}', '${u.nome}', '${u.perfil}')" title="Editar"><i class="fa fa-edit"></i></button>
                <button onclick="excluirUsuarioLocal(${i})" title="Excluir Perfil Local"><i class="fa fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function preencherParaEdicao(email, nome, perfil) {
    document.getElementById("usuarioNome").value = nome;
    document.getElementById("usuarioEmail").value = email;
    document.getElementById("usuarioPerfil").value = perfil;
    document.getElementById("usuarioEmail").focus();
}

function excluirUsuarioLocal(i) {
    const usuario = usuarios[i];
    if (!confirm(`Excluir o perfil local de "${usuario.nome}" (${usuario.email})? Note que isso N√ÉO exclui o usu√°rio do Firebase Authentication.`)) return;
    
    usuarios.splice(i, 1);
    salvarUsuariosNoFirebase(usuarios); 
    atualizarTabelaUsuarios();
    mostrarMensagem(`Perfil local de ${usuario.nome} exclu√≠do.`, "sucesso");
}

function filtrarUsuarios() {
    atualizarTabelaUsuarios();
}

// --- UTILIT√ÅRIOS GLOBAIS ---

function ordenarListasAlfabeticamente() {
  if (typeof produtos !== "undefined" && Array.isArray(produtos)) {
    produtos.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
    // N√£o precisa salvar, pois esta √© apenas uma fun√ß√£o de ordena√ß√£o visual/de refer√™ncia
  }

  if (typeof entradas !== "undefined" && Array.isArray(entradas)) {
    entradas.sort((a, b) => (a.fornecedor || "").localeCompare(b.fornecedor || "", 'pt-BR', { sensitivity: 'base' }));
  }

  if (typeof saidas !== "undefined" && Array.isArray(saidas)) {
    saidas.sort((a, b) => (a.produto || "").localeCompare(b.produto || "", 'pt-BR', { sensitivity: 'base' }));
  }

  if (typeof usuarios !== "undefined" && Array.isArray(usuarios)) {
    usuarios.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
  }
  
  // Atualiza selects de produto
  if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
}


// --- EXECU√á√ÉO INICIAL ---

document.addEventListener("DOMContentLoaded", () => {
    // A autentica√ß√£o Firebase (no script type="module" acima) cuida do carregamento e atualiza√ß√£o inicial.
    // Garante que o menu de setor √© preenchido na se√ß√£o de Sa√≠da
    atualizarSetorAutomatico(); 
});


</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>





