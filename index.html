<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* ========================= VARI√ÅVEIS DE CORES ========================= */
    :root {
      --azul: #0d6efd;
      --azul-escuro: #003b88;
      --cinza-fundo: #f4f6f9;
      --branco: #ffffff;
      --cinza: #e0e0e0;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #222;
    }
    
    /* üîπ Centraliza√ß√£o est√°vel da tela de login */
    #loginView {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      overflow: hidden;
      z-index: 1000;
    }
    
    .login-card {
      background: var(--branco);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      text-align: center;
      width: 320px;
    }

    .login-card h2 {
      color: var(--azul-escuro);
      margin-bottom: 20px;
    }

    .login-card input {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .login-card button {
      width: 100%;
      margin-top: 10px;
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 8px;
      border-radius: 5px;
      font-size: 15px;
      cursor: pointer;
    }

    .login-card button:hover {
      background: var(--azul-escuro);
    }
    
    #loginMsg {
      background: #f8d7da;
      border-radius: 5px;
      padding: 8px;
      font-weight: bold;
      margin-top: 10px;
    }
    #loginMsg[style*="green"] {
      background: #d4edda;
    }


    /* ========================= HEADER ========================= */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--azul);
      color: var(--branco);
      padding: 12px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 900;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header button {
      background: none;
      border: none;
      color: var(--branco);
      cursor: pointer;
      font-size: 1.3rem;
    }

    header button:hover {
      color: #e2e2e2;
    }

   /* ========================= MENU LATERAL ========================= */
   /* Dentro da sua tag <style> */

#sidebar {
    /* ... outras propriedades existentes ... */
    position: fixed;
    top: 50px; /* Ou a altura do seu header */
    left: -220px;
    width: 220px;
    height: calc(100% - 50px); /* Ou o que for necess√°rio */
    background: var(--azul-escuro);
    z-index: 1000;
    padding: 10px 0;
    box-shadow: 2px 0 5px rgba(0,0,0,0.2);

    /* üëà ADICIONE ESTA LINHA: Transi√ß√£o suave de 0.3 segundos */
    transition: left 0.3s ease; 
    
}

    /* Quando ativo (aberto) */
    #sidebar.active {
      left: 0;
    }

    #sidebar button {
      display: block;
      width: 100%;
      border: none;
      background: none;
      color: var(--branco);
      text-align: left;
      padding: 14px 18px;
      font-size: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      transition: background 0.2s;
    }

    #sidebar button i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
    }

    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* ========================= √ÅREA PRINCIPAL ========================= */
    main {
      margin: 20px;
      padding-left: 0;
      transition: margin-left 0.3s ease;
      overflow-x: hidden; /* impede overflow lateral */
    }

    @media (min-width: 900px) {
      #sidebar.active + main {
        margin-left: 250px;
      }
    }

    /* ========================= SE√á√ïES ========================= */
    .section {
      display: none;
      max-height: calc(100vh - 140px); /* altura vis√≠vel abaixo do cabe√ßalho */
      overflow-y: auto; /* ativa rolagem vertical */
      overflow-x: hidden; /* evita rolagem lateral */
      padding-bottom: 20px; /* espa√ßamento inferior */
      scroll-behavior: smooth; /* rolagem suave */
    }

    .section h2 {
      color: var(--azul-escuro);
      border-left: 5px solid var(--azul);
      padding-left: 10px;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

/* ========================= DASHBOARD ========================= */
.dash-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.dash-card {
  background: var(--branco);
  border-radius: 10px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  padding: 15px 20px;
  transition: transform 0.2s ease;
}

.dash-card:hover {
  transform: scale(1.02);
}

.dash-card h3 {
  color: var(--azul-escuro);
  margin-bottom: 10px;
  border-bottom: 2px solid var(--azul);
  padding-bottom: 5px;
  font-size: 16px;
}

.dash-card ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.dash-card ul li {
  padding: 5px 0;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.dash-card ul li:last-child {
  border-bottom: none;
}

    /* ========================= TABELAS ========================= */
    .table-wrap {
      max-height: 60vh; /* altura m√°xima vis√≠vel */
      overflow-y: auto;          /* rolagem vertical */
      overflow-x: auto; /* rolagem horizontal se necess√°rio */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: #888 #f0f0f0;
    }

    .table-wrap table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* evita desalinhamento */
    }

    .table-wrap table thead th {
      position: sticky;
      top: 0;
      background: var(--azul);
      color: #fff;
      z-index: 10;
      text-align: left;
      padding: 10px 12px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
    }

    .table-wrap table td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      font-size: 14px;
    }

    .table-wrap table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    /* üîπ Scrollbar estilizada */
    .table-wrap::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .table-wrap::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 8px;
    }
    .table-wrap::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 8px;
    }
    .table-wrap::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* ========================= BOT√ïES ========================= */
    button {
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    button:hover {
      background: var(--azul-escuro);
    }

    /* ========================= INPUTS E SELECTS ========================= */
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .input-row .flex {
      flex: 1; /* Faz o input expandir o m√°ximo poss√≠vel */
      min-width: 150px;
    }

    input, select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin: 3px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--azul);
    }

    /* ========================= IMAGENS ========================= */
    .thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .thumb:hover {
      transform: scale(1.08);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
    }

    #imagemAmpliada {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #imagemAmpliada img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      cursor: pointer;
    }
    
    /* TOAST MESSAGE */
    #toastMessage {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.4s, transform 0.4s;
      pointer-events: none; /* N√£o impede cliques */
      font-family: "Segoe UI, sans-serif";
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
	.section h2 {
  color: #003b88;
}
.table-wrap {
  overflow-x: auto;
}

  /* estilos antigos... */
  body {
    font-family: Arial, sans-serif;
    background: #f8f9fa;
  }

  /* ... outras se√ß√µes como entrada, sa√≠da, estoque ... */

  /* ==============================================
     üêû SE√á√ÉO: ERROS E PROBLEMAS
     ============================================== */
  .situacao-vermelha { color: #dc3545; font-weight: bold; }
  .situacao-laranja { color: #fd7e14; font-weight: bold; }
  .situacao-amarela { color: #ffc107; font-weight: bold; }
  .situacao-verde { color: #198754; font-weight: bold; }
  .situacao-azul { color: #0d6efd; font-weight: bold; }

  #tabelaErros th:nth-child(7),
#tabelaErros td:nth-child(7) {
  min-width: 220px;
  max-width: 350px;
  word-break: break-word;
}
#tabelaErros th:nth-child(8),
#tabelaErros td:nth-child(8) {
  width: 100px;
  text-align: center;
}
#tabelaValorHistorico th,
#tabelaValorHistorico td {
  text-align: center;
  font-size: 13px;
  padding: 6px;
}
#tabelaValorHistorico td:first-child {
  text-align: left;
  font-weight: bold;
  background: #f8f9fa;
}
#filtroValorHistorico {
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px 10px;
}
#filtroValorHistorico:focus {
  outline: 2px solid #0d6efd;
}
#logoLogin:hover,
#logoBoasVindas:hover {
  opacity: 1;
}

.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.login-card {
  background: rgba(255, 255, 255, 0.95);
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  text-align: center;
}

/* Evita quebra de linha em TODAS as c√©lulas */
#tabelaEntradas td {
    white-space: nowrap;
    padding: 6px 10px;
}

/* Ajuste de largura para n√£o quebrar o layout */
#tabelaEntradas td:nth-child(3),  /* C√≥digo de Barras */
#tabelaEntradas td:nth-child(6),  /* Data */
#tabelaEntradas td:nth-child(8),  /* Fornecedor */
#tabelaEntradas td:nth-child(9),  /* CNPJ */
#tabelaEntradas td:nth-child(11), /* Validade */
#tabelaEntradas td:nth-child(12)  /* Setor */
{
    max-width: 140px;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* C√≥digo de barras menor ainda */
#tabelaEntradas td:nth-child(3) {
    max-width: 80px;
}
/* Ajuste visual do Estoque Atual */

/* C√≥d. Produto ‚Äì deixar mais estreito */
#tabelaEstoque td:nth-child(2),
#tabelaEstoque th:nth-child(2) {
  width: 65px !important;
  text-align: left !important;
}

/* Produto ‚Äì aumentar largura */
#tabelaEstoque td:nth-child(3),
#tabelaEstoque th:nth-child(3) {
  width: 260px !important;
}

/* Categoria ‚Äì aumentar largura */
#tabelaEstoque td:nth-child(5),
#tabelaEstoque th:nth-child(5) {
  width: 220px !important;
}

/* √öltimo Valor (R$) ‚Äì centralizado */
#tabelaEstoque td:nth-child(8),
#tabelaEstoque th:nth-child(8) {
  text-align: center !important;
  width: 110px !important;
}

/* Status ‚Äì diminuir largura */
#tabelaEstoque td:nth-child(9),
#tabelaEstoque th:nth-child(9) {
  width: 130px !important;
  text-align: center !important;
}



  </style>
</head>
<body>

  <div id="imagemAmpliada" onclick="this.style.display='none'">
    <img src="" alt="Imagem ampliada">
  </div>
  
  <div id="toastMessage" style="background:#0d6efd;"></div>

  <div id="loginView" class="login-container">
    <div class="login-card">
      <h2><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque</h2>
      <input id="usuarioLogin" type="text" placeholder="E-mail de Usu√°rio" />
      <input id="senhaLogin" type="password" placeholder="Senha" />
      <button onclick="fazerLogin()"><i class="fa fa-right-to-bracket"></i> Entrar</button>
	  <p id="loginMsg" style="display:none; color:red; font-weight:bold; text-align:center;"></p>
    <!-- ‚úÖ Marca AtendeTudo no canto inferior direito (Login) -->
    </div> <!-- Fecha .login-card -->
  </div> <!-- Fecha #loginView -->

  <!-- ‚úÖ Marca AtendeTudo no canto inferior direito (Login) -->
  <div id="marcaLogin"
       style="
         position: fixed;
         bottom: 25px;
         right: 30px;
         text-align: center;
         font-family: 'Segoe UI', sans-serif;
         color: white;
         opacity: 0.95;
         line-height: 1.1;
         user-select: none;
         z-index: 9999;
       ">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <div style="font-size: 18px; font-weight: 700;">AtendeTudo</div>
      <div style="font-size: 12px; color: rgba(255,255,255,0.85);">Suprimentos & Servi√ßos</div>
    </div>
  </div>

  <div id="mainApp" style="display:none;">


    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="menuToggle" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <h1><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
  <div id="userName" style="font-weight:700">Visitante</div>
  <div id="perfilBadge" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;font-size:13px;">PERFIL</div>

  <!-- üêû Bot√£o de Erros e Problemas -->
<button id="btnErrosProblemas" class="botao-erro" title="Erros e Problemas" onclick="abrirErrosProblemas()">
  <i class="fa fa-bug"></i>
</button>

  <!-- üö™ Bot√£o Sair -->
  <button onclick="logout()" title="Sair"><i class="fa fa-sign-out-alt"></i></button>
</div>

    </header>

  <aside id="sidebar" aria-hidden="true">

  <button data-section="dashboard" onclick="showSection('dashboard')">
    <i class="fa fa-chart-pie"></i> Dashboard
  </button>

  <button data-section="cadastro" onclick="showSection('cadastro')">
    <i class="fa fa-box"></i> Cadastro de Produtos
  </button>

  <button data-section="entrada" onclick="showSection('entrada')">
    <i class="fa fa-arrow-down"></i> Entrada de Materiais
  </button>

  <button data-section="saida" onclick="showSection('saida')">
    <i class="fa fa-arrow-up"></i> Sa√≠da de Materiais
  </button>

  <button data-section="estoque" onclick="showSection('estoque')">
    <i class="fa fa-warehouse"></i> Estoque Atual
  </button>

  <button data-section="limites" onclick="showSection('limites')">
    <i class="fa fa-sliders-h"></i> Estoque M√≠n/M√°x
  </button>

  <button data-section="valorHistorico" onclick="showSection('valorHistorico')">
    <i class="fa fa-chart-line"></i> Valor Hist√≥rico
  </button>

  <button data-section="financeiro" onclick="showSection('financeiro')">
    <i class="fa fa-coins"></i> Financeiro
  </button>

  <button data-section="relatorios" onclick="showSection('relatorios')">
    <i class="fa fa-file-excel"></i> Relat√≥rios
  </button>

  <button data-section="usuarios" onclick="showSection('usuarios')">
    <i class="fa fa-users"></i> Usu√°rios e Perfis
  </button>

  

</aside>


    <main>
		<section id="boasVindas" class="section active" style="text-align:center; padding:100px 20px;">
		  <h1 style="color:#003b88;">üëã Bem-vindo(a) <span id="nomeUsuarioBemVindo"></span>!</h1>
		  <h2 style="color:#0d6efd;">ao Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h2>
		  <p style="margin-top:20px; color:#555;">Use o menu lateral para iniciar suas atividades.</p>
		</section>
		
<section id="dashboard" class="section">
    <h2>üìä Dashboard do Sistema</h2>
    <div class="dash-container">
        <div class="dash-card">
            <h3>üïí Produtos Pr√≥ximos do Vencimento</h3>
            <ul id="listaProximosVencer"></ul>
        </div>
        <div class="dash-card">
            <h3>üí∞ Produtos Mais Caros</h3>
            <ul id="listaMaisCaros"></ul>
        </div>
        <div class="dash-card">
            <h3>üì¶ Produtos Mais Utilizados</h3>
            <ul id="listaMaisSaidas"></ul>
        </div>
        <div class="dash-card">
            <h3>üí§ Produtos com Menos Sa√≠das</h3>
            <ul id="listaMenosSaidas"></ul>
        </div>

        <div class="dash-card">
            <h3>‚ö†Ô∏è Estoque Cr√≠tico</h3>
            <ul id="listaEstoqueCritico"></ul>
        </div>

        <div class="dash-card">
            <h3>üìà Resumo Geral</h3>
            <div id="resumoGeral"></div>
        </div>
    </div>
</section>


      
 
<!-- SE√á√ÉO: CADASTRO DE PRODUTOS -->
<section id="cadastro" class="section">
  <h2><i class="fa fa-box"></i> Cadastro de Produtos</h2>

  <div class="input-row" style="margin-bottom:10px;gap:8px;">

    <!-- üÜï C√ìDIGO DO PRODUTO (NOVO CAMPO) -->
    <input id="produtoCodigo" type="text" placeholder="C√≥d. Produto" style="width:150px;" />

    <input id="produtoNome" type="text" placeholder="Nome do produto" class="flex" />

    <select id="produtoCategoria">
      <option value="">Selecione a categoria</option>
      <option>Centro Cir√∫rgico</option>
      <option>Cesta paciente</option>
      <option>Componentes</option>
      <option>Copa e Cozinha</option>
      <option>Escrit√≥rio</option>
      <option>Implante </option>
      <option>Insumo Dental</option>
      <option>Insumo Laborat√≥rio</option>
      <option>Material de Uso e Consumo</option>
      <option>Medicamentos</option>
      <option>Material de Limpeza</option>
    </select>

    <select id="produtoEmbalagem">
      <option value="">Selecione o tipo de embalagem</option>
      <option>Caixa</option>
      <option>Fardo</option>
      <option>Frasco</option>
      <option>Garrafa</option>
      <option>Gramas</option>
      <option>Litro</option>
      <option>Pacote</option>
      <option>Pe√ßa</option>
      <option>Quilogramas (KG)</option>
      <option>Saco</option>
      <option>Unidade</option>
      <option>Ampola</option>
    </select>

    <input id="produtoQtdEmbalagem" type="number" placeholder="Qtd por embalagem" style="width:140px" />

    <input id="produtoCodigoBarras" type="text" placeholder="üì∑C√≥digo de Barras (opcional)" style="width:220px" />

    <!-- Bot√£o para foto -->
    <div style="display:flex; flex-direction:column; align-items:flex-start; gap:4px;">
      <div style="display:flex; align-items:center; gap:6px;">
        <label for="produtoFoto" 
               style="background:#007bff; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; display:inline-flex; align-items:center; gap:6px;">
          üì∏ Insira foto do produto
        </label>
        <input id="produtoFoto" type="file" accept="image/*" style="display:none;">
      </div>
      <div id="fotoPreview" style="margin-top:6px; font-size:13px; color:#555; text-align:center;"></div>
    </div>

    <!-- Bot√µes -->
    <button onclick="cadastrarProduto()"><i class="fa fa-save"></i> Cadastrar</button>

    <button onclick="limparCamposProduto()" title="Limpar campos" style="background:#6c757d; color:#fff;">
      <i class="fa fa-broom"></i>
    </button>
  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroProduto" type="text" placeholder="üîç Filtrar por nome ou categoria" style="width:98%" oninput="filtrarProdutos()" />
  </div>

  <div class="table-wrap">
    <table id="tabelaProdutos">
      <thead>
        <tr>
          <th>#</th>
          <th>Foto</th>

          <!-- üÜï C√ìDIGO DO PRODUTO NA NOVA ORDEM -->
          <th>C√≥d. Produto</th>

          <th>Nome</th>
          <th>Categoria</th>
          <th>Embalagem</th>
          <th>Qtd/Emb.</th>
          <th>C√≥d. Barras</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>



     <section id="entrada" class="section">
      <h2><i class="fa fa-arrow-down"></i> Entrada de Materiais</h2>
      <div class="input-row" style="margin-bottom:10px;gap:8px;">
      
        <input id="entradaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" style="min-width:200px;" oninput="buscarProdutoPorCodigo('entrada')" />
        <input id="entradaCodigoProduto" type="text" placeholder="C√≥d. Produto" style="min-width:140px;" oninput="buscarProdutoPorCodigoProduto()" />
        <input id="entradaProduto" type="text" placeholder="Nome do produto" list="listaProdutos" style="min-width:220px" />
        <datalist id="listaProdutos"></datalist>
        
        <input id="entradaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
        <input id="entradaValor" type="number" placeholder="Valor Unit√°rio (R$)" step="0.01" style="width:150px" />
        <input id="entradaData" type="date" style="width:160px" />
        <input id="entradaNota" type="text" placeholder="Nota Fiscal" />
        <input id="entradaFornecedor" type="text" placeholder="Fornecedor" />
        <input 
            id="entradaCNPJ" 
            type="text" 
            placeholder="CNPJ" 
            oninput="formatarCNPJ(this)" 
            maxlength="18"
            style="min-width: 180px;"
        />
        <input id="entradaLote" type="text" placeholder="Lote" />
        <input id="entradaValidade" type="date" placeholder="Validade" />

        <select id="entradaSetor">
          <option value="">Selecione o Setor Utilizado</option>
      <option>Centro Cir√∫rgico</option>
      <option>Cesta paciente</option>
      <option>Componentes</option>
      <option>Copa e Cozinha</option>
      <option>Escrit√≥rio</option>
      <option>Implante </option>
      <option>Insumo Dental</option>
      <option>Insumo Laborat√≥rio</option>
      <option>Material de Uso e Consumo</option>
      <option>Medicamentos</option>
      <option>Material de Limpeza</option>

        </select>

        <button onclick="registrarEntrada()"><i class="fa fa-save"></i> Registrar Entrada</button>
		<!-- üßπ Bot√£o de limpar -->
<button onclick="limparCamposEntrada()" title="Limpar campos" style="background:#6c757d; color:#fff;">
  <i class="fa fa-broom"></i>
</button>

      </div>

      <div style="margin-bottom:10px;">
        <input id="filtroEntrada" type="text" placeholder="üîç Buscar por produto, fornecedor ou NF" style="width:98%" oninput="filtrarEntradas()" />
      </div>

      <div class="table-wrap">
        <table id="tabelaEntradas">
          <thead>
            <tr>
              <th>#</th>
			  <th>C√≥d. Produto</th> 
              <th>Produto</th>
              <th>C√≥d. Barras</th>
              <th>Qtd</th>
              <th>Valor (R$)</th>
              <th>Data</th>
              <th>NF</th>
              <th>Fornecedor</th>
              <th>CNPJ</th>
              <th>Lote</th>
              <th>Validade</th>
              <th>Setor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </section>

     <section id="saida" class="section" style="display:none;">
  <h2><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</h2>

 <div class="input-row" style="margin-bottom:10px;gap:8px;">
        <input id="saidaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" oninput="buscarProdutoPorCodigoSaida()" />
<input id="saidaCodigoProduto" type="text" placeholder="C√≥d. Produto" style="width:150px;" />
           
    <input id="saidaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" oninput="atualizarSetorAutomatico()" />
    <input id="saidaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
    <input id="saidaResponsavel" type="text" placeholder="Respons√°vel" />
    <input id="saidaObservacao" type="text" placeholder="Observa√ß√£o (opcional)" />
    <select id="saidaSetor">
      <option value="">Selecione o Setor</option>
    </select>
    <input id="saidaData" type="date" style="width:160px" />
    <button onclick="registrarSaida()"><i class="fa fa-save"></i> Registrar Sa√≠da</button>
	<!-- üßπ Bot√£o de limpar -->
<button onclick="limparCamposSaida()" 
        title="Limpar campos" 
        style="background:#6c757d; color:#fff; border:none; border-radius:5px; padding:6px 10px; margin-left:10px; cursor:pointer; font-size:14px;">
  <i class="fa fa-broom"></i>
</button>

  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroSaida" type="text" placeholder="üîç Buscar por produto, setor ou respons√°vel" style="width:98%" oninput="filtrarSaidas()" />
  </div>

  <div class="table-wrap">
    <table id="tabelaSaidas">
      <thead>
        <tr>
          <th>#</th>
          <th>Produto</th>
		  <th>C√≥d. Produto</th>
		   <th>C√≥digo de Barras</th>
          <th>Qtd</th>
          <th>Data</th>
          <th>Setor</th>
          <th>Respons√°vel</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
  
  <section id="estoque" class="section">
  <h2><i class="fa fa-warehouse"></i> Estoque Atual</h2>
  <!-- üîπ Resumo de contagem -->
   <div style="margin-bottom:10px;">
    <input id="filtroEstoque" type="text" placeholder="üîç Filtrar por produto ou categoria" style="width:98%" oninput="filtrarEstoque()" />
	<button onclick="limparFiltroEstoque()" title="Limpar filtro" 
    style="background:#0d6efd; color:#fff; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
    <i class="fa fa-broom"></i>
  </button>
   <button onclick="recalcularEstoqueGeral()" title="Recalcular Estoque"
    style="background:#198754; color:#fff; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
    <i class="fa fa-sync-alt"></i>
  </button>
  </div>

  <div class="table-wrap">
    <table id="tabelaEstoque">
      <thead>
        <tr>
          <th>#</th>
		   <th>C√≥d. Produto</th>
          <th>Produto</th>
          <th>C√≥digo de Barras</th>
          <th>Categoria</th>
          <th>Quantidade</th>
          <th>Lote</th>
          <th>√öltimo Valor (R$)</th>
          <th>Validade</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="resumoEstoque" style="margin-top:10px; padding:10px; background:#fff; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);"></div>
</section>

<section id="limites" class="section" style="display:none;">
  <h2><i class="fa fa-boxes"></i> Estoque M√≠nimo e M√°ximo</h2>

  <!-- üìä Resumo correto -->
 <div id="resumoLimites" style="margin-top:10px; font-weight:bold; color:#333;">
  üßæ Total de Produtos: 0 |
  ‚ö†Ô∏è Abaixo do M√≠nimo: 0 |
  ‚úÖ Dentro do Limite: 0 |
  üì¶ Acima do M√°ximo: 0
</div>

  <!-- üîç Filtros -->
  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; align-items:center;">
    <input
      id="filtroLimites"
      type="text"
      placeholder="üîç Buscar por produto"
      style="flex:1; min-width:220px"
      oninput="filtrarLimites()"
    />

    <!-- üßπ Bot√£o de limpar filtro (igual aos outros pain√©is) -->
    <button onclick="limparFiltroLimites()" title="Limpar filtro"
      style="background:#6c757d; color:#fff;">
      <i class="fa fa-broom"></i>
    </button>

    <select id="filtroCategoria" onchange="atualizarTabelaLimites()" style="min-width:220px;">
      <option value="">Todas as Categorias</option>
      <option>Centro Cir√∫rgico</option>
      <option>Cesta paciente</option>
      <option>Componentes</option>
      <option>Copa e Cozinha</option>
      <option>Escrit√≥rio</option>
      <option>Implante </option>
      <option>Insumo Dental</option>
      <option>Insumo Laborat√≥rio</option>
      <option>Material de Uso e Consumo</option>
      <option>Medicamentos</option>
      <option>Material de Limpeza</option>

    </select>

    <button onclick="gerarListaCompra()">
      <i class="fa fa-list"></i> Gerar Lista de Compra
    </button>

    <button onclick="limparListaCompra()">
      <i class="fa fa-trash"></i> Limpar Lista
    </button>
  </div>

  <!-- üìã Tabela principal -->
  <div class="table-wrap">
    <table id="tabelaLimites">
      <thead>
        <tr>
          <th>#</th>
		  <th>C√≥d. Produto</th>
          <th>Produto</th>
          <th>C√≥digo de Barras</th>
          <th>Categoria</th>
          <th>Qtd Atual</th>
          <th>M√≠nimo</th>
          <th>M√°ximo</th>
          <th>Status</th>
          <th>Recomenda√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- üõí Lista de compra -->
  <div id="listaCompraContainer" style="display:none; margin-top:20px;">
    <h3><i class="fa fa-shopping-cart"></i> Lista de Compra Gerada</h3>
    <div class="table-wrap" style="max-height:400px; overflow-y:auto; overflow-x:auto;">
     <table id="tabelaListaCompra">
  <thead>
    <tr>
      <th>#</th>
      <th>Produto</th>
      <th>C√≥d. Barras</th>
      <th>Categoria</th>
      <th>Qtd Atual</th>
      <th>Recomenda√ß√£o</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="5" style="text-align:right; font-weight:bold;">Total de Itens:</td>
      <td id="totalItensCompra" style="font-weight:bold;">0</td>
    </tr>
  </tfoot>
</table>

    </div>

    <!-- ‚öôÔ∏è Bot√µes de a√ß√£o -->
    <div style="margin-top:10px;">
      <button onclick="exportarListaExcel()">
        <i class="fa fa-file-excel"></i> Exportar para Excel
      </button>
      <button onclick="gerarPedidoPDF()">
        <i class="fa fa-file-pdf"></i> Gerar Pedido de Or√ßamento (PDF)
      </button>
    </div>
  </div>
</section>

<!-- üìä NOVA SE√á√ÉO: VALOR HIST√ìRICO -->
<section id="valorHistorico" class="section" style="display:none;">
  <h2><i class="fa fa-chart-line"></i> Valor Hist√≥rico de Produtos</h2>


  <p style="color:#555; margin-bottom:10px;">
    Acompanhe aqui a evolu√ß√£o dos valores de entrada m√™s a m√™s para cada produto. As setas indicam a varia√ß√£o de pre√ßo.
  </p>
<!-- üîπ Filtro -->
<div style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
  <input
    id="filtroValorHistorico"
    type="text"
    placeholder="üîç Buscar produto..."
    style="flex:1; max-width:400px;"
    oninput="filtrarValorHistorico()"
  />
  <button onclick="limparFiltroValorHistorico()" title="Limpar filtro" style="background:#6c757d; color:#fff;">
    <i class="fa fa-broom"></i>
  </button>
</div>

<div class="table-wrap">
  <div class="table-wrap">
    <table id="tabelaValorHistorico">
      <thead>
        <tr>
		 <th style="width:40px; text-align:center;">#</th>
		<th>C√≥d. Produto</th>
          <th>Produto</th>		   
          <th>Jan</th>
          <th>Fev</th>
          <th>Mar</th>
          <th>Abr</th>
          <th>Mai</th>
          <th>Jun</th>
          <th>Jul</th>
          <th>Ago</th>
          <th>Set</th>
          <th>Out</th>
          <th>Nov</th>
          <th>Dez</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>


    
    <section id="financeiro" class="section" style="display:none;">
  <h2><i class="fa fa-chart-line"></i> Painel Financeiro</h2>

  <!-- üî∏ Indicadores financeiros detalhados -->
  <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;">

    <!-- √öltimo valor de entrada -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ √öltimo Valor de Entrada</h3>
      <p id="valorUltimaEntrada" style="font-size:1.4em; font-weight:bold; color:#007bff;">R$ 0,00</p>
    </div>

    <!-- Custo m√©dio ponderado -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üìä Custo M√©dio Ponderado</h3>
      <p id="valorCustoMedio" style="font-size:1.4em; font-weight:bold; color:#6f42c1;">R$ 0,00</p>
    </div>

    <!-- Valor total do estoque atual -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üì¶ Valor Total do Estoque Atual</h3>
      <p id="valorEstoqueAtualPainel" style="font-size:1.4em; font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>
  </div>

  <!-- üî∏ Indicadores principais existentes -->
  <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ Valor Total do Estoque Atual (Cont√°bil)</h3>
      <p id="valorEstoque" style="font-size:1.4em; font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>

    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∏ Valor Total das Sa√≠das (Estimado)</h3>
      <p id="valorSaidas" style="font-size:1.4em; font-weight:bold; color:#dc3545;">R$ 0,00</p>
    </div>
  </div>

  <!-- üî∏ Entradas agrupadas -->
  <h3 style="margin-top:25px;"><i class="fa fa-file-invoice"></i> Entradas Agrupadas por Nota Fiscal</h3>
  <div class="table-wrap">
    <table id="tabelaFinanceiro">
      <thead>
        <tr>
          <th>Fornecedor</th>
          <th>Nota Fiscal</th>
          <th>Valor Total da Nota (R$)</th>
          <th>Saldo da Nota (R$)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
    
    <section id="relatorios" class="section">
      <h2><i class="fa fa-file-excel"></i> Gera√ß√£o de Relat√≥rios</h2>
      
      <div class="input-row">
        <label for="dataInicioRelatorio">De:</label>
        <input type="date" id="dataInicioRelatorio" style="width:150px;" />
        <label for="dataFimRelatorio">At√©:</label>
        <input type="date" id="dataFimRelatorio" style="width:150px;" />
        <button onclick="definirPeriodoRapido('7dias')">√öltimos 7 dias</button>
        <button onclick="definirPeriodoRapido('30dias')">√öltimos 30 dias</button>
        <button onclick="definirPeriodoRapido('mes')">M√™s Atual</button>
        <button onclick="limparPeriodo()">Limpar</button>
      </div>

      <div class="input-row" style="margin-top:10px;">
        <button onclick="exportarTabelaExcel('tabelaEntradas', 'Entradas', 'Entradas_')" style="background:#28a745;">
          <i class="fa fa-file-excel"></i> Exportar Entradas
        </button>
        <button onclick="exportarTabelaExcel('tabelaSaidas', 'Sa√≠das', 'Saidas_')" style="background:#dc3545;">
          <i class="fa fa-file-excel"></i> Exportar Sa√≠das
        </button>
        <button onclick="exportarTabelaExcel('tabelaEstoque', 'Estoque', 'Estoque_')" style="background:#0d6efd;">
          <i class="fa fa-file-excel"></i> Exportar Estoque Atual
        </button>
        <button onclick="exportarTabelaExcel('tabelaFinanceiro', 'Financeiro', 'Financeiro_')" style="background:#ffc107;">
          <i class="fa fa-file-excel"></i> Exportar Financeiro
        </button>
      </div>

      <div style="background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-top:20px;">
        <p>Os relat√≥rios em Excel (.csv) consideram o per√≠odo de data selecionado para Entradas e Sa√≠das. Os relat√≥rios de Estoque e Financeiro consideram o estado atual.</p>
      </div>
    </section>
    
	
   <section id="usuarios" class="section" style="display:none;">
  <h2><i class="fa fa-users"></i> Gerenciar Usu√°rios e Perfis</h2>
  <p style="color:#555; font-size:14px;">
    ‚ö†Ô∏è <b>Funcionalidade Firebase:</b> A cria√ß√£o e autentica√ß√£o de e-mails/senhas s√£o feitas diretamente no Firebase.
    Aqui voc√™ gerencia apenas perfis e metadados locais.
  </p>

  <!-- üßç Cadastro / Edi√ß√£o -->
  <div class="input-row" style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
    <input id="usuarioNome" type="text" placeholder="Nome Completo" class="flex" />
    <input id="usuarioEmail" type="email" placeholder="E-mail (ID do Firebase)" class="flex" />
    <input id="usuarioSenha" type="password" placeholder="Definir Senha (m√≠n. 6 caracteres)" class="flex" style="min-width:200px;" />
    
    <select id="usuarioPerfil" style="width:200px;">
      <option value="">Selecione o Perfil</option>
      <option>ADMIN</option>
      <option>GERENCIA</option>
      <option>ESTOQUISTA</option>
    </select>

    <button onclick="salvarUsuarioLocal()" style="background:#198754; color:#fff;">
      <i class="fa fa-user-plus"></i> Salvar / Atualizar Perfil
    </button>
  </div>

  <!-- üîç Campo de busca + bot√£o üßπ -->
  <div style="display:flex; align-items:center; gap:8px; margin-top:10px; margin-bottom:10px;">
    <input
      id="filtroUsuarios"
      type="text"
      placeholder="üîç Buscar por nome ou e-mail"
      oninput="filtrarUsuarios()"
      style="flex:1; min-width:250px;"
    />
    <button onclick="limparFiltroUsuarios()" title="Limpar filtro"
      style="background:#6c757d; color:#fff;">
      <i class="fa fa-broom"></i>
    </button>
  </div>

  <!-- üìã Tabela de usu√°rios -->
  <div class="table-wrap">
    <table id="tabelaUsuarios">
      <thead>
        <tr>
          <th>#</th>
          <th>Nome</th>
          <th>E-mail</th>
          <th>Perfil</th>
          <th>UID</th>
          <th>Data</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="errosProblemas" class="section" style="display:none;">
  <h2><i class="fa fa-bug"></i> Registro de Melhorias, Erros ou Problemas</h2>

  <!-- üî∏ Formul√°rio de novo relato -->
  <div class="input-row" style="margin-bottom:10px; gap:8px; flex-wrap:wrap;">
    <input id="erroData" type="date" style="width:160px;" readonly />
    <input id="erroTitulo" type="text" placeholder="T√≠tulo do Erro ou Problema" style="flex:1; min-width:300px;" />

    <select id="erroSituacao" style="min-width:180px;">
      <option value="">Selecione a Situa√ß√£o</option>
      <option>üî¥ Emerg√™ncia</option>
      <option>üü† Muito Urgente</option>
      <option>üü° Urgente</option>
      <option>üü¢ Pouco Urgente</option>
      <option>üîµ N√£o Urgente</option>
    </select>

    <input id="erroPrevisao" type="date" placeholder="Previs√£o de Conclus√£o" style="width:180px;" />

    <button onclick="registrarErro()" style="background:#0d6efd; color:#fff;">
      <i class="fa fa-save"></i> Registrar Erro
    </button>
  </div>

  <textarea
  id="erroDescricao"
  placeholder="Relate aqui qualquer erro, falha ou ideia para aprimorar o sistema ‚ú®"
  rows="3"
  style="width:98%; margin-bottom:10px; border-radius:6px; padding:8px;"
></textarea>


  <!-- üîπ Filtro -->
  <div style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
    <input
      id="filtroErros"
      type="text"
      placeholder="üîç Buscar por t√≠tulo, situa√ß√£o ou parecer"
      style="flex:1;"
      oninput="filtrarErros()"
    />
    <button onclick="limparFiltroErros()" title="Limpar filtro" style="background:#6c757d; color:#fff;">
      <i class="fa fa-broom"></i>
    </button>
  </div>

  <!-- üî∏ Tabela de Erros -->
  <div class="table-wrap">
    <table id="tabelaErros">
      <thead>
        <tr>
          <th>#</th>
          <th>Data</th>
          <th>T√≠tulo</th>
          <th>Situa√ß√£o</th>
          <th>Descri√ß√£o</th>
          <th>Previs√£o</th>
          <th>Parecer</th>
          <th>Dt Concl.</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>



<!-- === üî• FIREBASE LOGIN E SINCRONIZA√á√ÉO === -->
<script type="module" defer>
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

  import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    onSnapshot,
    collection,     // üëà ADICIONADO
    getDocs,        // üëà ADICIONADO
	deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // üîê Configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCxhDaVIiLuNCagXOkyOSYC0El8KzbGfDw",
    authDomain: "oralunicestoque.firebaseapp.com",
    projectId: "oralunicestoque",
    storageBucket: "oralunicestoque.appspot.com",
    messagingSenderId: "660233908877",
    appId: "1:660233908877:web:2a6c9cd10b056b41bde8c4"
  };

  // üöÄ Inicializa Firebase e Firestore
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // üîπ Torna acess√≠vel globalmente para fun√ß√µes fora do m√≥dulo
  window.db = db;
  window.auth = auth;
  window.doc = doc;
  window.setDoc = setDoc;
  window.getDoc = getDoc;
  window.onSnapshot = onSnapshot;
  window.collection = collection;   // üëà ADICIONADO
  window.getDocs = getDocs;         // üëà ADICIONADO
  window.deleteDoc = deleteDoc;

  const estoqueRef = doc(db, "estoqueGlobal", "estoque");
  const usuariosRef = doc(db, "estoqueGlobal", "usuarios");
// ================================
// carregarProdutosMesclados()
// Busca produtos do documento antigo + da subcollection e mescla sem duplicar
// ================================
async function carregarProdutosMesclados() {
  try {
    const estoqueRefLocal = doc(db, "estoqueGlobal", "estoque");

    // 1) produtos do documento antigo
    let produtosDoDoc = [];
    try {
      const snapDoc = await getDoc(estoqueRefLocal);
      if (snapDoc.exists()) {
        const data = snapDoc.data() || {};
        produtosDoDoc = Array.isArray(data.produtos) ? data.produtos.map(p => ({ ...p })) : [];
      }
    } catch (e) {
      console.warn("Falha ao ler produtos do documento antigo:", e);
    }

    // 2) produtos da subcollection (novos)
    let produtosDaCol = [];
    try {
      const colRef = collection(estoqueRefLocal, "produtos");
      const snapCol = await getDocs(colRef);
      produtosDaCol = snapCol.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (e) {
      console.warn("Falha ao ler produtos da subcollection:", e);
    }

    // 3) mesclar (prioriza docs da collection)
    const mapa = new Map();
    produtosDaCol.forEach(p => {
      mapa.set(String(p.id || p.codigo || p.nome).toLowerCase(), p);
    });
    produtosDoDoc.forEach(p => {
      const chave = String(p.id || p.codigo || p.nome || "").toLowerCase();
      if (!mapa.has(chave)) {
        const id = String(p.id || Date.now() + Math.floor(Math.random() * 10000));
        mapa.set(chave, { ...p, id });
      }
    });

    window.produtos = Array.from(mapa.values());

    // salva e atualiza UI
    if (typeof salvarTodosLocal === "function") salvarTodosLocal();
    if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
    console.log("‚úÖ carregarProdutosMesclados: produtos carregados =", window.produtos.length);
    return window.produtos;
  } catch (err) {
    console.error("Erro em carregarProdutosMesclados:", err);
    return [];
  }
}

// ===================================================
// üîê LOGIN E AUTENTICA√á√ÉO (100% COMPAT√çVEL COM SEU SCRIPT)
// ===================================================

// === FUN√á√ÉO DE LOGIN (garante que est√° sempre definida) ===
window.fazerLogin = async function () {
  const usuarioEl = document.getElementById("usuarioLogin");
  const senhaEl = document.getElementById("senhaLogin");
  const msgEl = document.getElementById("loginMsg");

  if (msgEl) { msgEl.style.display = "none"; msgEl.textContent = ""; }

  const usuario = usuarioEl?.value?.trim() || "";
  const senha = senhaEl?.value?.trim() || "";

  if (!usuario || !senha) {
    if (msgEl) { msgEl.style.display = "block"; msgEl.style.color = "red"; msgEl.textContent = "‚ö†Ô∏è Preencha e-mail e senha!"; }
    return;
  }

  const email = usuario.toLowerCase();

  try {
    // signInWithEmailAndPassword deve existir (importado)
    const userCredential = await signInWithEmailAndPassword(auth, email, senha);
    const user = userCredential.user;
    if (msgEl) { msgEl.style.display = "block"; msgEl.style.color = "green"; msgEl.textContent = "‚úÖ Login realizado com sucesso!"; }
    console.log("‚úÖ Usu√°rio logado:", user.email);

    if (typeof mostrarSistema === "function") mostrarSistema(user);
  } catch (error) {
    console.error("‚ùå Erro ao logar:", error);
    if (msgEl) { msgEl.style.display = "block"; msgEl.style.color = "red"; }
    const code = error?.code || "";
    if (msgEl) {
      if (code === "auth/wrong-password" || code === "auth/invalid-credential") msgEl.textContent = "‚ùå Senha incorreta ou inv√°lida!";
      else if (code === "auth/user-not-found") msgEl.textContent = "‚ùå Usu√°rio n√£o encontrado!";
      else if (code === "auth/too-many-requests") msgEl.textContent = "‚ö†Ô∏è Muitas tentativas. Tente mais tarde.";
      else msgEl.textContent = "‚ùå Erro ao fazer login.";
    }
  }
};



// üîπ Permite login com tecla Enter
document.addEventListener("DOMContentLoaded", () => {
  const usuarioEl = document.getElementById("usuarioLogin");
  const senhaEl = document.getElementById("senhaLogin");

  [usuarioEl, senhaEl].forEach(el => {
    if (!el) return;
    el.addEventListener("keypress", event => {
      if (event.key === "Enter") {
        event.preventDefault();
        if (typeof window.fazerLogin === "function") {
          window.fazerLogin();
        }
      }
    });
  });
});


// ============================================================
// üî• FIRESTORE ‚Äì SALVAMENTO ESCAL√ÅVEL E OTIMIZADO
// ============================================================

// üß© Salvar produtos individualmente na subcole√ß√£o
window.salvarProdutosNoFirebase = async function(listaDeProdutos) {
  try {
    if (!Array.isArray(listaDeProdutos)) return;

    const estoqueRef = doc(db, "estoqueGlobal", "estoque");
    const produtosCol = collection(estoqueRef, "produtos");

    for (const p of listaDeProdutos) {
      const id = String(p.id || Date.now() + Math.floor(Math.random() * 10000));
      p.id = id; // garante id
      const docRef = doc(produtosCol, id);
      await setDoc(docRef, p, { merge: true });
    }

    console.log("‚úÖ Produtos salvos individualmente na cole√ß√£o estoque/produtos");
  } catch (e) {
    console.error("‚ùå Erro ao salvar produtos individualmente:", e);
  }
};

// üß© Salvar entradas na subcole√ß√£o
window.salvarEntradasNoFirebase = async function(listaDeEntradas) {
  try {
    if (!Array.isArray(listaDeEntradas)) return;

    const entradasRef = collection(db, "estoqueGlobal", "estoque", "entradas");
    for (const e of listaDeEntradas) {
      const id = String(e.id || Date.now() + Math.floor(Math.random() * 10000));
      e.id = id;
      await setDoc(doc(entradasRef, id), e, { merge: true });
    }

    console.log("‚úÖ Entradas salvas na cole√ß√£o estoque/entradas");
  } catch (e) {
    console.error("‚ùå Erro ao salvar entradas no Firestore:", e);
  }
};

// üß© Salvar sa√≠das na subcole√ß√£o
window.salvarSaidasNoFirebase = async function(listaDeSaidas) {
  try {
    if (!Array.isArray(listaDeSaidas)) return;

    const saidasRef = collection(db, "estoqueGlobal", "estoque", "saidas");
    for (const s of listaDeSaidas) {
      const id = String(s.id || Date.now() + Math.floor(Math.random() * 10000));
      s.id = id;
      await setDoc(doc(saidasRef, id), s, { merge: true });
    }

    console.log("‚úÖ Sa√≠das salvas na cole√ß√£o estoque/saidas");
  } catch (e) {
    console.error("‚ùå Erro ao salvar sa√≠das no Firestore:", e);
  }
};

// üß© Salvar erros e problemas na subcole√ß√£o
window.salvarErrosProblemasNoFirebase = async function(listaDeErros) {
  try {
    if (!Array.isArray(listaDeErros)) return;

    const errosRef = collection(db, "estoqueGlobal", "estoque", "errosProblemas");
    for (const err of listaDeErros) {
      const id = String(err.id || Date.now() + Math.floor(Math.random() * 10000));
      err.id = id;
      await setDoc(doc(errosRef, id), err, { merge: true });
    }

    console.log("‚úÖ Erros/Problemas salvos na cole√ß√£o estoque/errosProblemas");
  } catch (e) {
    console.error("‚ùå Erro ao salvar errosProblemas no Firestore:", e);
  }
};

// üß© Salvar usu√°rios (documento separado)
window.salvarUsuariosNoFirebase = async function(listaDeUsuarios) {
  try {
    const docRef = doc(db, "estoqueGlobal", "usuarios");
    await setDoc(docRef, { usuarios: listaDeUsuarios }, { merge: true });
    console.log("‚úÖ Usu√°rios salvos no documento estoqueGlobal/usuarios");
  } catch (e) {
    console.error("‚ùå Erro ao salvar usu√°rios no Firestore:", e);
  }
};

// üß© Atualizar o documento principal com resumo leve
window.salvarResumoDoEstoque = async function() {
  try {
    const docRef = doc(db, "estoqueGlobal", "estoque");
    await setDoc(docRef, {
      resumo: {
        totalProdutos: (window.produtos || []).length,
        totalEntradas: (window.entradas || []).length,
        totalSaidas: (window.saidas || []).length,
        ultimaAtualizacao: new Date().toISOString()
      },
      limites: window.limites || [],
      usuarios: window.usuarios || []
    }, { merge: true });

    console.log("üìÑ Documento principal 'estoque' atualizado (leve e resumido).");
  } catch (e) {
    console.error("‚ùå Erro ao atualizar documento principal:", e);
  }
};

// ============================================================
// üß© Garante arrays v√°lidos
// ============================================================
if (!Array.isArray(window.produtos)) window.produtos = [];
if (!Array.isArray(window.entradas)) window.entradas = [];
if (!Array.isArray(window.saidas)) window.saidas = [];
if (!Array.isArray(window.usuarios)) window.usuarios = [];

console.log("üì¶ Dados carregados do localStorage:", {
  produtos: window.produtos.length,
  entradas: window.entradas.length,
  saidas: window.saidas.length,
  usuarios: window.usuarios.length
});

// ============================================================
// üë• Permiss√µes (sem altera√ß√µes)
// ============================================================
window.PERMISSOES = {
  "ADMIN": { canView: ["boasVindas","dashboard","cadastro","entrada","saida","estoque","limites","valorHistorico","financeiro","relatorios","usuarios","errosProblemas"] },
  "GERENCIA": { canView: ["boasVindas","dashboard","cadastro","entrada","saida","estoque","limites","valorHistorico","financeiro","relatorios","errosProblemas"] },
  "ESTOQUISTA": { canView: ["boasVindas","cadastro","entrada","saida","estoque","limites","valorHistorico","relatorios"] }
};





// -----------------------------
// Salvar tudo no localStorage (idempotente)
// -----------------------------
function salvarTodosLocal() {
  try {
    // üîπ Cria uma c√≥pia leve dos dados (amostra, n√£o o banco inteiro)
    const dadosSistema = {
      produtos: (window.produtos || []).slice(0, 20),
      entradas: (window.entradas || []).slice(0, 10),
      saidas: (window.saidas || []).slice(0, 10),
      usuarios: (window.usuarios || []).slice(0, 5),
      limites: window.limites || [],
      errosProblemas: (window.errosProblemas || []).slice(0, 5)
    };

    localStorage.setItem("dadosSistema", JSON.stringify(dadosSistema));

    console.log("üíæ Cache local leve salvo:", {
      produtos: dadosSistema.produtos.length,
      entradas: dadosSistema.entradas.length,
      saidas: dadosSistema.saidas.length,
      usuarios: dadosSistema.usuarios.length,
      errosProblemas: dadosSistema.errosProblemas.length
    });
  } catch (e) {
    console.warn("‚ö†Ô∏è Cache local ignorado (QuotaExceededError prevenido):", e);
  }
}
window.salvarTodosLocal = salvarTodosLocal;


// -----------------------------
// Carregar dados do localStorage (√∫nico, idempotente)
// -----------------------------
function carregarTodosLocal() {
  try {
    const dadosLocais = JSON.parse(localStorage.getItem("dadosSistema") || "{}");
    window.produtos = Array.isArray(dadosLocais.produtos) ? dadosLocais.produtos : (window.produtos || []);
    window.entradas = Array.isArray(dadosLocais.entradas) ? dadosLocais.entradas : (window.entradas || []);
    window.saidas = Array.isArray(dadosLocais.saidas) ? dadosLocais.saidas : (window.saidas || []);
    window.limites = Array.isArray(dadosLocais.limites) ? dadosLocais.limites : (window.limites || []);
    window.usuarios = Array.isArray(dadosLocais.usuarios) ? dadosLocais.usuarios : (window.usuarios || []);
    window.errosProblemas = Array.isArray(dadosLocais.errosProblemas) ? dadosLocais.errosProblemas : (window.errosProblemas || []);

    console.log("üì¶ Dados locais restaurados. Produtos:", window.produtos.length, "Erros:", window.errosProblemas.length);
  } catch (e) {
    console.error("‚ùå Erro ao carregar dados locais:", e);
    window.produtos = window.produtos || [];
    window.entradas = window.entradas || [];
    window.saidas = window.saidas || [];
    window.limites = window.limites || [];
    window.usuarios = window.usuarios || [];
    window.errosProblemas = window.errosProblemas || [];
  }
}
carregarTodosLocal(); // chame uma vez na inicializa√ß√£o


// ‚úÖ Torna a fun√ß√£o acess√≠vel globalmente
window.salvarTodosLocal = salvarTodosLocal;


// ===================================================
// üåê CARREGAMENTO E SINCRONIZA√á√ÉO EM TEMPO REAL (VERS√ÉO FINAL)
// ===================================================
async function carregarDadosDoFirestore() {
  console.log("üîÑ Iniciando carregamento e sincroniza√ß√£o do Firestore...");

  try {
    const estoqueRef = doc(db, "estoqueGlobal", "estoque");

    // ======== 1Ô∏è‚É£ Escuta o documento principal (dados gerais) ========
    onSnapshot(estoqueRef, async (docSnap) => {
      try {
        if (!docSnap.exists()) {
          await setDoc(estoqueRef, {
            resumo: {},
            limites: [],
            usuarios: []
          }, { merge: true });

          console.log("üìÑ Documento 'estoque' criado (inicial).");
          return;
        }

        if (window.bloquearAtualizacaoSnapshot) {
          console.log("‚è∏Ô∏è Snapshot ignorado (bloqueio ativo).");
          return;
        }

        const data = docSnap.data() || {};

        // üîπ Atualiza dados gerais (que ficam no documento)
        window.limites = Array.isArray(data.limites) ? data.limites : [];
        window.resumo = data.resumo || {};

        // üîπ Atualiza cache local (somente dados leves)
        salvarTodosLocal?.();

        // üîπ Atualiza interface leve
        atualizarTabelaLimites?.();
        atualizarTabelaUsuarios?.();
        atualizarDashboard?.();
        atualizarPainelFinanceiro?.();

        console.log("‚úÖ Documento principal sincronizado com sucesso.");
      } catch (err) {
        console.error("‚ùå Erro no snapshot do documento principal:", err);
      }
    });

    // ======== 2Ô∏è‚É£ Escuta a subcole√ß√£o de produtos em tempo real ========
    const produtosCol = collection(estoqueRef, "produtos");
    onSnapshot(produtosCol, (snap) => {
      try {
        window.produtos = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        salvarTodosLocal?.();
        atualizarTabelaProdutos?.();
        atualizarTabelaEstoque?.();
        atualizarDashboard?.();
        atualizarPainelFinanceiro?.();

        console.log(`üî• Produtos sincronizados em tempo real: ${window.produtos.length}`);
      } catch (err) {
        console.error("‚ùå Erro ao processar produtos:", err);
      }
    });

    // ======== 3Ô∏è‚É£ Escuta subcole√ß√µes de entradas, sa√≠das e erros ========
    const escutarColecao = (nome, destino, atualizarFn) => {
      onSnapshot(collection(estoqueRef, nome), (snap) => {
        try {
          window[destino] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          salvarTodosLocal?.();
          atualizarFn?.();
          console.log(`üì¶ ${nome} sincronizados (${window[destino].length})`);
        } catch (e) {
          console.error(`‚ùå Erro ao sincronizar ${nome}:`, e);
        }
      });
    };

    escutarColecao("entradas", "entradas", atualizarTabelaEntradas);
    escutarColecao("saidas", "saidas", atualizarTabelaSaidas);
    escutarColecao("errosProblemas", "errosProblemas", atualizarTabelaErros);

    console.log("üü¢ Escutas em tempo real configuradas com sucesso.");

  } catch (erro) {
    console.error("‚ùå Erro ao iniciar sincroniza√ß√£o:", erro);
    mostrarMensagem?.("Erro ao conectar ao Firestore!", "erro");
  }
}




// ============================================================
// üîÅ SINCRONIZA√á√ÉO SEM PERMITIR PERFIL ‚ÄúUSUARIO‚Äù
// ============================================================
async function sincronizarUsuariosDoAuth() {
  try {
    if (!auth || !db) return;

    const userAtual = auth.currentUser;
    if (!userAtual) return;

    if (!Array.isArray(window.usuarios)) window.usuarios = [];

    // 1) PROCURA LOCAL
    let usuarioLocal = window.usuarios.find(
      u => u.email?.toLowerCase() === userAtual.email?.toLowerCase()
    );

    if (usuarioLocal) {
      console.log("‚úî Usu√°rio encontrado localmente com perfil:", usuarioLocal.perfil);
      return; // N√ÉO ALTERA PERFIL
    }

    // 2) PROCURA NO FIRESTORE
    let usuariosFS = [];
    try {
      const docSnap = await getDoc(doc(db, "estoqueGlobal", "usuarios"));
      if (docSnap.exists()) usuariosFS = docSnap.data().usuarios || [];
    } catch (e) {}

    let usuarioFS = usuariosFS.find(
      u => u.email?.toLowerCase() === userAtual.email?.toLowerCase()
    );

    if (usuarioFS) {
      console.log("‚úî Encontrado no Firestore com perfil:", usuarioFS.perfil);
      window.usuarios.push(usuarioFS);
      salvarTodosLocal?.();
      return;
    }

    // 3) SE N√ÉO EXISTE EM NENHUM LUGAR ‚Üí CRIAR SEM PERFIL
    const novo = {
      uid: userAtual.uid,
      nome: userAtual.displayName || userAtual.email.split("@")[0],
      email: userAtual.email,
      perfil: "", // üî• nunca colocar "USUARIO"
      criadoEm: new Date().toISOString()
    };

    console.warn("‚ö† Usu√°rio criado sem perfil. Defina no Gerenciar Usu√°rios:", novo.email);

    window.usuarios.push(novo);
    salvarTodosLocal?.();

  } catch (e) {
    console.error("Erro na sincroniza√ß√£o:", e);
  }
}












// === CRIA√á√ÉO DE USU√ÅRIO (FIREBASE AUTH) ===

¬† window.criarUsuarioNoFirebase = async function(email, senha) {
¬† ¬† if (!auth.currentUser) {
¬† ¬† ¬† ¬† mostrarMensagem("Apenas usu√°rios logados podem criar novas contas.", "erro");
¬† ¬† ¬† ¬† return false;
¬† ¬† }
¬† ¬†¬†
¬† ¬† try {
¬† ¬† ¬† ¬† const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
¬† ¬† ¬† ¬† return userCredential.user;
¬† ¬† } catch (error) { 
¬† ¬† ¬† ¬† let msg = "Erro ao criar usu√°rio: " + error.code;
¬† ¬† ¬† ¬† if (error.code === 'auth/weak-password') {
¬† ¬† ¬† ¬† ¬† ¬† msg = "A senha deve ter pelo menos 6 caracteres.";
¬† ¬† ¬† ¬† } else if (error.code === 'auth/email-already-in-use') {
¬† ¬† ¬† ¬† ¬† ¬† msg = "O e-mail j√° est√° em uso por outra conta.";
¬† ¬† ¬† ¬† } else if (error.code === 'auth/invalid-email') {
¬† ¬† ¬† ¬† ¬† ¬† msg = "E-mail inv√°lido.";
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† mostrarMensagem(msg, "erro");
¬† ¬† ¬† ¬† console.error("Erro ao criar usu√°rio:", error.code, error.message);
¬† ¬† ¬† ¬† return false;
¬† ¬† }
¬† } 




// =================================================================================
// === FUN√á√ÉO CORRIGIDA: SALVAR / ATUALIZAR USU√ÅRIO (sem deslogar o admin atual) ===
// =================================================================================

window.salvarUsuarioLocal = async function() {
  // üö® PASSO 1: Guarda o contexto atual do administrador logado
  const adminUser = auth.currentUser;
  const adminEmailLogado = adminUser ? adminUser.email.toLowerCase() : null;

  // 1Ô∏è‚É£ Coleta e valida√ß√£o dos campos
  const nomeEl = document.getElementById("usuarioNome");
  const emailEl = document.getElementById("usuarioEmail");
  const senhaEl = document.getElementById("usuarioSenha");
  const perfilEl = document.getElementById("usuarioPerfil");

  if (!nomeEl.value.trim()) return mostrarMensagem("Informe o nome completo!", "erro");
  if (!emailEl.value.trim().includes("@")) return mostrarMensagem("Informe um e-mail v√°lido!", "erro");
  if (!perfilEl.value.trim()) return mostrarMensagem("Selecione o perfil do usu√°rio!", "erro");

  const nome = nomeEl.value.trim();
  const email = emailEl.value.trim().toLowerCase();
  const senha = senhaEl.value.trim();
  const perfil = perfilEl.value.trim();

  const index = window.usuarios.findIndex(u => u.email.toLowerCase() === email);
  const isNovoUsuario = index === -1;

  try {
    if (isNovoUsuario) {
      if (!senha || senha.length < 6) {
        return mostrarMensagem("A senha √© obrigat√≥ria (m√≠n. 6 caracteres) para um novo usu√°rio.", "erro");
      }

      // ‚úÖ Guarda o admin atual antes da cria√ß√£o
      const userBefore = auth.currentUser;

      // Cria o novo usu√°rio no Firebase Auth (isso faz login autom√°tico)
      const firebaseUser = await window.criarUsuarioNoFirebase(email, senha);

      if (!firebaseUser) {
        mostrarMensagem("Falha ao criar o usu√°rio no Firebase.", "erro");
        return;
      }

      // üîÅ Reautentica o admin original imediatamente ap√≥s criar o novo usu√°rio
      if (userBefore) {
        await auth.updateCurrentUser(userBefore);
      }

      // Adiciona o novo usu√°rio √† lista local
      const novoUsuarioPerfil = {
        uid: firebaseUser.uid,
        email,
        nome,
        perfil,
        criadoEm: new Date().toISOString(),
      };

      window.usuarios.push(novoUsuarioPerfil);

      mostrarMensagem(`‚úÖ Usu√°rio "${nome}" criado no Firebase Auth e perfil salvo!`, "sucesso");
    } else {
      // ‚úèÔ∏è Atualiza perfil existente
      window.usuarios[index].nome = nome;
      window.usuarios[index].perfil = perfil;
      if (senha) {
        mostrarMensagem("‚ö†Ô∏è Senha n√£o pode ser alterada aqui. Use o painel do Firebase.", "info");
      } else {
        mostrarMensagem(`‚úèÔ∏è Perfil de "${nome}" atualizado com sucesso!`, "sucesso");
      }
    }

    // üßπ Remove duplicatas
    const uidsUnicos = new Set();
    window.usuarios = window.usuarios.filter(u => {
      if (uidsUnicos.has(u.uid)) return false;
      uidsUnicos.add(u.uid);
      return true;
    });

    // üíæ Salva local e envia para o Firestore
    if (typeof salvarTodosLocal === "function") salvarTodosLocal();
    if (typeof window.salvarUsuariosNoFirebase === "function") {
      await window.salvarUsuariosNoFirebase(window.usuarios);
    }

    // üîÑ Mant√©m o admin original autenticado
    if (adminUser && auth.currentUser?.uid !== adminUser.uid) {
      await auth.updateCurrentUser(adminUser);
    }

    // üîÅ Atualiza tabela e limpa campos
    if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();

    nomeEl.value = "";
    emailEl.value = "";
    senhaEl.value = "";
    perfilEl.value = "";

  } catch (e) {
    console.error("‚ùå Erro ao salvar usu√°rio:", e);
    mostrarMensagem("Erro ao salvar usu√°rio. Veja o console para detalhes.", "erro");

    // Caso ocorra algum erro, reautentica o admin para seguran√ßa
    if (adminUser && auth.currentUser?.uid !== adminUser.uid) {
      try {
        await auth.updateCurrentUser(adminUser);
      } catch (err) {
        console.error("Falha ao restaurar sess√£o do admin:", err);
      }
    }
  }
};

/**
 * üîπ Fun√ß√£o utilit√°ria para preencher os campos para EDI√á√ÉO (Exposta no window)
 */
window.editarUsuarioLocal = function(i) {
    const usuario = window.usuarios[i];
    if (!usuario) return;

    document.getElementById("usuarioNome").value = usuario.nome || '';
    document.getElementById("usuarioEmail").value = usuario.email || '';
    document.getElementById("usuarioPerfil").value = usuario.perfil || '';
    document.getElementById("usuarioSenha").value = ''; 

    document.getElementById("usuarioEmail").disabled = true;
    document.getElementById("usuarioNome").focus();
    
    if (typeof mostrarMensagem === 'function') mostrarMensagem(`Editando perfil de ${usuario.nome}. Clique em Salvar/Atualizar Perfil para finalizar.`, "info");
}

/**
 * üîπ Fun√ß√£o para EXCLUIR APENAS O PERFIL LOCAL (Exposta no window)
 */
window.excluirUsuarioLocal = function(i) {
    // üö® VERIFICA√á√ÉO DE SEGURAN√áA
    if (!window.usuarios[i]) {
        console.warn("Usu√°rio com √≠ndice inv√°lido, recarregando tabela.");
        window.atualizarTabelaUsuarios();
        return;
    }

    const usuario = window.usuarios[i];
    
    // ... (o restante da fun√ß√£o continua)
    if (!confirm(`Excluir o perfil local de "${usuario.nome}" (${usuario.email})? Note que isso N√ÉO exclui o usu√°rio do Firebase Authentication.`)) return; 
    
    window.usuarios.splice(i, 1);
    
    if (typeof salvarTodosLocal === 'function') salvarTodosLocal();
    window.salvarUsuariosNoFirebase(window.usuarios);
    
    window.atualizarTabelaUsuarios();
    
    if (typeof mostrarMensagem === 'function') mostrarMensagem(`Perfil local de ${usuario.nome} exclu√≠do.`, "sucesso");
}

/**
 * üîπ Fun√ß√£o para ATUALIZAR A TABELA de Usu√°rios na interface (Exposta no window)
 */
window.atualizarTabelaUsuarios = function() {
    const tbody = document.querySelector("#tabelaUsuarios tbody");
    if (!tbody) return; 

    const filtroEl = document.getElementById("filtroUsuarios");
    const filtro = filtroEl ? filtroEl.value.toLowerCase() : "";
    tbody.innerHTML = "";

    window.usuarios.forEach((u, i) => {
        const nome = (u.nome || "").toLowerCase();
        const email = (u.email || "").toLowerCase();
        
        if (filtro && !nome.includes(filtro) && !email.includes(filtro)) return;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${i + 1}</td>
            <td style="font-weight: bold;">${u.nome || "-"}</td>
            <td>${u.email || "-"}</td>
            <td><span style="background:#0d6efd; color:white; padding:4px 8px; border-radius:5px; font-size:12px;">${u.perfil || "-"}</span></td>
            <td>${u.uid ? u.uid.substring(0, 8) + '...' : 'N/A'}</td>
            <td>${u.criadoEm ? new Date(u.criadoEm).toLocaleDateString('pt-BR') : 'Desconhecido'}</td>
            <td>
                <button onclick="editarUsuarioLocal(${i})" title="Editar Perfil"><i class="fa fa-edit"></i></button>
                <button onclick="excluirUsuarioLocal(${i})" title="Excluir Perfil Local"><i class="fa fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });
};

/**
 * üîπ Fun√ß√£o auxiliar de filtro (Exposta no window)
 */
window.filtrarUsuarios = function() {
    window.atualizarTabelaUsuarios();
}

/**
 * üîπ Limpa o filtro de busca E os campos do formul√°rio de usu√°rio
 */
window.limparFiltroUsuarios = function() {
  const nome = document.getElementById("usuarioNome");
  const email = document.getElementById("usuarioEmail");
  const senha = document.getElementById("usuarioSenha");
  const perfil = document.getElementById("usuarioPerfil");
  const filtro = document.getElementById("filtroUsuarios");

  if (nome) nome.value = "";
  if (email) {
    email.value = "";
    email.disabled = false; // ‚úÖ Desbloqueia o campo SEMPRE
  }
  if (senha) senha.value = "";
  if (perfil) perfil.value = "";
  if (filtro) filtro.value = "";

  if (typeof window.atualizarTabelaUsuarios === "function") {
    window.atualizarTabelaUsuarios();
  }

  // üí¨ Muda apenas a mensagem para clareza
  if (typeof mostrarMensagem === "function") {
    mostrarMensagem("Campos limpos. Pronto para cadastrar novo usu√°rio.", "info");
  }
};

async function carregarPerfilAntesDeMostrar(user) {
  // espera firestore carregar usu√°rios
  let tentativas = 0;

  while (tentativas < 20) { // tenta por 4 segundos
    if (Array.isArray(window.usuarios) && window.usuarios.length > 0) {
      const u = window.usuarios.find(x => x.email?.toLowerCase() === user.email.toLowerCase());
      if (u) return u; // achou o perfil real
    }
    
    tentativas++;
    await new Promise(res => setTimeout(res, 200)); // espera 200ms
  }

  return null; // n√£o achou
}


// === MOSTRAR SISTEMA (vers√£o segura que espera o perfil carregar) ===
async function mostrarSistema(user) {
  const loginView = document.getElementById("loginView");
  const mainApp = document.getElementById("mainApp");

  loginView.style.display = "none";
  mainApp.style.display = "block";

  // üîµ Aguarda Firestore trazer o perfil verdadeiro (EVITA PERFIL = USUARIO)
  const dados = await carregarPerfilAntesDeMostrar(user);

  let nome, perfil;

  if (dados) {
    nome = dados.nome;
    perfil = normalizarPerfil(dados.perfil);
  } else {
    // ‚ö†Ô∏è Se n√£o encontrar perfil, usa GERENCIA PARA N√ÉO BLOQUEAR O SISTEMA
    nome = user.email.split("@")[0];
    perfil = "GERENCIA";
  }

  window.usuarioAtual = {
    nome,
    email: user.email,
    perfil
  };

  // atualiza UI
  document.getElementById("userName").textContent = nome;
  document.getElementById("perfilBadge").textContent = "Perfil: " + perfil;
  document.getElementById("nomeUsuarioBemVindo").textContent = nome;

  // exibe boas-vindas
  document.querySelectorAll("main section").forEach(sec => sec.style.display = "none");
  document.getElementById("boasVindas").style.display = "block";

  // aplica as permiss√µes
  aplicarPermissoesNoMenu();

  console.log("‚úî Perfil carregado corretamente:", window.usuarioAtual);
}




  // ==========================================================
  // ‚öôÔ∏è RECARREGA TABELAS E DASHBOARDS
  // ==========================================================
  if (typeof carregarDadosDoFirestore === "function") {
    carregarDadosDoFirestore().then(() => {
      if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
      if (typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
      if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
      if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
      if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
      if (typeof atualizarDashboard === "function") atualizarDashboard();
      if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
    });
  }




// ====================================================
// üîê AUTENTICA√á√ÉO E SINCRONIZA√á√ÉO EM TEMPO REAL (CORRE√á√ÉO FINAL)
// ====================================================
// ====================================================
// üîê AUTENTICA√á√ÉO E SINCRONIZA√á√ÉO EM TEMPO REAL (VERS√ÉO FINAL)
// ====================================================
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.warn("üëã Nenhum usu√°rio logado ‚Äî aguardando login...");
    return;
  }

  console.log(`‚úÖ Usu√°rio logado: ${user.email}`);
  console.log("üîÑ Iniciando carregamento e sincroniza√ß√£o do Firestore...");

  try {
    // üîπ 1) Carrega dados iniciais e ativa listener principal
    await carregarDadosDoFirestore();

    // üîπ 2) Sincroniza usu√°rios do Auth (se existir fun√ß√£o)
    if (typeof sincronizarUsuariosDoAuth === "function") {
      await sincronizarUsuariosDoAuth();
    }

    console.log("üü¢ Escutas em tempo real configuradas com sucesso.");

  } catch (erroGeral) {
    console.error("‚ùå Erro durante a inicializa√ß√£o da sincroniza√ß√£o:", erroGeral);
    if (typeof mostrarMensagem === "function") {
      mostrarMensagem("Erro ao conectar e sincronizar com Firestore!", "erro");
    }
  }
});


¬†
¬† // === LOGOUT ===
window.logout = async function () {
  try {
    console.log("üö™ Iniciando logout...");

    // Se estiver autenticado no Firebase
    if (typeof signOut === "function" && typeof auth !== "undefined") {
      await signOut(auth);
    }

    // Limpa dados locais e globais
    localStorage.clear();
    sessionStorage.clear();
    window.usuarioAtual = null;

    // Retorna para a tela de login
    const mainApp = document.getElementById("mainApp");
    const loginView = document.getElementById("loginView");

    if (mainApp) mainApp.style.display = "none";
    if (loginView) loginView.style.display = "block";

    // Reseta o campo de login (por seguran√ßa)
    const usuarioLogin = document.getElementById("usuarioLogin");
    const senhaLogin = document.getElementById("senhaLogin");
    if (usuarioLogin) usuarioLogin.value = "";
    if (senhaLogin) senhaLogin.value = "";

    // Mensagem visual
    if (typeof mostrarMensagem === "function") {
      mostrarMensagem("Sess√£o encerrada com sucesso!", "info");
    }

    console.log("‚úÖ Logout conclu√≠do com sucesso.");
  } catch (err) {
    console.error("‚ùå Erro ao sair:", err);
    if (typeof mostrarMensagem === "function") {
      mostrarMensagem("Erro ao sair da conta!", "erro");
    }
  }
};

// === Expor Firestore e Auth globalmente ===
window.db = db;
window.auth = auth;

// === Controle de se√ß√µes (mantido) ===
window.showSection = function (id) {

  if (!window.validarPermissao(id)) {
    mostrarMensagem("‚ùå Voc√™ n√£o tem permiss√£o para acessar esta se√ß√£o!", "erro");
    return;
  }

  // Oculta tudo
  document.querySelectorAll("section").forEach(s => s.style.display = "none");

  // Mostra a se√ß√£o correta
  const section = document.getElementById(id);
  if (section) section.style.display = "block";

  // Atualiza√ß√µes autom√°ticas:
  if (id === "dashboard") atualizarDashboard?.();
  if (id === "estoque") atualizarTabelaEstoque?.();
  if (id === "limites") atualizarTabelaLimites?.();
  if (id === "cadastro") atualizarTabelaProdutos?.();
  if (id === "entrada") atualizarTabelaEntradas?.();
  if (id === "saida") atualizarTabelaSaidas?.();
  if (id === "usuarios") atualizarTabelaUsuarios?.();
  if (id === "financeiro") atualizarPainelFinanceiro?.();
};


function normalizarPerfil(str) {
  return String(str || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim()
    .toUpperCase();
}
// === VALIDAR PERMISS√ÉO (VERS√ÉO FINAL CORRIGIDA) ===
window.validarPermissao = function (secao) {
  const user = window.usuarioAtual;
  if (!user || !user.perfil) return false;

  // Normaliza perfil do usu√°rio
  const perfil = String(user.perfil || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toUpperCase()
    .trim();

  // Busca regras pelo nome normalizado
  let regras = window.PERMISSOES[perfil];

  if (!regras) {
    // tenta localizar chave equivalente
    for (const key in window.PERMISSOES) {
      const keyNorm = key.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
      if (keyNorm === perfil) {
        regras = window.PERMISSOES[key];
        break;
      }
    }
  }

  if (!regras || !Array.isArray(regras.canView)) return false;

  // Normaliza nome da se√ß√£o tamb√©m
  const secaoNorm = String(secao || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();

  return regras.canView.includes(secaoNorm);
};




// =============================
// ‚úÖ CONTROLE DO MENU LATERAL (VERS√ÉO FINAL FUNCIONAL)
// =============================
window.toggleSidebar = function () {
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.querySelector("main");
  if (!sidebar || !mainContent) return;

  const aberto = sidebar.style.left === "0px";

  if (aberto) {
    sidebar.style.left = "-220px";
    mainContent.style.marginLeft = "20px";
  } else {
    sidebar.style.left = "0px";
    mainContent.style.marginLeft = "240px";
  }
};


// -----------------------------
// Listener √∫nico para cliques (fecha sidebar quando clicar em itens do menu)
// -----------------------------
// Listener √∫nico: fecha sidebar ao clicar em item do menu OU clicar fora da sidebar
document.addEventListener("click", (event) => {
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.querySelector("main");
  const menuToggle = document.getElementById("menuToggle"); // bot√£o que abre/fecha

  if (!sidebar || !mainContent) return;

  // Determina se a sidebar est√° vis√≠vel (usa estilo computado para maior robustez)
  const computedLeft = parseFloat(window.getComputedStyle(sidebar).left) || 0;
  const sidebarAberta = computedLeft >= 0; // se left >= 0 considera aberta

  // 1) Se clicou em item do menu, fecha sempre
  const clicouItemMenu = event.target.closest("#sidebar button, #sidebar a, #sidebar li");
  if (clicouItemMenu) {
    sidebar.style.left = "-220px";
    mainContent.style.marginLeft = "20px";
    sidebar.setAttribute("aria-hidden", "true");
    return;
  }

  // 2) Se sidebar estiver aberta e o clique foi FORA da sidebar e FORA do bot√£o de toggle, fecha
  const clicouDentroSidebar = sidebar.contains(event.target);
  const clicouNoToggle = menuToggle && menuToggle.contains(event.target);

  if (sidebarAberta && !clicouDentroSidebar && !clicouNoToggle) {
    // Fecha a sidebar
    sidebar.style.left = "-220px";
    mainContent.style.marginLeft = "20px";
    sidebar.setAttribute("aria-hidden", "true");
    return;
  }

  // 3) Se clicou no toggle, deixa o toggle() cuidar (n√£o for√ßamos fechar aqui)
});


// === PERMISS√ïES DO MENU (vers√£o final) ===
window.aplicarPermissoesNoMenu = function () {
  const user = window.usuarioAtual;
  if (!user || !user.perfil) {
    // Oculta tudo se perfil inv√°lido
    document.querySelectorAll("#sidebar button").forEach(b => b.style.display = "none");
    return;
  }

  const perfil = normalizarPerfil(user.perfil);
  const regras = window.PERMISSOES[perfil];

  if (!regras) return;

  // Oculta todos
  document.querySelectorAll("#sidebar button").forEach(btn => btn.style.display = "none");

  // Mostra somente permitidos
  regras.canView.forEach(secao => {
    const btn = document.querySelector(`#sidebar button[data-section="${secao}"]`);
    if (btn) btn.style.display = "block";
  });
};


// üîπ Abre a se√ß√£o "Erros e Problemas"
window.abrirErrosProblemas = function() {
  // Oculta todas as se√ß√µes
  document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");

  // Mostra apenas a se√ß√£o de erros
  const secErros = document.getElementById("errosProblemas");
  if (secErros) {
    secErros.style.display = "block";
    secErros.classList.add("active");
  }

  // Atualiza tabela sempre que abrir
  if (typeof atualizarTabelaErros === "function") {
    atualizarTabelaErros();
  }

  console.log("üêû Se√ß√£o de Erros e Problemas aberta com sucesso.");
};

// üîπ Abre a se√ß√£o "Valor Hist√≥rico"
window.abrirValorHistorico = function () {
  document.querySelectorAll(".section").forEach(sec => (sec.style.display = "none"));
  const sec = document.getElementById("valorHistorico");
  if (sec) sec.style.display = "block";
  atualizarTabelaValorHistorico();
};
// üîç Filtra produtos pelo nome digitado
window.filtrarValorHistorico = function() {
  const filtro = document.getElementById("filtroValorHistorico").value.toLowerCase();
  const linhas = document.querySelectorAll("#tabelaValorHistorico tbody tr");

  linhas.forEach(linha => {
    const produto = linha.querySelector("td")?.innerText.toLowerCase() || "";
    linha.style.display = produto.includes(filtro) ? "" : "none";
  });
};

// üßπ Limpa o campo de busca e mostra todos os produtos
window.limparFiltroValorHistorico = function() {
  const campo = document.getElementById("filtroValorHistorico");
  if (campo) campo.value = "";
  filtrarValorHistorico();
};


</script>

¬†¬†
¬†</script>


<script>
// --- VARI√ÅVEIS GLOBAIS ---
// Elas s√£o inicializadas no script type="module" acima, mas devem ser declaradas aqui para o escopo global.
if (typeof produtos === "undefined") window.produtos = [];
if (typeof entradas === "undefined") window.entradas = [];
if (typeof saidas === "undefined") window.saidas = [];
if (typeof usuarios === "undefined") window.usuarios = [];



// --- EXECU√á√ÉO INICIAL (AJUSTADA) ---

document.addEventListener("DOMContentLoaded", () => {
    // A autentica√ß√£o Firebase (no script type="module" acima) cuida do carregamento e atualiza√ß√£o inicial.
    // Garante que o menu de setor √© preenchido na se√ß√£o de Sa√≠da
    if (typeof atualizarSetorAutomatico === "function") atualizarSetorAutomatico(); 
});


// üö® CORRE√á√ÉO DO EVENT LISTENER (para fechar ao clicar fora)
document.addEventListener('click', (event) => {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    if (!sidebar || !menuToggle) return;
    
    // L√™ o valor atual usando a mesma l√≥gica robusta
    const currentLeft = parseFloat(window.getComputedStyle(sidebar).getPropertyValue('left'));

    // Se a sidebar estiver vis√≠vel (currentLeft >= 0)
    if (currentLeft >= 0) {
        
        // Verifica se o clique foi dentro da sidebar OU no bot√£o de toggle
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickOnToggle = menuToggle.contains(event.target);

        // Se o clique n√£o foi dentro da sidebar E n√£o foi no bot√£o de toggle, fecha
        if (!isClickInsideSidebar && !isClickOnToggle) {
            toggleSidebar();
        }
    }
});






// =============================
// ‚úÖ MOSTRAR SE√á√ïES DO SISTEMA
// =============================
function showSection(id) {
  // Esconde todas as se√ß√µes
  document.querySelectorAll("section").forEach((section) => {
    section.style.display = "none";
  });

  // Mostra apenas a se√ß√£o selecionada
  const sectionToShow = document.getElementById(id);
  if (sectionToShow) {
    sectionToShow.style.display = "block";
  }

  // Fecha o menu se ele estiver aberto
  const sidebar = document.getElementById("sidebar");
  if (sidebar.style.left === "0px") {
    toggleSidebar();
  }

  // Atualiza automaticamente os pain√©is conforme a se√ß√£o
  if (id === "dashboard") atualizarDashboard();
  if (id === "estoque") atualizarTabelaEstoque();
  if (id === "limites") atualizarTabelaLimites();
  if (id === "financeiro") atualizarPainelFinanceiro();
  if (id === "cadastro") atualizarTabelaProdutos();
  if (id === "entrada") atualizarTabelaEntradas();
  if (id === "saida") atualizarTabelaSaidas();
  if (id === "usuarios") atualizarTabelaUsuarios();
}

// =============================
// ‚úÖ MOSTRAR TELA DE BOAS-VINDAS AP√ìS LOGIN
// =============================
// Dentro do onAuthStateChanged (l√° no seu script type="module"),
// troque qualquer chamada "showSection('dashboard')" por isto:
showSection('boasVindas');


/**
 * üîπ Exibe uma notifica√ß√£o de "toast" no rodap√©
 */
function mostrarMensagem(texto, tipo = "info") {
  const box = document.getElementById("toastMessage");
  if (!box) {
      // Cria a caixa se n√£o existir
      const newBox = document.createElement("div");
      newBox.id = "toastMessage";
      document.body.appendChild(newBox);
      // Reaplica a vari√°vel box
      box = document.getElementById("toastMessage");
  }

  box.textContent = texto;
  box.style.background = tipo === "erro" ? "#dc3545" : tipo === "sucesso" ? "#28a745" : "#0d6efd";
  box.style.opacity = "1";
  box.style.transform = "translateX(-50%) translateY(0)"; // Move para cima

  setTimeout(() => {
      box.style.opacity = "0";
      box.style.transform = "translateX(-50%) translateY(20px)"; // Move para baixo
  }, 4000);
}

/**
 * üîπ Destaca o campo com erro
 */
function destacarErro(el, msg) {
  el.style.border = "2px solid red";
  el.focus();
  mostrarMensagem(msg, "erro");
}

/**
 * üîπ Remove marca√ß√µes de erro
 */
function limparErros(secaoId) {
    document.querySelectorAll(`#${secaoId} input, #${secaoId} select`).forEach(el => {
        el.style.border = "1px solid #ccc";
        el.title = "";
    });
}

/**
 * üîπ Fun√ß√£o gen√©rica ‚Äî limpa todos os inputs e selects dentro de uma se√ß√£o
 */
function limparCampos(secaoId) {
  const secao = document.getElementById(secaoId);
  if (!secao) return;
  secao.querySelectorAll("input, select").forEach(el => {
    if (el.type === "file") {
      el.value = "";
    } else if (el.tagName === "SELECT") {
      el.selectedIndex = 0;
    } else {
      el.value = "";
    }
  });
}

/**
 * üîπ Amplia a imagem do produto no modal
 */
function ampliarImagem(src) {
  const modal = document.getElementById("imagemAmpliada");
  modal.querySelector("img").src = src;
  modal.style.display = "flex";
}

/**
 * üîπ Fun√ß√£o utilit√°ria: busca c√≥digo de barras do produto
 */
function buscarCodigoBarrasDoProduto(nome) {
    const p = produtos.find(p => p.nome === nome);
    return p ? p.codigoBarras : "-";
}
/**
 * üîπ Leitor de QR Code integrado ao campo de c√≥digo de barras
 * Compat√≠vel com leitor f√≠sico (USB) e c√¢mera (QR)
 */
function iniciarLeitorQRCode() {
  const video = document.createElement("video");
  const canvasElement = document.createElement("canvas");
  const canvas = canvasElement.getContext("2d");
  let scanning = false;

  const modal = document.createElement("div");
  modal.id = "qrModal";
  modal.style.cssText = `
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; z-index: 9999;
  `;
  modal.innerHTML = `
    <video id="qrVideo" style="width: 300px; height: 300px; border: 3px solid #00ff88; border-radius: 10px;"></video>
    <button id="fecharQR" style="margin-top: 15px; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Fechar</button>
  `;
  document.body.appendChild(modal);

  const fecharBtn = modal.querySelector("#fecharQR");
  fecharBtn.addEventListener("click", () => {
    scanning = false;
    video.srcObject?.getTracks().forEach(track => track.stop());
    modal.remove();
  });

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      scanning = true;
      video.setAttribute("playsinline", true);
      video.srcObject = stream;
      video.play();
      tick();
      scan();
    });

  function tick() {
    if (!scanning) return;
    canvasElement.height = video.videoHeight;
    canvasElement.width = video.videoWidth;
    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
    requestAnimationFrame(tick);
  }

  function scan() {
    try {
      const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
      if (code) {
        scanning = false;
        video.srcObject?.getTracks().forEach(track => track.stop());
        modal.remove();

        const codigoLido = code.data.trim();
        const campoCodigo = document.getElementById("produtoCodigoBarras") || document.getElementById("saidaCodigoBarras");

        if (campoCodigo) {
          campoCodigo.value = codigoLido;
          campoCodigo.dispatchEvent(new Event("input")); // dispara mudan√ßa
        }

        // üîπ NOVO: preenche automaticamente o nome, se existir no cat√°logo
        const produto = window.produtos?.find(p =>
          String(p.codBarras || p.codigoBarras || "").trim() === codigoLido
        );

        if (produto) {
          const campoNome =
            document.getElementById("produtoNome") ||
            document.getElementById("saidaProduto");

          if (campoNome) campoNome.value = produto.nome || "";
          mostrarMensagem(`‚úÖ Produto identificado: ${produto.nome}`, "sucesso");
        } else {
          mostrarMensagem("‚ö†Ô∏è C√≥digo n√£o encontrado no cat√°logo de produtos!", "erro");
        }

      } else if (scanning) {
        setTimeout(scan, 200);
      }
    } catch (e) {
      console.warn("Erro na leitura do QR:", e);
      if (scanning) setTimeout(scan, 200);
    }
  }
}


/**
 * üîπ Atualiza o campo 'quantidade' no estoque global
 */
function atualizarEstoque(nomeProduto, quantidadeDelta, ultimoValor = null, lote = "", validade = "") {
  const produtoRef = produtos.find(
    p => p.nome.trim().toLowerCase() === nomeProduto.trim().toLowerCase()
  );

  if (produtoRef) {
    let qtdAtual = Number(produtoRef.quantidade || 0);
    qtdAtual += quantidadeDelta;
    produtoRef.quantidade = Math.max(0, qtdAtual);

    // üîπ Atualiza campos adicionais com dados da √∫ltima entrada
    if (ultimoValor !== null && !isNaN(ultimoValor)) produtoRef.ultimoValor = Number(ultimoValor);
    if (lote) produtoRef.lote = lote;
    if (validade) produtoRef.validade = validade;

    salvarProdutosNoFirebase(produtos);
    atualizarTabelaEstoque();
    atualizarDashboard();
    atualizarPainelFinanceiro();
  }
}


// --- PADRONIZA√á√ÉO DE DADOS ---

/**
 * üîπ Formata o texto para padr√£o (Primeira Letra Mai√∫scula)
 */
function formatarTextoPadrao(texto) {
  if (!texto) return "";
  return texto
    .toLowerCase()
    .split(" ")
    .filter(p => p.trim() !== "")
    .map(p => p.charAt(0).toUpperCase() + p.slice(1))
    .join(" ");
}

/**
 * üî∏ Aplica automaticamente a padroniza√ß√£o ao sair de campos de texto
 */
document.addEventListener("blur", (e) => {
  const el = e.target;
  if (el.tagName === "INPUT" && el.type === "text") {
    // Ignora campos que n√£o devem ser alterados (ex: c√≥digos, e-mail)
    if (
      el.id.toLowerCase().includes("cnpj") ||
      el.id.toLowerCase().includes("email") ||
      el.id.toLowerCase().includes("login") ||
      el.id.toLowerCase().includes("lote") ||
      el.id.toLowerCase().includes("barras")
    ) return;
    el.value = formatarTextoPadrao(el.value);
  }
}, true);

/**
 * üî∏ Garante padroniza√ß√£o em todos os campos antes de salvar/cadastrar
 */
function padronizarCamposAntesDeSalvar() {
  document.querySelectorAll('input[type="text"]').forEach(el => {
    // Mesma l√≥gica de ignorar campos espec√≠ficos
    if (
      el.id.toLowerCase().includes("cnpj") ||
      el.id.toLowerCase().includes("email") ||
      el.id.toLowerCase().includes("login") ||
      el.id.toLowerCase().includes("lote") ||
      el.id.toLowerCase().includes("barras")
    ) return;
    el.value = formatarTextoPadrao(el.value);
  });
}
// ============================================================
// üîÑ CARREGA DADOS SALVOS LOCALMENTE (INCLUSIVE REGISTRO DE ERROS)
// ============================================================
(function restaurarDadosLocais() {
  try {
    const dadosLocais = JSON.parse(localStorage.getItem("oralUnicEstoque")) || {};

    window.produtos = Array.isArray(dadosLocais.produtos) ? dadosLocais.produtos : [];
    window.entradas = Array.isArray(dadosLocais.entradas) ? dadosLocais.entradas : [];
    window.saidas = Array.isArray(dadosLocais.saidas) ? dadosLocais.saidas : [];
    window.limites = Array.isArray(dadosLocais.limites) ? dadosLocais.limites : [];
    window.usuarios = Array.isArray(dadosLocais.usuarios) ? dadosLocais.usuarios : [];
    window.errosProblemas = Array.isArray(dadosLocais.errosProblemas) ? dadosLocais.errosProblemas : []; // ‚úÖ restaura o hist√≥rico

    console.log(`üì¶ Dados locais restaurados. Produtos: ${window.produtos.length}, Erros: ${window.errosProblemas.length}`);
  } catch (e) {
    console.error("‚ö†Ô∏è Falha ao carregar dados locais:", e);
    window.produtos = [];
    window.entradas = [];
    window.saidas = [];
    window.limites = [];
    window.usuarios = [];
    window.errosProblemas = [];
  }
})();

// ================================
// FUN√á√ÉO FINAL: cadastrarProduto (CORRIGIDA)
// ================================
window.cadastrarProduto = async function () {
  limparErros && limparErros("cadastro");

  // ----- Elementos do formul√°rio -----
  const codigoEl = document.getElementById("produtoCodigo");
  const nomeEl = document.getElementById("produtoNome");
  const categoriaEl = document.getElementById("produtoCategoria");
  const embalagemEl = document.getElementById("produtoEmbalagem");
  const qtdEmbEl = document.getElementById("produtoQtdEmbalagem");
  const codBarrasEl = document.getElementById("produtoCodigoBarras");
  const fotoEl = document.getElementById("produtoFoto");

  const codigo = (codigoEl?.value || "").trim();
  const nome = (nomeEl?.value || "").trim();
  const categoria = (categoriaEl?.value || "").trim();
  const embalagem = (embalagemEl?.value || "").trim();
  const qtdEmb = parseInt(qtdEmbEl?.value || "") || 0;
  const codBarras = (codBarrasEl?.value || "").trim();

  const isEdicao = typeof indiceEdicaoProduto === "number"
                && indiceEdicaoProduto !== null;

  // Valida√ß√µes
  if (!nome) return destacarErro(nomeEl, "Informe o nome do produto!");
  if (!categoria) return destacarErro(categoriaEl, "Selecione a categoria!");
  if (!embalagem) return destacarErro(embalagemEl, "Selecione a embalagem!");
  if (!qtdEmb) return destacarErro(qtdEmbEl, "Informe a quantidade!");

  // Foto
  let fotoBase64 = "";
  if (!isEdicao && !(fotoEl?.files?.[0])) {
    return destacarErro(fotoEl, "A foto √© obrigat√≥ria!");
  }
  if (fotoEl?.files?.[0]) {
    fotoBase64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(fotoEl.files[0]);
    });
  }

  // Garante array
  window.produtos = Array.isArray(window.produtos) ? window.produtos : [];

  // Duplicidade
  const produtoDuplicado = window.produtos.find((p, idx) => {
    if (isEdicao && idx === indiceEdicaoProduto) return false;
    const nomeA = (p.nome||"").toLowerCase();
    const nomeB = nome.toLowerCase();
    const codigoA = (p.codigo||"").toLowerCase();
    const codigoB = (codigo||"").toLowerCase();
    if (codigoB && codigoA === codigoB) return true;
    if (!codigoB && nomeA === nomeB) return true;
    return false;
  });
  if (produtoDuplicado)
    return mostrarMensagem("‚ùå J√° existe este nome/c√≥digo!", "erro");

  // Helper
  async function salvarUmProduto(prod) {
    try {
      if (typeof window.salvarUmProdutoNoFirebase === "function") {
        await window.salvarUmProdutoNoFirebase(prod);
        return;
      }
      const estoqueRefLocal = doc(db, "estoqueGlobal", "estoque");
      const produtosCol = collection(estoqueRefLocal, "produtos");
      const id = String(prod.id || Date.now());
      prod.id = id;
      await setDoc(doc(produtosCol, id), prod, { merge: true });
    } catch (e) {
      console.error("Erro ao salvar:", e);
      throw e;
    }
  }

  // --- EDI√á√ÉO ---
  if (isEdicao) {
    const prod = window.produtos[indiceEdicaoProduto];
    if (!prod) return mostrarMensagem("Produto n√£o encontrado.", "erro");

    prod.codigo = codigo;
    prod.nome = nome;
    prod.categoria = categoria;
    prod.embalagem = embalagem;
    prod.qtdEmbalagem = qtdEmb;
    prod.codBarras = codBarras;
    if (fotoBase64) prod.foto = fotoBase64;

    window.bloquearAtualizacaoSnapshot = true;

    try {
      await salvarUmProduto(prod);
      mostrarMensagem(`‚úÖ Produto "${nome}" atualizado!`, "sucesso");
      indiceEdicaoProduto = null;
      mostrarBotaoCancelar?.(false);
    } finally {
      setTimeout(() => {
        window.bloquearAtualizacaoSnapshot = false;
        atualizarTabelaProdutos?.();
      }, 600);
    }
    return;
  }

  // --- NOVO PRODUTO ---
  const novoProduto = {
    id: String(Date.now()),
    codigo,
    nome,
    categoria,
    embalagem,
    qtdEmbalagem: qtdEmb,
    codBarras,
    foto: fotoBase64,
    criadoEm: new Date().toISOString(),
  };

  window.produtos.push(novoProduto);

  window.bloquearAtualizacaoSnapshot = true;

  try {
    await salvarUmProduto(novoProduto);
    mostrarMensagem(`‚úÖ Produto "${nome}" cadastrado!`, "sucesso");
  } finally {
    setTimeout(() => {
      window.bloquearAtualizacaoSnapshot = false;
      atualizarTabelaProdutos?.();
    }, 600);
  }

  salvarTodosLocal?.();

  // --- LIMPAR CAMPOS (AGORA SIM, DENTRO DA FUN√á√ÉO) ---
  codigoEl.value = "";
  nomeEl.value = "";
  categoriaEl.value = "";
  embalagemEl.value = "";
  qtdEmbEl.value = "";
  codBarrasEl.value = "";
  if (fotoEl) fotoEl.value = "";
  const preview = document.getElementById("fotoPreview");
  if (preview) preview.innerHTML = "";
};








// ===============================================
// ‚úÖ Torna fun√ß√£o de cancelar edi√ß√£o global
// ===============================================
window.cancelarEdicaoProduto = function () {
  indiceEdicaoProduto = null;

  if (typeof limparCampos === "function") {
    limparCampos("cadastro");
  }

  document.querySelectorAll("#tabelaProdutos tbody tr").forEach((tr) => {
    tr.style.background = "";
  });

if (typeof window.mostrarBotaoCancelar === "function") {
  window.mostrarBotaoCancelar(false);
}

// üü¢ Limpa o preview da foto ao cancelar a edi√ß√£o
const fotoPreview = document.getElementById("fotoPreview");
if (fotoPreview) fotoPreview.innerHTML = "";

mostrarMensagem("üö´ Edi√ß√£o cancelada.", "info");
};


// ===============================================
// ‚úÖ Fun√ß√£o global para atualizar refer√™ncias de produtos
// ===============================================
window.atualizarReferenciasProduto = function (nomeAntigo, nomeNovo) {
  if (!nomeAntigo || !nomeNovo || nomeAntigo === nomeNovo) return;

  // Atualiza o nome nas listas de entradas e sa√≠das
  window.entradas?.forEach((e) => {
    if (e.produto === nomeAntigo) e.produto = nomeNovo;
  });

  window.saidas?.forEach((s) => {
    if (s.produto === nomeAntigo) s.produto = nomeNovo;
  });

  // Atualiza tamb√©m na lista principal de produtos
  window.produtos?.forEach((p) => {
    if (p.nome === nomeAntigo) p.nome = nomeNovo;
  });

  // Salva tudo localmente se a fun√ß√£o existir
  if (typeof window.salvarTodosLocal === "function") {
    window.salvarTodosLocal();
  }

  mostrarMensagem("üîÑ Refer√™ncias atualizadas em todo o sistema.", "info");
};

// ===============================================
// üìã COPIAR C√ìDIGO DE BARRAS (Entrada de Materiais)
// ===============================================
window.copiarCodigoBarras = function (codigo) {
  if (!codigo || codigo === "-") return;

  navigator.clipboard.writeText(codigo)
    .then(() => {
      mostrarMensagem
        ? mostrarMensagem("üìã C√≥digo copiado!", "sucesso")
        : alert("C√≥digo copiado!");
    })
    .catch(() => {
      mostrarMensagem
        ? mostrarMensagem("‚ùå N√£o foi poss√≠vel copiar.", "erro")
        : alert("Erro ao copiar.");
    });
};


window.atualizarTabelaProdutos = function () {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  if (!tbody) return;

  const filtroEl = document.getElementById("filtroProduto");
  const filtro = filtroEl ? filtroEl.value.toLowerCase() : "";

  tbody.innerHTML = "";

  if (!Array.isArray(window.produtos)) window.produtos = [];

  // Ordena√ß√£o alfab√©tica por nome
  const produtosOrdenados = [...window.produtos].sort((a, b) => {
    const nomeA = (a.nome || "").toLowerCase();
    const nomeB = (b.nome || "").toLowerCase();
    return nomeA.localeCompare(nomeB, "pt-BR");
  });

  if (produtosOrdenados.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML =
      `<td colspan="9" style="text-align:center; color:#777;">Nenhum produto cadastrado.</td>`;
    tbody.appendChild(row);
    return;
  }

  // Renderiza√ß√£o das linhas
  produtosOrdenados.forEach((produto, i) => {
    const nomeLower = (produto.nome || "").toLowerCase();
    const categoriaLower = (produto.categoria || "").toLowerCase();

    // Filtro
    if (filtro && !nomeLower.includes(filtro) && !categoriaLower.includes(filtro)) return;

    const foto = produto.foto || "";
    const fotoHtml = foto
      ? `<img src="${foto}" class="thumb" onclick="ampliarImagem('${foto}')" alt="Foto do produto">`
      : `<span style="color:red;font-weight:bold;">‚ùå</span>`;

    const codigoBarras = produto.codBarras || "-";

    const row = document.createElement("tr");
    row.setAttribute("data-id", produto.id || "");

    row.innerHTML = `
      <td>${i + 1}</td>
      <td style="text-align:center;">${fotoHtml}</td>
      <td>${produto.codigo || "-"}</td>
      <td style="font-weight:600;">${produto.nome || "-"}</td>
      <td>${produto.categoria || "-"}</td>
      <td>${produto.embalagem || "-"}</td>
      <td>${produto.qtdEmbalagem || "-"}</td>
      <td style="max-width:60px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;"
          title="${codigoBarras}"
          onclick="copiarCodigoBarras('${codigoBarras}')">
          ${codigoBarras}
      </td>

      <td style="text-align:center; width:140px;">
        <button title="Editar" style="margin-right:6px;"
                onclick="editarProdutoPorId('${produto.id}')">
            <i class="fa fa-edit"></i>
        </button>

        <button title="Excluir"
                onclick="excluirProdutoPorId('${produto.id}')"
                style="background:#dc3545; color:white;">
            <i class="fa fa-trash"></i>
        </button>
      </td>
    `;

    // Destacar linha em edi√ß√£o
    if (typeof indiceEdicaoProduto === "number") {
      const prodEmEdicao = window.produtos[indiceEdicaoProduto];
      if (prodEmEdicao && String(prodEmEdicao.id) === String(produto.id)) {
        row.style.background = "#fff3cd";
      }
    }

    tbody.appendChild(row);
  });

  console.log("‚úÖ Tabela de produtos atualizada sem snapshot gigante.");
};





// ==========================
// Helper: obter √≠ndice por id
// ==========================
window.obterIndicePorIdProduto = function(id) {
  if (!Array.isArray(window.produtos)) window.produtos = [];
  return window.produtos.findIndex(p => String(p.id) === String(id));
};



// ==========================
// ==========================
// EDI√á√ÉO: por id (CORRIGIDA)
// ==========================
window.editarProdutoPorId = function(id) {
  const idx = obterIndicePorIdProduto(id);
  if (idx === -1) {
    console.warn("Produto n√£o encontrado para edi√ß√£o:", id);
    mostrarMensagem && mostrarMensagem("Produto n√£o encontrado para edi√ß√£o.", "erro");
    return;
  }

  const produto = window.produtos[idx];
  indiceEdicaoProduto = idx;

  // üü¢ AGORA SIM: apenas preencher o formul√°rio ‚Äî sem alterar o objeto!
  document.getElementById("produtoCodigo").value = produto.codigo || "";
  document.getElementById("produtoNome").value = produto.nome || "";
  document.getElementById("produtoCategoria").value = produto.categoria || "";
  document.getElementById("produtoEmbalagem").value = produto.embalagem || "";
  document.getElementById("produtoQtdEmbalagem").value = produto.qtdEmbalagem || "";
  document.getElementById("produtoCodigoBarras").value = produto.codBarras || produto.codigoBarras || "";

  // Foto
  const fotoPreview = document.getElementById("fotoPreview");
  if (fotoPreview) {
    if (produto.foto) {
      fotoPreview.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px">
          <img src="${produto.foto}" alt="Foto atual" style="width:60px;height:60px;object-fit:cover;border:1px solid #ccc;border-radius:5px;">
          <span style="font-size:13px;color:#444">üì∏ Foto atual ‚Äî ser√° mantida se n√£o escolher outra.</span>
        </div>`;
    } else {
      fotoPreview.innerHTML = `<span style="color:#888">Nenhuma foto cadastrada para este produto.</span>`;
    }
  }

  // Destacar linha selecionada
  document.querySelectorAll("#tabelaProdutos tbody tr").forEach(tr => {
    tr.style.background = tr.getAttribute("data-id") === String(id) ? "#fff3cd" : "";
  });

  mostrarBotaoCancelar?.(true);
  mostrarMensagem && mostrarMensagem(`‚úèÔ∏è Editando: ${produto.nome}`, "info");
};



window.excluirProdutoPorId = async function(id) {
  const idx = obterIndicePorIdProduto(id);
  if (idx === -1) {
    mostrarMensagem("Produto n√£o encontrado.", "erro");
    return;
  }

  const produto = window.produtos[idx];
  if (!confirm(`Excluir o produto "${produto.nome}"?`)) return;

  try {
    // üîí 1Ô∏è‚É£ Bloqueia atualiza√ß√£o via snapshot durante o processo
    window.bloquearAtualizacaoSnapshot = true;

    // üß≠ 2Ô∏è‚É£ Caminho correto no Firestore
    const estoqueRef = doc(db, "estoqueGlobal", "estoque");
    const produtoRef = doc(collection(estoqueRef, "produtos"), id);

    await deleteDoc(produtoRef);

    console.log(`üóëÔ∏è Produto ${id} removido do Firestore com sucesso.`);

    // üßπ 3Ô∏è‚É£ Remove localmente
    window.produtos.splice(idx, 1);

    // üíæ 4Ô∏è‚É£ Atualiza cache local
    salvarTodosLocal?.();

    // üîÑ 5Ô∏è‚É£ Atualiza interface
    atualizarTabelaProdutos?.();
    atualizarTabelaEstoque?.();
    atualizarDashboard?.();
    atualizarPainelFinanceiro?.();

    mostrarMensagem(`‚úÖ Produto "${produto.nome}" exclu√≠do com sucesso!`, "sucesso");

  } catch (e) {
    console.error("‚ùå Erro ao excluir produto:", e);
    mostrarMensagem("‚ùå Falha ao excluir produto.", "erro");
  } finally {
    // üîì 6Ô∏è‚É£ Reativa o snapshot
    setTimeout(() => {
      window.bloquearAtualizacaoSnapshot = false;
      console.log("üîì Snapshot reativado ap√≥s exclus√£o.");
    }, 2000);
  }
};





// ==========================
// Compatibilidade: fun√ß√µes index-based (opcionais)
// Se voc√™ tiver c√≥digo que chama editarProduto(index) ou excluirProduto(index),
// mantenha estas wrappers que convertem √≠ndice/valor para id.
// ==========================
window.editarProdutoPorIndice = function(indexNaLista) {
  const p = window.produtos[indexNaLista];
  if (!p) return mostrarMensagem("Produto n√£o encontrado (√≠ndice).", "erro");
  return editarProdutoPorId(p.id);
};
// ==========================
// Compatibilidade: fun√ß√µes index-based (opcionais)
// ==========================
window.editarProdutoPorIndice = function(indexNaLista) {
  const p = window.produtos[indexNaLista];
  if (!p) return mostrarMensagem("Produto n√£o encontrado (√≠ndice).", "erro");
  return editarProdutoPorId(p.id);
};

window.excluirProdutoPorIndice = function(indexNaLista) {
  const p = window.produtos[indexNaLista];
  if (!p) return mostrarMensagem("Produto n√£o encontrado (√≠ndice).", "erro");
  return excluirProdutoPorId(p.id);
};


// ===============================================
// ‚úÖ Preview de imagem com visual moderno (redondo e centralizado)
// ===============================================
document.getElementById("produtoFoto").addEventListener("change", (e) => {
  const file = e.target.files[0];
  const fotoPreview = document.getElementById("fotoPreview");
  if (!fotoPreview) return;

  if (file) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      fotoPreview.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
          <img src="${ev.target.result}" 
               alt="Nova foto" 
               style="width:80px; height:80px; object-fit:cover; border:2px solid #ccc; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,0.15);">
          <span>üñºÔ∏è Nova foto: <strong>${file.name}</strong></span>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  } else {
    // Se o usu√°rio cancelar a sele√ß√£o, volta para a foto atual (caso exista)
    const index = window.indiceEdicaoProduto;
    const produto = window.produtos?.[index];
    if (produto && produto.foto) {
      fotoPreview.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
          <img src="${produto.foto}" 
               alt="Foto atual" 
               style="width:80px; height:80px; object-fit:cover; border:2px solid #ccc; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,0.15);">
          <span>üì∏ Foto atual ‚Äî ser√° mantida se voc√™ n√£o escolher outra.</span>
        </div>
      `;
    } else {
      fotoPreview.textContent = "Nenhuma foto cadastrada.";
    }
  }
});


// ===============================================
// üîÑ Fun√ß√£o para limpar todos os campos do cadastro
// ===============================================
window.limparCamposProduto = function () {
  const codigoEl = document.getElementById("produtoCodigo");
  const nomeEl = document.getElementById("produtoNome");
  const categoriaEl = document.getElementById("produtoCategoria");
  const embalagemEl = document.getElementById("produtoEmbalagem");
  const qtdEmbEl = document.getElementById("produtoQtdEmbalagem");
  const codBarrasEl = document.getElementById("produtoCodigoBarras");
  const fotoEl = document.getElementById("produtoFoto");
  const fotoPreview = document.getElementById("fotoPreview");
  const filtro = document.getElementById("filtroProduto");

  // üîÑ Limpa todos os campos de cadastro
  if (codigoEl) codigoEl.value = "";
  if (nomeEl) nomeEl.value = "";
  if (categoriaEl) categoriaEl.value = "";
  if (embalagemEl) embalagemEl.value = "";
  if (qtdEmbEl) qtdEmbEl.value = "";
  if (codBarrasEl) codBarrasEl.value = "";
  if (fotoEl) fotoEl.value = "";
  if (fotoPreview) fotoPreview.innerHTML = "";

  // üßΩ Remove produto em edi√ß√£o
  if (typeof indiceEdicaoProduto !== "undefined") {
    indiceEdicaoProduto = null;
  }

  // üßπ Limpa destaque da tabela
  document.querySelectorAll("#tabelaProdutos tbody tr").forEach((tr) => {
    tr.style.background = "";
  });

  // üîô Esconde bot√£o de cancelar edi√ß√£o
  if (typeof window.mostrarBotaoCancelar === "function") {
    window.mostrarBotaoCancelar(false);
  }

  // üîç Limpa campo de filtro
  if (filtro) {
    filtro.value = "";
    if (typeof window.filtrarProdutos === "function") {
      window.filtrarProdutos();
    }
  }

  // üëâ Foca novamente no primeiro campo
  if (codigoEl) codigoEl.focus();

  // üì¢ Feedback
  if (typeof mostrarMensagem === "function") {
    mostrarMensagem("Campos do produto limpos.", "info");
  } else {
    console.log("Campos do produto limpos.");
  }
};



// ===============================================
// ‚úÖ Torna fun√ß√£o de mostrar/ocultar bot√£o global
// ===============================================
window.mostrarBotaoCancelar = function (exibir) {
  let botaoCancelar = document.getElementById("botaoCancelarEdicao");

  if (exibir) {
    if (!botaoCancelar) {
      botaoCancelar = document.createElement("button");
      botaoCancelar.id = "botaoCancelarEdicao";
      botaoCancelar.textContent = "Cancelar Edi√ß√£o";
      botaoCancelar.style.background = "#dc3545";
      botaoCancelar.style.color = "#fff";
      botaoCancelar.style.marginLeft = "10px";
      botaoCancelar.style.borderRadius = "5px";
      botaoCancelar.onclick = window.cancelarEdicaoProduto; // importante: window. para funcionar globalmente

      const botaoCadastrar = document.querySelector('#cadastro button[onclick*="cadastrarProduto"]');
      if (botaoCadastrar) {
        botaoCadastrar.insertAdjacentElement("afterend", botaoCancelar);
      }
    }
  } else {
    if (botaoCancelar) botaoCancelar.remove();
  }
};
// üîπ Fun√ß√£o de filtro de produtos (corrigida e segura)
// üîπ Fun√ß√£o de filtro de produtos (corrigida e segura) 
window.filtrarProdutos = function () {
  const filtro = document.getElementById("filtroProduto").value.toLowerCase().trim();
  const tabela = document.getElementById("tabelaProdutos").querySelector("tbody");

  if (!tabela) return;

  tabela.innerHTML = "";

  // Lista REAL de produtos
  const lista = Array.isArray(window.produtos) ? [...window.produtos] : [];

  // üîé FILTRO COMPLETO (C√≥d. Produto, Nome, Categoria, C√≥d. Barras)
  const filtrados = lista.filter(p => {
    const nome = (p.nome || "").toLowerCase();
    const categoria = (p.categoria || "").toLowerCase();
    const codigoProduto = (p.codigo || "").toLowerCase();           // üÜï C√ìD PRODUTO
    const codigoBarras = (p.codBarras || p.codigoBarras || "").toLowerCase();

    return (
      nome.includes(filtro) ||
      categoria.includes(filtro) ||
      codigoProduto.includes(filtro) ||   // üÜï FILTRO PELO C√ìD PRODUTO
      codigoBarras.includes(filtro)       // üÜï FILTRO PELO C√ìD BARRAS
    );
  });

  // Renderiza√ß√£o da tabela corrigida (seguindo a ordem do THEAD)
  filtrados.forEach((p, i) => {
    const foto = p.foto
      ? `<img src="${p.foto}" class="thumb">`
      : `<span style="color:red;font-weight:bold;">‚ùå</span>`;

    const codigoProduto = p.codigo || "";   // üÜï C√ìD PRODUTO
    const codigoBarras = p.codBarras || p.codigoBarras || "-";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${foto}</td>

      <!-- üÜï C√ìDIGO DO PRODUTO -->
      <td>${codigoProduto}</td>

      <td>${p.nome || "-"}</td>
      <td>${p.categoria || "-"}</td>
      <td>${p.embalagem || "-"}</td>
      <td>${p.qtdEmbalagem || p.qtd || "-"}</td>

      <td style="cursor:pointer;" 
          title="${codigoBarras}"
          onclick="copiarCodigoBarras('${codigoBarras}')">
          ${codigoBarras}
      </td>

      <td>
        <button onclick="editarProdutoPorId('${p.id}')"><i class="fa fa-edit"></i></button>
        <button onclick="excluirProdutoPorId('${p.id}')" style="background:#dc3545;color:white;">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    `;

    tabela.appendChild(row);
  });

  // Mensagem caso nenhum produto seja encontrado
  if (filtrados.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="9" style="text-align:center; color:#888;">Nenhum produto encontrado.</td>`;
    tabela.appendChild(row);
  }
};



// -----------------------------
// ENTRADA: Atualiza√ß√µes para C√≥d. Produto
// -----------------------------

function atualizarSelectProdutos() {
  const selectEntrada = document.getElementById("listaProdutos");
  if (!selectEntrada) return;

  selectEntrada.innerHTML = "";

  const listaOrdenada = [...(window.produtos || [])].sort((a, b) =>
    (a.nome || "").localeCompare(b.nome || "", "pt-BR", { sensitivity: "base" })
  );

  listaOrdenada.forEach(p => {
    const option = document.createElement("option");
    option.value = p.nome;
    selectEntrada.appendChild(option);
  });
}

// Busca por c√≥digo de barras (preenche nome) OU por c√≥digo do produto se encontrado pelo campo de leitura de CB
function buscarProdutoPorCodigo(contexto) {
  const campoCodigo = document.getElementById(`${contexto}CodigoBarras`);
  const campoProduto = document.getElementById(`${contexto}Produto`);
  const campoCodigoProduto = document.getElementById(`${contexto}CodigoProduto`);

  if (!campoCodigo || !campoProduto) return;

  const codigoDigitado = (campoCodigo.value || "").trim().toLowerCase();

  campoCodigo.style.border = "1px solid #ccc";
  campoProduto.value = "";
  if (campoCodigoProduto) campoCodigoProduto.value = "";

  if (!codigoDigitado) return;

  const produto = (window.produtos || []).find(p =>
    String(p.codBarras || p.codigoBarras || "").trim().toLowerCase() === codigoDigitado ||
    String(p.codigo || "").trim().toLowerCase() === codigoDigitado   // üü¢ AGORA FUNCIONA
  );

  if (!produto) {
    campoCodigo.style.border = "2px solid red";
    mostrarMensagem("C√≥digo n√£o encontrado!", "erro");
    return;
  }

  campoProduto.value = produto.nome || "";
  if (campoCodigoProduto) campoCodigoProduto.value = produto.codigo || "";

  mostrarMensagem(`Produto "${produto.nome}" encontrado.`, "info");
}




// Busca por C√≥d. Produto (campo novo) ‚Äî preenche nome e c√≥digo de barras
function buscarProdutoPorCodigoProduto() {
  const campoCodigoProduto = document.getElementById("entradaCodigoProduto");
  const campoProduto = document.getElementById("entradaProduto");
  const campoCodigoBarras = document.getElementById("entradaCodigoBarras");

  if (!campoCodigoProduto || !campoProduto) return;

  const codigoDigitado = (campoCodigoProduto.value || "").trim().toLowerCase();

  // Reset visual
  campoCodigoProduto.style.border = "1px solid #ccc";
  campoCodigoProduto.title = "";
  campoProduto.value = "";
  if (campoCodigoBarras) campoCodigoBarras.value = "";

  if (!codigoDigitado) return;

  // ‚úÖ CORRE√á√ÉO: agora compara corretamente o c√≥digo digitado com o c√≥digo salvo
  const produto = (window.produtos || []).find(p =>
    String(p.codigo || "").trim().toLowerCase() === codigoDigitado
  );

  if (!produto) {
    campoCodigoProduto.style.border = "2px solid red";
    campoCodigoProduto.title = "C√≥d. Produto n√£o encontrado.";
    mostrarMensagem("C√≥d. Produto n√£o encontrado!", "erro");
    return;
  }

  // Preenche nome
  campoProduto.value = produto.nome || "";

  // Preenche c√≥digo de barras se existir
  if (campoCodigoBarras && (produto.codBarras || produto.codigoBarras)) {
    campoCodigoBarras.value = produto.codBarras || produto.codigoBarras;
  }

  mostrarMensagem(`Produto "${produto.nome}" encontrado pelo C√≥d. Produto.`, "info");
}



// Eventos
document.getElementById("entradaCodigoBarras")?.addEventListener("change", () => buscarProdutoPorCodigo("entrada"));
document.getElementById("entradaCodigoBarras")?.addEventListener("blur", () => buscarProdutoPorCodigo("entrada"));
document.getElementById("entradaCodigoProduto")?.addEventListener("change", buscarProdutoPorCodigoProduto);
document.getElementById("entradaCodigoProduto")?.addEventListener("blur", buscarProdutoPorCodigoProduto);


// =============================================================
// REGISTRAR ENTRADA ‚Äî integrando C√≥d. Produto
// =============================================================
function registrarEntrada() {
  limparErros("entrada");

  const codigoProdutoEl = document.getElementById("entradaCodigoProduto"); // novo campo
  const produtoEl = document.getElementById("entradaProduto");
  const qtdEl = document.getElementById("entradaQuantidade");
  const valorEl = document.getElementById("entradaValor");
  const dataEl = document.getElementById("entradaData");
  const notaEl = document.getElementById("entradaNota");
  const fornecedorEl = document.getElementById("entradaFornecedor");
  const cnpjEl = document.getElementById("entradaCNPJ");
  const loteEl = document.getElementById("entradaLote");
  const validadeEl = document.getElementById("entradaValidade");
  const setorEl = document.getElementById("entradaSetor");
  const codigoEl = document.getElementById("entradaCodigoBarras");

  const codigoProduto = codigoProdutoEl?.value.trim() || "";
  const produto = produtoEl?.value?.trim() || "";
  const qtd = parseFloat(qtdEl?.value?.trim()) || 0;
  const valor = parseFloat(valorEl?.value?.trim()) || 0;
  const data = dataEl?.value?.trim() || "";
  const nota = notaEl?.value?.trim() || "";
  const fornecedor = fornecedorEl?.value?.trim() || "";
  const cnpj = cnpjEl?.value?.trim() || "";
  const lote = loteEl?.value?.trim() || "";
  const validade = validadeEl?.value?.trim() || "";
  const setor = setorEl?.value?.trim() || "";
  const codigoBarras = codigoEl?.value?.trim() || "";

  // Valida√ß√µes
  if (!produto) return destacarErro(produtoEl, "O campo 'Nome do produto' √© obrigat√≥rio!");
  if (!qtd || qtd <= 0) return destacarErro(qtdEl, "Informe a quantidade v√°lida!");
  if (!valor || valor <= 0) return destacarErro(valorEl, "Informe o valor unit√°rio!");
  if (!data) return destacarErro(dataEl, "Informe a data de entrada!");
  if (!nota) return destacarErro(notaEl, "Informe o n√∫mero da nota fiscal!");
  if (!fornecedor) return destacarErro(fornecedorEl, "Informe o nome do fornecedor!");
  if (!cnpj) return destacarErro(cnpjEl, "Informe o CNPJ do fornecedor!");
  if (!validade) return destacarErro(validadeEl, "Informe a data de vencimento do material!");
  if (!setor) return destacarErro(setorEl, "Selecione o setor utilizado!");

  // Edi√ß√£o de registro existente
  if (typeof indiceEdicaoEntrada === "number" && indiceEdicaoEntrada !== null) {
    const e = window.entradas[indiceEdicaoEntrada];
    if (!e) return;
    Object.assign(e, {
      codigoProduto,
      produto,
      qtd,
      valor,
      data,
      nota,
      fornecedor,
      cnpj,
      lote,
      validade,
      setor,
      codigoBarras
    });
    mostrarMensagem(`‚úÖ Entrada de "${produto}" atualizada com sucesso!`, "sucesso");
    indiceEdicaoEntrada = null;
    if (typeof window.mostrarBotaoCancelarEntrada === "function") window.mostrarBotaoCancelarEntrada(false);
  } else {
    // Nova entrada
    const novaEntrada = { 
  produto, 
  qtd,
  valor,
  data,
  nota,
  fornecedor,
  cnpj,
  lote,
  validade,
  setor,
  codigoBarras,
  codigoProduto, // <-- ADICIONE
  id: Date.now()
};

    if (!Array.isArray(window.entradas)) window.entradas = [];
    window.entradas.push(novaEntrada);
    mostrarMensagem(`‚úÖ Entrada registrada para "${produto}"`, "sucesso");
  }

  // Atualiza produto no cat√°logo ‚Äî busca por nome, c√≥d. barras ou c√≥d. produto
  let produtoRef = (window.produtos || []).find(p =>
    (p.nome || "").toLowerCase() === produto.toLowerCase() ||
    String(p.codBarras || p.codigoBarras || "").trim() === String(codigoBarras).trim() ||
    String(p.codigo || "").trim() === String(codigoProduto).trim()
  );

  if (!produtoRef) {
    produtoRef = {
      id: Date.now(),
      codigo: codigoProduto || "",
      nome: produto,
      categoria: "N√£o especificada",
      embalagem: "",
      qtdEmbalagem: "",
      quantidade: 0
    };
    window.produtos.push(produtoRef);
  } else {
    // se existir e tiver novo c√≥digo, atualiza
    if (codigoProduto && !produtoRef.codigo) produtoRef.codigo = codigoProduto;
    if (codigoBarras && !produtoRef.codBarras) produtoRef.codBarras = codigoBarras;
  }

  // Atualiza estoque e informa√ß√µes do produto
  produtoRef.quantidade = (produtoRef.quantidade || 0) + qtd;
  produtoRef.ultimoValor = valor;
  produtoRef.lote = lote || produtoRef.lote;
  produtoRef.validade = validade || produtoRef.validade;
  produtoRef.codigoBarras = produtoRef.codigoBarras || codigoBarras;
  if (codigoProduto) produtoRef.codigo = codigoProduto;



  // Salva local & nuvem
  salvarTodosLocal?.();
  salvarProdutosNoFirebase?.(window.produtos);
  window.salvarEntradasNoFirebase?.(window.entradas);

  // Atualiza interface
  atualizarTabelaEntradas?.();
  atualizarTabelaEstoque?.();
  atualizarPainelFinanceiro?.();
  atualizarDashboard?.();

  // Limpa campos (mant√©m comportamento anterior)
  document.querySelectorAll('#entrada input, #entrada select, #entrada textarea').forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });

  document.getElementById("entradaCodigoBarras")?.focus();
  mostrarMensagem("‚úÖ Entrada salva, sincronizada e campos limpos.", "sucesso");
}






// ===============================================
// ‚úÖ LIMPAR CAMPOS DE ENTRADA (fun√ß√£o global)
// ===============================================
window.limparCamposEntrada = function () {
  // üîπ Limpa todos os campos de input, select e textarea dentro da se√ß√£o de entrada
  const formElements = document.querySelectorAll('#entrada input, #entrada select, #entrada textarea');
  formElements.forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });

  // üîπ Remove destaque visual de edi√ß√£o
  document.querySelectorAll("#tabelaEntradas tbody tr").forEach(tr => tr.style.background = "");

  // üîπ Reseta modo de edi√ß√£o e oculta bot√£o "Cancelar Edi√ß√£o"
  if (typeof indiceEdicaoEntrada !== "undefined") indiceEdicaoEntrada = null;
  if (typeof window.mostrarBotaoCancelarEntrada === "function") {
    window.mostrarBotaoCancelarEntrada(false);
  }

  // üîπ Limpa o filtro e recarrega a tabela de entradas
  const filtroEl = document.getElementById("filtroEntrada");
  if (filtroEl) filtroEl.value = "";

  if (typeof window.atualizarTabelaEntradas === "function") {
    window.atualizarTabelaEntradas(); // mostra novamente todas as entradas
  } else if (typeof window.filtrarEntradas === "function") {
    window.filtrarEntradas(); // fallback, caso a fun√ß√£o tenha outro nome
  }

  // üîπ Atualiza tamb√©m o painel financeiro, se houver
  if (typeof window.atualizarPainelFinanceiro === "function") {
    window.atualizarPainelFinanceiro();
  }

  // ‚úÖ Feedback visual
  if (typeof mostrarMensagem === "function") {
    mostrarMensagem("üßπ Campos e filtro de entrada limpos. Tabela recarregada.", "info");
  } else {
    console.log("üßπ Campos e filtro de entrada limpos. Tabela recarregada.");
  }

  // üîπ Foco de volta no leitor de c√≥digo de barras
  document.getElementById("entradaCodigoBarras")?.focus();
};






window.excluirEntrada = async function (i) {
  const e = window.entradas[i];
  if (!e) return;

  if (!confirm(`Excluir entrada do produto "${e.produto}" (Qtd: ${e.qtd || e.quantidade})?`)) return;

  try {
    // Remove do Firestore direto da subcole√ß√£o
    const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js");
    const entradaRef = doc(db, "estoqueGlobal", "estoque", "entradas", e.id);
    await deleteDoc(entradaRef);

    // Remove localmente
    window.entradas.splice(i, 1);
    salvarTodosLocal?.();

    mostrarMensagem(`? Entrada de "${e.produto}" exclu√≠da.`, "sucesso");

    // Atualiza tudo
    atualizarTabelaEntradas?.();
    atualizarTabelaEstoque?.();
    atualizarTabelaLimites?.();
    atualizarPainelFinanceiro?.();
  } catch (erro) {
    console.error("? Erro ao excluir entrada:", erro);
    mostrarMensagem("Erro ao excluir entrada do Firestore.", "erro");
  }
};

function filtrarEntradas() {
  atualizarTabelaEntradas();
}
// ADICIONE ESTA FUN√á√ÉO AO SEU <script type="module">
function aplicarMascaraCNPJ(valor) {
    // Remove tudo que n√£o for d√≠gito
    let v = valor.replace(/\D/g, "");
    
    // Aplica a m√°scara: XX.XXX.XXX/XXXX-XX
    if (v.length > 2) {
        v = v.replace(/^(\d{2})(\d)/, "$1.$2");
    }
    if (v.length > 6) {
        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
    }
    if (v.length > 10) {
        v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4");
    }
    if (v.length > 15) {
        v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
    }
    
    // Limita o tamanho m√°ximo (18 caracteres com a m√°scara)
    return v.substring(0, 18);
}
// ADICIONE ESTA FUN√á√ÉO AO SEU <script type="module">
function formatarCNPJ(input) {
    input.value = aplicarMascaraCNPJ(input.value);
}

function atualizarTabelaEntradas() {
  const tbody = document.querySelector("#tabelaEntradas tbody");
  const filtroEl = document.getElementById("filtroEntrada");
  const filtro = filtroEl ? (filtroEl.value || "").toLowerCase() : "";
  tbody.innerHTML = "";

  if (!Array.isArray(window.entradas)) window.entradas = [];

  // exibir mais recente primeiro (mantendo l√≥gica anterior)
  window.entradas.slice().reverse().forEach((e, i) => {
    const idxOriginal = window.entradas.length - 1 - i;

    const produtoLower = (e.produto || "").toLowerCase();
    const fornecedorLower = (e.fornecedor || "").toLowerCase();
    const notaLower = (e.nota || "").toLowerCase();
    const codigoProdutoLower = (e.codigoProduto || "").toLowerCase();
    const codigoBarrasLower = (e.codigoBarras || "").toLowerCase();

    if (filtro) {
      const matches = produtoLower.includes(filtro) ||
                      fornecedorLower.includes(filtro) ||
                      notaLower.includes(filtro) ||
                      codigoProdutoLower.includes(filtro) ||
                      codigoBarrasLower.includes(filtro);
      if (!matches) return;
    }

    const row = document.createElement("tr");

   row.innerHTML = `
  <td>${idxOriginal + 1}</td>

  <!-- üÜï C√≥d. Produto (Corre√ß√£o DEFINITIVA) -->
  <td title="${e.codigoProduto || (window.produtos.find(p => p.nome === e.produto)?.codigo) || '-'}">
    ${e.codigoProduto || (window.produtos.find(p => p.nome === e.produto)?.codigo) || "-"}
  </td>

  <!-- üî• PRODUTO ‚Äî coluna ampliada para melhor leitura -->
  <td 
    title="${e.produto || '-'}"
    style="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
  >
    ${e.produto || "-"}
  </td>

  <td 
    title="${e.codigoBarras || '-'}"
    onclick="copiarCodigoBarras('${e.codigoBarras || ''}')"
    style="cursor:pointer; color:#444; max-width:80px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
  >
    ${e.codigoBarras || "-"}
  </td>

  <td>${e.qtd || 0}</td>
  <td>${(e.valor || 0).toFixed(2)}</td>
  <td title="${e.data || '-'}">${e.data || "-"}</td>
  <td title="${e.nota || '-'}">${e.nota || "-"}</td>
  <td title="${e.fornecedor || '-'}">${e.fornecedor || "-"}</td>
  <td title="${e.cnpj || '-'}">${e.cnpj || "-"}</td>
  <td title="${e.lote || '-'}">${e.lote || "-"}</td>
  <td title="${e.validade || '-'}">${e.validade || "-"}</td>
  <td title="${e.setor || '-'}">${e.setor || "-"}</td>

  <td>
    <button onclick="editarEntrada(${idxOriginal})" title="Editar Entrada">
      <i class="fa fa-edit"></i>
    </button>
    <button onclick="excluirEntrada(${idxOriginal})" title="Excluir Entrada">
      <i class="fa fa-trash"></i>
    </button>
  </td>
`;


    tbody.appendChild(row);
  });
 // se n√£o houver entradas, mostra mensagem
  if ((window.entradas || []).length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="14" style="text-align:center; color:#777;">Nenhuma entrada registrada.</td>`;
    tbody.appendChild(row);
  }
}
// =============================
// ‚úÖ EDI√á√ÉO DE ENTRADAS DE MATERIAIS
// =============================

// √çndice global para controle da entrada em edi√ß√£o
let indiceEdicaoEntrada = null;

/**
 * üîπ Inicia a edi√ß√£o de uma entrada
 */
function editarEntrada(index) {
  const entrada = window.entradas[index];
  if (!entrada) return;

  indiceEdicaoEntrada = index;

  document.getElementById("entradaProduto").value = entrada.produto || "";
  document.getElementById("entradaQuantidade").value = entrada.quantidade ?? entrada.qtd ?? entrada.qtdEntrada ?? "";
  document.getElementById("entradaValor").value = entrada.valor || "";
  document.getElementById("entradaData").value = entrada.data || "";
  document.getElementById("entradaNota").value = entrada.nota || "";
  document.getElementById("entradaFornecedor").value = entrada.fornecedor || "";
  document.getElementById("entradaCNPJ").value = entrada.cnpj || "";
  document.getElementById("entradaLote").value = entrada.lote || "";
  document.getElementById("entradaValidade").value = entrada.validade || "";
  document.getElementById("entradaSetor").value = entrada.setor || "";
  document.getElementById("entradaCodigoBarras").value = entrada.codigoBarras || "";
  // novo campo
  if (document.getElementById("entradaCodigoProduto")) {
    document.getElementById("entradaCodigoProduto").value = entrada.codigoProduto || "";
  }

  // destaca a linha em edi√ß√£o
  const total = window.entradas.length;
  document.querySelectorAll("#tabelaEntradas tbody tr").forEach((tr, i) => {
    const idxOriginal = total - 1 - i;
    tr.style.background = idxOriginal === index ? "#fff3cd" : "";
  });

  // mostra bot√£o cancelar
  mostrarBotaoCancelarEntrada(true);

  mostrarMensagem(`‚úèÔ∏è Editando entrada do produto: ${entrada.produto}`, "info");
}

/**
 * üîπ Cancela a edi√ß√£o da entrada atual
 */
function cancelarEdicaoEntrada() {
  indiceEdicaoEntrada = null;
  limparCampos("entrada");

  // Remove o destaque da tabela
  document.querySelectorAll("#tabelaEntradas tbody tr").forEach((tr) => {
    tr.style.background = "";
  });

  // Esconde o bot√£o de cancelar
  mostrarBotaoCancelarEntrada(false);

  mostrarMensagem("üö´ Edi√ß√£o de entrada cancelada.", "info");
}



/* =====================================================
   üîπ AUTO-COMPLETE DIN√ÇMICO ‚Äî ENTRADA DE MATERIAIS (VERS√ÉO FINAL)
   ===================================================== */
function iniciarAutoCompleteEntrada() {

    const produtoInput = document.getElementById("entradaProduto");
    const fornecedorInput = document.getElementById("entradaFornecedor");
    const cnpjInput = document.getElementById("entradaCNPJ");

    if (!produtoInput || !fornecedorInput || !cnpjInput) {
        console.warn("‚ö†Ô∏è Campos de entrada n√£o encontrados para autocomplete.");
        return;
    }

    // üëâ Garante cont√™ineres
    const criarContainer = (id, parent) => {
        if (!document.getElementById(id)) {
            const div = document.createElement("div");
            div.id = id;
            div.className = "autocomplete-sugestoes";
            parent.style.position = "relative";
            parent.appendChild(div);
        }
    };

    criarContainer("sugestoesProduto", produtoInput.parentNode);
    criarContainer("sugestoesFornecedor", fornecedorInput.parentNode);
    criarContainer("sugestoesCNPJ", cnpjInput.parentNode);

    /* FUN√á√ÉO GEN√âRICA */
    function configurarCampo(inputEl, listaFn, sugestoesId) {
        inputEl.addEventListener("input", () => {
            const texto = inputEl.value.trim().toLowerCase();
            const container = document.getElementById(sugestoesId);
            container.innerHTML = "";

            if (!texto) return;

            // üëâ Agora a lista √© sempre atualizada na hora
            const lista = listaFn();

            const filtrados = lista
                .filter(v => v && v.toLowerCase().includes(texto))
                .slice(0, 10);

            filtrados.forEach(item => {
                const div = document.createElement("div");
                div.textContent = item;
                div.className = "sugestao-item";
                div.onclick = () => {
                    inputEl.value = item;
                    container.innerHTML = "";
                };
                container.appendChild(div);
            });
        });

        // Fecha ao clicar fora
        document.addEventListener("click", (e) => {
            if (!inputEl.contains(e.target)) {
                document.getElementById(sugestoesId).innerHTML = "";
            }
        });
    }

    // üî• Agora as listas s√£o APENAS fun√ß√µes (sempre atualizadas)
    const nomesProdutos = () =>
        [...new Set((window.produtos || []).map(p => p.nome).filter(Boolean))];

    const fornecedores = () =>
        [...new Set((window.entradas || []).map(e => e.fornecedor).filter(Boolean))];

    const cnpjs = () =>
        [...new Set((window.entradas || []).map(e => e.cnpj).filter(Boolean))];

    // Aplica autocomplete
    configurarCampo(produtoInput, nomesProdutos, "sugestoesProduto");
    configurarCampo(fornecedorInput, fornecedores, "sugestoesFornecedor");
    configurarCampo(cnpjInput, cnpjs, "sugestoesCNPJ");

    console.log("‚ú® AutoComplete Iniciado (vers√£o atualizada)");
}

/* =====================================================
   üîπ Estilos (mantidos)
   ===================================================== */
const estiloAuto = document.createElement("style");
estiloAuto.textContent = `
.autocomplete-sugestoes {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-top: none;
  max-height: 200px;
  overflow-y: auto;
  z-index: 9999;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.sugestao-item {
  padding: 6px 10px;
  cursor: pointer;
  font-size: 14px;
}
.sugestao-item:hover {
  background: #0d6efd;
  color: white;
}
`;
document.head.appendChild(estiloAuto);

/* =====================================================
   üîπ Inicializa√ß√£o INTELIGENTE
   üî• Agora funciona mesmo com snapshots e carregamento tardio dos produtos
   ===================================================== */
function esperarDadosEIniciarAutoComplete() {
    const tentar = setInterval(() => {
        if (window.produtos && window.produtos.length > 0) {
            clearInterval(tentar);
            iniciarAutoCompleteEntrada();
        }
    }, 300);
}

esperarDadosEIniciarAutoComplete();






// =============================
// ‚úÖ SA√çDA DE MATERIAIS (UNIFICADA)
// =============================

let indiceEdicaoSaida = null;

// üîπ Registrar nova sa√≠da ou atualizar uma existente
function registrarSaida() {
  limparErros("saida");

  const produto = document.getElementById("saidaProduto").value.trim();
  const qtd = parseFloat(document.getElementById("saidaQuantidade").value.trim()) || 0;
  const data = document.getElementById("saidaData").value.trim();
  const setor = document.getElementById("saidaSetor").value.trim();
  const responsavel = document.getElementById("saidaResponsavel").value.trim();
  const observacao = document.getElementById("saidaObservacao").value.trim();
  const codigoBarras = document.getElementById("saidaCodigoBarras").value.trim();

  if (!produto) return destacarErro(document.getElementById("saidaProduto"), "Informe o nome do produto!");
  if (!qtd || qtd <= 0) return destacarErro(document.getElementById("saidaQuantidade"), "Informe a quantidade!");
  if (!data) return destacarErro(document.getElementById("saidaData"), "Informe a data da sa√≠da!");
  if (!setor) return destacarErro(document.getElementById("saidaSetor"), "Selecione o setor!");
  if (!responsavel) return destacarErro(document.getElementById("saidaResponsavel"), "Informe o respons√°vel!");

  const produtoRef = window.produtos.find(p => p.nome.toLowerCase() === produto.toLowerCase());
  if (!produtoRef) return destacarErro(document.getElementById("saidaProduto"), "Produto n√£o encontrado no cadastro!");

  const estoqueAtual = Number(produtoRef.quantidade || 0);
  if (qtd > estoqueAtual) {
    return destacarErro(document.getElementById("saidaQuantidade"), `Estoque insuficiente! Restam ${estoqueAtual} unidade(s).`);
  }

  // Atualiza√ß√£o ou nova sa√≠da
  if (typeof indiceEdicaoSaida === "number" && indiceEdicaoSaida !== null) {
    const s = window.saidas[indiceEdicaoSaida];
    if (!s) return;

    Object.assign(s, { produto, qtd, data, setor, responsavel, observacao, codigoBarras });
    mostrarMensagem(`‚úÖ Sa√≠da de "${produto}" atualizada com sucesso!`, "sucesso");
    indiceEdicaoSaida = null;
    mostrarBotaoCancelarSaida(false);
  } else {
    const novaSaida = {
      produto, qtd, data, setor, responsavel, observacao, codigoBarras,
      usuario: auth.currentUser ? auth.currentUser.email : "desconhecido",
      timestamp: new Date().toISOString(),
    };
    window.saidas.push(novaSaida);
    mostrarMensagem(`‚úÖ Sa√≠da registrada para "${produto}"`, "sucesso");
  }

  // Atualiza estoque e salva
  produtoRef.quantidade = (produtoRef.quantidade || 0) - qtd;
  salvarTodosLocal();
  salvarProdutosNoFirebase(window.produtos);
  salvarSaidasNoFirebase(window.saidas);

  // Atualiza interface
  atualizarTabelaSaidas();
  atualizarTabelaEstoque();
  atualizarPainelFinanceiro?.();
  atualizarDashboard?.();

  // Limpa campos
  document.querySelectorAll("#saida input, #saida select, #saida textarea").forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });
  document.querySelectorAll("#tabelaSaidas tbody tr").forEach(tr => tr.style.background = "");
  document.getElementById("saidaCodigoBarras")?.focus();
}

// üîπ Atualiza a tabela de sa√≠das
function atualizarTabelaSaidas() {
  const tbody = document.querySelector("#tabelaSaidas tbody");
  const filtro = document.getElementById("filtroSaida")?.value.toLowerCase() || "";
  tbody.innerHTML = "";

  window.saidas.slice().reverse().forEach((s, i) => {
    const idxOriginal = window.saidas.length - 1 - i;
    const produto = (s.produto || "").toLowerCase();
    const responsavel = (s.responsavel || "").toLowerCase();
    const setor = (s.setor || "").toLowerCase();

    if (filtro && !produto.includes(filtro) && !responsavel.includes(filtro) && !setor.includes(filtro)) return;

    const row = document.createElement("tr");
  row.innerHTML = `
  <td>${idxOriginal + 1}</td>

  <!-- C√≥d. Produto (usa o valor salvo na sa√≠da ou busca no cadastro pelo nome) -->
  <td title="${s.codigoProduto || (window.produtos.find(p => p.nome === s.produto)?.codigo) || '-'}">
    ${s.codigoProduto || (window.produtos.find(p => p.nome === s.produto)?.codigo) || "-"}
  </td>

  <!-- Produto (coluna maior para leitura) -->
  <td 
    title="${s.produto || '-'}"
    style="max-width:240px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
  >
    ${s.produto || "-"}
  </td>

  <!-- C√≥digo de Barras (coluna reduzida) -->
  <td
    title="${s.codigoBarras || '-'}"
    onclick="copiarCodigoBarras('${s.codigoBarras || ''}')"
    style="cursor:pointer; color:#444; max-width:100px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
  >
    ${s.codigoBarras || "-"}
  </td>

  <td>${s.qtd || 0}</td>
  <td title="${s.data || '-'}">${s.data || "-"}</td>
  <td title="${s.setor || '-'}">${s.setor || "-"}</td>
  <td title="${s.responsavel || '-'}">${s.responsavel || "-"}</td>
  <td title="${s.observacao || '-'}" style="max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
    ${s.observacao || "-"}
  </td>

  <td>
    <button onclick="editarSaida(${idxOriginal})" title="Editar Sa√≠da"><i class="fa fa-edit"></i></button>
    <button onclick="excluirSaida(${idxOriginal})" title="Excluir Sa√≠da"><i class="fa fa-trash"></i></button>
  </td>
`;


    tbody.appendChild(row);
  });
}

// üîπ Editar, cancelar e excluir
function editarSaida(index) {
  const s = window.saidas[index];
  if (!s) return;

  indiceEdicaoSaida = index;

  document.getElementById("saidaProduto").value = s.produto || "";
  document.getElementById("saidaQuantidade").value = s.qtd ?? s.quantidade ?? "";
  document.getElementById("saidaResponsavel").value = s.responsavel || "";
  document.getElementById("saidaObservacao").value = s.observacao || "";
  document.getElementById("saidaSetor").value = s.setor || "";
  document.getElementById("saidaData").value = s.data || "";
  document.getElementById("saidaCodigoBarras").value = s.codigoBarras || "";

   const total = window.saidas.length;
  document.querySelectorAll("#tabelaSaidas tbody tr").forEach((tr, i) => {
    const idxOriginal = total - 1 - i;
    tr.style.background = idxOriginal === index ? "#fff3cd" : "";
  });

  mostrarBotaoCancelarSaida(true);
  mostrarMensagem(`‚úèÔ∏è Editando sa√≠da de: ${s.produto}`, "info");
}
// üîπ Alias para permitir que o campo de filtro funcione corretamente
function filtrarSaidas() {
  // apenas reaproveita a fun√ß√£o existente
  if (typeof atualizarTabelaSaidas === "function") {
    atualizarTabelaSaidas();
  }
}


function cancelarEdicaoSaida() {
  indiceEdicaoSaida = null;
  limparCampos("saida");
  document.querySelectorAll("#tabelaSaidas tbody tr").forEach(tr => tr.style.background = "");
  mostrarBotaoCancelarSaida(false);
  mostrarMensagem("üö´ Edi√ß√£o de sa√≠da cancelada.", "info");
}

function mostrarBotaoCancelarSaida(exibir) {
  let botaoCancelar = document.getElementById("botaoCancelarEdicaoSaida");
  if (exibir) {
    if (!botaoCancelar) {
      botaoCancelar = document.createElement("button");
      botaoCancelar.id = "botaoCancelarEdicaoSaida";
      botaoCancelar.textContent = "Cancelar Edi√ß√£o";
      botaoCancelar.style.background = "#dc3545";
      botaoCancelar.style.color = "#fff";
      botaoCancelar.style.marginLeft = "10px";
      botaoCancelar.style.borderRadius = "5px";
      botaoCancelar.onclick = cancelarEdicaoSaida;

      const botaoRegistrar = document.querySelector('#saida button[onclick*="registrarSaida"]');
      if (botaoRegistrar) botaoRegistrar.insertAdjacentElement("afterend", botaoCancelar);
    }
  } else if (botaoCancelar) botaoCancelar.remove();
}

function excluirSaida(i) {
  const s = window.saidas[i];
  if (!s) return;

  if (!confirm(`Excluir sa√≠da do produto "${s.produto}" (Qtd: ${s.qtd || s.quantidade})?`)) return;

  window.saidas.splice(i, 1);

  salvarSaidasNoFirebase(window.saidas);
  salvarTodosLocal();

  mostrarMensagem(`üóëÔ∏è Sa√≠da de "${s.produto}" exclu√≠da.`, "sucesso");

  // üîÅ Atualiza tudo
  if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
  if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
  if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
  if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
}

// üîπ Fun√ß√£o para limpar todos os campos da Sa√≠da de Materiais
function limparCamposSaida() {
  const formElements = document.querySelectorAll('#saida input, #saida select, #saida textarea');

  formElements.forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") {
      el.checked = false;
    } else {
      el.value = "";
    }
  });

  // Remove destaque da tabela e reseta edi√ß√£o
  document.querySelectorAll("#tabelaSaidas tbody tr").forEach(tr => tr.style.background = "");
  indiceEdicaoSaida = null;
  if (typeof mostrarBotaoCancelarSaida === "function") {
    mostrarBotaoCancelarSaida(false);
  }

  mostrarMensagem("üßπ Campos da sa√≠da limpos!", "info");
  document.getElementById("saidaCodigoBarras")?.focus();
}


// üîπ Setor autom√°tico
function atualizarSetorAutomatico() {
  const produtoInput = document.getElementById("saidaProduto");
  const setorSelect = document.getElementById("saidaSetor");
  const codigoInput = document.getElementById("saidaCodigoBarras");
  
  if (!produtoInput || !setorSelect) return;

  const nomeProduto = produtoInput.value.trim();
  const codigo = codigoInput ? codigoInput.value.trim() : "";
  let entradaEncontrada = null;

  if (codigo && Array.isArray(produtos)) {
    const produto = produtos.find(p => p.codigoBarras === codigo);
    if (produto) entradaEncontrada = entradas.slice().reverse().find(e => e.produto === produto.nome);
  }

  if (!entradaEncontrada && nomeProduto) {
    entradaEncontrada = entradas.slice().reverse().find(e => e.produto.toLowerCase() === nomeProduto.toLowerCase());
  }

  const setoresUnicos = Array.from(new Set(entradas.map(e => e.setor).filter(s => s)));
  setorSelect.innerHTML = '<option value="">Selecione o Setor</option>';
  setoresUnicos.forEach(setor => {
    const option = document.createElement("option");
    option.value = setor;
    option.textContent = setor;
    setorSelect.appendChild(option);
  });
  
  if (entradaEncontrada && entradaEncontrada.setor) {
    setorSelect.value = entradaEncontrada.setor;
  }
}

function atualizarSetoresPorProduto() {
  const produtoNome = document.getElementById("saidaProduto").value.trim();
  const setorSelect = document.getElementById("saidaSetor");
  setorSelect.innerHTML = `<option value="">Selecione o Setor</option>`;

  if (!produtoNome) return;

  const setoresCompletos = [
    "Limpeza da Cl√≠nica",
    "Laborat√≥rio",
    "Escrit√≥rio",
    "Copa e Cozinha",
    "Cl√≠nico Geral",
    "Centro Cir√∫rgico"
  ];

  setorSelect.innerHTML = setoresCompletos
    .map(s => `<option value="${s}">${s}</option>`)
    .join("");
}
/* =====================================================
   üîπ AUTO-COMPLETE DIN√ÇMICO ‚Äî SA√çDA DE MATERIAIS
   ===================================================== */
function iniciarAutoCompleteSaida() {
  const saidaProdutoInput = document.getElementById("saidaProduto");

  if (!saidaProdutoInput) {
    console.warn("‚ö†Ô∏è Campo de produto da sa√≠da n√£o encontrado.");
    return;
  }

  // üü¢ Cria o container de sugest√µes se n√£o existir
  if (!document.getElementById("sugestoesSaidaProduto")) {
    const sug = document.createElement("div");
    sug.id = "sugestoesSaidaProduto";
    sug.className = "autocomplete-sugestoes";
    saidaProdutoInput.parentNode.style.position = "relative";
    saidaProdutoInput.parentNode.appendChild(sug);
  }

  // üîπ Dados √∫nicos de produtos
  const nomesProdutos = [...new Set((window.produtos || []).map(p => p.nome).filter(Boolean))];

  // üß† Evento de digita√ß√£o
  saidaProdutoInput.addEventListener("input", () => {
    const texto = saidaProdutoInput.value.trim().toLowerCase();
    const container = document.getElementById("sugestoesSaidaProduto");
    container.innerHTML = "";
    if (!texto) return;

    const filtrados = nomesProdutos
      .filter((v) => v && v.toLowerCase().includes(texto))
      .slice(0, 10); // limita a 10 resultados

    filtrados.forEach((item) => {
      const div = document.createElement("div");
      div.textContent = item;
      div.className = "sugestao-item";
      div.onclick = () => {
        saidaProdutoInput.value = item;
        container.innerHTML = "";
      };
      container.appendChild(div);
    });
  });

  // üîπ Fecha sugest√µes ao clicar fora
  document.addEventListener("click", (e) => {
    if (!saidaProdutoInput.contains(e.target)) {
      const sug = document.getElementById("sugestoesSaidaProduto");
      if (sug) sug.innerHTML = "";
    }
  });

  console.log("‚ú® AutoComplete din√¢mico de Sa√≠da iniciado com sucesso.");
}
/* =====================================================
   üîπ ESTILO DO AUTO-COMPLETE (caso ainda n√£o exista)
   ===================================================== */
if (!document.getElementById("estiloAutoCompleteSaida")) {
  const estiloAuto = document.createElement("style");
  estiloAuto.id = "estiloAutoCompleteSaida";
  estiloAuto.textContent = `
.autocomplete-sugestoes {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-top: none;
  max-height: 200px;
  overflow-y: auto;
  z-index: 9999;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.sugestao-item {
  padding: 6px 10px;
  cursor: pointer;
  font-size: 14px;
}
.sugestao-item:hover {
  background: #0d6efd;
  color: white;
}
`;
  document.head.appendChild(estiloAuto);
}
function buscarSaidaPorCodigoBarras() {
  const campoCodigoBarras = document.getElementById("saidaCodigoBarras");
  const campoProduto = document.getElementById("saidaProduto");
  const campoCodigoProduto = document.getElementById("saidaCodigoProduto");

  const codigo = campoCodigoBarras.value.trim();
  if (!codigo) return;

  const produto = (window.produtos || []).find(p =>
    String(p.codBarras || p.codigoBarras || "").trim() === codigo
  );

  if (!produto) {
    campoCodigoBarras.style.border = "2px solid red";
    return;
  }

  campoProduto.value = produto.nome || "";
  campoCodigoProduto.value = produto.codigo || "";  // <<< AQUI!
  campoCodigoBarras.style.border = "1px solid #ccc";
}

function buscarSaidaPorCodigoProduto() {
  const campoCodigoProduto = document.getElementById("saidaCodigoProduto");
  const campoProduto = document.getElementById("saidaProduto");
  const campoCodigoBarras = document.getElementById("saidaCodigoBarras");

  const codDigitado = campoCodigoProduto.value.trim().toLowerCase();
  if (!codDigitado) return;

  const produto = (window.produtos || []).find(p =>
    String(p.codigo || "").trim().toLowerCase() === codDigitado
  );

  if (!produto) {
    campoCodigoProduto.style.border = "2px solid red";
    return;
  }

  campoProduto.value = produto.nome || "";
  campoCodigoBarras.value = produto.codBarras || produto.codigoBarras || "";
  campoCodigoProduto.style.border = "1px solid #ccc";
}
function buscarSaidaPorNomeProduto() {
  const campoProduto = document.getElementById("saidaProduto");
  const campoCodigoProduto = document.getElementById("saidaCodigoProduto");
  const campoCodigoBarras = document.getElementById("saidaCodigoBarras");

  const nome = campoProduto.value.trim().toLowerCase();
  if (!nome) return;

  const produto = (window.produtos || []).find(p =>
    String(p.nome || "").trim().toLowerCase() === nome
  );

  if (!produto) {
    campoProduto.style.border = "2px solid red";
    return;
  }

  campoCodigoProduto.value = produto.codigo || "";
  campoCodigoBarras.value = produto.codBarras || produto.codigoBarras || "";
  campoProduto.style.border = "1px solid #ccc";
}

// üìå COLE AQUI OS EVENTOS AUTOM√ÅTICOS
document.getElementById("saidaCodigoBarras")
  ?.addEventListener("blur", buscarSaidaPorCodigoBarras);
document.getElementById("saidaCodigoProduto")
  ?.addEventListener("blur", buscarSaidaPorCodigoProduto);
document.getElementById("saidaProduto")
  ?.addEventListener("blur", buscarSaidaPorNomeProduto);
  
// üîÅ Inicializa o autocompletar ap√≥s 1 segundo (garante que os produtos j√° foram carregados)
setTimeout(iniciarAutoCompleteSaida, 1000);

// ============================================================
// üì¶ ESTOQUE ATUAL ‚Äî Vers√£o corrigida (n√£o sobrescreve dados)
// ============================================================
window.atualizarTabelaEstoque = function (filtroTexto = "") {
  const tabela = document.querySelector("#tabelaEstoque tbody");
  if (!tabela) return;

  const filtro = (filtroTexto || (document.getElementById("filtroEstoque")?.value || "")).toLowerCase().trim();
  tabela.innerHTML = "";

  const entradas = Array.isArray(window.entradas) ? window.entradas : [];
  const saidas = Array.isArray(window.saidas) ? window.saidas : [];
  const produtosCatalogo = Array.isArray(window.produtos) ? [...window.produtos] : [];

  // Mapa por nome normalizado para somar entradas/sa√≠das e guardar √∫ltima entrada
  const mapa = {}; // { chaveNome: { quantidade: number, ultimaEntrada: entryObject } }
  const norm = s => (String(s || "").toLowerCase().trim());

  // Agrega entradas
  entradas.forEach(e => {
    const chave = norm(e.produto || e.nomeProduto);
    if (!chave) return;
    mapa[chave] = mapa[chave] || { quantidade: 0, ultimaEntrada: null };
    mapa[chave].quantidade += Number(e.qtd || e.quantidade || 0);
    // considera como "√∫ltima" a mais recente por data (se existir)
    if (!mapa[chave].ultimaEntrada) mapa[chave].ultimaEntrada = e;
    else {
      const atual = mapa[chave].ultimaEntrada;
      // compara datas se existirem no formato YYYY-MM-DD
      const dataAtual = new Date(atual.data || atual.dataEntrada || 0);
      const dataNovo = new Date(e.data || e.dataEntrada || 0);
      if (dataNovo > dataAtual) mapa[chave].ultimaEntrada = e;
    }
  });

  // Subtrai sa√≠das
  saidas.forEach(s => {
    const chave = norm(s.produto || s.nomeProduto);
    if (!chave) return;
    mapa[chave] = mapa[chave] || { quantidade: 0, ultimaEntrada: null };
    mapa[chave].quantidade -= Number(s.qtd || s.quantidade || 0);
  });

  // Garante que n√£o haja negativos
  Object.keys(mapa).forEach(k => {
    if (mapa[k].quantidade < 0) mapa[k].quantidade = 0;
  });

  // Prepara lista final de exibi√ß√£o: TODOS os produtos do cat√°logo (mantendo metadados)
  const produtosParaExibir = produtosCatalogo.map(p => {
    const chave = norm(p.nome || p.id || p.codigoBarras);
    const infoMov = mapa[chave] || { quantidade: 0, ultimaEntrada: null };

    // Se n√£o houver correspond√™ncia por nome, tenta por c√≥digo de barras
    if (infoMov.quantidade === 0 && (p.codigoBarras || p.codBarras)) {
      const cb = String(p.codigoBarras || p.codBarras);
      // procura entradas por c√≥digo
      const entradasPorCB = entradas.filter(en => String(en.codigoBarras || en.codBarras || "") === cb);
      if (entradasPorCB.length > 0) {
        // calcula quantidade e pega ultima entrada por data
        let qtd = 0;
        let ultima = null;
        entradasPorCB.forEach(en => {
          qtd += Number(en.qtd || 0);
          if (!ultima) ultima = en;
          else if (new Date(en.data || 0) > new Date(ultima.data || 0)) ultima = en;
        });
        // subtrai saidas por codigo de barras
        const saidasPorCB = saidas.filter(s => String(s.codigoBarras || s.codBarras || "") === cb);
        saidasPorCB.forEach(s => qtd -= Number(s.qtd || 0));
        if (qtd < 0) qtd = 0;
        infoMov.quantidade = qtd;
        infoMov.ultimaEntrada = ultima;
      }
    }

    // monta objeto final sem sobrescrever propriedades importantes
    return {
      _orig: p,
      nome: p.nome || "-",
      codigoBarras: p.codigoBarras || p.codBarras || "-",
      categoria: p.categoria || "-",
      quantidade: typeof infoMov.quantidade === "number" ? infoMov.quantidade : (p.quantidade || 0),
      lote: (infoMov.ultimaEntrada && infoMov.ultimaEntrada.lote) || p.lote || "-",
      ultimoValor: (infoMov.ultimaEntrada && (Number(infoMov.ultimaEntrada.valor || infoMov.ultimaEntrada.valorUnitario || 0))) || (p.ultimoValor || 0),
      validade: (infoMov.ultimaEntrada && infoMov.ultimaEntrada.validade) || p.validade || "-",
      statusOk: ( (typeof infoMov.quantidade === "number" ? infoMov.quantidade : (p.quantidade || 0)) > 0 ),
      foto: p.foto || p.imagem || "",
    };
  });

  // Se quiser incluir produtos que est√£o somente nas movimenta√ß√µes (sem cadastro), adicione-os:
  Object.keys(mapa).forEach(chaveMov => {
    const existe = produtosParaExibir.some(pp => norm(pp.nome) === chaveMov);
    if (!existe) {
      const inf = mapa[chaveMov];
      produtosParaExibir.push({
        _orig: null,
        nome: chaveMov,
        codigoBarras: "-",
        categoria: "-",
        quantidade: inf.quantidade,
        lote: inf.ultimaEntrada?.lote || "-",
        ultimoValor: Number(inf.ultimaEntrada?.valor || 0),
        validade: inf.ultimaEntrada?.validade || "-",
        statusOk: inf.quantidade > 0,
        foto: ""
      });
    }
  });

  // Ordena alfabeticamente pelo nome (pt-BR)
  produtosParaExibir.sort((a, b) => (String(a.nome || "").toLowerCase()).localeCompare(String(b.nome || "").toLowerCase(), 'pt-BR'));

  // Filtra para UI ‚Äî AGORA COMPLETO
const filtrados = produtosParaExibir.filter(p => {
  if (!filtro) return true;

  return (
    String(p._orig?.codigo || "").toLowerCase().includes(filtro) ||  // C√≥d. Produto
    String(p.nome || "").toLowerCase().includes(filtro) ||           // Produto
    String(p.codigoBarras || "").toLowerCase().includes(filtro) ||   // C√≥digo de Barras
    String(p.categoria || "").toLowerCase().includes(filtro) ||      // Categoria
    String(p.quantidade || "").toLowerCase().includes(filtro) ||     // Quantidade
    String(p.lote || "").toLowerCase().includes(filtro) ||           // Lote
    String(p.ultimoValor || "").toLowerCase().includes(filtro) ||    // √öltimo Valor (R$)
    String(p.validade || "").toLowerCase().includes(filtro)          // Validade
  );
});
function formatarDataBR(dataISO) {
  if (!dataISO || dataISO === "-") return "-";
  const partes = dataISO.split("-");
  if (partes.length !== 3) return dataISO;
  return `${partes[2]}-${partes[1]}-${partes[0]}`;
}


  // Renderiza
  if (filtrados.length === 0) {
    tabela.innerHTML = `<tr><td colspan="9" style="text-align:center; color:#888;">Nenhum produto encontrado no estoque atual.</td></tr>`;
  } else {
    filtrados.forEach((p, i) => {
      const valor = Number(p.ultimoValor || 0);
      const tr = document.createElement("tr");
 tr.innerHTML = `
  <td>${i + 1}</td>

  <!-- üü¶ C√ìD. PRODUTO ‚Äî agora REALMENTE PEQUENO -->
  <td 
    style="max-width:45px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
    title="${p._orig?.codigo || '-'}"
  >
    ${p._orig?.codigo || "-"}
  </td>

  <!-- üü© PRODUTO (mantido grande para leitura) -->
  <td 
    style="max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
    title="${p.nome || '-'}"
  >
    ${p.nome || "-"}
  </td>

  <!-- üü´ C√ìDIGO DE BARRAS -->
  <td 
    style="max-width:90px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
    title="${p.codigoBarras || '-'}"
  >
    ${p.codigoBarras || "-"}
  </td>

  <!-- üü® CATEGORIA ‚Äî ampliada para mostrar nomes completos -->
  <td 
    style="max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
    title="${p.categoria || '-'}"
  >
    ${p.categoria || "-"}
  </td>

  <!-- üü• QUANTIDADE -->
  <td style="text-align:center;">${p.quantidade}</td>

  <!-- LOTE -->
  <td>${p.lote || "-"}</td>

  <!-- üü™ √öLTIMO VALOR ‚Äî centralizado -->
  <td 
    style="max-width:85px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
    title="${valor ? valor.toFixed(2) : '-'}"
  >
    ${valor ? valor.toFixed(2) : "-"}
  </td>

 <!-- VALIDADE (formato BR DD-MM-YYYY) -->
<td 
  style="max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
  title="${formatarDataBR(p.validade)}"
>
  ${formatarDataBR(p.validade)}
</td>


  <!-- STATUS -->
  <td style="font-weight:bold; color:${p.statusOk ? '#198754' : '#dc3545'};">
    ${p.statusOk ? "‚úÖ Em Estoque" : "‚ùå Zerado"}
  </td>
`;




      tabela.appendChild(tr);
    });
  }

  // Atualiza label de hora (n√£o salva dados aqui)
  const lbl = document.getElementById("ultimaAtualizacaoEstoque");
  if (lbl) lbl.textContent = "√öltima atualiza√ß√£o: " + new Date().toLocaleString();
};


// ============================================================
// üîç FILTRO DIN√ÇMICO ‚Äî executa enquanto o usu√°rio digita
// ============================================================
function filtrarEstoque() {
  const campo = document.getElementById("filtroEstoque");
  if (!campo) return;
  const texto = campo.value.toLowerCase().trim();
  atualizarTabelaEstoque(texto);
}

// ============================================================
// üßπ LIMPAR FILTRO ‚Äî bot√£o ‚ÄúLimpar‚Äù
// ============================================================
function limparFiltroEstoque() {
  const campoTexto = document.getElementById("filtroEstoque");
  const campoCategoria = document.getElementById("filtroCategoria"); // ID do select de categorias

  // 1Ô∏è‚É£ Limpa o texto digitado no filtro
  if (campoTexto) campoTexto.value = "";

  // 2Ô∏è‚É£ Volta o select para "Todas as Categorias"
  if (campoCategoria) campoCategoria.value = "";

  // 3Ô∏è‚É£ Recarrega a tabela completa
  atualizarTabelaEstoque();

  // 4Ô∏è‚É£ Foco no campo de busca
  campoTexto?.focus();
}

// =============================================================
// üîÑ Recalcula Estoque Geral ‚Äî vers√£o limpa e sincronizada
// =============================================================
function recalcularEstoqueGeral() {
  if (!Array.isArray(window.produtos)) window.produtos = [];
  if (!Array.isArray(window.entradas)) window.entradas = [];
  if (!Array.isArray(window.saidas)) window.saidas = [];

  // ‚ö†Ô∏è 1Ô∏è‚É£ Nenhuma entrada/sa√≠da ‚Üí zera tudo
  if (window.entradas.length === 0 && window.saidas.length === 0) {
    (window.produtos || []).forEach(p => {
      p.quantidade = 0;
      p.ultimoValor = 0;
      p.lote = "";
      p.validade = "";
    });

    salvarTodosLocal?.();
    if (typeof salvarProdutosNoFirebase === "function") salvarProdutosNoFirebase(window.produtos);

    atualizarTabelaEstoque?.();
    atualizarTabelaLimites?.();
    atualizarDashboard?.();
    atualizarPainelFinanceiro?.();

    console.log("üßæ Nenhuma movimenta√ß√£o ‚Äî estoque e metadados zerados.");
    mostrarMensagem?.("üßæ Estoque zerado (sem entradas/sa√≠das registradas).", "info");
    return;
  }

  // üîπ 2Ô∏è‚É£ Recalcula com base em entradas e sa√≠das
  const mapa = {};
  window.produtos.forEach(p => {
    mapa[p.nome?.toLowerCase() || p.id] = {
      quantidade: 0,
      ultimoValor: 0,
      lote: "",
      validade: "",
      pRef: p
    };
  });

  // ‚ûï Soma ENTRADAS
  (window.entradas || []).forEach(en => {
    const chave = (en.produto || "").toLowerCase();
    const m = mapa[chave] || mapById(en.codigoBarras) || null;
    if (m) {
      m.quantidade += Number(en.qtd || 0);
      if (en.valor || en.valor === 0) m.ultimoValor = Number(en.valor);
      if (en.lote) m.lote = en.lote;
      if (en.validade) m.validade = en.validade;
    }
  });

  // ‚ûñ Subtrai SA√çDAS
  (window.saidas || []).forEach(s => {
    const chave = (s.produto || "").toLowerCase();
    const m = mapa[chave] || mapById(s.codigoBarras) || null;
    if (m) m.quantidade -= Number(s.qtd || 0);
  });

  // üîÑ 3Ô∏è‚É£ Aplica resultados recalculados
  Object.values(mapa).forEach(entry => {
    if (!entry.pRef) return;
    entry.pRef.quantidade = Math.max(0, entry.quantidade);
    entry.pRef.ultimoValor = entry.ultimoValor || 0;
    entry.pRef.lote = entry.lote || "";
    entry.pRef.validade = entry.validade || "";
  });

  // üíæ 4Ô∏è‚É£ Salva e atualiza interface
  salvarTodosLocal?.();
  if (typeof salvarProdutosNoFirebase === "function") salvarProdutosNoFirebase(window.produtos);

  mostrarMensagem?.("‚úÖ Estoque recalculado automaticamente.", "sucesso");
  atualizarTabelaEstoque?.();
  atualizarTabelaLimites?.();
  atualizarDashboard?.();
  atualizarPainelFinanceiro?.();

  // üîç Fun√ß√£o auxiliar
  function mapById(cod) {
    if (!cod) return null;
    const p = window.produtos.find(p => String(p.codigoBarras || p.codBarras || p.id) === String(cod));
    return p ? { ...p, pRef: p } : null;
  }
}



// ============================================================
// ‚ö° ATUALIZA√á√ÉO AUTOM√ÅTICA AP√ìS MOVIMENTA√á√ïES ‚Äî vers√£o final
// ============================================================
["registrarEntrada", "registrarSaida", "excluirEntrada", "excluirSaida"].forEach(nomeFunc => {
  const original = window[nomeFunc];
  if (typeof original === "function") {
    window[nomeFunc] = function (...args) {
      const resultado = original.apply(this, args);
      setTimeout(() => {
        recalcularEstoqueGeral();     // üîÅ Atualiza tudo (estoque real)
        atualizarTabelaEstoque?.();   // üìä Estoque atual
        atualizarTabelaLimites?.();   // üìâ Estoque m√≠nimo/m√°ximo
        atualizarDashboard?.();       // üìà Painel principal
        atualizarPainelFinanceiro?.();// üí∞ Financeiro
      }, 300);
      return resultado;
    };
  }
});



// ============================================================
// üìä ESTOQUE M√çNIMO E M√ÅXIMO ‚Äî Sincronizado com estoque real
// ============================================================
function atualizarTabelaLimites(filtroTexto = "") {
  const tabela = document.querySelector("#tabelaLimites tbody");
  if (!tabela) return;

  const produtos = Array.isArray(window.produtos) ? window.produtos : [];
  const entradas = Array.isArray(window.entradas) ? window.entradas : [];
  const saidas = Array.isArray(window.saidas) ? window.saidas : [];
  const resumoDiv = document.getElementById("resumoLimites");

  const filtro = filtroTexto.toLowerCase().trim() ||
    (document.getElementById("filtroLimites")?.value || "").toLowerCase().trim();

  tabela.innerHTML = "";

  // ‚ö†Ô∏è Caso n√£o haja movimenta√ß√µes (entradas/sa√≠das) ‚Üí mostra zerado
  if (entradas.length === 0 && saidas.length === 0) {
    produtos.forEach(p => { p.quantidade = 0; });
    salvarTodosLocal?.();
    if (typeof salvarProdutosNoFirebase === "function") salvarProdutosNoFirebase(produtos);

    tabela.innerHTML = `
      <tr>
        <td colspan="10" style="text-align:center; color:#888; padding: 20px;">
          Nenhuma movimenta√ß√£o registrada ‚Äî Estoque zerado.
        </td>
      </tr>`;
    if (resumoDiv)
      resumoDiv.innerHTML = `
        üßæ Total de Produtos: ${produtos.length} |
        ‚ö†Ô∏è Abaixo do M√≠nimo: 0 |
        ‚úÖ Dentro do Limite: 0 |
        üì¶ Acima do M√°ximo: 0`;
    return;
  }

  // üîπ C√°lculo real da quantidade atual (entradas - sa√≠das)
  const mapaEstoque = {};
  produtos.forEach(p => { mapaEstoque[p.nome] = 0; });

  entradas.forEach(e => {
    const nome = e.produto || e.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] += Number(e.qtd || e.quantidade || 0);
  });

  saidas.forEach(s => {
    const nome = s.produto || s.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] -= Number(s.qtd || s.quantidade || 0);
  });

  // üîÑ Atualiza cada produto com a quantidade real recalculada
  produtos.forEach(p => {
    p.quantidade = Math.max(0, mapaEstoque[p.nome] ?? 0);
  });

  salvarTodosLocal?.();
  if (typeof salvarProdutosNoFirebase === "function") salvarProdutosNoFirebase(produtos);


  let total = 0, abaixo = 0, dentro = 0, acima = 0;

  // üîç Filtro + status + recomenda√ß√£o
  let produtosFiltrados = produtos.filter(p => {
    const filtroTxt = filtro.toLowerCase();

    const nome = (p.nome || "").toLowerCase();
    const categoria = (p.categoria || "").toLowerCase();
    const codProduto = (p.codigo || "").toLowerCase();
    const codBarras = (p.codigoBarras || "").toLowerCase();
    
    const qtd = Number(mapaEstoque[p.nome] ?? p.quantidade ?? 0);
    const textoQtd = String(qtd);

    const minimo = Number(p.minimo || 0);
    const maximo = Number(p.maximo || 0);

    let status = "‚úÖ Dentro do Limite";
    let recomendacao = "Estoque ideal";

    if (qtd < minimo) {
      status = "‚ö†Ô∏è Abaixo do M√≠nimo";
      recomendacao = `Comprar ${maximo - qtd}`;
    } else if (maximo > 0 && qtd > maximo) {
      status = "üì¶ Acima do M√°ximo";
      recomendacao = `Reduzir novas entradas (${qtd - maximo} excedentes)`;
    }

    const textoStatus = status.toLowerCase();
    const textoRecomendacao = recomendacao.toLowerCase();

    if (!filtroTxt) return true;

    return (
      codProduto.includes(filtroTxt) ||
      nome.includes(filtroTxt) ||
      codBarras.includes(filtroTxt) ||
      categoria.includes(filtroTxt) ||
      textoQtd.includes(filtroTxt) ||
      textoStatus.includes(filtroTxt) ||
      textoRecomendacao.includes(filtroTxt)
    );
  });

  // üü¶ FILTRO DE CATEGORIA ‚Äî MOSTRA APENAS OS PRODUTOS DA CATEGORIA ESCOLHIDA
  const categoriaSelecionada = document.getElementById("filtroCategoria")?.value || "";
  if (categoriaSelecionada) {
    produtosFiltrados = produtosFiltrados.filter(p =>
      (p.categoria || "") === categoriaSelecionada
    );
  }
// ‚úÖ ORDENAR PRODUTOS POR NOME (A ‚Üí Z)
produtosFiltrados.sort((a, b) =>
  (a.nome || "").localeCompare(b.nome || "", "pt-BR", { sensitivity: "base" })
);
  // üî∏ Monta a tabela
  produtosFiltrados.forEach((p, i) => {
    total++;

    let qtd = mapaEstoque[p.nome] ?? p.quantidade ?? 0;
    if (qtd < 0) qtd = 0;

    const minimo = Number(p.minimo || 0);
    const maximo = Number(p.maximo || 0);

    let status = "‚úÖ Dentro do Limite";
    let recomendacao = "Estoque ideal";

    if (qtd < minimo) {
      status = "‚ö†Ô∏è Abaixo do M√≠nimo";
      recomendacao = `Comprar ${maximo - qtd}`;
      abaixo++;
    } else if (maximo > 0 && qtd > maximo) {
      status = "üì¶ Acima do M√°ximo";
      recomendacao = `Reduzir novas entradas (${qtd - maximo} excedentes)`;
      acima++;
    } else {
      dentro++;
    }

    const corStatus =
      status.includes("Abaixo") ? "#dc3545" :
      status.includes("Acima") ? "#fd7e14" : "#198754";

    const linha = document.createElement("tr");
  linha.innerHTML = `
  <td>${i + 1}</td>

 <!-- üÜï C√ìD. PRODUTO ‚Äî agora menor e alinhado √† esquerda -->
<td 
  style="max-width:30px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left;"
  title="${p.codigo || '-'}"
>
  ${p.codigo || "-"}
</td>

  <!-- PRODUTO (MAIOR) -->
  <td style="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
      title="${p.nome || '-'}">
    ${p.nome || "-"}
  </td>

  <!-- C√ìDIGO DE BARRAS (MENOR) -->
  <td style="max-width:80px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;"
      title="${p.codigoBarras || '-'}"
      onclick="copiarCodigoBarras('${p.codigoBarras || ''}')">
    ${p.codigoBarras || "-"}
  </td>

  <!-- CATEGORIA (MAIOR) -->
  <td style="max-width:160px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
      title="${p.categoria || '-'}">
    ${p.categoria || "-"}
  </td>

  <td style="text-align:center;">${qtd}</td>

  <td>
  <input 
    type="number" 
     id="min_${p.codigo || p.nome.replace(/\s+/g,'_')}"
    value="${minimo}" 
    style="width:55px; padding:3px; text-align:center;"
  >
</td>

<td>
  <input 
    type="number" 
    id="max_${p.codigo || p.nome.replace(/\s+/g,'_')}"
    value="${maximo}" 
    style="width:55px; padding:3px; text-align:center;"
  >
</td>

  <!-- STATUS (MAIOR) -->
  <td style="font-weight:bold; color:${corStatus}; white-space:nowrap; max-width:160px; text-overflow:ellipsis; overflow:hidden;">
    ${status}
  </td>

  <!-- RECOMENDA√á√ÉO -->
  <td style="max-width:160px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
    ${recomendacao}
  </td>

  <!-- A√á√ïES (MAIS LARGA) -->
  <td style="text-align:center; width:90px;">
  <button onclick="salvarLimites('${p.codigo || p.nome.replace(/\s+/g,'_')}')" title="Salvar Limites" style="margin-right:5px;">
    <i class="fa fa-save"></i>
  </button>
</td>
`;



    tabela.appendChild(linha);
  });

  // üî∏ Atualiza o resumo
  if (resumoDiv) {
    resumoDiv.innerHTML = `
      üßæ Total de Produtos: ${total} |
      ‚ö†Ô∏è Abaixo do M√≠nimo: ${abaixo} |
      ‚úÖ Dentro do Limite: ${dentro} |
      üì¶ Acima do M√°ximo: ${acima}
    `;
  }
}


// ============================================================
// üîç Filtro din√¢mico ‚Äî ao digitar
// ============================================================
function filtrarLimites() {
  const campo = document.getElementById("filtroLimites");
  if (!campo) return;
  const texto = campo.value.toLowerCase().trim();
  atualizarTabelaLimites(texto);
}

// ============================================================
// üßπ Limpar filtro ‚Äî bot√£o ‚ÄúLimpar‚Äù
// ============================================================
function limparFiltroLimites() {
  const campo = document.getElementById("filtroLimites");
  if (campo) campo.value = "";
  atualizarTabelaLimites();
  campo?.focus();
}




// ====================================================
// üõí GERAR LISTA DE COMPRA ‚Äî sincronizada com Estoque M√≠n/M√°x
// ====================================================
function gerarListaCompra() {
  const container = document.getElementById("listaCompraContainer");
  const tabela = document.getElementById("tabelaListaCompra");
  const tbody = tabela ? tabela.querySelector("tbody") : null;
  const totalSpan = document.getElementById("totalItensCompra");
  const filtroCategoria = document.getElementById("filtroCategoria")?.value || "";

  // üîç Seguran√ßa: elementos obrigat√≥rios
  if (!container || !tabela || !tbody || !totalSpan) {
    console.error("‚ö†Ô∏è Elementos da lista de compra n√£o encontrados no DOM.");
    mostrarMensagem("Erro: tabela da lista de compra n√£o encontrada.", "erro");
    return;
  }

  const produtos = Array.isArray(window.produtos) ? window.produtos : [];
  const entradas = Array.isArray(window.entradas) ? window.entradas : [];
  const saidas = Array.isArray(window.saidas) ? window.saidas : [];

  // üîπ 1. Mapa de estoque real (entradas - sa√≠das)
  const mapaEstoque = {};
  entradas.forEach(e => {
    const nome = (e.produto || e.nomeProduto || "").trim().toLowerCase();
    if (!nome) return;
    mapaEstoque[nome] = (mapaEstoque[nome] || 0) + Number(e.qtd || e.quantidade || 0);
  });
  saidas.forEach(s => {
    const nome = (s.produto || s.nomeProduto || "").trim().toLowerCase();
    if (!nome) return;
    mapaEstoque[nome] = (mapaEstoque[nome] || 0) - Number(s.qtd || s.quantidade || 0);
  });

  // üîπ 2. Identifica produtos abaixo do m√≠nimo (usando a mesma l√≥gica do Estoque M√≠n/M√°x)
  const produtosAbaixo = produtos
    .map(p => {
      const nome = (p.nome || "").trim().toLowerCase();
      const qtdAtual = Number(mapaEstoque[nome] ?? p.quantidade ?? 0);
      const minimo = Number(p.minimo || 0);
      const maximo = Number(p.maximo || 0);
      const categoria = p.categoria || "-";

      let recomendacao = "";

      // üü¢ Mesma regra da tabela de limites
      if (qtdAtual < minimo) {
        const qtdComprar = maximo > 0 ? (maximo - qtdAtual) : (minimo - qtdAtual);
        recomendacao = `Comprar ${qtdComprar}`;
      }

      return {
        nome: p.nome,
        codigoBarras: p.codigoBarras || "-",
        categoria,
        qtd: qtdAtual,
        recomendacao
      };
    })
    .filter(p => p.recomendacao)
    .filter(p => !filtroCategoria || p.categoria === filtroCategoria)
    .sort((a, b) => a.nome.localeCompare(b.nome));

  // üîπ 3. Monta a tabela
  tbody.innerHTML = "";

  if (produtosAbaixo.length === 0) {
    const mensagem = filtroCategoria
      ? `Nenhum item abaixo do estoque m√≠nimo na categoria <b>${filtroCategoria}</b>.`
      : `Nenhum item abaixo do estoque m√≠nimo.`;

    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; color:#777;">${mensagem}</td>
      </tr>
    `;

    totalSpan.textContent = "0";
    container.style.display = "block";
    mostrarMensagem("Nenhum produto abaixo do estoque m√≠nimo encontrado.", "info");
    return;
  }

  // üîπ 4. Preenche linhas da tabela
  produtosAbaixo.forEach((p, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome}</td>
      <td>${p.codigoBarras}</td>
      <td>${p.categoria}</td>
      <td style="text-align:center;">${p.qtd}</td>
      <td style="font-weight:bold; color:#0d6efd;">${p.recomendacao}</td>
    `;
    tbody.appendChild(row);
  });

  // üîπ 5. Exibe resumo
  totalSpan.textContent = produtosAbaixo.length.toString();
  container.style.display = "block";
  container.scrollIntoView({ behavior: "smooth" });
  mostrarMensagem(`Lista de compra gerada com ${produtosAbaixo.length} item(ns).`, "sucesso");
}



// ============================================================
// üü© REGISTRAR NOVO ERRO / PROBLEMA
// ============================================================
window.registrarErro = async function () {
  try {
    const dataEl = document.getElementById("erroData");
    const tituloEl = document.getElementById("erroTitulo");
    const situacaoEl = document.getElementById("erroSituacao");
    const previsaoEl = document.getElementById("erroPrevisao");
    const descricaoEl = document.getElementById("erroDescricao");

    const titulo = tituloEl.value.trim();
    const descricao = descricaoEl.value.trim();
    const dataOriginal = dataEl.value; // deve estar YYYY-MM-DD

    if (!titulo) return mostrarMensagem("Informe o t√≠tulo!", "erro");
    if (!descricao) return mostrarMensagem("Descreva o erro ou problema!", "erro");

    // usa data v√°lida: usa data do campo se estiver ok, sen√£o gera local
    const data = (dataOriginal && !isNaN(new Date(dataOriginal))) 
      ? dataOriginal 
      : dataLocalYYYYMMDD();

    if (!Array.isArray(window.errosProblemas)) window.errosProblemas = [];

    const novo = {
      id: "err_" + Date.now(),
      data, // YYYY-MM-DD (LOCAL)
      titulo,
      situacao: situacaoEl.value || "",
      descricao,
      previsao: previsaoEl.value || "",
      parecer: "",
      dtConclusao: "",
      bloqueado: false
    };

    window.errosProblemas.unshift(novo);
    salvarTodosLocal?.();
    await window.salvarErrosProblemasNoFirebase?.(window.errosProblemas);

    atualizarTabelaErros?.();

    tituloEl.value = "";
    descricaoEl.value = "";
    if (situacaoEl) situacaoEl.value = "";
    if (previsaoEl) previsaoEl.value = "";
    if (dataEl) dataEl.value = dataLocalYYYYMMDD();

    mostrarMensagem("‚úîÔ∏è Registro criado com sucesso!", "sucesso");
  } catch (e) {
    console.error("‚ùå Erro ao registrar erro:", e);
    mostrarMensagem("Erro ao registrar. Veja o console.", "erro");
  }
};



/* ============================================================
   üß© REGISTRO DE ERROS E PROBLEMAS ‚Äî VERS√ÉO CORRIGIDA
   ============================================================ */

// Linha em edi√ß√£o
window.indiceErroEditando = null;


// üîπ Atualiza a tabela
window.atualizarTabelaErros = function () {
  const tbody = document.querySelector("#tabelaErros tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  window.errosProblemas = Array.isArray(window.errosProblemas)
    ? window.errosProblemas
    : [];

  if (window.errosProblemas.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align:center;color:#777;">
          Nenhum registro encontrado.
        </td>
      </tr>`;
    return;
  }

  window.errosProblemas.forEach((e, i) => {
    const editando = window.indiceErroEditando === i;
    const bloqueado = e.bloqueado === true;

    const parecerHTML = editando
      ? `<textarea id="campoParecer" style="width:100%;height:70px;">${e.parecer || ""}</textarea>`
      : (e.parecer || "-");

    let botoes = "";

    if (editando) {
      botoes = `
        <button onclick="salvarEdicaoErro(${i})"
                style="background:green;color:white;padding:6px 12px;border-radius:5px;">
          <i class="fa fa-check"></i> Salvar
        </button>`;
    } else if (!bloqueado) {
      botoes = `
        <button onclick="editarErro(${i})"
                style="background:#0d6efd;color:white;padding:6px 12px;border-radius:5px;">
          <i class="fa fa-edit"></i> Editar
        </button>`;
    } else {
      botoes = `<span style="color:green;font-weight:bold;">Conclu√≠do</span>`;
    }

    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${formatarDataParaPtBR(e.data)}</td>
      <td>${e.titulo}</td>
      <td>${e.situacao}</td>
      <td onclick="mostrarDescricaoCompleta('${e.descricao.replace(/'/g, "\\'")}')" 
    style="cursor:pointer; max-width:270px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
    title="Clique para ver completo">
    ${e.descricao}
</td>

      <td>${e.previsao ? new Date(e.previsao).toLocaleDateString("pt-BR") : "-"}</td>
      <td>${parecerHTML}</td>
      <td>${e.dtConclusao ? new Date(e.dtConclusao).toLocaleDateString("pt-BR") : "-"}</td>
      <td style="text-align:center;">${botoes}</td>
    `;

    tbody.appendChild(row);
  });
};

function formatarDataParaPtBR(dateStr) {
  if (!dateStr) return "-";
  // se j√° estiver no formato YYYY-MM-DD
  const m = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) {
    return `${m[3]}/${m[2]}/${m[1]}`; // dd/mm/yyyy
  }
  // fallback: tenta Date e toLocale
  const dt = new Date(dateStr);
  if (!isNaN(dt)) return dt.toLocaleDateString("pt-BR");
  return "-";
}


window.mostrarDescricaoCompleta = function(texto) {
  alert("Descri√ß√£o Completa:\n\n" + texto);
};



// üîπ Entrar no modo edi√ß√£o
window.editarErro = function (i) {
  window.indiceErroEditando = i;
  atualizarTabelaErros();
};


// üîπ Salvar edi√ß√£o (parecer + data)
window.salvarEdicaoErro = async function (i) {
  const item = window.errosProblemas[i];
  if (!item) return;

  const campo = document.getElementById("campoParecer");
  if (!campo) return mostrarMensagem("Campo de parecer n√£o encontrado!", "erro");

  item.parecer = campo.value.trim();
  item.dtConclusao = new Date().toISOString();
  item.bloqueado = true;
  window.indiceErroEditando = null;

  // üîí BLOQUEIA O SNAPSHOT
  window.bloquearAtualizacaoSnapshot = true;

  // üíæ SALVAR LOCAL
  salvarTodosLocal();

  // ‚òÅÔ∏è SALVAR FIRESTORE
  await window.salvarErrosProblemasNoFirebase(window.errosProblemas);

  // ‚è≥ LIBERA SNAPSHOT AP√ìS O SALVAMENTO
  setTimeout(() => window.bloquearAtualizacaoSnapshot = false, 800);

  mostrarMensagem("‚úîÔ∏è Parecer salvo e registro conclu√≠do!", "sucesso");
  atualizarTabelaErros();
};

// === Sempre preencher a data do formul√°rio com a data atual ===
function dataHojeInput() {
  const hoje = new Date();
  const yyyy = hoje.getFullYear();
  const mm = String(hoje.getMonth() + 1).padStart(2, "0");
  const dd = String(hoje.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

// Preenche quando a p√°gina carrega
document.addEventListener("DOMContentLoaded", () => {
  const campoData = document.getElementById("erroData");
  if (campoData) campoData.value = dataHojeInput();
});

// Preenche sempre que entrar na se√ß√£o de erros
window.abrirErrosProblemas = function () {
  document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");

  const secErros = document.getElementById("errosProblemas");
  if (secErros) secErros.style.display = "block";

  const campoData = document.getElementById("erroData");
  if (campoData && !campoData.value) campoData.value = dataHojeInput();

  atualizarTabelaErros?.();
};

// ====================================================
// üßπ LIMPAR E GERENCIAR LISTA DE COMPRA (CORRE√á√ÉO FINAL)
// ====================================================
function limparListaCompra() {
  console.log("üîÑ Limpando lista de compra...");

  // 1Ô∏è‚É£ Limpa a tabela da lista gerada
  const tabela = document.querySelector("#tabelaListaCompra tbody");
  if (tabela) tabela.innerHTML = "";

  // 2Ô∏è‚É£ Zera o total de itens
  const totalSpan = document.getElementById("totalItensCompra");
  if (totalSpan) totalSpan.textContent = "0";

  // 3Ô∏è‚É£ Esconde o container da lista gerada
  const container = document.getElementById("listaCompraContainer");
  if (container) container.style.display = "none";

  // 4Ô∏è‚É£ *** VOLTAR O SELECT PARA ‚ÄúTODAS AS CATEGORIAS‚Äù ***
  const selectCategoria = document.getElementById("filtroCategoria");
  if (selectCategoria) {
    selectCategoria.value = ""; // <-- ESSA LINHA √â A PRINCIPAL
  }

  // 5Ô∏è‚É£ *** RESETAR o filtro de texto ***
  const filtroTexto = document.getElementById("filtroLimites");
  if (filtroTexto) filtroTexto.value = "";

  // 6Ô∏è‚É£ *** Resetar filtros globais ***
  window.filtroLimites = "";
  window.filtroCategoria = "";

  // 7Ô∏è‚É£ *** RECARREGAR A TABELA COMPLETA ‚Äî SEM FILTROS ***
  if (typeof atualizarTabelaLimites === "function") {
    atualizarTabelaLimites();
  }

  // 8Ô∏è‚É£ Mensagem final
  mostrarMensagem("üßπ Lista de compra limpa! Tabela restaurada.", "info");
}


function removerItemListaCompra(botao) {
  const linha = botao.closest("tr");
  if (linha) {
    linha.remove();
    const totalSpan = document.getElementById("totalItensCompra");
    if (totalSpan) {
      const novoTotal = Math.max(0, Number(totalSpan.textContent) - 1);
      totalSpan.textContent = novoTotal.toString();
    }
    mostrarMensagem("üóëÔ∏è Item removido da lista.", "info");
  }
}

// üßæ Mensagem visual (reutiliza o mesmo estilo das suas mensagens existentes)
function mostrarMensagem(texto, tipo = "info") {
  const div = document.createElement("div");
  div.textContent = texto;
  div.className = `mensagem mensagem-${tipo}`;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}
function atualizarTabelaErros() {
  const tbody = document.querySelector("#tabelaErros tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  window.errosProblemas.forEach((e, i) => {
    const classeSituacao =
      e.situacao.includes("Emerg√™ncia") ? "situacao-vermelha" :
      e.situacao.includes("Muito Urgente") ? "situacao-laranja" :
      e.situacao.includes("Urgente") ? "situacao-amarela" :
      e.situacao.includes("Pouco Urgente") ? "situacao-verde" :
      "situacao-azul";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${e.data}</td>
      <td>${e.titulo}</td>
      <td class="${classeSituacao}">${e.situacao}</td>
      <td>${e.descricao}</td>
      <td>${e.previsao || "-"}</td>
      <td>${e.parecer || "-"}</td>
      <td>${e.concluidoEm || "-"}</td>
      <td>
        <button onclick="salvarParecer(${i})" title="Adicionar Parecer"><i class="fa fa-comment"></i></button>
        <button onclick="concluirErro(${i})" title="Concluir"><i class="fa fa-check"></i></button>
        <button onclick="excluirErro(${i})" title="Excluir"><i class="fa fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}




function concluirErro(index) {
  window.errosProblemas[index].concluidoEm = new Date().toLocaleDateString();
  mostrarMensagem("‚úîÔ∏è Erro conclu√≠do com sucesso!", "sucesso");
  atualizarTabelaErros();
}

function excluirErro(index) {
  if (confirm("Deseja realmente excluir este registro?")) {
    window.errosProblemas.splice(index, 1);
    atualizarTabelaErros();
    mostrarMensagem("üóëÔ∏è Registro exclu√≠do com sucesso.", "sucesso");
  }
}

function filtrarErros() {
  const termo = document.getElementById("filtroErros").value.toLowerCase();
  const tbody = document.querySelector("#tabelaErros tbody");
  tbody.querySelectorAll("tr").forEach(tr => {
    const texto = tr.textContent.toLowerCase();
    tr.style.display = texto.includes(termo) ? "" : "none";
  });
}

function limparFiltroErros() {
  const campo = document.getElementById("filtroErros");
  if (campo) campo.value = "";
  filtrarErros();
  mostrarMensagem("Filtro limpo.", "info");
}
// ====================================================
// üíæ SALVAR / LIMPAR / FILTRAR LIMITES
// ====================================================

function salvarLimites(idProduto) {
  const produtoRef = window.produtos.find(p =>
    String(p.codigo) === String(idProduto) ||
    p.nome.replace(/\s+/g,'_') === idProduto
  );

  if (!produtoRef) {
    mostrarMensagem("Erro: Produto n√£o encontrado para salvar limites!", "erro");
    return;
  }

  const minEl = document.getElementById(`min_${idProduto}`);
  const maxEl = document.getElementById(`max_${idProduto}`);

  produtoRef.minimo = Number(minEl?.value || 0);
  produtoRef.maximo = Number(maxEl?.value || 0);

  salvarProdutosNoFirebase(window.produtos);
  salvarTodosLocal();

  mostrarMensagem(`Limites do produto "${produtoRef.nome}" salvos com sucesso!`, "sucesso");

  atualizarTabelaLimites();
}



function removerLimites(nome) {
  const produtoRef = window.produtos.find(p => p.nome === nome);
  if (!produtoRef) return;

  if (confirm(`Remover limites do produto "${nome}"?`)) {
    produtoRef.minimo = 0;
    produtoRef.maximo = 0;
    salvarProdutosNoFirebase(window.produtos);
    salvarTodosLocal();
    atualizarTabelaLimites();
    mostrarMensagem(`Limites de "${nome}" removidos com sucesso.`, "sucesso");
  }
}

function filtrarLimites() {
  const filtro = document.getElementById("filtroLimites");
  window.filtroLimites = filtro?.value || "";
  atualizarTabelaLimites();
}

function limparFiltroLimites() {
  const filtro = document.getElementById("filtroLimites");
  if (filtro) filtro.value = "";
  window.filtroLimites = "";
  atualizarTabelaLimites();
  mostrarMensagem("Filtro de Estoque M√≠nimo e M√°ximo limpo.", "info");
}


async function salvarParecer(index) {
  const parecerInput = document.getElementById(`parecer_${index}`);
  const dataConclusaoInput = document.getElementById(`dataConclusao_${index}`);
  if (!parecerInput || !dataConclusaoInput) return;

  const parecer = parecerInput.value.trim() || "-";
  const dataConclusao = dataConclusaoInput.value || "-";

  // Atualiza mem√≥ria local
  window.errosProblemas[index].parecer = parecer;
  window.errosProblemas[index].concluidoEm = dataConclusao;

  // üîí BLOQUEIA SNAPSHOT PARA N√ÉO SOBRESCREVER OS DADOS ENVIADOS
  window.bloquearAtualizacaoSnapshot = true;

  // üíæ SALVA EM LOCALSTORAGE
  try {
    salvarTodosLocal();
  } catch (e) {
    console.error("Erro ao salvar localmente:", e);
  }

  // ‚òÅÔ∏è SALVA NO FIRESTORE APENAS UMA VEZ
  try {
    await window.salvarErrosProblemasNoFirebase(window.errosProblemas);
    mostrarMensagem("‚úÖ Parecer e data de conclus√£o salvos com sucesso!", "sucesso");
  } catch (e) {
    mostrarMensagem("‚ùå Erro ao salvar no servidor!", "erro");
    console.error("Erro ao salvar no Firestore:", e);
  }

  // ‚è≥ LIBERA SNAPSHOT (pequeno delay garante sincroniza√ß√£o)
  setTimeout(() => {
    window.bloquearAtualizacaoSnapshot = false;
  }, 800);

  // üîÑ Atualiza tabela
  atualizarTabelaErros();
}





// ====================================================
// üí∞ PAINEL FINANCEIRO ‚Äî Corre√ß√£o completa e autom√°tica
// ====================================================
function atualizarPainelFinanceiro() {
  try {
    // üîπ Garante que os dados existam e sejam arrays v√°lidos
    const entradas = Array.isArray(window.entradas) ? window.entradas : [];
    const saidas = Array.isArray(window.saidas) ? window.saidas : [];
    const produtos = Array.isArray(window.produtos) ? window.produtos : [];

    // ‚ö†Ô∏è Se ainda n√£o h√° dados, interrompe a atualiza√ß√£o
    if (entradas.length === 0 && saidas.length === 0 && produtos.length === 0) {
      console.warn("‚ö†Ô∏è Dados ainda n√£o prontos para atualizar painel financeiro.");
      return;
    }

    let valorTotalEntradas = 0;
    let valorTotalSaidas = 0;
    let valorTotalCustoMedioGeral = 0;
    let valorTotalUltimaEntradaGeral = 0;

    // --- C√ÅLCULO DE ENTRADAS E CUSTO M√âDIO ---
    entradas.forEach(e => {
      valorTotalEntradas += (Number(e.valor) || 0) * (Number(e.qtd) || 0);
    });

    produtos.forEach(p => {
      const entradasDoProduto = entradas.filter(e => e.produto === p.nome);
      const qtdAtual = Number(p.quantidade || 0);

      if (entradasDoProduto.length > 0) {
        const totalQtdEntradas = entradasDoProduto.reduce((s, e) => s + (Number(e.qtd) || 0), 0);
        const totalValorEntradas = entradasDoProduto.reduce(
          (s, e) => s + ((Number(e.qtd) || 0) * (Number(e.valor) || 0)),
          0
        );
        const custoMedio = totalQtdEntradas > 0 ? totalValorEntradas / totalQtdEntradas : 0;

        const valorUltimo = Number(entradasDoProduto.slice(-1)[0].valor || 0);

        valorTotalCustoMedioGeral += qtdAtual * custoMedio;
        valorTotalUltimaEntradaGeral += qtdAtual * valorUltimo;
      }
    });

    // --- SA√çDAS ---
    saidas.forEach(s => {
      const entradaRelacionado = entradas.find(
        e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase()
      );
      const valorUnitario = entradaRelacionado ? (Number(entradaRelacionado.valor) || 0) : 0;
      valorTotalSaidas += valorUnitario * (Number(s.qtd) || 0);
    });

    // --- C√ÅLCULOS GERAIS ---
    const valorTotalEstoqueContabil = valorTotalEntradas - valorTotalSaidas;
    const valorEstoqueAtualEstimado = valorTotalUltimaEntradaGeral;

    // --- ATUALIZA OS CARDS ---
    const setText = (id, valor) => {
      const el = document.getElementById(id);
      if (el) el.textContent = `R$ ${valor.toFixed(2)}`;
    };

    setText("valorUltimaEntrada", valorTotalUltimaEntradaGeral);
    setText("valorCustoMedio", valorTotalCustoMedioGeral);
    setText("valorEstoqueAtualPainel", valorEstoqueAtualEstimado);
    setText("valorEstoque", valorTotalEstoqueContabil);
    setText("valorSaidas", valorTotalSaidas);

    // --- ATUALIZA A TABELA FINANCEIRA ---
    const tbody = document.querySelector("#tabelaFinanceiro tbody");
    if (tbody) {
      tbody.innerHTML = "";

      const agrupadas = {};

      entradas.forEach(e => {
        const fornecedor = e.fornecedor || "Fornecedor n√£o informado";
        const nota = e.nota || "Sem Nota Fiscal";
        const chave = `${fornecedor}_${nota}`;

        if (!agrupadas[chave]) {
          agrupadas[chave] = { fornecedor, nota, valorNota: 0, valorSaida: 0 };
        }

        agrupadas[chave].valorNota += (Number(e.valor) || 0) * (Number(e.qtd) || 0);
      });

      saidas.forEach(s => {
        const entrada = entradas.find(
          e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase()
        );
        if (!entrada) return;

        const fornecedor = entrada.fornecedor || "Fornecedor n√£o informado";
        const nota = entrada.nota || "Sem Nota Fiscal";
        const chave = `${fornecedor}_${nota}`;

        const valorUnitario = Number(entrada.valor) || 0;
        const valorSaida = valorUnitario * (Number(s.qtd) || 0);

        if (agrupadas[chave]) agrupadas[chave].valorSaida += valorSaida;
      });

      const registros = Object.values(agrupadas);
      if (registros.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="4" style="text-align:center; color:#777;">Nenhum dado financeiro encontrado.</td></tr>`;
      } else {
        registros.forEach(a => {
          const saldo = a.valorNota - a.valorSaida;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${a.fornecedor}</td>
            <td>${a.nota}</td>
            <td>R$ ${a.valorNota.toFixed(2)}</td>
            <td style="color:${saldo >= 0 ? "green" : "red"}">R$ ${saldo.toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    console.log("‚úÖ Painel Financeiro atualizado com sucesso!");
  } catch (e) {
    console.error("‚ùå Erro ao atualizar painel financeiro:", e);
  }
}

window.addEventListener("load", () => {
  setTimeout(() => {
    console.log("üß© Teste ‚Äî produtos atuais:", window.produtos);
  }, 3000);
});

// --- DASHBOARD ---

function calcularFrequenciaSaida() {
    const frequencia = {};
    const hoje = new Date();
    const trintaDiasAtras = new Date(hoje);
    trintaDiasAtras.setDate(hoje.getDate() - 30);

    saidas.forEach(s => {
        const dataSaida = new Date(s.data);
        if (dataSaida >= trintaDiasAtras) {
            frequencia[s.produto] = (frequencia[s.produto] || 0) + (s.qtd || 0);
        }
    });

    // Converte para array para ordenar
    return Object.entries(frequencia)
        .map(([produto, qtd]) => ({ produto, qtd }))
        .sort((a, b) => b.qtd - a.qtd); // Mais sa√≠das primeiro
}

// ===============================================
// FUN√á√ïES AUXILIARES DO DASHBOARD
// ===============================================

/**
 * Fun√ß√£o auxiliar para formatar valores como moeda Real (R$).
 */
function formatarMoeda(valor) {
    // Converte o valor para n√∫mero e formata como Real Brasileiro
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(Number(valor));
}

/**
 * Fun√ß√£o auxiliar para montar o bloco de Resumo Geral com o design EXATO da imagem.
 */
function atualizarBlocoResumo(totalProdutos, qtdTotalEstoque, totalSaidas, valorUltimaEntrada, valorEstoqueContabil, criticosCount) {
    const resumoEl = document.getElementById("resumoGeral"); 
    if (!resumoEl) return; 

    // O HTML INJETADO USA AS CLASSES CSS FORNECIDAS
    resumoEl.innerHTML = `
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-boxes resumo-icon icon-produtos"></i> Total de Produtos Cadastrados:</span>
            <span class="resumo-value">${totalProdutos}</span>
        </div>
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-box-open resumo-icon icon-estoque"></i> Quantidade Total em Estoque (Unid):</span>
            <span class="resumo-value">${qtdTotalEstoque.toFixed(0)}</span>
        </div>
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-sign-out-alt resumo-icon icon-saidas"></i> Total de Sa√≠das Registradas:</span>
            <span class="resumo-value">${totalSaidas}</span>
        </div>
        <hr style="margin: 10px 0; border-color: #ddd;">
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-coins resumo-icon icon-valor"></i> Valor Total (√öltimo Custo):</span>
            <span class="resumo-value">${formatarMoeda(valorUltimaEntrada)}</span>
        </div>
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-chart-line resumo-icon icon-contabil"></i> Valor Total do Estoque (C.M.P):</span>
            <span class="resumo-value">${formatarMoeda(valorEstoqueContabil)}</span>
        </div>
        <hr style="margin: 10px 0; border-color: #ddd;">
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-exclamation-triangle resumo-icon" style="color: ${criticosCount > 0 ? 'red' : 'green'};"></i> Produtos em Estoque Cr√≠tico:</span>
            <span class="resumo-value" style="color: ${criticosCount > 0 ? 'red' : 'green'};">${criticosCount}</span>
        </div>
    `;
}

// ===============================================
// FUN√á√ÉO PRINCIPAL DO DASHBOARD (VERS√ÉO FINAL E √Ä PROVA DE ERROS)
// ===============================================
function atualizarDashboard() {
  try {
    const produtosLocal = Array.isArray(window.produtos) ? window.produtos : [];
    const entradasLocal = Array.isArray(window.entradas) ? window.entradas : [];
    const saidasLocal = Array.isArray(window.saidas) ? window.saidas : [];

    // üß© 1Ô∏è‚É£ Se n√£o h√° entradas e sa√≠das, zera tudo e limpa o painel
    if (entradasLocal.length === 0 && saidasLocal.length === 0) {
      const resumoEl = document.getElementById("resumoGeral");
      const listaVencer = document.getElementById("listaProximosVencer");
      const listaMaisCarosEl = document.getElementById("listaMaisCaros");
      const listaMaisSaidasEl = document.getElementById("listaMaisSaidas");
      const listaMenosSaidasEl = document.getElementById("listaMenosSaidas");
      const listaCriticos = document.getElementById("listaEstoqueCritico");

      if (resumoEl) {
        resumoEl.innerHTML = `
          <div><b>Total de produtos:</b> ${produtosLocal.length}</div>
          <div><b>Quantidade total em estoque:</b> 0</div>
          <div><b>Total de sa√≠das registradas:</b> 0</div>
          <hr>
          <div><b>üí∞ Valor total (√öltimo valor de entrada):</b> R$ 0,00</div>
          <div><b>üí∞ Valor total (Custo m√©dio ponderado):</b> R$ 0,00</div>
          <div><b>üí∞ Valor total do Estoque Atual (estimado):</b> R$ 0,00</div>
          <div><b>‚ö†Ô∏è Produtos em Estoque Cr√≠tico:</b> <span style="color:green">0</span></div>
        `;
      }
      if (listaVencer) listaVencer.innerHTML = "<li>Nenhum produto pr√≥ximo do vencimento.</li>";
      if (listaMaisCarosEl) listaMaisCarosEl.innerHTML = "<li>Nenhum custo registrado.</li>";
      if (listaMaisSaidasEl) listaMaisSaidasEl.innerHTML = "<li>Nenhuma sa√≠da registrada.</li>";
      if (listaMenosSaidasEl) listaMenosSaidasEl.innerHTML = "<li>Sem registros dispon√≠veis.</li>";
      if (listaCriticos) listaCriticos.innerHTML = "<li>Tudo OK!</li>";

      console.log("üßæ Dashboard zerado automaticamente (sem entradas/sa√≠das).");
      return;
    }

    // ================================================================
    // üîπ C√ÅLCULOS NORMAIS DO DASHBOARD (s√≥ roda se h√° entradas/sa√≠das)
    // ================================================================

    const igualNome = (a, b) => String(a || "").trim().toLowerCase() === String(b || "").trim().toLowerCase();

    function buscarValorUnitario(nomeProduto) {
      if (!nomeProduto) return 0;
      const entradasDoProduto = entradasLocal
        .filter(e => igualNome(e.produto, nomeProduto) && !isNaN(Number(e.valor)) && Number(e.valor) > 0)
        .sort((a, b) => new Date(b.data) - new Date(a.data));
      return entradasDoProduto.length ? Number(entradasDoProduto[0].valor) : 0;
    }

    const contagemSaidas = saidasLocal.reduce((acc, s) => {
      const nome = s.produto || s.nomeProduto || "";
      const qtdSaida = Number(s.qtd || s.quantidade || 0) || 0;
      const key = String(nome).trim();
      if (!key) return acc;
      acc[key] = (acc[key] || 0) + qtdSaida;
      return acc;
    }, {});

    const estoqueDetalhado = produtosLocal.map(p => {
      const qtdAtual = Number(p.quantidade || 0) || 0;
      const nome = p.nome || p.descricao || "";
      const minimo = Number(p.minimo || 0) || 0;

      const entradasProduto = entradasLocal
        .filter(e => igualNome(e.produto, nome) && !isNaN(Number(e.valor)) && (Number(e.qtd || e.quantidade || 0) > 0))
        .sort((a, b) => new Date(a.data) - new Date(b.data));

      const custoTotalProduto = entradasProduto.reduce((sum, e) => sum + ((Number(e.valor) || 0) * (Number(e.qtd || e.quantidade || 0) || 0)), 0);
      const qtdTotalEntradaProduto = entradasProduto.reduce((sum, e) => sum + (Number(e.qtd || e.quantidade || 0) || 0), 0);
      const CMP_produto = qtdTotalEntradaProduto > 0 ? (custoTotalProduto / qtdTotalEntradaProduto) : 0;

      const ultimaComValor = entradasProduto.length ? entradasProduto[entradasProduto.length - 1] : null;
      const ultimoCusto = ultimaComValor ? Number(ultimaComValor.valor || 0) : 0;

      const validadeMaisProxima = entradasProduto
        .map(e => new Date(String(e.validade).trim()))
        .filter(d => !isNaN(d.getTime()))
        .sort((a, b) => a - b)[0] || null;

      const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
      const diasVencer = validadeMaisProxima ? Math.ceil((validadeMaisProxima.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24)) : Infinity;
      const qtdSaidas = contagemSaidas[nome] || 0;
      const isCritico = minimo > 0 && qtdAtual < minimo;

      return {
        nome,
        qtdAtual,
        ultimoCusto,
        cmp: CMP_produto,
        qtdSaidas,
        validade: validadeMaisProxima,
        diasVencer,
        isCritico
      };
    });

    const criarLi = item => `<li>${item}</li>`;

    // Produtos pr√≥ximos do vencimento
    const proximosVencer = estoqueDetalhado
      .filter(p => isFinite(p.diasVencer) && p.qtdAtual > 0 && p.diasVencer <= 90)
      .sort((a, b) => a.diasVencer - b.diasVencer)
      .slice(0, 5);

    const listaVencer = document.getElementById("listaProximosVencer");
    if (listaVencer) {
      listaVencer.innerHTML = proximosVencer.length
        ? proximosVencer.map(p => {
          const status = p.diasVencer <= 0
            ? `<span style="color:red;font-weight:bold;">(VENCIDO)</span>`
            : `(Vence em ${p.diasVencer} dias)`;
          return criarLi(`${p.nome} ‚Äî ${p.qtdAtual} un ${status}`);
        }).join("")
        : criarLi("Nenhum produto pr√≥ximo do vencimento.");
    }

    // Produtos mais caros
    const maisCaros = estoqueDetalhado.filter(p => p.ultimoCusto > 0)
      .sort((a, b) => b.ultimoCusto - a.ultimoCusto)
      .slice(0, 5);
    const listaMaisCarosEl = document.getElementById("listaMaisCaros");
    if (listaMaisCarosEl) {
      listaMaisCarosEl.innerHTML = maisCaros.length
        ? maisCaros.map(p => criarLi(`${p.nome} (${formatarMoeda(p.ultimoCusto)})`)).join("")
        : criarLi("Nenhum custo registrado.");
    }

    // Produtos mais utilizados (sa√≠das)
    const maisSaidas = estoqueDetalhado.filter(p => p.qtdSaidas > 0)
      .sort((a, b) => b.qtdSaidas - a.qtdSaidas)
      .slice(0, 5);
    const listaMaisSaidasEl = document.getElementById("listaMaisSaidas");
    if (listaMaisSaidasEl) {
      listaMaisSaidasEl.innerHTML = maisSaidas.length
        ? maisSaidas.map(p => criarLi(`${p.nome} (${p.qtdSaidas} sa√≠das)`)).join("")
        : criarLi("Nenhuma sa√≠da registrada.");
    }

    // üßπ Produtos com menos sa√≠das ‚Äî mostra apenas os que t√™m estoque e movimenta√ß√£o
    const menosSaidas = estoqueDetalhado
      .filter(p => p.qtdAtual > 0 && (p.qtdSaidas > 0))
      .sort((a, b) => a.qtdSaidas - b.qtdSaidas)
      .slice(0, 5);

    const listaMenosSaidasEl = document.getElementById("listaMenosSaidas");
    if (listaMenosSaidasEl) {
      listaMenosSaidasEl.innerHTML = menosSaidas.length
        ? menosSaidas.map(p => criarLi(`${p.nome} (${p.qtdSaidas} sa√≠das)`)).join("")
        : criarLi("Sem registros dispon√≠veis.");
    }

    // Estoque cr√≠tico
    const criticos = estoqueDetalhado.filter(p => p.isCritico)
      .sort((a, b) => (a.qtdAtual - a.minimo) - (b.qtdAtual - b.minimo))
      .slice(0, 5);
    const listaCriticos = document.getElementById("listaEstoqueCritico");
    if (listaCriticos) {
      listaCriticos.innerHTML = criticos.length
        ? criticos.map(p => criarLi(`${p.nome} (${p.qtdAtual} un ‚Äî M√≠n: ${p.minimo})`)).join("")
        : criarLi("Tudo OK!");
    }

    // --- Resumo Geral ---
    const produtosComEstoque = estoqueDetalhado.filter(p => p.qtdAtual > 0);
    const totalProdutos = produtosLocal.length;
    const qtdTotalEmEstoque = produtosComEstoque.reduce((s, p) => s + (p.qtdAtual || 0), 0);
    const totalSaidasRegistradas = saidasLocal.reduce((s, r) => s + (Number(r.qtd || r.quantidade) || 0), 0);
    const criticosCount = criticos.length;
    const valorUltimaEntrada = produtosComEstoque.reduce((s, p) => s + (Number(p.qtdAtual || 0) * Number(p.ultimoCusto || 0)), 0);
    const valorEstoqueCustoMedio = produtosComEstoque.reduce((s, p) => s + (Number(p.qtdAtual || 0) * Number(p.cmp || 0)), 0);

    const resumoEl = document.getElementById("resumoGeral");
    if (resumoEl) {
      resumoEl.innerHTML = `
        <div><b>Total de produtos:</b> ${totalProdutos}</div>
        <div><b>Quantidade total em estoque:</b> ${qtdTotalEmEstoque}</div>
        <div><b>Total de sa√≠das registradas:</b> ${totalSaidasRegistradas}</div>
        <hr>
        <div><b>üí∞ Valor total (√öltimo valor de entrada):</b> ${formatarMoeda(valorUltimaEntrada)}</div>
        <div><b>üí∞ Valor total (Custo m√©dio ponderado):</b> ${formatarMoeda(valorEstoqueCustoMedio)}</div>
        <div><b>üí∞ Valor total do Estoque Atual (estimado):</b> ${formatarMoeda(valorEstoqueCustoMedio)}</div>
        <div><b>‚ö†Ô∏è Produtos em Estoque Cr√≠tico:</b> <span style="color:${criticosCount>0?'red':'green'}">${criticosCount}</span></div>
      `;
    }

    if (typeof atualizarPainelFinanceiro === "function") {
      try { atualizarPainelFinanceiro(); } catch (e) { console.warn("Falha ao atualizar painel financeiro:", e); }
    }

    console.log("‚úÖ Dashboard atualizado:", {
      produtos: totalProdutos,
      qtdEstoque: qtdTotalEmEstoque,
      valorUltimaEntrada,
      valorEstoqueCustoMedio
    });
  } catch (err) {
    console.error("‚ùå Erro em atualizarDashboard():", err);
  }
}



// --- RELAT√ìRIOS ---

function definirPeriodoRapido(tipo) {
  const hoje = new Date();
  let dataInicio, dataFim;

  if (tipo === '7dias') {
    dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - 7);
  } else if (tipo === '30dias') {
    dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - 30);
  } else if (tipo === 'mes') {
    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  } else {
    return; // N√£o faz nada se o tipo for inv√°lido
  }
  
  dataFim = hoje;
  
  document.getElementById("dataInicioRelatorio").value = dataInicio.toISOString().split('T')[0];
  document.getElementById("dataFimRelatorio").value = dataFim.toISOString().split('T')[0];
  mostrarMensagem(`Per√≠odo definido para: ${tipo}.`, "info");
}

function limparPeriodo() {
  document.getElementById("dataInicioRelatorio").value = "";
  document.getElementById("dataFimRelatorio").value = "";
  mostrarMensagem("Filtro de per√≠odo limpo.", "info");
}

/**
 * üîπ Fun√ß√£o gen√©rica para exportar qualquer tabela para Excel (CSV)
 */
function exportarTabelaExcel(idTabela, nomeArquivoBase, prefixo) {
  const tabela = document.getElementById(idTabela);
  if (!tabela) return alert("Tabela n√£o encontrada.");
  
  const dataInicio = document.getElementById("dataInicioRelatorio").value;
  const dataFim = document.getElementById("dataFimRelatorio").value;
  
  let dadosFiltrados = [];
  let cabecalho = [];

  // 1. Obt√©m o cabe√ßalho
  tabela.querySelectorAll('thead th').forEach(th => {
    // Ignora colunas de A√ß√µes e Foto para um CSV mais limpo
    if (th.textContent.trim() !== "A√ß√µes" && th.textContent.trim() !== "Foto") {
      cabecalho.push(th.textContent.trim());
    }
  });

  // 2. Obt√©m os dados e filtra por data (se for tabela de Entradas ou Sa√≠das)
  const isEntradaOuSaida = idTabela === 'tabelaEntradas' || idTabela === 'tabelaSaidas';
  const dataColuna = isEntradaOuSaida ? 5 : -1; // Coluna 5 √© a 'Data' em Entradas e Sa√≠das (√≠ndice 0)

  tabela.querySelectorAll('tbody tr').forEach(row => {
    let rowData = [];
    let shouldInclude = true;
    let dataDaLinha = "";
    
    row.querySelectorAll('td').forEach((td, index) => {
      // Ignora a √∫ltima coluna (A√ß√µes) e a segunda (Foto)
      if (index === row.cells.length - 1 || td.querySelector('.thumb')) return;
      
      const texto = td.textContent.trim();
      rowData.push(texto);
      
      if (isEntradaOuSaida && index === dataColuna) {
        dataDaLinha = texto;
      }
    });
    
    // Filtra por data se aplic√°vel
    if (isEntradaOuSaida && dataDaLinha && dataInicio && dataFim) {
        const dataLinha = new Date(dataDaLinha);
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        // Adiciona um dia ao fim para incluir a data final
        fim.setDate(fim.getDate() + 1); 

        if (dataLinha < inicio || dataLinha >= fim) {
            shouldInclude = false;
        }
    }

    if (shouldInclude && rowData.length > 0) {
      dadosFiltrados.push(rowData);
    }
  });
  
  if (dadosFiltrados.length === 0) {
      alert("Nenhum dado encontrado para exportar com base nos filtros (se houver).");
      return;
  }

  // 3. Cria o conte√∫do CSV
  let csvContent = cabecalho.join(";") + "\n";
  dadosFiltrados.forEach(row => {
    // Substitui v√≠rgulas por pontos e v√≠rgulas para evitar problemas de formata√ß√£o em Excel
    csvContent += row.map(item => item.replace(/;/g, ",").replace(/\r?\n|\r/g, " ")).join(";") + "\n";
  });

  // 4. Cria o Blob e baixa o arquivo
  const nomeCompleto = `${prefixo || ""}${nomeArquivoBase}_${new Date().toISOString().split('T')[0]}.csv`;
  const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // \uFEFF for BOM (UTF-8 encoding in Excel)
  const link = document.createElement("a");
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", nomeCompleto);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    mostrarMensagem(`Relat√≥rio '${nomeArquivoBase}' exportado com sucesso!`, "sucesso");
  }
}

function exportarListaExcel() {
    exportarTabelaExcel('tabelaListaCompra', 'Lista_de_Compra', 'Compra_');
}

/**
 * üîπ Fun√ß√£o para gerar Pedido de Or√ßamento em PDF (usando jspdf e autotable)
 */
function gerarPedidoPDF() {
    if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        alert("Erro: Biblioteca jsPDF n√£o carregada. Verifique as tags <script> no final do arquivo.");
        return;
    }
    
    // Pega os dados da lista de compra ATUAL (o que est√° na tela)
    const tabela = document.getElementById("tabelaListaCompra");
    const tbody = tabela ? tabela.querySelector("tbody") : null;
    if (!tbody || tbody.textContent.includes("Nenhum item abaixo")) {
        alert("‚ö†Ô∏è Nenhuma Lista de Compra gerada para exportar!");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Paisagem, mil√≠metros, A4
    const larguraPagina = doc.internal.pageSize.getWidth();
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    
    // --- CABE√áALHO ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("ORAL UNIC CAMPO GRANDE", larguraPagina / 2, 20, { align: "center" });
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.text("Pedido de Or√ßamento", larguraPagina / 2, 28, { align: "center" });
    
    doc.setFontSize(10);
    doc.text(`Data: ${dataAtual}`, 14, 38);
    doc.text(`Solicitante: ${document.getElementById("userName").textContent}`, 14, 44);

    // --- LINHA SEPARADORA ---
    doc.setDrawColor(180);
    doc.line(14, 48, larguraPagina - 14, 48);
    
    // --- TABELA ---
    const headers = [
        ['#', 'Produto', 'C√≥d. Barras', 'Categoria', 'Qtd Atual', 'M√≠nimo', 'Recomenda√ß√£o', 'Observa√ß√£o']
    ];
    
    const body = [];
    tbody.querySelectorAll("tr").forEach(tr => {
        const cols = tr.querySelectorAll("td");
        if (cols.length > 1) { // Ignora linha de rodap√© e linha de erro
            body.push([
                cols[0].textContent.trim(),
                cols[1].textContent.trim(),
                cols2.textContent.trim(), // C√≥d. Barras
                cols[3].textContent.trim(),
                cols[4].textContent.trim(),
                cols[5].textContent.trim(),
                cols[6].textContent.trim(),
                '' // Coluna vazia para observa√ß√£o manual do fornecedor
            ]);
        }
    });

    doc.autoTable({
        head: headers,
        body: body,
        startY: 55,
        theme: 'striped',
        headStyles: { fillColor: [13, 110, 253] }, // Azul
        columnStyles: {
            0: { cellWidth: 10 },
            1: { cellWidth: 40 },
            2: { cellWidth: 25 },
            6: { fontStyle: 'bold' },
        },
        styles: { fontSize: 8, overflow: 'linebreak' },
    });
    
    // --- RODAP√â ---
    const finalY = doc.autoTable.previous.finalY;
    doc.setFontSize(10);
    doc.setFont("helvetica", "italic");
    doc.text("Este documento n√£o √© um pedido oficial de compra, mas um pedido de or√ßamento.", 14, finalY + 10);
    
    doc.save(`Pedido_Orcamento_${new Date().toISOString().split('T')[0]}.pdf`);
    mostrarMensagem("Pedido de Or√ßamento exportado para PDF.", "sucesso");
}



// --- UTILIT√ÅRIOS GLOBAIS ---

function ordenarListasAlfabeticamente() {
  if (typeof produtos !== "undefined" && Array.isArray(produtos)) {
    produtos.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
    // N√£o precisa salvar, pois esta √© apenas uma fun√ß√£o de ordena√ß√£o visual/de refer√™ncia
  }

  if (typeof entradas !== "undefined" && Array.isArray(entradas)) {
    entradas.sort((a, b) => (a.fornecedor || "").localeCompare(b.fornecedor || "", 'pt-BR', { sensitivity: 'base' }));
  }

  if (typeof saidas !== "undefined" && Array.isArray(saidas)) {
    saidas.sort((a, b) => (a.produto || "").localeCompare(b.produto || "", 'pt-BR', { sensitivity: 'base' }));
  }

  if (typeof usuarios !== "undefined" && Array.isArray(usuarios)) {
    usuarios.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
  }
  
  // Atualiza selects de produto
  if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
}


// --- EXECU√á√ÉO INICIAL ---

document.addEventListener("DOMContentLoaded", () => {
  const dadosLocais = JSON.parse(localStorage.getItem("dadosSistema") || "{}");

  window.errosProblemas = Array.isArray(dadosLocais.errosProblemas)
    ? dadosLocais.errosProblemas
    : [];

  atualizarTabelaErros();
});


document.addEventListener('click', (event) => {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    if (!sidebar || !menuToggle) return;

    // Use a mesma l√≥gica robusta: Se a sidebar n√£o estiver completamente escondida
    const currentLeft = parseFloat(window.getComputedStyle(sidebar).getPropertyValue('left'));
    
    // Se a sidebar estiver vis√≠vel (left: 0px)
    if (currentLeft >= 0) {
        
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickOnToggle = menuToggle.contains(event.target);

        // Se o clique n√£o foi dentro da sidebar e n√£o foi no bot√£o de toggle, fecha
        if (!isClickInsideSidebar && !isClickOnToggle) {
            // Chamamos toggleSidebar para fechar a sidebar
            toggleSidebar();
        }
    }
});

// =============================================
// üìä FUN√á√ÉO: Atualizar Tabela de Valor Hist√≥rico
// =============================================
window.atualizarTabelaValorHistorico = function() {
  const tabela = document.querySelector("#tabelaValorHistorico tbody");
  if (!tabela) return;
  tabela.innerHTML = "";

  const entradas = window.entradas || [];
  if (entradas.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="14" style="text-align:center; color:#888;">Sem registros de entrada encontrados.</td>`;
    tabela.appendChild(row);
    return;
  }

  // üîπ Agrupa valores por produto e m√™s
  const historico = {};

  entradas.forEach(ent => {
    if (!ent.produto || !ent.valor || !ent.data) return;

    const produto = ent.produto;
    const valor = parseFloat(ent.valor);
    const data = new Date(ent.data);
    const mes = data.getMonth(); // 0 = jan, 11 = dez

    if (!historico[produto]) historico[produto] = Array(12).fill(null);
    historico[produto][mes] = valor;
  });

  // üîπ Ordena produtos em ordem alfab√©tica
const historicoOrdenado = Object.entries(historico).sort(([a], [b]) =>
  a.localeCompare(b, 'pt-BR')
);

// üîπ Preenche a tabela com lista ordenada
historicoOrdenado.forEach(([produto, valores], index) => {
    const cadastrado = window.produtos.find(p => p.nome === produto);
    const codigoProduto = cadastrado?.codigo || "-";
    const row = document.createElement("tr");

    let html = `
      <td style="text-align:center; font-weight:600;">${index + 1}</td>
      <td style="text-align:center; width:70px;" title="${codigoProduto}">
        ${codigoProduto}
      </td>
      <td style="text-align:left; max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
          title="${produto}">
        ${produto}
      </td>
    `;


    // üóìÔ∏è 12 meses
    for (let i = 0; i < 12; i++) {
      const valor = valores[i];

      if (valor === null) {
        html += `<td style="color:#ccc; text-align:center;">‚Äì</td>`;
      } else {

        let seta = "";

        // Compara√ß√£o com o m√™s anterior
        if (i > 0 && valores[i - 1] !== null) {
          const anterior = valores[i - 1];

          if (valor > anterior) {
            seta = `<span style="
              display:inline-block;
              background:#dc3545;
              color:#fff;
              border-radius:50%;
              width:18px;
              height:18px;
              line-height:18px;
              font-size:12px;
              text-align:center;
            ">‚ñ≤</span>`;
          }

          else if (valor < anterior) {
            seta = `<span style="
              display:inline-block;
              background:#0d6efd;
              color:#fff;
              border-radius:50%;
              width:18px;
              height:18px;
              line-height:18px;
              font-size:12px;
              text-align:center;
              transform:rotate(180deg);
            ">‚ñ≤</span>`;
          }

          else {
            seta = `<span style="
              display:inline-block;
              background:#ccc;
              border-radius:50%;
              width:12px;
              height:12px;
              box-shadow:inset 0 0 2px rgba(0,0,0,0.4);
            "></span>`;
          }
        }

        html += `
          <td style="text-align:center;">
            R$ ${valor.toFixed(2)} ${seta}
          </td>
        `;
      }
    }

       row.innerHTML = html;
    tabela.appendChild(row);
  });

  // üîç Filtro CORRIGIDO de busca ‚Äî procura em toda a linha
window.filtrarValorHistorico = function() {
  const filtro = (document.getElementById("filtroValorHistorico").value || "")
    .toLowerCase()
    .trim();

  const linhas = document.querySelectorAll("#tabelaValorHistorico tbody tr");

  linhas.forEach(linha => {
    const textoLinha = (linha.innerText || "").toLowerCase();
    linha.style.display = textoLinha.includes(filtro) ? "" : "none";
  });
};

// üîÑ Limpar filtro
window.limparFiltroValorHistorico = function() {
  const campo = document.getElementById("filtroValorHistorico");
  if (campo) campo.value = "";
  window.filtrarValorHistorico();
};

}

// üîÑ Atualiza a tabela automaticamente ao abrir a se√ß√£o
document
  .querySelector("#sidebar button[onclick=\"showSection('valorHistorico')\"]")
  ?.addEventListener("click", atualizarTabelaValorHistorico);


/* =====================================================
   ‚ú® CORRE√á√ÉO ORTOGR√ÅFICA AUTOM√ÅTICA ‚Äî RELATOS DE ERROS
   ===================================================== */
function habilitarCorrecaoOrtografica() {
  const campoRelato = document.getElementById("erroDescricao");
  if (!campoRelato) {
    console.warn("‚ö†Ô∏è Campo de relato n√£o encontrado.");
    return;
  }

  // üîπ Ativa corre√ß√£o nativa do navegador
  campoRelato.setAttribute("spellcheck", "true");
  campoRelato.setAttribute("autocomplete", "on");
  campoRelato.setAttribute("autocorrect", "on");
  campoRelato.setAttribute("autocapitalize", "sentences");

  // üîπ Corre√ß√µes simples autom√°ticas (acentos e pontua√ß√£o b√°sica)
  campoRelato.addEventListener("input", () => {
    let texto = campoRelato.value;

    // Pequenas substitui√ß√µes comuns de digita√ß√£o
    texto = texto
      .replace(/\bnao\b/gi, "n√£o")
      .replace(/\bestao\b/gi, "est√£o")
      .replace(/\bvoce\b/gi, "voc√™")
      .replace(/\bta\b/gi, "t√°")
      .replace(/\bpor que\b/gi, "por qu√™")
      .replace(/\btd\b/gi, "tudo")
      .replace(/\bpq\b/gi, "porque")
      .replace(/\bq\b/gi, "que")
      .replace(/\bvc\b/gi, "voc√™")
      .replace(/\bnem sei\b/gi, "nem sei üòÖ");

    // Corrige espa√ßos duplos e capitaliza o in√≠cio da frase
    texto = texto.replace(/\s{2,}/g, " ");
    texto = texto.replace(/(^|[\.\!\?]\s+)([a-z])/g, (m, p1, p2) => p1 + p2.toUpperCase());

    campoRelato.value = texto;
  });

  console.log("üìù Corre√ß√£o ortogr√°fica leve ativada para relatos de erros.");
}

// üîÅ Ativa ap√≥s 1 segundo (garantindo que o campo j√° existe no DOM)
setTimeout(habilitarCorrecaoOrtografica, 1000);







</script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

		




















