<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --azul: #0d6efd;
      --azul-escuro: #003b88;
      --cinza-fundo: #f4f6f9;
      --branco: #ffffff;
      --cinza: #e0e0e0;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #222;
    }

    /* ========================= HEADER ========================= */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--azul);
      color: var(--branco);
      padding: 12px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 900;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header button {
      background: none;
      border: none;
      color: var(--branco);
      cursor: pointer;
      font-size: 1.3rem;
    }

    header button:hover {
      color: #e2e2e2;
    }

   /* ========================= MENU LATERAL ========================= */
 #sidebar {
  position: fixed;
  top: 0;
  left: -260px; /* escondido 10px a mais */
  width: 250px;
  height: 100%;
  background: var(--azul-escuro);
  color: var(--branco);
  overflow-y: auto;
  transition: left 0.3s ease;
  z-index: 800;
  padding-top: 60px;
  border-right: none;
  box-shadow: none;
 }

/* Quando ativo (aberto) */
#sidebar.active {
  left: 0;
}


    #sidebar.active {
      left: 0;
    }

    #sidebar button {
      display: block;
      width: 100%;
      border: none;
      background: none;
      color: var(--branco);
      text-align: left;
      padding: 14px 18px;
      font-size: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      transition: background 0.2s;
    }

    #sidebar button i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
    }

    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* ========================= √ÅREA PRINCIPAL ========================= */
   main {
  margin: 20px;
  padding-left: 0;
  transition: margin-left 0.3s ease;
  overflow-x: hidden; /* impede overflow lateral */
}


    @media (min-width: 900px) {
      #sidebar.active + main {
        margin-left: 250px;
      }
    }

    /* ========================= TABELAS ========================= */
.table-wrap {
  max-height: 60vh; /* altura m√°xima vis√≠vel */
  overflow-y: auto;          /* rolagem vertical */
  overflow-x: auto; /* rolagem horizontal se necess√°rio */
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  scrollbar-width: thin; /* Firefox */
  scrollbar-color: #888 #f0f0f0;
}

/* üîπ Mant√©m o cabe√ßalho fixo dentro da √°rea rol√°vel */
.table-wrap table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px; /* evita desalinhamento */
}

.table-wrap table thead th {
  position: sticky;
  top: 0;
  background: var(--azul);
  color: #fff;
  z-index: 10;
  text-align: left;
  padding: 10px 12px;
  border: 1px solid #ddd;
  box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
}

.table-wrap table td {
  border: 1px solid #ddd;
  padding: 10px 12px;
  font-size: 14px;
}

.table-wrap table tr:nth-child(even) {
  background-color: #f9f9f9;
}

/* üîπ Scrollbar estilizada */
.table-wrap::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
.table-wrap::-webkit-scrollbar-track {
  background: #f0f0f0;
  border-radius: 8px;
}
.table-wrap::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 8px;
}
.table-wrap::-webkit-scrollbar-thumb:hover {
  background: #555;
}


    /* ========================= BOT√ïES (Geral) ========================= */
    button {
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    button:hover {
      background: var(--azul-escuro);
    }

    /* ========================= INPUTS E SELECTS (Geral) ========================= */
    input, select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin: 3px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--azul);
    }

/* ======================================================= */
/* ====== CORRE√á√ÉO LAYOUT E BOT√ïES (Input Row, Cards) ====== */
/* ======================================================= */

/* Melhoria na apar√™ncia dos inputs nas se√ß√µes */
.section input[type="text"],
.section input[type="number"],
.section input[type="date"],
.section select {
  padding: 8px 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-sizing: border-box; /* Essencial para layout em linha */
  min-height: 40px; /* Garante altura uniforme */
}

/* Otimiza√ß√£o: For√ßa campos em linha a se ajustarem */
.input-row > input[type="text"].flex,
.input-row > input[type="number"].flex {
    flex-grow: 1;
    min-width: 150px;
}


/* üîπ Organiza√ß√£o dos campos de formul√°rio em linha (muito importante) */
.input-row {
  display: flex;
  flex-wrap: wrap; /* Permite que os itens quebrem a linha */
  gap: 12px;
  align-items: center;
  margin-bottom: 25px !important; /* Mais espa√ßo para o bloco */
  padding: 15px;
  border: 1px solid var(--cinza);
  border-radius: 8px;
  background: var(--branco);
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
}

/* üîπ Bot√µes de A√ß√£o nas Se√ß√µes (Mais robustos) */
.section button {
  background: var(--azul);
  color: var(--branco);
  border: none;
  padding: 10px 18px;
  border-radius: 5px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s, transform 0.1s;
  white-space: nowrap;
  font-size: 15px;
}

.section button:hover {
  background: var(--azul-escuro);
  transform: translateY(-1px);
}

/* üîπ Melhoria nos Cards do Dashboard (Estilo modernizado com borda lateral) */
/* Sobrescreve o estilo existente com este mais completo */
.dash-card {
  background: var(--branco);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  border-left: 5px solid var(--azul); /* Borda de destaque */
  transition: all 0.2s ease;
}

.dash-card h3 {
  color: var(--azul-escuro);
  margin-top: 0;
  font-size: 1.1em;
  padding-bottom: 0;
  border-bottom: none;
}

.dash-card ul {
  list-style: none;
  padding: 0;
  margin-top: 10px;
}

.dash-card li {
  padding: 6px 0;
  border-bottom: 1px dashed #eee;
  font-size: 0.9em;
}

.dash-card li:last-child {
  border-bottom: none;
}

/* Bot√µes da Tabela (Estilo secund√°rio) */
table button {
  background: #6c757d; /* Cinza secund√°rio */
  padding: 5px 10px;
  font-size: 13px;
  font-weight: 500;
}

table button:hover {
  background: #5a6268;
}

/* Bot√µes de A√ß√£o Espec√≠ficos */
button.btn-delete {
  background: #dc3545 !important;
}
button.btn-delete:hover {
  background: #c82333 !important;
}



    /* ========================= IMAGENS ========================= */
    .thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .thumb:hover {
      transform: scale(1.08);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
    }

    #imagemAmpliada {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #imagemAmpliada img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      cursor: pointer;
    }

    /* ========================= LOGIN ========================= */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
    }

    .login-card {
      background: var(--branco);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      text-align: center;
      width: 320px;
    }

    .login-card h2 {
      color: var(--azul-escuro);
      margin-bottom: 20px;
    }

    .login-card input {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .login-card button {
      width: 100%;
      margin-top: 10px;
    }
/* üîπ Centraliza√ß√£o est√°vel da tela de login */
#loginView {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  overflow: hidden;
  z-index: 1000;
}

/* Evita o scroll autom√°tico ao alternar login/sistema */
html, body {
  height: 100%;
  overflow-y: auto; /* ativa rolagem vertical */
  overflow-x: hidden; /* evita rolagem lateral */
}
#loginMsg {
  background: #f8d7da;
  border-radius: 5px;
  padding: 8px;
  font-weight: bold;
}
#loginMsg[style*="green"] {
  background: #d4edda;
}

    /* ========================= SE√á√ïES ========================= */
    section {
      display: none;
    }

    section h2 {
      color: var(--azul-escuro);
      border-left: 5px solid var(--azul);
      padding-left: 10px;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
	/* ========================= ROLAGEM POR SE√á√ÉO ========================= */
.section {
  max-height: calc(100vh - 140px); /* altura vis√≠vel abaixo do cabe√ßalho */
  overflow-y: auto; /* ativa rolagem vertical */
  overflow-x: hidden; /* evita rolagem lateral */
  padding-bottom: 20px; /* espa√ßamento inferior */
  scroll-behavior: smooth; /* rolagem suave */
}
/* ========================= DASHBOARD (Ajustado) ========================= */
.dash-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.dash-card {
  background: var(--branco);
  border-radius: 10px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  padding: 15px 20px;
  transition: transform 0.2s ease;
}

.dash-card:hover {
  transform: scale(1.02);
}

.dash-card h3 {
  color: var(--azul-escuro);
  margin-bottom: 10px;
  border-bottom: 2px solid var(--azul);
  padding-bottom: 5px;
  font-size: 16px;
}

.dash-card ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.dash-card ul li {
  padding: 5px 0;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.dash-card ul li:last-child {
  border-bottom: none;
}


    /* ========================= RODAP√â (opcional futuro) ========================= */
  </style>
</head>
<body>

  <div id="imagemAmpliada" onclick="this.style.display='none'">
    <img src="" alt="Imagem ampliada">
  </div>

  <div id="loginView" class="login-container">
    <div class="login-card">
      <h2><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque</h2>
      <input id="usuarioLogin" type="text" placeholder="Usu√°rio" />
      <input id="senhaLogin" type="password" placeholder="Senha" />
      <button onclick="fazerLogin()"><i class="fa fa-right-to-bracket"></i> Entrar</button>
	  <p id="loginMsg" 
 style="display:none; color:red; font-weight:bold; text-align:center;"></p>
      
      </div>
    </div>
  </div>

  <div id="mainApp" style="display:none;">

    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="menuToggle" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <h1><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
     
     <div id="userName" style="font-weight:700">Visitante</div>
        <div id="perfilBadge" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;font-size:13px;">PERFIL</div>
        <button onclick="logout()" title="Sair"><i class="fa fa-sign-out-alt"></i></button>
      </div>
    </header>

    <aside id="sidebar" aria-hidden="true">
	  <button onclick="showSection('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</button>
      <button onclick="showSection('cadastro')"><i class="fa fa-box"></i> Cadastro de Produtos</button>
      <button onclick="showSection('entrada')"><i class="fa fa-arrow-down"></i> Entrada de Materiais</button>
      <button onclick="showSection('saida')"><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</button>
      <button onclick="showSection('estoque')"><i 
 class="fa fa-warehouse"></i> Estoque Atual</button>
      <button onclick="showSection('limites')"><i class="fa fa-sliders-h"></i> Estoque M√≠n/M√°x</button>
      <button onclick="showSection('financeiro')"><i class="fa fa-coins"></i> Financeiro</button>
      <button onclick="showSection('relatorios')"><i class="fa fa-file-excel"></i> Relat√≥rios</button>
      <button onclick="showSection('usuarios')"><i class="fa fa-users"></i> Usu√°rios e Perfis</button>

    </aside>

    <main>
<section id="boasVindas" class="section active" style="text-align:center;
 padding:100px 20px;">
  <h1 style="color:#003b88;">üëã Bem-vindo(a) <span id="nomeUsuarioBemVindo"></span>!</h1>
  <h2 style="color:#0d6efd;">ao Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h2>
  <p style="margin-top:20px;
 color:#555;">Use o menu lateral para iniciar suas atividades.</p>
</section>

      <section id="cadastro" class="section">
        <h2><i class="fa fa-box"></i> Cadastro de Produtos</h2>

        <div class="input-row">
          <input id="produtoNome" type="text" placeholder="Nome do produto" class="flex" />
		  
          <select id="produtoCategoria">
  <option value="">Selecione a categoria</option>
  <option>Material de Uso e Consumo</option>
  <option>Copa e Cozinha</option>
  <option>Escrit√≥rio</option>
  <option>Implante e 
 Componentes</option>
  <option>Insumo Dental</option>
  <option>Insumo Laborat√≥rio</option>
  <option>Medicamentos</option>
  <option>Material de Limpeza</option>
</select>
          <select id="produtoEmbalagem">
  <option value="">Selecione o tipo de embalagem</option>
  <option>Ampola</option>
  <option>Caixa</option>
  <option>Fardo</option>
  <option>Frasco</option>
  <option>Garrafa</option>
  <option>Gramas</option>
  <option>Litro</option>
  <option>Pacote</option>
  <option>Pe√ßa</option>
  <option>Quilogramas (KG)</option>
  <option>Saco</option>
  <option>Unidade</option>
</select>
          <input id="produtoQtdEmbalagem" type="number" placeholder="Qtd por embalagem" style="width:140px" />
		  <input id="produtoCodigoBarras" type="text" placeholder="üì∑C√≥digo de Barras (opcional)" style="width:220px" />

          <input id="produtoFoto" type="file" accept="image/*" />
    
        <button onclick="cadastrarProduto()"><i class="fa fa-save"></i> Cadastrar</button>
        </div>

        <div style="margin-bottom:10px;">
          <input id="filtroProduto" type="text" placeholder="üîç Filtrar por nome ou categoria" style="width:98%" oninput="filtrarProdutos()" />
        </div>

        <div class="table-wrap">
          <table id="tabelaProdutos">
            <thead>
            
  <tr>
                <th>#</th>
                <th>Foto</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Embalagem</th>
                <th>Qtd/Emb.</th>
				 <th>C√≥d.
 Barras</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

     <section id="entrada" class="section" style="display:none;">

  <h2><i class="fa 
 fa-arrow-down"></i> Entrada de Materiais</h2>
   <div class="input-row">
<input id="entradaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" 
       style="min-width:200px;"
 oninput="buscarProdutoPorCodigo('entrada')" />
    <input id="entradaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" />
    <input id="entradaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
    <input id="entradaValor" type="number" placeholder="Valor Unit√°rio (R$)" step="0.01" style="width:150px" />
    <input id="entradaData" type="date" style="width:160px" />
    <input id="entradaNota" type="text" placeholder="Nota Fiscal" />
    <input id="entradaFornecedor" type="text" placeholder="Fornecedor" />
    <input id="entradaCNPJ" type="text" placeholder="CNPJ" />
    <input id="entradaLote" type="text" placeholder="Lote" />
    <input id="entradaValidade" type="date" placeholder="Validade" />
    
    <select id="entradaSetor">
     
   <option value="">Selecione o Setor Utilizado</option>
      <option>Limpeza da Cl√≠nica</option>
      <option>Laborat√≥rio</option>
      <option>Escrit√≥rio</option>
      <option>Copa e Cozinha</option>
      <option>Cl√≠nico Geral</option>
      <option>Centro Cir√∫rgico</option>
    </select>

    <button onclick="registrarEntrada()"><i class="fa fa-save"></i> Registrar Entrada</button>
  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroEntrada" type="text" placeholder="üîç Buscar por produto, fornecedor ou NF" style="width:98%" oninput="filtrarEntradas()" />
  </div>

  <div class="table-wrap">
  <table id="tabelaEntradas">
    <thead>
      <tr>
 
        <th>#</th>
        <th>Produto</th>
        <th>C√≥digo de Barras</th>
        <th>Qtd</th>
        <th>Valor (R$)</th>
        <th>Data</th>
        <th>NF</th>
        <th>Fornecedor</th>
        <th>CNPJ</th>
        <th>Lote</th>
        <th>Validade</th>
        <th>Setor</th>
  
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</section>



 <section id="saida" class="section" style="display:none;">
  <h2><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</h2>

  <div class="input-row">
  <input id="saidaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" oninput="atualizarSetorAutomatico()" />

           
    <input id="saidaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" oninput="atualizarSetorAutomatico()" />
    <input id="saidaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
    <input id="saidaResponsavel" type="text" placeholder="Respons√°vel" />
    <input id="saidaObservacao" type="text" 
 placeholder="Observa√ß√£o (opcional)" />
    <select id="saidaSetor">
      <option value="">Selecione o Setor</option>
    </select>
    <input id="saidaData" type="date" style="width:160px" />
    <button onclick="registrarSaida()"><i class="fa fa-save"></i> Registrar Sa√≠da</button>
  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroSaida" type="text" placeholder="üîç Buscar por produto, setor ou respons√°vel" style="width:98%" oninput="filtrarSaidas()" />
  </div>

  <div class="table-wrap">
    <table id="tabelaSaidas">
      <thead>
        <tr>
          <th>#</th>
        
          <th>Produto</th>
		   <th>C√≥digo de Barras</th>
          <th>Qtd</th>
          <th>Data</th>
          <th>Setor</th>
          <th>Respons√°vel</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>



      <section id="estoque" class="section" style="display:none;">
        <h2><i class="fa fa-warehouse"></i> Estoque Atual</h2>

        <div style="margin-bottom:10px;">
          <input id="filtroEstoque" type="text" placeholder="üîç Buscar no estoque (produto, categoria)" style="width:98%" oninput="filtrarEstoque()" />
        </div>

        <div class="table-wrap">
        <table id="tabelaEstoque">
  <thead>
    <tr>
      <th>#</th>
      <th>Produto</th>
  
      <th>C√≥digo de Barras</th>
      <th>Categoria</th>
      <th>Quantidade</th>
      <th>Lote</th>
      <th>Validade</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
        </div>
      </section>

<section id="limites" class="section" style="display:none;">
  <h2><i class="fa fa-boxes"></i> Estoque M√≠nimo e M√°ximo</h2>

  <div id="resumoEstoque" style="margin-bottom:10px;
 font-weight:bold; color:#333;">
    üßæ Total de Produtos: 0 |
    ‚ö†Ô∏è Abaixo do M√≠nimo: 0 |
    ‚úÖ Dentro do Limite: 0 |
    üì¶ Acima do M√°ximo: 0
  </div>

  <div style="display:flex;
 flex-wrap:wrap; gap:10px; margin-bottom:15px;">
    <input
      id="filtroLimite"
      type="text"
      placeholder="üîç Buscar por produto"
      style="flex:1;
 min-width:220px"
      oninput="atualizarTabelaLimites()"
    />

    <select id="filtroCategoria" onchange="atualizarTabelaLimites()" style="min-width:220px;">
      <option value="">Todas as Categorias</option>
      <option>Material de Uso e Consumo</option>
      <option>Copa e Cozinha</option>
      <option>Escrit√≥rio</option>
      <option>Implante e Componentes</option>
      <option>Insumo Dental</option>
      <option>Insumo Laborat√≥rio</option>
      <option>Medicamentos</option>
      <option>Material de Limpeza</option>
    </select>

    <button onclick="gerarListaCompra()"><i class="fa fa-list"></i> Gerar Lista 
 de Compra</button>
    <button onclick="limparListaCompra()"><i class="fa fa-trash"></i> Limpar Lista</button>
  </div>

  <div class="table-wrap">
  <table id="tabelaLimites">
  <thead>
    <tr>
      <th>#</th>
      <th>Produto</th>
      <th>C√≥digo de Barras</th>
      <th>Categoria</th>
      <th>Qtd Atual</th>
      <th>M√≠nimo</th>
      <th>M√°ximo</th>
      <th>Status</th>
      <th>Recomenda√ß√£o</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
 
  <tbody></tbody>
</table>


  </div>

  
  <div id="listaCompraContainer" style="display:none;
 margin-top:20px;">
  <h3><i class="fa fa-shopping-cart"></i> Lista de Compra Gerada</h3>

 <div class="table-wrap" style="max-height:400px; overflow-y:auto; overflow-x:auto;
 border:1px solid #ccc;">
    <table id="tabelaListaCompra" class="tabela-padrao">
      <thead>
        <tr>
          <th>#</th>
          <th>Produto</th>
          <th>C√≥digo de Barras</th>
          <th>Categoria</th>
          <th>Qtd Atual</th>
          <th>M√≠nimo</th>
          <th>Recomendado Comprar</th>
    
     </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="6" style="text-align:right;
 font-weight:bold;">Total de Itens:</td>
          <td id="totalItensCompra" style="font-weight:bold;">0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div style="margin-top:10px;">
    <button onclick="exportarListaExcel()">
      <i class="fa fa-file-excel"></i> Exportar para Excel
    </button>
    <button onclick="gerarPedidoPDF()">
      <i class="fa fa-file-pdf"></i> Gerar Pedido de Or√ßamento (PDF)
    </button>
  </div>
</div>

</section>







      <section id="financeiro" class="section" style="display:none;">
  <h2><i class="fa fa-chart-line"></i> Painel Financeiro</h2>

  <div style="display:flex;
 flex-wrap:wrap; gap:15px; margin-bottom:20px;">

    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px;
 padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ √öltimo Valor de Entrada</h3>
      <p id="valorUltimaEntrada" style="font-size:1.4em;
 font-weight:bold; color:#007bff;">R$ 0,00</p>
    </div>

    <div style="flex:1;
 min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üìä Custo M√©dio Ponderado</h3>
      <p id="valorCustoMedio" style="font-size:1.4em;
 font-weight:bold; color:#6f42c1;">R$ 0,00</p>
    </div>

    <div style="flex:1;
 min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üì¶ Valor Total do Estoque Atual</h3>
      <p id="valorEstoqueAtualPainel" style="font-size:1.4em;
 font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>
  </div>

  <div style="display:flex; flex-wrap:wrap;
 gap:15px; margin-bottom:20px;">
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center;
 box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ Valor Total do Estoque Atual (Cont√°bil)</h3>
      <p id="valorEstoque" style="font-size:1.4em;
 font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>

    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center;
 box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∏ Valor Total das Sa√≠das (Estimado)</h3>
      <p id="valorSaidas" style="font-size:1.4em;
 font-weight:bold; color:#dc3545;">R$ 0,00</p>
    </div>
  </div>

  <h3 style="margin-top:25px;"><i class="fa fa-file-invoice"></i> Entradas Agrupadas por Nota Fiscal</h3>
  <div class="table-wrap">
    <table id="tabelaFinanceiro">
      <thead>
        <tr>
          <th>Fornecedor</th>
          <th>Nota Fiscal</th>
          <th>Valor Total da Nota (R$)</th>
          <th>Saldo da Nota (R$)</th>
      
    </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>




      <section id="relatorios" class="section" style="display:none;">
  <h2><i class="fa fa-chart-line"></i> Relat√≥rios</h2>

  <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
    <button onclick="gerarRelatorioProdutos()"><i class="fa fa-file-excel"></i> Produtos</button>
    <button onclick="gerarRelatorioEntradas()"><i class="fa fa-file-excel"></i> Entradas</button>
    <button onclick="gerarRelatorioSaidas()"><i class="fa fa-file-excel"></i> Sa√≠das</button>
    <button onclick="gerarRelatorioEstoque()"><i class="fa fa-file-excel"></i> Estoque</button>
  </div>

  <div id="filtroPeriodo" style="margin: 15px 
 0; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
    <label><b>Data In√≠cio:</b></label>
    <input type="date" id="dataInicioRelatorio" style="padding: 4px 6px;">
    <label><b>Data Fim:</b></label>
    <input type="date" id="dataFimRelatorio" style="padding: 4px 6px;">
    <button onclick="filtrarRelatoriosPorPeriodo()">Filtrar</button>
    <button onclick="definirPeriodoRapido('7dias')">√öltimos 7 dias</button>
    <button onclick="definirPeriodoRapido('30dias')">√öltimos 30 dias</button>
    <button onclick="definirPeriodoRapido('mes')">M√™s Atual</button>
    <button onclick="limparPeriodo()">Limpar</button>
  </div>

  <div style="background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    <p>Os relat√≥rios s√£o gerados em formato Excel (.csv) e incluem todos os dados das tabelas correspondentes.</p>
  </div>
</section>


      <section id="usuarios" class="section" style="display:none;">
        <h2><i class="fa fa-users"></i> Gerenciar Usu√°rios e Perfis</h2>
        
        <div class="input-row">
          <input id="usuarioNome" type="text" placeholder="Nome" />
          <input id="usuarioCPF" type="text" placeholder="CPF" />
          <input id="usuarioEmail" type="email" placeholder="E-mail" />
          <input id="usuarioSenha" type="password" placeholder="Senha" />
          <select id="usuarioPerfil">
            <option value="admin">Administrador</option>
            <option value="simples1">Simples 01</option>
            <option value="simples2">Simples 02</option>
          </select>
          <button onclick="salvarUsuario()"><i class="fa fa-save"></i> Salvar</button>
        </div>

        <div class="table-wrap">
          <table id="tabelaUsuarios">
            <thead>
              <tr>
                <th>#</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>Email</th>
                <th>Perfil</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="dashboard" class="section">
        <h2>üìä Dashboard do Sistema</h2>

        <div class="dash-container">
          <div class="dash-card">
            <h3>üïí Produtos Pr√≥ximos do Vencimento</h3>
            <ul id="listaProximosVencer"></ul>
          </div>
          <div class="dash-card">
            <h3>‚ö†Ô∏è Itens Abaixo do Estoque M√≠nimo</h3>
            <ul id="listaEstoqueMinimo"></ul>
          </div>
          <div class="dash-card">
            <h3>üìà Top 5 Produtos (Mais Sa√≠da)</h3>
            <ul id="listaTopSaidas"></ul>
          </div>
          <div class="dash-card">
            <h3>üè• Top 5 Setores (Mais Consumo)</h3>
            <ul id="listaTopSetores"></ul>
          </div>
        </div>

      </section>

    </main>
  </div>
  
  <script>
    // ================================ üîπ VARI√ÅVEIS GLOBAIS (DADOS) üîπ ================================
    let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
    let entradas = JSON.parse(localStorage.getItem("entradas")) || [];
    let saidas = JSON.parse(localStorage.getItem("saidas")) || [];
    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
    let usuarioLogado = null; // Armazena dados do usu√°rio logado

    // ================================ üõ†Ô∏è FUN√á√ïES DE UTILIDADE ================================

    /* ========================= üîπ Alternar Menu Lateral ========================= */
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const mainContent = document.querySelector("main");
      sidebar.classList.toggle("active");

      // Adiciona/remove classe do main para ajuste de margem
      if (window.innerWidth >= 900) {
        if (sidebar.classList.contains("active")) {
          mainContent.style.marginLeft = "250px";
        } else {
          mainContent.style.marginLeft = "0";
        }
      }
    }

    /* ========================= üîπ Exibir Se√ß√£o ========================= */
    function showSection(id) {
      document.querySelectorAll(".section").forEach(sec => {
        sec.classList.remove("active");
        sec.style.display = "none";
      });
      const section = document.getElementById(id);
      if (section) {
        section.classList.add("active");
        section.style.display = "block";
        section.scrollTop = 0; // Volta ao topo da se√ß√£o
      }
      
      // üîπ Atualiza dados se for financeiro
      if (id === "financeiro" && typeof atualizarPainelFinanceiro === "function") {
        atualizarPainelFinanceiro();
      }
      // üîπ Atualiza dados se for o dashboard
      if (id === "dashboard" && typeof atualizarDashboard === "function") {
        atualizarDashboard();
      }

      // üîπ Mant√©m a tela centralizada no login
      window.scrollTo(0, 0); 
    }

    /* ========================= üîπ Logout ========================= */
    function logout() {
      // üîπ Remove sess√£o salva
      localStorage.removeItem("usuarioLogado");
      // üîπ Esconde o app e volta para tela de login
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("loginView").style.display = "flex";
      // üîπ Limpa os campos de login e mensagem
      const usuarioEl = document.getElementById("usuarioLogin");
      const senhaEl = document.getElementById("senhaLogin");
      const msg = document.getElementById("loginMsg");
      if (usuarioEl) usuarioEl.value = "";
      if (senhaEl) senhaEl.value = "";
      if (msg) {
        msg.textContent = "";
        msg.style.display = "none";
      }
      // üîπ Opcional: foco no campo usu√°rio
      usuarioEl.focus();
    }


    /* ================================ üîê LOGIN, VERIFICA√á√ÉO E LOGOUT ================================ */
    
    // Executa quando o DOM estiver pronto
    document.addEventListener("DOMContentLoaded", () => {
        verificarSessao();
    });

    // === FUN√á√ÉO DE LOGIN ===
    function fazerLogin() {
      const nome = document.getElementById("usuarioLogin")?.value.trim();
      const senha = document.getElementById("senhaLogin")?.value.trim();
      let msg = document.getElementById("loginMsg");
      if (!msg) {
        msg = document.createElement("p");
        msg.id = "loginMsg";
        msg.style.cssText = "margin-top:10px; font-weight:bold; text-align:center;";
        document.getElementById("loginView").appendChild(msg);
      }
      
      msg.style.display = "none";
      
      // üîπ Verifica√ß√£o no Array de Usu√°rios (sem Firebase)
      const usuarioEncontrado = usuarios.find(u => u.email === nome && u.senha === senha);

      if (usuarioEncontrado) {
        // Sucesso
        msg.textContent = "Login bem-sucedido!";
        msg.style.cssText = "display:block; color:green; background:#d4edda; padding:8px; border-radius:4px;";
        
        // Salva sess√£o no localStorage
        localStorage.setItem("usuarioLogado", JSON.stringify(usuarioEncontrado));
        
        setTimeout(() => {
          mostrarSistema(usuarioEncontrado);
        }, 800);
        
      } else {
        // Falha no Login
        msg.textContent = "Erro: Usu√°rio ou senha inv√°lidos.";
        msg.style.cssText = "display:block; color:red; background:#f8d7da; padding:8px; border-radius:4px;";
      }
    }


    // === MOSTRA SISTEMA ===
    function mostrarSistema(sessao) {
      const loginView = document.getElementById("loginView");
      const mainApp = document.getElementById("mainApp");
      const userName = document.getElementById("userName");
      const perfilBadge = document.getElementById("perfilBadge");
      const sidebar = document.getElementById("sidebar");

      if (loginView && mainApp) {
        loginView.style.display = "none";
        mainApp.style.display = "block";
      }

      if (userName && sessao?.nome) userName.textContent = sessao.nome;
      if (perfilBadge && sessao?.perfil) perfilBadge.textContent = "Perfil: " + sessao.perfil.toUpperCase();
      
      // üîπ Mostra mensagem de boas-vindas
      const nomeBemVindo = document.getElementById("nomeUsuarioBemVindo");
      if (nomeBemVindo) nomeBemVindo.textContent = sessao.nome;
      
      // üîπ Oculta todas as outras se√ß√µes e mostra apenas a de boas-vindas
      document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
      const boasVindas = document.getElementById("boasVindas");
      if (boasVindas) boasVindas.style.display = "block";

      // üîπ Garante que o menu lateral esteja fechado
      if (sidebar && sidebar.classList.contains("active")) {
        sidebar.classList.remove("active");
      }

      // üîπ Atualiza vari√°veis e permiss√µes
      window.usuarioLogado = sessao;
      if (typeof aplicarPermissoes === "function") aplicarPermissoes();
      if (typeof bloquearAcoesSimples2 === "function") bloquearAcoesSimples2();

    }

    // === VERIFICA√á√ÉO DE SESS√ÉO (ao carregar) ===
    function verificarSessao() {
      const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado") || "{}");
      const loginView = document.getElementById("loginView");
      const mainApp = document.getElementById("mainApp");

      if (usuarioLogado && usuarioLogado.nome) {
        // Usu√°rio logado encontrado
        mostrarSistema(usuarioLogado);
      } else {
        // Nenhum usu√°rio logado, mant√©m tela de login
        if (loginView) loginView.style.display = "flex";
        if (mainApp) mainApp.style.display = "none";
      }
    }


    /* ========================= üì¶ Cadastro de produtos ========================= */
    function cadastrarProduto() {
      if (typeof padronizarCamposAntesDeSalvar === "function") padronizarCamposAntesDeSalvar();

      const nomeEl = document.getElementById("produtoNome");
      const categoriaEl = document.getElementById("produtoCategoria");
      const embalagemEl = document.getElementById("produtoEmbalagem");
      const qtdEl = document.getElementById("produtoQtdEmbalagem");
      const fotoInput = document.getElementById("produtoFoto");
      const codigoBarrasEl = document.getElementById("produtoCodigoBarras");
      const codigoBarras = codigoBarrasEl ? codigoBarrasEl.value.trim() : "";

      // üîπ Remove marca√ß√µes anteriores
      [nomeEl, categoriaEl, embalagemEl, qtdEl, fotoInput, codigoBarrasEl].forEach(el => {
        if (el) el.style.border = "1px solid #ccc";
      });

      // üîπ Valida√ß√µes ‚Äî mant√©m o que foi digitado
      if (!nomeEl.value.trim()) {
        alert("Informe o nome do produto!");
        nomeEl.style.border = "2px solid red";
        nomeEl.focus();
        return false;
      }
      if (!categoriaEl.value.trim()) {
        alert("Selecione a categoria do produto!");
        categoriaEl.style.border = "2px solid red";
        categoriaEl.focus();
        return false;
      }
      if (!embalagemEl.value.trim()) {
        alert("Selecione o tipo de embalagem!");
        embalagemEl.style.border = "2px solid red";
        embalagemEl.focus();
        return false;
      }
      if (!qtdEl.value || Number(qtdEl.value) <= 0) {
        alert("Informe a quantidade por embalagem!");
        qtdEl.style.border = "2px solid red";
        qtdEl.focus();
        return false;
      }
      if (!fotoInput.files || !fotoInput.files[0]) {
        alert("√â obrigat√≥rio inserir uma foto do produto!");
        fotoInput.style.border = "2px solid red";
        fotoInput.focus();
        return false;
      }

      // üîπ Verifica duplicidade (apenas nome)
      if (produtos.some(p => p.nome.toLowerCase() === nomeEl.value.trim().toLowerCase())) {
          alert("Este produto j√° est√° cadastrado!");
          nomeEl.style.border = "2px solid orange";
          nomeEl.focus();
          return false;
      }

      // Transforma a imagem em Base64
      const file = fotoInput.files[0];
      const reader = new FileReader();

      reader.onload = function(event) {
        const fotoBase64 = event.target.result;

        // Cria o novo produto
        const novoProduto = {
          nome: nomeEl.value.trim(),
          categoria: categoriaEl.value,
          embalagem: embalagemEl.value,
          qtdEmbalagem: Number(qtdEl.value),
          codigoBarras: codigoBarras,
          foto: fotoBase64,
          quantidade: 0, // Estoque inicial 0
          minimo: 0,
          maximo: 0,
        };

        // Adiciona e salva
        produtos.push(novoProduto);
        localStorage.setItem("produtos", JSON.stringify(produtos));
        
        // Atualiza tabelas e limpa
        atualizarTabelaProdutos();
        preencherProdutosSelect();
        limparCampos("cadastro");
        alert("Produto cadastrado com sucesso!");
      };

      reader.readAsDataURL(file);
    }

    function atualizarTabelaProdutos() {
      const tbody = document.querySelector("#tabelaProdutos tbody");
      if (!tbody) return;

      tbody.innerHTML = "";
      // Ordena por nome
      produtos.sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));

      produtos.forEach((p, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${p.foto ? `<img src="${p.foto}" class="thumb" onclick="ampliarImagem('${p.foto}')">` : "-"}</td>
          <td>${p.nome}</td>
          <td>${p.categoria}</td>
          <td>${p.embalagem}</td>
          <td>${p.qtdEmbalagem}</td>
          <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
          <td>
            <button onclick="editarProduto(${i})"><i class="fa fa-edit"></i></button>
            <button onclick="excluirProduto(${i})" class="btn-delete"><i class="fa fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function excluirProduto(i) {
      if (!confirm("Excluir este produto? Esta a√ß√£o n√£o pode ser desfeita e remover√° o produto, entradas e sa√≠das relacionadas.")) return;
      
      const nomeProduto = produtos[i].nome;

      produtos.splice(i, 1);
      
      // Remove entradas e sa√≠das relacionadas
      entradas = entradas.filter(e => e.produto !== nomeProduto);
      saidas = saidas.filter(s => s.produto !== nomeProduto);

      localStorage.setItem("produtos", JSON.stringify(produtos));
      localStorage.setItem("entradas", JSON.stringify(entradas));
      localStorage.setItem("saidas", JSON.stringify(saidas));
      
      atualizarTabelaProdutos();
      if(typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
      if(typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
      if(typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
      if(typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
      
      preencherProdutosSelect();
      alert("Produto e todos os registros relacionados exclu√≠dos!");
    }

    function ampliarImagem(src) {
      const modal = document.getElementById("imagemAmpliada");
      const img = modal.querySelector("img");
      if (modal && img) {
        img.src = src;
        modal.style.display = "flex";
      }
    }

    function filtrarProdutos() {
      const termo = document.getElementById("filtroProduto").value.toLowerCase();
      const tbody = document.querySelector("#tabelaProdutos tbody");
      if (!tbody) return;

      tbody.querySelectorAll("tr").forEach(tr => {
        const texto = tr.textContent.toLowerCase();
        tr.style.display = texto.includes(termo) ? "" : "none";
      });
    }
    
    // Fun√ß√£o de edi√ß√£o para o futuro (placeholder)
    function editarProduto(i) {
        alert("Fun√ß√£o de Edi√ß√£o do Produto " + produtos[i].nome + " (√çndice: " + i + ") - A ser implementada.");
    }


    /* ========================= üîπ Busca por C√≥digo de Barras ========================= */
    function buscarProdutoPorCodigo(contexto) {
      const campoCodigo = document.getElementById(`${contexto}CodigoBarras`);
      if (!campoCodigo) return;

      const codigo = campoCodigo.value.trim();
      
      // Limpa a borda vermelha se come√ßar a digitar
      campoCodigo.style.border = "1px solid #ccc";
      campoCodigo.title = "";

      if (!codigo) return;

      const produto = produtos.find(p => (p.codigoBarras || "").trim() === codigo);

      if (!produto) {
        campoCodigo.style.border = "2px solid red";
        campoCodigo.title = "C√≥digo de barras n√£o encontrado.";
        return;
      }
      
      // Preenche o campo do nome automaticamente
      const campoProduto = document.getElementById(`${contexto}Produto`);
      if (campoProduto) campoProduto.value = produto.nome;
      
      // Se for entrada, tenta buscar dados recentes
      if (contexto === 'entrada' && typeof preencherEntradaAutomatica === 'function') {
           preencherEntradaAutomatica(produto.nome);
      }
      
       // Se for sa√≠da, atualiza o setor
      if (contexto === 'saida' && typeof atualizarSetorAutomatico === 'function') {
           atualizarSetorAutomatico();
      }
    }
    
    /* ========================= üîπ Entradas ========================= */
    function registrarEntrada() {
      if (typeof padronizarCamposAntesDeSalvar === "function") padronizarCamposAntesDeSalvar();

      const produtoEl = document.getElementById("entradaProduto");
      const qtdEl = document.getElementById("entradaQuantidade");
      const valorEl = document.getElementById("entradaValor");
      const dataEl = document.getElementById("entradaData");
      const notaEl = document.getElementById("entradaNota");
      const fornecedorEl = document.getElementById("entradaFornecedor");
      const cnpjEl = document.getElementById("entradaCNPJ");
      const loteEl = document.getElementById("entradaLote");
      const validadeEl = document.getElementById("entradaValidade");
      const setorEl = document.getElementById("entradaSetor");
      const codigoBarrasEl = document.getElementById("entradaCodigoBarras");
      
      // Limpa bordas
      const camposParaReset = [produtoEl, qtdEl, valorEl, dataEl, notaEl, fornecedorEl, setorEl];
      camposParaReset.forEach(el => { if (el) el.style.border = "1px solid #ccc"; });


      // Valida√ß√µes
      if (!produtoEl.value.trim()) { alert("Informe o nome do produto!"); produtoEl.style.border = "2px solid red"; produtoEl.focus(); return false; }
      const qtd = Number(qtdEl.value);
      if (qtd <= 0 || isNaN(qtd)) { alert("Quantidade deve ser maior que zero!"); qtdEl.style.border = "2px solid red"; qtdEl.focus(); return false; }
      const valor = Number(valorEl.value);
      if (valor <= 0 || isNaN(valor)) { alert("Valor unit√°rio deve ser maior que zero!"); valorEl.style.border = "2px solid red"; valorEl.focus(); return false; }
      if (!dataEl.value) { alert("Informe a data de entrada!"); dataEl.style.border = "2px solid red"; dataEl.focus(); return false; }
      if (!notaEl.value.trim()) { alert("Informe a Nota Fiscal!"); notaEl.style.border = "2px solid red"; notaEl.focus(); return false; }
      if (!fornecedorEl.value.trim()) { alert("Informe o Fornecedor!"); fornecedorEl.style.border = "2px solid red"; fornecedorEl.focus(); return false; }
      if (!setorEl.value.trim()) { alert("Selecione o Setor Utilizado!"); setorEl.style.border = "2px solid red"; setorEl.focus(); return false; }
      
      // Procura o produto no estoque (para verificar se existe)
      const produtoNoEstoque = produtos.find(p => p.nome === produtoEl.value.trim());
      if (!produtoNoEstoque) {
          alert(`Produto "${produtoEl.value.trim()}" n√£o encontrado no cadastro. Cadastre o produto primeiro.`);
          produtoEl.style.border = "2px solid red";
          produtoEl.focus();
          return false;
      }


      // Cria objeto de entrada
      const novaEntrada = {
        produto: produtoEl.value.trim(),
        codigoBarras: codigoBarrasEl.value.trim() || produtoNoEstoque.codigoBarras,
        qtd: qtd,
        valorUnitario: valor,
        data: dataEl.value,
        nota: notaEl.value.trim(),
        fornecedor: fornecedorEl.value.trim(),
        cnpj: cnpjEl.value.trim(),
        lote: loteEl.value.trim(),
        validade: validadeEl.value,
        setor: setorEl.value.trim(),
      };

      // Adiciona e salva
      entradas.push(novaEntrada);
      localStorage.setItem("entradas", JSON.stringify(entradas));
      
      // Atualiza estoque (soma) e tabelas
      atualizarEstoque(novaEntrada.produto, novaEntrada.qtd);
      atualizarTabelaEntradas();
      
      // Limpa campos (usando setTimeout para garantir que a atualiza√ß√£o visual do erro passe primeiro)
      setTimeout(() => limparCampos("entrada"), 300);
      alert("Entrada registrada com sucesso!");
      return true; // Sucesso
    }

    function atualizarTabelaEntradas() {
      const tbody = document.querySelector("#tabelaEntradas tbody");
      if (!tbody) return;

      tbody.innerHTML = "";
      // Exibe as entradas da mais recente para a mais antiga
      entradas.slice().reverse().forEach((e, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entradas.length - i}</td>
          <td>${e.produto}</td>
          <td>${e.codigoBarras || '-'}</td>
          <td>${e.qtd}</td>
          <td>R$ ${e.valorUnitario ? e.valorUnitario.toFixed(2).replace('.', ',') : '0,00'}</td>
          <td>${e.data}</td>
          <td>${e.nota}</td>
          <td>${e.fornecedor}</td>
          <td>${e.cnpj}</td>
          <td>${e.lote || '-'}</td>
          <td style="color:${e.validade && new Date(e.validade) < new Date() ? 'red' : 'inherit'};">${e.validade || '-'}</td>
          <td>${e.setor}</td>
          <td>
            <button onclick="excluirEntrada(${entradas.length - 1 - i})" class="btn-delete"><i class="fa fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(row);
      });
      // Garante que o painel financeiro seja atualizado
      if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
    }

    function excluirEntrada(i) {
      if (!confirm("Excluir este registro de entrada? O estoque ser√° ajustado.")) return;
      
      const entrada = entradas[i];
      
      // Atualiza estoque (subtrai)
      if (entrada.qtd) {
         atualizarEstoque(entrada.produto, -entrada.qtd);
      }
      
      entradas.splice(i, 1);
      localStorage.setItem("entradas", JSON.stringify(entradas));
      
      atualizarTabelaEntradas();
      if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
      if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
      
      alert("Entrada exclu√≠da e estoque ajustado!");
    }

    function filtrarEntradas() {
      const termo = document.getElementById("filtroEntrada").value.toLowerCase();
      const tbody = document.querySelector("#tabelaEntradas tbody");
      if (!tbody) return;

      tbody.querySelectorAll("tr").forEach(tr => {
        const texto = tr.textContent.toLowerCase();
        tr.style.display = texto.includes(termo) ? "" : "none";
      });
    }

    // Fun√ß√£o para preencher automaticamente campos de entrada com base no √∫ltimo registro
    function preencherEntradaAutomatica(nomeProduto) {
        const ultimaEntrada = entradas.slice().reverse().find(e => e.produto === nomeProduto);
        if (ultimaEntrada) {
            document.getElementById("entradaFornecedor").value = ultimaEntrada.fornecedor || '';
            document.getElementById("entradaCNPJ").value = ultimaEntrada.cnpj || '';
            document.getElementById("entradaLote").value = ultimaEntrada.lote || '';
            document.getElementById("entradaValidade").value = ultimaEntrada.validade || '';
            document.getElementById("entradaSetor").value = ultimaEntrada.setor || '';
            document.getElementById("entradaValor").value = ultimaEntrada.valorUnitario || '';
        }
    }
    
    /* ========================= üîπ Sa√≠das ========================= */
    // Fun√ß√£o principal: valida e grava a sa√≠da (retorna true em sucesso, false em erro)
    function registrarSaida() {
      if (typeof padronizarCamposAntesDeSalvar === "function") padronizarCamposAntesDeSalvar();

      const produtoEl = document.getElementById("saidaProduto");
      const qtdEl = document.getElementById("saidaQuantidade");
      const responsavelEl = document.getElementById("saidaResponsavel");
      const observacaoEl = document.getElementById("saidaObservacao");
      const setorEl = document.getElementById("saidaSetor");
      const dataEl = document.getElementById("saidaData");
      const codigoBarrasEl = document.getElementById("saidaCodigoBarras");

      // Protege caso algum elemento falte no DOM (evita TypeError)
      const camposParaReset = [produtoEl, qtdEl, responsavelEl, setorEl, dataEl];
      camposParaReset.forEach(el => { if (el) el.style.border = "1px solid #ccc"; });

      // Valida√ß√µes ‚Äî mant√™m os valores preenchidos em caso de erro
      if (!produtoEl || !produtoEl.value.trim()) { alert("Informe o nome do produto!"); if (produtoEl) { produtoEl.style.border = "2px solid red"; produtoEl.focus(); } return false; }
      const produto = produtoEl.value.trim();
      
      const qtd = Number(qtdEl.value);
      if (qtd <= 0 || isNaN(qtd)) { alert("Quantidade deve ser maior que zero!"); if (qtdEl) { qtdEl.style.border = "2px solid red"; qtdEl.focus(); } return false; }
      
      if (!responsavelEl || !responsavelEl.value.trim()) { alert("Informe o respons√°vel pela retirada!"); if (responsavelEl) { responsavelEl.style.border = "2px solid red"; responsavelEl.focus(); } return false; }
      const responsavel = responsavelEl.value.trim();
      
      if (!setorEl || !setorEl.value.trim()) { alert("Selecione o setor de destino!"); if (setorEl) { setorEl.style.border = "2px solid red"; setorEl.focus(); } return false; }
      const setor = setorEl.value.trim();
      
      if (!dataEl || !dataEl.value) { alert("Informe a data da sa√≠da!"); if (dataEl) { dataEl.style.border = "2px solid red"; dataEl.focus(); } return false; }
      const data = dataEl.value;
      
      const observacao = observacaoEl ? observacaoEl.value.trim() : "";
      const codigoBarras = codigoBarrasEl ? codigoBarrasEl.value.trim() : "";

      // üîπ Checagem de estoque
      const produtoNoEstoque = produtos.find(p => p.nome === produto);
      if (!produtoNoEstoque) {
        alert(`Produto "${produto}" n√£o encontrado no cadastro.`);
        if (produtoEl) { produtoEl.style.border = "2px solid red"; produtoEl.focus(); }
        return false;
      }
      
      const estoqueAtual = Number(produtoNoEstoque.quantidade) || 0;
      if (qtd > estoqueAtual) {
        alert(`Estoque insuficiente: h√° ${estoqueAtual} unidade(s) dispon√≠veis.`);
        if (qtdEl) { qtdEl.style.border = "2px solid red"; qtdEl.focus(); }
        return false;
      }

      // Tudo ok -> registra a sa√≠da
      saidas.push({ 
          produto, 
          qtd, 
          data, 
          setor, 
          responsavel, 
          observacao,
          codigoBarras: codigoBarras || produtoNoEstoque.codigoBarras // Usa o c√≥digo de barras do cadastro se n√£o foi lido
      });
      localStorage.setItem("saidas", JSON.stringify(saidas));
      
      // Atualiza estoque (subtrai) e tabelas
      atualizarEstoque(produto, -qtd);
      if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
      if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
      
      alert("Sa√≠da registrada com sucesso!");
      return true; 
    }

    // Wrapper: chama registrarSaida e limpa os campos somente se retornar true
    const _registrarSaidaOriginal = registrarSaida;
    registrarSaida = function() {
        try {
            const result = _registrarSaidaOriginal();
            if (result === true) {
                // limpa os campos da se√ß√£o "saida" ap√≥s sucesso
                setTimeout(() => limparCampos("saida"), 300);
            } else {
                // mant√©m os dados e navega at√© o campo com erro (se houver)
                const erroEl = document.querySelector("#saida input[style*='red'], #saida select[style*='red']");
                if (erroEl) erroEl.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        } catch (err) {
            console.error("Erro ao registrar sa√≠da:", err);
        }
    };

    function atualizarTabelaSaidas() {
      const tbody = document.querySelector("#tabelaSaidas tbody");
      if (!tbody) return;

      tbody.innerHTML = "";
      // Exibe as sa√≠das da mais recente para a mais antiga
      saidas.slice().reverse().forEach((s, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${saidas.length - i}</td>
          <td>${s.produto}</td>
		  <td>${s.codigoBarras || '-'}</td>
          <td>${s.qtd}</td>
          <td>${s.data}</td>
          <td>${s.setor}</td>
          <td>${s.responsavel}</td>
          <td>${s.observacao || '-'}</td>
          <td>
            <button onclick="excluirSaida(${saidas.length - 1 - i})" class="btn-delete"><i class="fa fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function excluirSaida(i) {
      if (!confirm("Excluir este registro de sa√≠da? O estoque ser√° revertido.")) return;
      
      const saida = saidas[i];
      
      // Atualiza estoque (reverte a sa√≠da, ou seja, soma)
      if (saida.qtd) {
        atualizarEstoque(saida.produto, saida.qtd);
      }
      
      saidas.splice(i, 1);
      localStorage.setItem("saidas", JSON.stringify(saidas));
      
      atualizarTabelaSaidas();
      if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
      if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
      
      alert("Sa√≠da exclu√≠da e estoque ajustado!");
    }

    function filtrarSaidas() {
      const termo = document.getElementById("filtroSaida").value.toLowerCase();
      const tbody = document.querySelector("#tabelaSaidas tbody");
      if (!tbody) return;

      tbody.querySelectorAll("tr").forEach(tr => {
        const texto = tr.textContent.toLowerCase();
        tr.style.display = texto.includes(termo) ? "" : "none";
      });
    }
    
    /* ========================= üîπ Atualiza setor automaticamente ao digitar ou ler c√≥digo de barras ========================= */
    function atualizarSetorAutomatico() {
      const produtoInput = document.getElementById("saidaProduto");
      const codigoInput = document.getElementById("saidaCodigoBarras");
      const setorSelect = document.getElementById("saidaSetor");
      
      if (!produtoInput || !setorSelect) return;

      const nomeProduto = produtoInput.value.trim();
      const codigo = codigoInput ? codigoInput.value.trim() : "";
      
      let nomeParaBusca = nomeProduto;

      // üîπ Primeiro tenta achar pela leitura do c√≥digo de barras
      if (codigo && Array.isArray(produtos)) {
          const produto = produtos.find(p => p.codigoBarras === codigo);
          if (produto) {
              produtoInput.value = produto.nome;
              nomeParaBusca = produto.nome;
          }
      }
      
      // üîπ Busca a entrada mais recente
      let entradaEncontrada = null;
      if (nomeParaBusca) {
           entradaEncontrada = (entradas || []).slice().reverse().find(e => e.produto === nomeParaBusca);
      }

      // üîπ Atualiza o campo de setor
      if (entradaEncontrada && entradaEncontrada.setor) {
          // Cria o select com apenas a op√ß√£o mais recente
          setorSelect.innerHTML = `<option value="${entradaEncontrada.setor}">√öltimo Setor: ${entradaEncontrada.setor}</option>`;
      } else {
          // Se n√£o houver entrada, exibe as op√ß√µes padr√£o
          setorSelect.innerHTML = `
              <option value="">Selecione o Setor</option>
              <option>Limpeza da Cl√≠nica</option>
              <option>Laborat√≥rio</option>
              <option>Escrit√≥rio</option>
              <option>Copa e Cozinha</option>
              <option>Cl√≠nico Geral</option>
              <option>Centro Cir√∫rgico</option>
          `;
      }
    }


    /* ========================= üîπ Atualizar Estoque ========================= */
    function atualizarEstoque(produtoNome, delta) {
      const produto = produtos.find(p => p.nome === produtoNome);
      if (produto) {
        let qtdAtual = Number(produto.quantidade) || 0;
        qtdAtual += delta;
        produto.quantidade = Math.max(0, qtdAtual); // Garante que a quantidade n√£o seja negativa
        localStorage.setItem("produtos", JSON.stringify(produtos));
        
        // Atualiza tabelas que dependem do estoque
        if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
        if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
        if (typeof atualizarDashboard === "function") atualizarDashboard();
        if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
      }
    }


    /* ========================= üîπ Estoque Atual ========================= */
    function atualizarTabelaEstoque() {
      const tbody = document.querySelector("#tabelaEstoque tbody");
      if (!tbody) return;

      tbody.innerHTML = "";
      
      // Filtra entradas v√°lidas para obter informa√ß√µes de lote/validade
      const estoqueDetalhado = {};

      entradas.forEach(e => {
        const produto = e.produto;
        const lote = e.lote || 'Geral';
        const chave = `${produto}|${lote}`;

        if (!estoqueDetalhado[chave]) {
          estoqueDetalhado[chave] = {
            produto: produto,
            codigoBarras: e.codigoBarras,
            validade: e.validade,
            lote: lote,
            quantidade: 0,
            categoria: produtos.find(p => p.nome === produto)?.categoria || '-',
          };
        }
        // Soma as entradas
        estoqueDetalhado[chave].quantidade += e.qtd;
      });

      saidas.forEach(s => {
        const produto = s.produto;
        // Tenta achar o lote na sa√≠da, mas pode ser dif√≠cil parear 1:1.
        // Por simplicidade (e como o lote n√£o √© obrigat√≥rio na sa√≠da no c√≥digo atual),
        // subtrai do estoque total do produto, e se tiver lote/validade espec√≠ficos,
        // o usu√°rio deve gerenciar a l√≥gica de sa√≠da por lote.
        // Aqui, faremos uma subtra√ß√£o simplificada do estoque total do produto.
        // O modelo ideal exigiria que a sa√≠da especificasse o LOTE.
        // Como o c√≥digo n√£o tem essa complexidade, usaremos o "estoque total do produto".
      });
      
      // Usa a quantidade TOTAL do produto para o estoque
      produtos.forEach(p => {
        const chaveGeral = `${p.nome}|Geral`;
        estoqueDetalhado[chaveGeral] = {
            produto: p.nome,
            codigoBarras: p.codigoBarras,
            validade: '-',
            lote: '-',
            quantidade: Number(p.quantidade) || 0,
            categoria: p.categoria || '-',
        };
      });
      
      // Remove entradas com quantidade 0 (ap√≥s sa√≠das)
      const estoqueFinal = Object.values(estoqueDetalhado).filter(item => item.quantidade > 0);
      
      estoqueFinal.forEach((item, i) => {
        const row = document.createElement("tr");
        const isVencido = item.validade && new Date(item.validade) < new Date();
        const status = isVencido ? 'VENCIDO' : (item.quantidade <= 0 ? 'ZERADO' : 'OK');
        const statusColor = isVencido ? 'red' : (item.quantidade <= 0 ? '#777' : 'green');
        
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${item.produto}</td>
          <td>${item.codigoBarras || '-'}</td>
          <td>${item.categoria}</td>
          <td>${item.quantidade}</td>
          <td>${item.lote || '-'}</td>
          <td style="color:${isVencido ? 'red' : 'inherit'};">${item.validade || '-'}</td>
          <td style="color:${statusColor}; font-weight:bold;">${status}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function filtrarEstoque() {
      const termo = document.getElementById("filtroEstoque").value.toLowerCase();
      const tbody = document.querySelector("#tabelaEstoque tbody");
      if (!tbody) return;

      tbody.querySelectorAll("tr").forEach(tr => {
        const texto = tr.textContent.toLowerCase();
        tr.style.display = texto.includes(termo) ? "" : "none";
      });
    }
    
    
    
    /* ========================= üîπ Estoque M√≠nimo e M√°ximo ========================= */
    // Vari√°vel global para armazenar a lista de compra
    let listaDeCompra = []; 
    
    function atualizarTabelaLimites() {
      const tbody = document.querySelector("#tabelaLimites tbody");
      const filtroTexto = document.getElementById("filtroLimite")?.value.toLowerCase().trim();
      const filtroCategoria = document.getElementById("filtroCategoria")?.value.toLowerCase().trim();
      const resumoEl = document.getElementById("resumoEstoque");
      if (!tbody || !resumoEl) return;

      tbody.innerHTML = "";
      
      let totalProdutos = 0;
      let abaixoMinimo = 0;
      let dentroLimite = 0;
      let acimaMaximo = 0;

      // Ordena por status (Abaixo, Acima, Dentro)
      const produtosOrdenados = produtos.slice().sort((a, b) => {
          const statusA = (Number(a.quantidade) || 0) < (Number(a.minimo) || 0) ? 0 : 1;
          const statusB = (Number(b.quantidade) || 0) < (Number(b.minimo) || 0) ? 0 : 1;
          return statusA - statusB;
      });
      
      produtosOrdenados.forEach((p, i) => {
          const nome = (p.nome || "").toLowerCase();
          const categoria = (p.categoria || "").toLowerCase();
          const minimo = Number(p.minimo) || 0;
          const maximo = Number(p.maximo) || 0;
          const qtd = Number(p.quantidade) || 0;
          
          let statusTexto = "";
          let statusCor = "";
          let recomendacao = "";
          
          if (qtd < minimo) {
              statusTexto = "‚ö†Ô∏è Abaixo do m√≠nimo";
              statusCor = "red";
              recomendacao = `Comprar ${minimo - qtd} unidade(s)`;
              abaixoMinimo++;
          } else if (maximo && qtd > maximo) {
              statusTexto = "üì¶ Acima do m√°ximo";
              statusCor = "orange";
              recomendacao = "Reduzir estoque";
              acimaMaximo++;
          } else {
              statusTexto = "‚úÖ Dentro do limite";
              statusCor = "green";
              recomendacao = "OK";
              dentroLimite++;
          }
          
          // ------- FILTROS -------
          if (filtroCategoria && filtroCategoria !== "" && categoria !== filtroCategoria) return; 

          if (filtroTexto) { 
              const codigo = (p.codigoBarras || "").toLowerCase();
              const qtdStr = String(qtd).toLowerCase();
              const statusLower = statusTexto.toLowerCase();
              const recLower = (recomendacao || "").toLowerCase();
              
              const matches = nome.includes(filtroTexto) ||
                  codigo.includes(filtroTexto) ||
                  categoria.includes(filtroTexto) ||
                  qtdStr.includes(filtroTexto) ||
                  statusLower.includes(filtroTexto) ||
                  recLower.includes(filtroTexto);
                  
              if (!matches) return;
          }
          
          // Se passou nos filtros, conta
          totalProdutos++;

          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${i + 1}</td>
              <td>${p.nome}</td>
              <td>${p.codigoBarras || '-'}</td>
              <td>${p.categoria}</td>
              <td>${qtd}</td>
              <td><input type="number" value="${minimo}" onchange="salvarLimite('${p.nome}', 'minimo', this.value)" style="width:80px"></td>
              <td><input type="number" value="${maximo}" onchange="salvarLimite('${p.nome}', 'maximo', this.value)" style="width:80px"></td>
              <td style="color:${statusCor}; font-weight:bold;">${statusTexto}</td>
              <td>${recomendacao}</td>
              <td>
                  <button onclick="adicionarAlistaCompra('${p.nome}')" title="Adicionar √† Lista de Compra"><i class="fa fa-shopping-cart"></i></button>
              </td>
          `;
          tbody.appendChild(row);
      });
      
      // Atualiza resumo
      resumoEl.innerHTML = `
          üßæ Total de Produtos: ${totalProdutos} |
          ‚ö†Ô∏è Abaixo do M√≠nimo: ${abaixoMinimo} |
          ‚úÖ Dentro do Limite: ${dentroLimite} |
          üì¶ Acima do M√°ximo: ${acimaMaximo}
      `;
    }

    function salvarLimite(nomeProduto, tipoLimite, valor) {
      const produto = produtos.find(p => p.nome === nomeProduto);
      if (produto) {
        let valorNumerico = Number(valor);
        if (isNaN(valorNumerico) || valorNumerico < 0) valorNumerico = 0;
        
        produto[tipoLimite] = valorNumerico;
        localStorage.setItem("produtos", JSON.stringify(produtos));
        
        // Re-renderiza a tabela para atualizar status/recomenda√ß√£o
        atualizarTabelaLimites();
        
        // Atualiza dashboard se estiver ativo
        if (typeof atualizarDashboard === "function") atualizarDashboard();
      }
    }
    
    function adicionarAlistaCompra(nomeProduto) {
        const produto = produtos.find(p => p.nome === nomeProduto);
        if (!produto) return;
        
        const qtd = Number(produto.quantidade) || 0;
        const minimo = Number(produto.minimo) || 0;
        const recomendado = minimo > qtd ? minimo - qtd : 0;
        
        if (recomendado > 0) {
            // Verifica se j√° est√° na lista
            const itemExistente = listaDeCompra.find(item => item.produto === nomeProduto);
            if (itemExistente) {
                // Atualiza a quantidade se j√° estiver
                itemExistente.recomendadoComprar = recomendado;
            } else {
                 // Adiciona √† lista
                listaDeCompra.push({
                    produto: produto.nome,
                    codigoBarras: produto.codigoBarras,
                    categoria: produto.categoria,
                    qtdAtual: qtd,
                    minimo: minimo,
                    recomendadoComprar: recomendado
                });
            }
            atualizarTabelaListaCompra();
            document.getElementById("listaCompraContainer").style.display = 'block';
            alert(`Adicionado √† lista de compra: ${recomendado} unidade(s) de ${nomeProduto}.`);
        } else {
            alert(`O produto ${nomeProduto} j√° est√° dentro do limite.`);
        }
    }
    
    function gerarListaCompra() {
        // Limpa a lista atual
        listaDeCompra = []; 
        
        produtos.forEach(p => {
            const qtd = Number(p.quantidade) || 0;
            const minimo = Number(p.minimo) || 0;
            const recomendado = minimo > qtd ? minimo - qtd : 0;
            
            if (recomendado > 0) {
                 listaDeCompra.push({
                    produto: p.nome,
                    codigoBarras: p.codigoBarras,
                    categoria: p.categoria,
                    qtdAtual: qtd,
                    minimo: minimo,
                    recomendadoComprar: recomendado
                });
            }
        });
        
        atualizarTabelaListaCompra();
        
        if (listaDeCompra.length > 0) {
            document.getElementById("listaCompraContainer").style.display = 'block';
            alert(`Lista de compra gerada com ${listaDeCompra.length} itens abaixo do m√≠nimo!`);
            document.getElementById("listaCompraContainer").scrollIntoView({ behavior: "smooth" });
        } else {
            document.getElementById("listaCompraContainer").style.display = 'none';
            alert("Nenhum produto est√° abaixo do estoque m√≠nimo.");
        }
    }
    
    function limparListaCompra() {
        listaDeCompra = [];
        atualizarTabelaListaCompra();
        document.getElementById("listaCompraContainer").style.display = 'none';
        alert("Lista de compra limpa.");
    }

    function atualizarTabelaListaCompra() {
      const tbody = document.querySelector("#tabelaListaCompra tbody");
      const totalSpan = document.getElementById("totalItensCompra");
      const container = document.getElementById("listaCompraContainer");
      
      if (!tbody || !totalSpan || !container) { 
        console.error("Erro: Elementos da lista de compra n√£o encontrados. Verifique o HTML.");
        return; 
      }

      if (!listaDeCompra.length) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#777;">Lista de compra vazia.</td></tr>`;
          totalSpan.textContent = "0";
          container.style.display = "block";
          return;
      }
      
      tbody.innerHTML = "";
      let totalItens = 0;
      listaDeCompra.forEach((item, i) => {
          totalItens += item.recomendadoComprar;
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${i + 1}</td>
              <td>${item.produto}</td>
              <td>${item.codigoBarras || '-'}</td>
              <td>${item.categoria}</td>
              <td>${item.qtdAtual}</td>
              <td>${item.minimo}</td>
              <td style="font-weight:bold; color:red;">${item.recomendadoComprar}</td>
          `;
          tbody.appendChild(row);
      });
      totalSpan.textContent = totalItens;
      container.style.display = "block";
    }

    /* ========================= üîπ Financeiro ========================= */
    function atualizarPainelFinanceiro() {
      // 1. Valor Total do Estoque (Cont√°bil)
      let valorEstoqueTotal = 0;
      
      produtos.forEach(produto => {
          const entradasDoProduto = entradas.filter(e => e.produto === produto.nome);
          const qtdAtual = Number(produto.quantidade) || 0;
          
          if (qtdAtual > 0 && entradasDoProduto.length > 0) {
              // C√°lculo do Custo M√©dio Ponderado (CMP)
              let somaValores = 0;
              let somaQuantidades = 0;
              
              entradasDoProduto.forEach(e => {
                  somaValores += e.qtd * e.valorUnitario;
                  somaQuantidades += e.qtd;
              });
              
              const custoMedio = somaQuantidades > 0 ? somaValores / somaQuantidades : 0;
              valorEstoqueTotal += qtdAtual * custoMedio;
          }
      });
      
      document.getElementById("valorEstoque") ? document.getElementById("valorEstoque").textContent = `R$ ${valorEstoqueTotal.toFixed(2).replace('.', ',')}` : null;
      document.getElementById("valorEstoqueAtualPainel") ? document.getElementById("valorEstoqueAtualPainel").textContent = `R$ ${valorEstoqueTotal.toFixed(2).replace('.', ',')}` : null;

      // 2. Valor Total das Sa√≠das (Estimado)
      let valorSaidasTotal = 0;
      
      saidas.forEach(saida => {
          const entradasDoProduto = entradas.filter(e => e.produto === saida.produto);
          
          if (entradasDoProduto.length > 0) {
              // Custo M√©dio Ponderado (CMP) no momento da sa√≠da
              let somaValores = 0;
              let somaQuantidades = 0;
              
              entradasDoProduto.forEach(e => {
                  // A rigor, o CMP deve ser calculado com base nas entradas *anteriores* √† sa√≠da.
                  // Aqui, por simplicidade, usamos o CMP total.
                  somaValores += e.qtd * e.valorUnitario;
                  somaQuantidades += e.qtd;
              });
              
              const custoMedio = somaQuantidades > 0 ? somaValores / somaQuantidades : 0;
              valorSaidasTotal += (saida.qtd || 0) * custoMedio;
          }
      });
      
      document.getElementById("valorSaidas") ? document.getElementById("valorSaidas").textContent = `R$ ${valorSaidasTotal.toFixed(2).replace('.', ',')}` : null;
      
      // 3. √öltimo Valor de Entrada (simplesmente a √∫ltima entrada registrada)
      const ultimaEntrada = entradas.length > 0 ? entradas[entradas.length - 1] : null;
      const valorUltima = ultimaEntrada ? (ultimaEntrada.qtd * ultimaEntrada.valorUnitario) : 0;
      document.getElementById("valorUltimaEntrada") ? document.getElementById("valorUltimaEntrada").textContent = `R$ ${valorUltima.toFixed(2).replace('.', ',')}` : null;
      
      // 4. Custo M√©dio Ponderado Geral (M√©dia de todos os produtos)
      const custoMedioGeral = produtos.length > 0 ? valorEstoqueTotal / produtos.reduce((acc, p) => acc + (Number(p.quantidade) || 0), 0) : 0;
      document.getElementById("valorCustoMedio") ? document.getElementById("valorCustoMedio").textContent = `R$ ${custoMedioGeral.toFixed(2).replace('.', ',')}` : null;


      // 5. Entradas Agrupadas por Nota Fiscal
      const agrupadas = {};

      // Primeiro, agrupa as entradas para calcular o valor total da nota
      entradas.forEach(e => {
        const chave = `${e.fornecedor}|${e.nota}`;
        const valorEntrada = (e.qtd || 0) * (e.valorUnitario || 0);

        if (!agrupadas[chave]) {
          agrupadas[chave] = {
            fornecedor: e.fornecedor,
            nota: e.nota,
            valorNota: 0,
            valorSaida: 0,
            itens: []
          };
        }
        agrupadas[chave].valorNota += valorEntrada;
        agrupadas[chave].itens.push(e.produto);
      });
      
      // Em seguida, subtrai as sa√≠das estimadas
      saidas.forEach(s => {
          // Itera sobre todas as notas para saber de qual nota aquela sa√≠da "pertence"
          // O modelo ideal seria vincular a SA√çDA √† ENTRADA espec√≠fica.
          // Por simplicidade, assumimos que a sa√≠da consome o item mais antigo (FIFO),
          // mas como n√£o temos essa complexidade, vamos calcular o valor total
          // da sa√≠da e apenas mostrar o saldo da nota no painel (simplificado).
          const produtoEntradas = entradas.filter(e => e.produto === s.produto);
          if (produtoEntradas.length > 0) {
             const custoMedio = produtoEntradas.reduce((sum, e) => sum + (e.qtd * e.valorUnitario), 0) / produtoEntradas.reduce((sum, e) => sum + e.qtd, 0);
             const valorSaida = (s.qtd || 0) * custoMedio;
             
             // Por n√£o saber a qual nota fiscal a sa√≠da se refere, vamos apenas
             // mostrar o valorSaida na primeira nota fiscal encontrada para o produto (simplifica√ß√£o para este painel).
             const chaveEntradaMaisRecente = `${produtoEntradas[produtoEntradas.length - 1].fornecedor}|${produtoEntradas[produtoEntradas.length - 1].nota}`;
             if (agrupadas[chaveEntradaMaisRecente]) {
                 agrupadas[chaveEntradaMaisRecente].valorSaida += valorSaida;
             }
          }
      });
      

      // Renderizar tabela agrupada
      const tbody = document.querySelector("#tabelaFinanceiro tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      Object.values(agrupadas).forEach(a => {
        const saldo = a.valorNota - a.valorSaida;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${a.fornecedor}</td>
          <td>${a.nota}</td>
          <td>R$ ${a.valorNota.toFixed(2).replace('.', ',')}</td>
          <td style="color:${saldo < 0 ? 'red' : 'green'}; font-weight:bold;">R$ ${saldo.toFixed(2).replace('.', ',')}</td>
        `;
        tbody.appendChild(row);
      });
    }

    /* ========================= üîπ Relat√≥rios ========================= */
    function exportarCSV(nome, dados) {
      if (!dados || !dados.length) return alert("Nenhum dado para exportar!");
      
      // Converte para formato que funcione bem em Excel (usando ponto e v√≠rgula como separador)
      const dadosTratados = dados.map(obj => {
          const novoObj = {};
          for (const key in obj) {
              let valor = obj[key];
              // Converte n√∫meros para string e trata o separador decimal
              if (typeof valor === 'number') {
                  valor = valor.toFixed(2).replace('.', ',');
              }
              // Remove ponto e v√≠rgula do texto para n√£o quebrar a coluna
              if (typeof valor === 'string') {
                  valor = valor.replace(/;/g, ','); 
              }
              novoObj[key] = valor;
          }
          return novoObj;
      });

      const header = Object.keys(dadosTratados[0]).join(";");
      const rows = dadosTratados.map((obj) => Object.values(obj).join(";"));
      const csv = [header, ...rows].join("\n");

      // Adiciona o BOM para garantir caracteres especiais (acentos) no Excel
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = nome + ".csv";
      link.click();
    }
    
    // Filtro de per√≠odo - Fun√ß√£o de utilidade para relat√≥rios
    function filtrarDadosPorPeriodo(dados) {
        const dataInicio = document.getElementById("dataInicioRelatorio")?.value;
        const dataFim = document.getElementById("dataFimRelatorio")?.value;
        
        if (!dataInicio && !dataFim) return dados;
        
        return dados.filter(item => {
            // Assume que todos os dados de entrada/sa√≠da t√™m um campo 'data'
            const dataItem = new Date(item.data);
            
            let dataInicioFiltro = dataInicio ? new Date(dataInicio) : null;
            let dataFimFiltro = dataFim ? new Date(dataFim) : null;
            
            // Ajusta a data fim para o final do dia
            if (dataFimFiltro) {
                dataFimFiltro.setHours(23, 59, 59, 999);
            }
            
            const aposInicio = !dataInicioFiltro || dataItem >= dataInicioFiltro;
            const antesFim = !dataFimFiltro || dataItem <= dataFimFiltro;
            
            return aposInicio && antesFim;
        });
    }
    
    function definirPeriodoRapido(tipo) {
        const hoje = new Date();
        const dataInicioEl = document.getElementById("dataInicioRelatorio");
        const dataFimEl = document.getElementById("dataFimRelatorio");
        let dataInicio;
        
        switch(tipo) {
            case '7dias':
                dataInicio = new Date(hoje.setDate(hoje.getDate() - 7));
                break;
            case '30dias':
                dataInicio = new Date(hoje.setDate(hoje.getDate() - 30));
                break;
            case 'mes':
                dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                break;
            default:
                return;
        }

        dataInicioEl.value = dataInicio.toISOString().split('T')[0];
        dataFimEl.value = new Date().toISOString().split('T')[0];
    }
    
    function limparPeriodo() {
        document.getElementById("dataInicioRelatorio").value = '';
        document.getElementById("dataFimRelatorio").value = '';
        alert("Filtro de per√≠odo limpo. Os pr√≥ximos relat√≥rios incluir√£o todos os dados.");
    }
    
    function filtrarRelatoriosPorPeriodo() {
        // Apenas informa o usu√°rio. O filtro √© aplicado na gera√ß√£o.
        alert("Filtro de per√≠odo aplicado. Clique nos bot√µes para gerar os relat√≥rios filtrados.");
    }


    function gerarRelatorioProdutos() {
      exportarCSV("Produtos", produtos);
    }
    
    function gerarRelatorioEntradas() {
      const dadosFiltrados = filtrarDadosPorPeriodo(entradas);
      exportarCSV("Entradas", dadosFiltrados);
    }
    
    function gerarRelatorioSaidas() {
      const dadosFiltrados = filtrarDadosPorPeriodo(saidas);
      exportarCSV("Saidas", dadosFiltrados);
    }
    
    function gerarRelatorioEstoque() {
      // O estoque √© um snapshot, ent√£o o filtro de data s√≥ faria sentido se
      // fosse um estoque em uma data passada (que √© complexo). Exportamos o atual.
      const dados = produtos.map((p) => ({ 
          nome: p.nome, 
          categoria: p.categoria, 
          codigoBarras: p.codigoBarras || '-',
          quantidade_atual: p.quantidade || 0,
          estoque_minimo: p.minimo || 0,
          estoque_maximo: p.maximo || 0
      }));
      exportarCSV("Estoque_Atual", dados);
    }

    // PDF da Lista de Compra
    function gerarPedidoPDF() {
        if (!listaDeCompra.length) return alert("A lista de compra est√° vazia!");
        
        // Importa a biblioteca jsPDF (necess√°rio incluir no HTML)
        if (typeof window.jspdf === "undefined") {
            alert("Erro: Biblioteca jsPDF n√£o carregada. Verifique o script no final do HTML.");
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const tabela = document.getElementById("tabelaListaCompra");
        const usuario = window.usuarioLogado || {};
        const nomeSolicitante = usuario.nome || "N√£o informado";
        
        // üîπ Cria documento
        const doc = new jsPDF({
            orientation: "portrait",
            unit: "mm",
            format: "a4"
        });

        const larguraPagina = doc.internal.pageSize.getWidth();
        const dataAtual = new Date().toLocaleDateString();

        // ---------- CABE√áALHO ----------
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("ORAL UNIC CAMPO GRANDE", larguraPagina / 2, 20, { align: "center" });
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text("Pedido de Or√ßamento", larguraPagina / 2, 28, { align: "center" });

        doc.setFontSize(10);
        doc.text(`Data: ${dataAtual}`, 14, 38);
        doc.text(`Solicitante: ${nomeSolicitante}`, 14, 44);

        // ---------- LINHA SEPARADORA ----------
        doc.setDrawColor(150);
        doc.line(14, 48, larguraPagina - 14, 48);

        // ---------- CABE√áALHO DA TABELA ----------
        let y = 55;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text("#", 14, y);
        doc.text("Produto", 25, y);
        doc.text("Categoria", 105, y);
        doc.text("Qtd. Comprar", 185, y, { align: "right" });

        // ---------- CONTE√öDO DA TABELA ----------
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        y += 7;

        listaDeCompra.forEach((item, i) => {
             // Limite de p√°gina
            if (y > 280) {
                doc.addPage();
                y = 20;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                doc.text("#", 14, y);
                doc.text("Produto", 25, y);
                doc.text("Categoria", 105, y);
                doc.text("Qtd. Comprar", 185, y, { align: "right" });
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                y += 7;
            }
            
            doc.text(String(i + 1), 14, y);
            
            // Quebra de linha para nome longo do produto
            const nomeProduto = item.produto;
            const nomeLinhas = doc.splitTextToSize(nomeProduto, 80); // 80mm de largura para o nome
            doc.text(nomeLinhas, 25, y);
            
            doc.text(item.categoria, 105, y);
            
            doc.setFont("helvetica", "bold");
            doc.setTextColor(255, 0, 0); // Vermelho para a quantidade
            doc.text(String(item.recomendadoComprar), 185, y, { align: "right" });
            
            // Volta ao normal
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0); 
            
            // Incrementa Y para a pr√≥xima linha (baseado no nome mais longo)
            y += (nomeLinhas.length * 4) + 2; 
        });


        // ---------- RODAP√â / RESUMO ----------
        doc.setDrawColor(150);
        doc.line(14, y, larguraPagina - 14, y);
        y += 5;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text(`Total de Itens Solicitados: ${listaDeCompra.reduce((sum, item) => sum + item.recomendadoComprar, 0)}`, larguraPagina - 14, y, { align: "right" });
        

        doc.save("Pedido_Orcamento.pdf");
        alert("PDF gerado com sucesso!");
    }


    /* ========================= üîπ Usu√°rios ========================= */
    function salvarUsuario() {
        if (typeof padronizarCamposAntesDeSalvar === "function") padronizarCamposAntesDeSalvar();
        
        const nomeEl = document.getElementById("usuarioNome");
        const cpfEl = document.getElementById("usuarioCPF");
        const emailEl = document.getElementById("usuarioEmail");
        const senhaEl = document.getElementById("usuarioSenha");
        const perfilEl = document.getElementById("usuarioPerfil");
        
        // üîπ Limpa bordas de erro
        [nomeEl, emailEl, senhaEl].forEach(el => el.style.border = "1px solid #ccc");

        // üîπ Valida√ß√£o
        if (!nomeEl.value.trim()) { alert("Informe o nome do usu√°rio!"); nomeEl.style.border = "2px solid red"; return; }
        if (!emailEl.value.trim().includes('@')) { alert("Informe um e-mail v√°lido!"); emailEl.style.border = "2px solid red"; return; }
        if (usuarios.some(u => u.email === emailEl.value.trim())) { alert("Este e-mail j√° est√° cadastrado!"); emailEl.style.border = "2px solid red"; return; }
        if (senhaEl.value.trim().length < 6) { alert("A senha deve ter no m√≠nimo 6 caracteres!"); senhaEl.style.border = "2px solid red"; return; }

        const novoUsuario = {
            nome: nomeEl.value.trim(),
            cpf: cpfEl.value.trim(),
            email: emailEl.value.trim(),
            senha: senhaEl.value.trim(),
            perfil: perfilEl.value
        };

        usuarios.push(novoUsuario);
        localStorage.setItem("usuarios", JSON.stringify(usuarios));
        atualizarTabelaUsuarios();
        limparCampos("usuarios");
        alert("Usu√°rio salvo com sucesso!");
    }

    function atualizarTabelaUsuarios() {
        const tbody = document.querySelector("#tabelaUsuarios tbody");
        if (!tbody) return;

        tbody.innerHTML = "";
        
        usuarios.forEach((u, i) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${u.nome}</td>
                <td>${u.cpf || '-'}</td>
                <td>${u.email}</td>
                <td>${u.perfil.toUpperCase()}</td>
                <td>
                    <button onclick="excluirUsuario(${i})" class="btn-delete"><i class="fa fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function excluirUsuario(i) {
        if (!confirm("Excluir este usu√°rio?")) return;
        
        usuarios.splice(i, 1);
        localStorage.setItem("usuarios", JSON.stringify(usuarios));
        atualizarTabelaUsuarios();
    }
    
    
    /* ========================= üìä Dashboard ========================= */
    function atualizarDashboard() {
        const listaVencerEl = document.getElementById("listaProximosVencer");
        const listaMinimoEl = document.getElementById("listaEstoqueMinimo");
        const listaTopSaidasEl = document.getElementById("listaTopSaidas");
        const listaTopSetoresEl = document.getElementById("listaTopSetores");
        
        if (!listaVencerEl || !listaMinimoEl || !listaTopSaidasEl || !listaTopSetoresEl) return;

        // --- 1. Pr√≥ximos do Vencimento (Itens com validade) ---
        listaVencerEl.innerHTML = "";
        const hoje = new Date();
        const trintaDias = new Date(hoje);
        trintaDias.setDate(hoje.getDate() + 30);

        // Agrupa entradas por produto/validade e filtra
        const itensVencer = {};
        
        entradas.forEach(e => {
            if (e.validade) {
                const dataValidade = new Date(e.validade);
                const produto = produtos.find(p => p.nome === e.produto);
                const qtdAtual = Number(produto?.quantidade) || 0;
                
                // Se a validade for nos pr√≥ximos 30 dias ou j√° estiver vencida
                if (dataValidade <= trintaDias && qtdAtual > 0) {
                     const chave = `${e.produto}|${e.validade}`;
                     if (!itensVencer[chave]) {
                         itensVencer[chave] = {
                             produto: e.produto,
                             validade: e.validade,
                             qtd: 0
                         };
                     }
                     itensVencer[chave].qtd += e.qtd;
                }
            }
        });
        
        const listaVencimento = Object.values(itensVencer).sort((a, b) => new Date(a.validade) - new Date(b.validade));
        
        if (listaVencimento.length === 0) {
             listaVencerEl.innerHTML = `<li>Nenhum item pr√≥ximo de vencer.</li>`;
        } else {
            listaVencimento.slice(0, 5).forEach(item => { // Limita a 5
                const data = new Date(item.validade).toLocaleDateString();
                const diff = Math.ceil((new Date(item.validade) - hoje) / (1000 * 60 * 60 * 24));
                const texto = diff <= 0 ? 'VENCIDO' : `em ${diff} dias`;
                const cor = diff <= 0 ? 'red' : (diff <= 15 ? 'orange' : 'inherit');
                
                listaVencerEl.innerHTML += `
                    <li style="color:${cor};">
                        <strong>${item.produto}</strong>: ${item.qtd} un. (${data}) - <i>${texto}</i>
                    </li>`;
            });
        }


        // --- 2. Estoque M√≠nimo ---
        listaMinimoEl.innerHTML = "";
        const abaixoDoMinimo = produtos.filter(p => (Number(p.quantidade) || 0) < (Number(p.minimo) || 0));
        
        if (abaixoDoMinimo.length === 0) {
            listaMinimoEl.innerHTML = `<li>Nenhum item abaixo do estoque m√≠nimo.</li>`;
        } else {
            abaixoDoMinimo.slice(0, 5).forEach(p => { // Limita a 5
                const falta = (Number(p.minimo) || 0) - (Number(p.quantidade) || 0);
                listaMinimoEl.innerHTML += `
                    <li style="color:red;">
                        <strong>${p.nome}</strong>: ${p.quantidade} un. (Faltam ${falta})
                    </li>`;
            });
        }
        
        // --- 3. Top 5 Produtos (Mais Sa√≠da) ---
        listaTopSaidasEl.innerHTML = "";
        const contagemSaidas = {};
        saidas.forEach(s => {
            contagemSaidas[s.produto] = (contagemSaidas[s.produto] || 0) + (s.qtd || 0);
        });
        
        const topSaidas = Object.entries(contagemSaidas)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5); // Top 5
            
        if (topSaidas.length === 0) {
             listaTopSaidasEl.innerHTML = `<li>Nenhuma sa√≠da registrada.</li>`;
        } else {
            topSaidas.forEach(([produto, qtd], i) => {
                listaTopSaidasEl.innerHTML += `
                    <li>
                        <strong>${i + 1}. ${produto}</strong>: ${qtd} un.
                    </li>`;
            });
        }
        
        // --- 4. Top 5 Setores (Mais Consumo) ---
        listaTopSetoresEl.innerHTML = "";
        const contagemSetores = {};
        saidas.forEach(s => {
            contagemSetores[s.setor] = (contagemSetores[s.setor] || 0) + (s.qtd || 0);
        });
        
        const topSetores = Object.entries(contagemSetores)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5); // Top 5
            
        if (topSetores.length === 0) {
             listaTopSetoresEl.innerHTML = `<li>Nenhuma sa√≠da registrada.</li>`;
        } else {
            topSetores.forEach(([setor, qtd], i) => {
                listaTopSetoresEl.innerHTML += `
                    <li>
                        <strong>${i + 1}. ${setor}</strong>: ${qtd} un.
                    </li>`;
            });
        }
    }


    /* ========================= üìù PADRONIZA√á√ÉO DE TEXTO (Primeira mai√∫scula e o resto min√∫sculo) ========================= */
    function formatarTextoPadrao(texto) {
      if (!texto) return "";
      return texto
        .toLowerCase()
        .split(" ")
        .filter(p => p.trim() !== "")
        .map(p => {
             // Ignora palavras pequenas como 'e', 'de', 'do'
            if (p.length <= 2 && p !== 'o' && p !== 'a') return p; 
            return p.charAt(0).toUpperCase() + p.slice(1);
        })
        .join(" ");
    }

    /* üî∏ Aplica automaticamente ao sair do campo de texto */
    document.addEventListener("blur", (e) => {
      const el = e.target;
      if (el.tagName === "INPUT" && el.type === "text") {
        // Ignora campos que n√£o devem ser alterados
        if (
          el.id.toLowerCase().includes("cnpj") ||
          el.id.toLowerCase().includes("email") ||
          el.id.toLowerCase().includes("login") ||
          el.id.toLowerCase().includes("observacao")
        ) return;
        el.value = formatarTextoPadrao(el.value);
      }
    }, true);

    /* üî∏ Garante padroniza√ß√£o antes de salvar/cadastrar */
    function padronizarCamposAntesDeSalvar() {
      document.querySelectorAll('input[type="text"]').forEach(el => {
        if (
          !el.id.toLowerCase().includes("cnpj") &&
          !el.id.toLowerCase().includes("email") &&
          !el.id.toLowerCase().includes("login") &&
          !el.id.toLowerCase().includes("observacao")
        ) {
          el.value = formatarTextoPadrao(el.value);
        }
      });
    }

    /* ========================= üî† ORDENAR LISTAS GLOBAIS ALFABETICAMENTE ========================= */
    function ordenarListasAlfabeticamente() {
      // üîπ Produtos
      if (typeof produtos !== "undefined" && Array.isArray(produtos)) {
        produtos.sort((a, b) =>
          (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' })
        );
        localStorage.setItem("produtos", JSON.stringify(produtos));
      }
      // üîπ Entradas (Fornecedor)
      if (typeof entradas !== "undefined" && Array.isArray(entradas)) {
        entradas.sort((a, b) =>
          (a.fornecedor || "").localeCompare(b.fornecedor || "", 'pt-BR', { sensitivity: 'base' })
        );
        localStorage.setItem("entradas", JSON.stringify(entradas));
      }
      // üîπ Usu√°rios e Perfis (Gerenciar Usu√°rios)
      if (typeof usuarios !== "undefined" && Array.isArray(usuarios)) {
        usuarios.sort((a, b) =>
          (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' })
        );
        localStorage.setItem("usuarios", JSON.stringify(usuarios));
      }
      
      // üîπ Atualiza tabelas e selects se as fun√ß√µes existirem
      if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
      if (typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
      if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
      if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
      if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
      if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();
      if (typeof atualizarDashboard === "function") atualizarDashboard();
      
      // üîπ Atualiza selects de produto (Entrada e Sa√≠da)
      atualizarSelectProdutos();
    }
    
    /* ========================= üîπ Atualiza o <select> de produtos em ordem alfab√©tica ========================= */
    function atualizarSelectProdutos() {
      // Como estamos usando input text com preenchimento autom√°tico para produto (Entrada/Sa√≠da), 
      // esta fun√ß√£o n√£o √© mais estritamente necess√°ria para <select>, mas o nome
      // do produto deve estar no `produtos` array para valida√ß√£o/busca.
    }


    /* ========================= üîé FILTROS GEN√âRICOS DE TABELA ========================= */
    function filtrarTabela(tabelaId, filtroId) {
      const termo = document.getElementById(filtroId).value.toLowerCase();
      const tbody = document.querySelector(`#${tabelaId} tbody`);
      if (!tbody) return;

      tbody.querySelectorAll("tr").forEach(tr => {
        const texto = tr.textContent.toLowerCase();
        tr.style.display = texto.includes(termo) ? "" : "none";
      });
    }

    /* ========================= üßπ LIMPAR CAMPOS AUTOMATICAMENTE (GLOBAL) ========================= */
    // üîπ Fun√ß√£o gen√©rica ‚Äî limpa todos os inputs e selects dentro de uma se√ß√£o
    function limparCampos(secaoId) {
      const secao = document.getElementById(secaoId);
      if (!secao) return;

      secao.querySelectorAll("input, select").forEach(el => {
        if (el.type === "file") {
          el.value = "";
        } else if (el.tagName === "SELECT") {
          el.selectedIndex = 0;
        } else {
          el.value = "";
        }
        // Remove borda vermelha de erro
        el.style.border = "1px solid #ccc";
      });
    }

    /* ========================= üîÑ RENOMEAR PRODUTO (Manuten√ß√£o) ========================= */
    // Fun√ß√£o para ser chamada quando um produto for editado e seu nome for alterado
    function renomearProdutoGlobal(nomeAntigo, novoNome) {
      if (nomeAntigo === novoNome) return;
      let alterado = false;

      // Atualiza nome nas entradas
      entradas.forEach(e => {
        if (e.produto === nomeAntigo) {
          e.produto = novoNome;
          alterado = true;
        }
      });

      // Atualiza nome nas sa√≠das
      saidas.forEach(s => {
        if (s.produto === nomeAntigo) {
          s.produto = novoNome;
          alterado = true;
        }
      });

      // Atualiza nome no estoque (caso mantenha cache separado)
      produtos.forEach(p => {
        if (p.nome === nomeAntigo) {
          p.nome = novoNome;
          alterado = true;
        }
      });

      if (alterado) {
        localStorage.setItem("entradas", JSON.stringify(entradas));
        localStorage.setItem("saidas", JSON.stringify(saidas));
        localStorage.setItem("produtos", JSON.stringify(produtos));
        atualizarTabelaEntradas();
        atualizarTabelaSaidas();
        atualizarTabelaEstoque();
        if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
        if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
      }
    }


    </script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Chamadas iniciais para preencher as tabelas e ordenar (opcionalmente)
  ordenarListasAlfabeticamente(); 
  if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
  if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
  if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
  if (typeof atualizarDashboard === "function") atualizarDashboard();
});
</script>
</body>
</html>
