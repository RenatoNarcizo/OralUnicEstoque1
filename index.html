<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

  <!-- üîπ Modal de imagem ampliada -->
  <div id="imagemAmpliada" onclick="this.style.display='none'">
    <img src="" alt="Imagem ampliada">
  </div>

  <!-- üîπ Tela de Login -->
  <div id="loginView" class="login-container">
    <div class="login-card">
      <h2>Sistema de Controle de Estoque</h2>
      <input type="text" id="usuarioLogin" placeholder="Usu√°rio">
      <input type="password" id="senhaLogin" placeholder="Senha">
      <button onclick="fazerLogin()">Entrar</button>
      <p id="loginMsg" style="display:none;"></p>
    </div>
  </div>

  <!-- üîπ Sistema principal -->
  <div id="mainApp" style="display:none;">

    <!-- üîπ Cabe√ßalho -->
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="menuToggle" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <h1><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h1>
      </div>

      <div style="display:flex;align-items:center;gap:12px;">
        <div id="userName" style="font-weight:700">Usu√°rio</div>
        <button onclick="logout()" title="Sair"><i class="fa fa-sign-out-alt"></i></button>
      </div>
    </header>

    <!-- üîπ Menu lateral -->
    <aside id="sidebar" aria-hidden="true">
      <button onclick="showSection('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</button>
      <button onclick="showSection('cadastro')"><i class="fa fa-box"></i> Cadastro de Produtos</button>
      <button onclick="showSection('entrada')"><i class="fa fa-arrow-down"></i> Entrada de Materiais</button>
      <button onclick="showSection('saida')"><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</button>
      <button onclick="showSection('estoque')"><i class="fa fa-warehouse"></i> Estoque Atual</button>
      <button onclick="showSection('limites')"><i class="fa fa-sliders-h"></i> Estoque M√≠n/M√°x</button>
      <button onclick="showSection('financeiro')"><i class="fa fa-coins"></i> Financeiro</button>
      <button onclick="showSection('relatorios')"><i class="fa fa-file-excel"></i> Relat√≥rios</button>
      <button onclick="showSection('usuarios')"><i class="fa fa-users"></i> Usu√°rios e Perfis</button>
    </aside>

    <!-- üîπ Conte√∫do principal -->
    <main>
      <!-- Tela de boas-vindas -->
      <section id="boasVindas" class="section active" style="text-align:center; padding:100px 20px;">
        <h1 style="color:#003b88;">üëã Bem-vindo(a) <span id="nomeUsuarioBemVindo"></span>!</h1>
        <h2 style="color:#0d6efd;">ao Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h2>
        <p style="margin-top:20px; color:#555;">Use o menu lateral para iniciar suas atividades.</p>
      </section>

      <!-- Outras se√ß√µes (mantidas 100%) -->
      <section id="dashboard" class="section"><h2>üìä Dashboard</h2></section>
      <section id="cadastro" class="section"><h2>üì¶ Cadastro de Produtos</h2></section>
      <section id="entrada" class="section"><h2>üì• Entrada de Materiais</h2></section>
      <section id="saida" class="section"><h2>üì§ Sa√≠da de Materiais</h2></section>
      <section id="estoque" class="section"><h2>üè∑Ô∏è Estoque Atual</h2></section>
      <section id="limites" class="section"><h2>‚öñÔ∏è Estoque M√≠n/M√°x</h2></section>
      <section id="financeiro" class="section"><h2>üí∞ Financeiro</h2></section>
      <section id="relatorios" class="section"><h2>üìë Relat√≥rios</h2></section>
      <section id="usuarios" class="section"><h2>üë• Usu√°rios e Perfis</h2></section>
    </main>

  </div>

</body>
</html>
:root {
  --azul: #0d6efd;
  --azul-escuro: #003b88;
  --cinza-fundo: #f4f6f9;
  --branco: #ffffff;
  --cinza: #e0e0e0;
}

/* ========================= GERAL ========================= */
html, body {
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: var(--cinza-fundo);
  color: #222;
  height: 100%;
  overflow-x: hidden;
}

/* ========================= HEADER ========================= */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--azul);
  color: var(--branco);
  padding: 12px 20px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  position: sticky;
  top: 0;
  z-index: 900;
}

header h1 {
  font-size: 1.2rem;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

header button {
  background: none;
  border: none;
  color: var(--branco);
  cursor: pointer;
  font-size: 1.3rem;
}

header button:hover {
  color: #e2e2e2;
}

/* ========================= SIDEBAR ========================= */
#sidebar {
  position: fixed;
  top: 0;
  left: -260px;
  width: 250px;
  height: 100%;
  background: var(--azul-escuro);
  color: var(--branco);
  overflow-y: auto;
  transition: left 0.3s ease;
  z-index: 800;
  padding-top: 60px;
  border-right: none;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
}

#sidebar.active {
  left: 0;
}

#sidebar button {
  display: block;
  width: 100%;
  border: none;
  background: none;
  color: var(--branco);
  text-align: left;
  padding: 14px 18px;
  font-size: 15px;
  cursor: pointer;
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
  transition: background 0.2s;
}

#sidebar button i {
  margin-right: 8px;
  width: 18px;
  text-align: center;
}

#sidebar button:hover {
  background: rgba(255, 255, 255, 0.15);
}

/* ========================= MAIN ========================= */
main {
  margin: 20px;
  padding-left: 0;
  transition: margin-left 0.3s ease;
  overflow-x: hidden;
}

@media (min-width: 900px) {
  #sidebar.active + main {
    margin-left: 250px;
  }
}

/* ========================= SE√á√ïES ========================= */
section {
  display: none;
  background: var(--branco);
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.section.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

section h2 {
  color: var(--azul-escuro);
  border-left: 5px solid var(--azul);
  padding-left: 10px;
  margin-bottom: 15px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========================= TABELAS ========================= */
.table-wrap {
  max-height: 60vh;
  overflow-y: auto;
  overflow-x: auto;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.table-wrap table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

.table-wrap table thead th {
  position: sticky;
  top: 0;
  background: var(--azul);
  color: #fff;
  z-index: 10;
  text-align: left;
  padding: 10px 12px;
  border: 1px solid #ddd;
  box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
}

.table-wrap table td {
  border: 1px solid #ddd;
  padding: 10px 12px;
  font-size: 14px;
}

.table-wrap table tr:nth-child(even) {
  background-color: #f9f9f9;
}

/* Scrollbar */
.table-wrap::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
.table-wrap::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 8px;
}
.table-wrap::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* ========================= BOT√ïES ========================= */
button {
  background: var(--azul);
  color: var(--branco);
  border: none;
  padding: 7px 14px;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 14px;
}

button:hover {
  background: var(--azul-escuro);
}

/* ========================= INPUTS ========================= */
input, select {
  padding: 6px 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-size: 14px;
  margin: 3px;
  outline: none;
  transition: border-color 0.2s;
}

input:focus, select:focus {
  border-color: var(--azul);
}

/* ========================= LOGIN ========================= */
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
}

.login-card {
  background: var(--branco);
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  text-align: center;
  width: 320px;
}

.login-card h2 {
  color: var(--azul-escuro);
  margin-bottom: 20px;
}

.login-card input {
  width: 100%;
  margin: 6px 0;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.login-card button {
  width: 100%;
  margin-top: 10px;
}

/* ========================= IMAGENS ========================= */
.thumb {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.2s;
}

.thumb:hover {
  transform: scale(1.08);
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
}

#imagemAmpliada {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

#imagemAmpliada img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
  cursor: pointer;
}

/* ========================= ANIMA√á√ïES ========================= */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* =========================
   üîπ VARI√ÅVEIS GLOBAIS
========================= */
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let entradas = JSON.parse(localStorage.getItem("entradas")) || [];
let saidas = JSON.parse(localStorage.getItem("saidas")) || [];
let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [
  { nome: "admin", senha: "1234", perfil: "Administrador" }
];

/* =========================
   üîπ LOGIN LOCAL
========================= */
function fazerLogin() {
  const usuario = document.getElementById("usuarioLogin").value.trim();
  const senha = document.getElementById("senhaLogin").value.trim();
  const msg = document.getElementById("loginMsg");

  if (!usuario || !senha) {
    msg.textContent = "‚ö†Ô∏è Informe usu√°rio e senha.";
    msg.style.color = "red";
    msg.style.display = "block";
    return;
  }

  const user = usuarios.find(u => u.nome === usuario && u.senha === senha);
  if (!user) {
    msg.textContent = "‚ùå Usu√°rio ou senha incorretos.";
    msg.style.color = "red";
    msg.style.display = "block";
    return;
  }

  // ‚úÖ Sucesso
  msg.textContent = "‚úÖ Login realizado com sucesso!";
  msg.style.color = "green";
  msg.style.display = "block";

  localStorage.setItem("usuarioLogado", JSON.stringify(user));

  setTimeout(() => {
    document.getElementById("loginView").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
    document.getElementById("userName").textContent = user.nome;
    document.getElementById("nomeUsuarioBemVindo").textContent = user.nome;
    showSection("boasVindas");
  }, 800);
}

// Permite login com ENTER
document.addEventListener("keydown", (e) => {
  const loginVisible = document.getElementById("loginView").style.display !== "none";
  if (e.key === "Enter" && loginVisible) fazerLogin();
});

// Logout
function logout() {
  localStorage.removeItem("usuarioLogado");
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("loginView").style.display = "flex";
}

/* =========================
   üîπ RECUPERAR LOGIN AUTOM√ÅTICO
========================= */
window.onload = () => {
  const logado = JSON.parse(localStorage.getItem("usuarioLogado"));
  if (logado) {
    document.getElementById("loginView").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
    document.getElementById("userName").textContent = logado.nome;
    document.getElementById("nomeUsuarioBemVindo").textContent = logado.nome;
    showSection("boasVindas");
  }
};

/* =========================
   üîπ MENU LATERAL
========================= */
function toggleSidebar(forceClose = false) {
  const sidebar = document.getElementById("sidebar");
  if (forceClose) sidebar.classList.remove("active");
  else sidebar.classList.toggle("active");
}

// Fecha o menu clicando fora dele
document.addEventListener("click", (e) => {
  const sidebar = document.getElementById("sidebar");
  const menuBtn = document.getElementById("menuToggle");
  if (
    sidebar.classList.contains("active") &&
    !sidebar.contains(e.target) &&
    !menuBtn.contains(e.target)
  ) {
    sidebar.classList.remove("active");
  }
});

/* =========================
   üîπ TROCA DE SE√á√ïES
========================= */
function showSection(id) {
  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
  const section = document.getElementById(id);
  if (section) {
    section.classList.add("active");
    toggleSidebar(true);
  }
}

/* =========================
   üîπ CADASTRO DE PRODUTOS
========================= */
async function cadastrarProduto() {
  const nomeEl = document.getElementById("produtoNome");
  const categoriaEl = document.getElementById("produtoCategoria");
  const embalagemEl = document.getElementById("produtoEmbalagem");
  const qtdEl = document.getElementById("produtoQtdEmbalagem");
  const fotoInput = document.getElementById("produtoFoto");
  const codigoBarrasEl = document.getElementById("produtoCodigoBarras");

  if (!nomeEl || !categoriaEl || !embalagemEl || !qtdEl || !fotoInput) {
    alert("Campos obrigat√≥rios faltando no HTML!");
    return;
  }

  const nome = nomeEl.value.trim();
  if (!nome) {
    alert("Informe o nome do produto!");
    return;
  }

  const categoria = categoriaEl.value.trim();
  const embalagem = embalagemEl.value.trim();
  const qtd = Number(qtdEl.value);
  if (!categoria || !embalagem || !qtd) {
    alert("Preencha todos os campos do produto!");
    return;
  }

  let foto = "";
  if (fotoInput.files.length > 0) {
    const reader = new FileReader();
    reader.onload = (e) => {
      foto = e.target.result;
      salvarProduto(nome, categoria, embalagem, qtd, foto, codigoBarrasEl?.value || "");
    };
    reader.readAsDataURL(fotoInput.files[0]);
  } else {
    salvarProduto(nome, categoria, embalagem, qtd, "", codigoBarrasEl?.value || "");
  }
}

function salvarProduto(nome, categoria, embalagem, qtd, foto, codigoBarras) {
  produtos.push({ nome, categoria, embalagem, qtd, foto, codigoBarras });
  localStorage.setItem("produtos", JSON.stringify(produtos));
  atualizarTabelaProdutos();
  alert("‚úÖ Produto cadastrado com sucesso!");
}

function atualizarTabelaProdutos() {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  produtos.forEach((p, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.foto ? `<img src="${p.foto}" class="thumb">` : "-"}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.embalagem}</td>
      <td>${p.qtd}</td>
      <td>${p.codigoBarras || "-"}</td>
    `;
    tbody.appendChild(row);
  });
}

/* =========================
   üîπ IMAGEM AMPLIADA
========================= */
function ampliarImagem(src) {
  const modal = document.getElementById("imagemAmpliada");
  modal.style.display = "flex";
  modal.querySelector("img").src = src;
}

/* =========================
   üîπ CADASTRO DE USU√ÅRIOS
========================= */
function salvarUsuario() {
  const nome = document.getElementById("usuarioNome").value.trim();
  const senha = document.getElementById("usuarioSenha").value.trim();
  const perfil = document.getElementById("usuarioPerfil").value;

  if (!nome || !senha) {
    alert("Preencha nome e senha!");
    return;
  }

  usuarios.push({ nome, senha, perfil });
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  alert("‚úÖ Usu√°rio cadastrado com sucesso!");
}
/* =========================
   üîπ REGISTRAR ENTRADA DE MATERIAIS
========================= */
function registrarEntrada() {
  const produto = document.getElementById("entradaProduto").value.trim();
  const quantidade = Number(document.getElementById("entradaQuantidade").value);
  const valor = Number(document.getElementById("entradaValor").value);
  const data = document.getElementById("entradaData").value;
  const nota = document.getElementById("entradaNota").value.trim();
  const fornecedor = document.getElementById("entradaFornecedor").value.trim();

  if (!produto || !quantidade || !valor || !data) {
    alert("‚ö†Ô∏è Preencha todos os campos obrigat√≥rios da entrada!");
    return;
  }

  entradas.push({ produto, quantidade, valor, data, nota, fornecedor });
  localStorage.setItem("entradas", JSON.stringify(entradas));

  // Atualiza estoque
  const p = produtos.find(p => p.nome.toLowerCase() === produto.toLowerCase());
  if (p) p.qtd += quantidade;

  localStorage.setItem("produtos", JSON.stringify(produtos));
  atualizarTabelaEntradas();
  atualizarTabelaEstoque();

  alert("‚úÖ Entrada registrada com sucesso!");
}

function atualizarTabelaEntradas() {
  const tbody = document.querySelector("#tabelaEntradas tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  entradas.forEach((e, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${e.produto}</td>
      <td>${e.quantidade}</td>
      <td>${e.valor.toFixed(2)}</td>
      <td>${e.data}</td>
      <td>${e.nota}</td>
      <td>${e.fornecedor}</td>
    `;
    tbody.appendChild(row);
  });
}

/* =========================
   üîπ REGISTRAR SA√çDA DE MATERIAIS
========================= */
function registrarSaida() {
  const produto = document.getElementById("saidaProduto").value.trim();
  const quantidade = Number(document.getElementById("saidaQuantidade").value);
  const responsavel = document.getElementById("saidaResponsavel").value.trim();
  const data = document.getElementById("saidaData").value;

  if (!produto || !quantidade || !responsavel || !data) {
    alert("‚ö†Ô∏è Preencha todos os campos obrigat√≥rios da sa√≠da!");
    return;
  }

  saidas.push({ produto, quantidade, responsavel, data });
  localStorage.setItem("saidas", JSON.stringify(saidas));

  // Atualiza estoque
  const p = produtos.find(p => p.nome.toLowerCase() === produto.toLowerCase());
  if (p) {
    p.qtd = Math.max(0, p.qtd - quantidade);
    localStorage.setItem("produtos", JSON.stringify(produtos));
  }

  atualizarTabelaSaidas();
  atualizarTabelaEstoque();

  alert("‚úÖ Sa√≠da registrada com sucesso!");
}

function atualizarTabelaSaidas() {
  const tbody = document.querySelector("#tabelaSaidas tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  saidas.forEach((s, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${s.produto}</td>
      <td>${s.quantidade}</td>
      <td>${s.data}</td>
      <td>${s.responsavel}</td>
    `;
    tbody.appendChild(row);
  });
}

/* =========================
   üîπ ESTOQUE ATUAL
========================= */
function atualizarTabelaEstoque() {
  const tbody = document.querySelector("#tabelaEstoque tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  produtos.forEach((p, i) => {
    const status =
      p.qtd <= 2
        ? `<span style="color:red">Cr√≠tico</span>`
        : `<span style="color:green">OK</span>`;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.qtd}</td>
      <td>${status}</td>
    `;
    tbody.appendChild(row);
  });
}

/* =========================
   üîπ ESTOQUE M√çNIMO E M√ÅXIMO
========================= */
function atualizarTabelaLimites() {
  const tbody = document.querySelector("#tabelaLimites tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  produtos.forEach((p, i) => {
    const minimo = 2;
    const maximo = 50;
    const status =
      p.qtd < minimo
        ? "‚ö†Ô∏è Abaixo do m√≠nimo"
        : p.qtd > maximo
        ? "üì¶ Acima do m√°ximo"
        : "‚úÖ Dentro do limite";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.qtd}</td>
      <td>${minimo}</td>
      <td>${maximo}</td>
      <td>${status}</td>
    `;
    tbody.appendChild(row);
  });
}

/* =========================
   üîπ PAINEL FINANCEIRO
========================= */
function atualizarPainelFinanceiro() {
  const totalEntradas = entradas.reduce((acc, e) => acc + e.valor * e.quantidade, 0);
  const totalSaidas = saidas.reduce((acc, s) => acc + s.quantidade * 5, 0); // estimativa
  const totalEstoque = produtos.reduce((acc, p) => acc + (p.qtd || 0) * 5, 0);

  document.getElementById("valorEstoque").textContent = "R$ " + totalEstoque.toFixed(2);
  document.getElementById("valorSaidas").textContent = "R$ " + totalSaidas.toFixed(2);
}

/* =========================
   üîπ RELAT√ìRIOS (CSV)
========================= */
function gerarRelatorioEstoque() {
  let csv = "Produto,Categoria,Quantidade\n";
  produtos.forEach(p => {
    csv += `${p.nome},${p.categoria},${p.qtd}\n`;
  });
  baixarCSV(csv, "Relatorio_Estoque.csv");
}

function gerarRelatorioEntradas() {
  let csv = "Produto,Quantidade,Valor,Data,Nota,Fornecedor\n";
  entradas.forEach(e => {
    csv += `${e.produto},${e.quantidade},${e.valor},${e.data},${e.nota},${e.fornecedor}\n`;
  });
  baixarCSV(csv, "Relatorio_Entradas.csv");
}

function gerarRelatorioSaidas() {
  let csv = "Produto,Quantidade,Responsavel,Data\n";
  saidas.forEach(s => {
    csv += `${s.produto},${s.quantidade},${s.responsavel},${s.data}\n`;
  });
  baixarCSV(csv, "Relatorio_Saidas.csv");
}

function baixarCSV(conteudo, nomeArquivo) {
  const blob = new Blob(["\uFEFF" + conteudo], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = nomeArquivo;
  link.click();
}

/* =========================
   üîπ ATUALIZA√á√ÉO AUTOM√ÅTICA
========================= */
setInterval(() => {
  atualizarTabelaProdutos();
  atualizarTabelaEntradas();
  atualizarTabelaSaidas();
  atualizarTabelaEstoque();
  atualizarTabelaLimites();
  atualizarPainelFinanceiro();
}, 2000);
/* =========================
   üîπ DASHBOARD DO SISTEMA
========================= */
function atualizarDashboard() {
  const proximosVencer = produtos.filter(p => p.validade && diasParaVencer(p.validade) <= 30);
  const maisCaros = [...produtos].sort((a, b) => (b.valor || 0) - (a.valor || 0)).slice(0, 5);
  const maisSaidas = contarMaisUsados(saidas).slice(0, 5);
  const menosSaidas = contarMenosUsados(saidas).slice(0, 5);
  const estoqueCritico = produtos.filter(p => (p.qtd || 0) < 3);

  preencherLista("listaProximosVencer", proximosVencer.map(p => `${p.nome} (${p.validade || "s/ validade"})`));
  preencherLista("listaMaisCaros", maisCaros.map(p => `${p.nome} - R$ ${(p.valor || 0).toFixed(2)}`));
  preencherLista("listaMaisSaidas", maisSaidas.map(p => `${p.produto} (${p.total}x)`));
  preencherLista("listaMenosSaidas", menosSaidas.map(p => `${p.produto} (${p.total}x)`));
  preencherLista("listaEstoqueCritico", estoqueCritico.map(p => `${p.nome} (${p.qtd || 0})`));

  document.getElementById("resumoGeral").innerHTML = `
    <p><b>Total de Produtos:</b> ${produtos.length}</p>
    <p><b>Total de Entradas:</b> ${entradas.length}</p>
    <p><b>Total de Sa√≠das:</b> ${saidas.length}</p>
    <p><b>Estoque Cr√≠tico:</b> ${estoqueCritico.length}</p>
  `;
}

function preencherLista(id, itens) {
  const ul = document.getElementById(id);
  if (!ul) return;
  ul.innerHTML = itens.length
    ? itens.map(i => `<li>${i}</li>`).join("")
    : "<li>‚Äî Nenhum item encontrado ‚Äî</li>";
}

function diasParaVencer(dataStr) {
  const hoje = new Date();
  const validade = new Date(dataStr);
  const diff = validade - hoje;
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

function contarMaisUsados(saidas) {
  const contagem = {};
  saidas.forEach(s => (contagem[s.produto] = (contagem[s.produto] || 0) + s.quantidade));
  return Object.entries(contagem).map(([produto, total]) => ({ produto, total }))
    .sort((a, b) => b.total - a.total);
}

function contarMenosUsados(saidas) {
  const contagem = contarMaisUsados(saidas);
  return contagem.sort((a, b) => a.total - b.total);
}

/* =========================
   üîπ IMAGEM AMPLIADA (MODAL)
========================= */
function ampliarImagem(src) {
  const modal = document.getElementById("imagemAmpliada");
  if (!modal) return;
  modal.style.display = "flex";
  modal.querySelector("img").src = src;
}

document.getElementById("imagemAmpliada")?.addEventListener("click", function () {
  this.style.display = "none";
});

/* =========================
   üîπ LOGIN / SISTEMA
========================= */
function mostrarSistema(usuario) {
  document.getElementById("loginView").style.display = "none";
  document.getElementById("mainApp").style.display = "block";
  document.getElementById("userName").textContent = usuario.nome;
  document.getElementById("nomeUsuarioBemVindo").textContent = usuario.nome;
  showSection("boasVindas");
  atualizarDashboard();
}

/* =========================
   üîπ TROCAR SE√á√ïES
========================= */
function showSection(id) {
  document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
  const section = document.getElementById(id);
  if (section) section.classList.add("active");
  if (id === "dashboard") atualizarDashboard();
}

/* =========================
   üîπ LOGOUT
========================= */
function logout() {
  localStorage.removeItem("usuarioLogado");
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("loginView").style.display = "flex";
}

/* =========================
   üîπ INICIALIZA√á√ÉO
========================= */
window.onload = function () {
  produtos = JSON.parse(localStorage.getItem("produtos")) || [];
  entradas = JSON.parse(localStorage.getItem("entradas")) || [];
  saidas = JSON.parse(localStorage.getItem("saidas")) || [];

  const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
  if (usuarioLogado && usuarioLogado.logado) {
    mostrarSistema(usuarioLogado);
  } else {
    document.getElementById("loginView").style.display = "flex";
    document.getElementById("mainApp").style.display = "none";
  }

  atualizarTabelaProdutos();
  atualizarTabelaEntradas();
  atualizarTabelaSaidas();
  atualizarTabelaEstoque();
  atualizarTabelaLimites();
  atualizarPainelFinanceiro();
  atualizarDashboard();
};
