<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
	<style>
    :root {
      --azul: #0d6efd;
      --azul-escuro: #003b88;
      --cinza-fundo: #f4f6f9;
      --branco: #ffffff;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #222;
    }

    /* ===== LOGIN ===== */
    #login {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    .login-card {
      background: var(--branco);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 320px;
    }

    .login-card h2 {
      color: var(--azul-escuro);
      margin-bottom: 20px;
    }

    .login-card input {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .login-card button {
      width: 100%;
      margin-top: 10px;
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 8px;
      border-radius: 5px;
      font-size: 15px;
      cursor: pointer;
    }

    .login-card button:hover {
      background: var(--azul-escuro);
    }

    /* ===== MAIN APP ===== */
    #mainApp {
      display: none;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--azul);
      color: var(--branco);
      padding: 12px 20px;
    }

    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100%;
      background: var(--azul-escuro);
      color: white;
      padding-top: 60px;
      transition: transform 0.3s ease;
      transform: translateX(-220px);
    }
    #sidebar.active {
      transform: translateX(0);
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      box-sizing: border-box;
    }
    main {
      margin-left: 0; /* Come√ßa em 0 */
      padding: 80px 20px 20px 20px; /* Padding no topo para evitar o header */
      transition: margin-left 0.3s ease;
    }

    /* Ajuste para quando o sidebar estiver ativo */
    #sidebar.active ~ main {
      margin-left: 240px;
    }
    
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* UTILS */
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .input-row input, .input-row select, .input-row button {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .input-row .flex {
      flex: 1;
      min-width: 150px;
    }
    .input-row button {
      background: var(--azul);
      color: white;
      border: none;
      cursor: pointer;
    }
    .input-row button:hover {
      background: var(--azul-escuro);
    }

    /* TABELA */
    .table-wrap {
      overflow-x: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border: 1px solid #eee;
      text-align: left;
    }
    th {
      background: var(--azul-escuro);
      color: white;
    }
    td .thumb {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }
    td button {
      background: var(--azul);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    td button.btnExcluir {
        background: #dc3545;
    }
    td button.btnExcluir:hover {
        background: #c82333;
    }
    /* Modal de Imagem */
    #imagemAmpliada {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
    }
    #imagemAmpliada img {
      margin: auto;
      display: block;
      width: 80%;
      max-width: 700px;
      max-height: 90vh;
    }
  </style>
</head>
<body>

  <div id="login">
    <div class="login-card">
      <h2>Sistema de Controle de Estoque</h2>
      <input type="text" id="usuario" placeholder="Usu√°rio (E-mail)" onkeydown="if(event.key==='Enter') window.fazerLogin()">
      <input type="password" id="senha" placeholder="Senha" onkeydown="if(event.key==='Enter') window.fazerLogin()">
      <button id="btnLogin" onclick="window.fazerLogin()">Entrar</button>
    </div>
  </div>
	
  <div id="mainApp" style="display:none;">
    
    <div id="imagemAmpliada" onclick="this.style.display='none'" style="display:none;">
      <img src="" alt="Imagem ampliada">
    </div>

    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="menuToggle" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <h1><i class="fa fa-boxes-stacked"></i> SCE ‚Äì Oral Unic Campo Grande</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div id="userName" style="font-weight:700">Visitante</div>
        <div id="perfilBadge" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;font-size:13px;">PERFIL</div>
        <button onclick="window.logout()" title="Sair"><i class="fa fa-sign-out-alt"></i></button>
      </div>
    </header>
    
    <aside id="sidebar" aria-hidden="true">
	    <button onclick="showSection('boasVindas')"><i class="fa fa-home"></i> In√≠cio</button>
	    <button onclick="showSection('dashboard');atualizarDashboard()"><i class="fa fa-chart-pie"></i> Dashboard</button>
      <button onclick="showSection('cadastro');atualizarTabelaProdutos()"><i class="fa fa-box"></i> Cadastro de Produtos</button>
      <button onclick="showSection('entrada');atualizarTabelaEntradas()"><i class="fa fa-arrow-down"></i> Entrada de Materiais</button>
      <button onclick="showSection('saida');atualizarTabelaSaidas()"><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</button>
      <button onclick="showSection('estoque');atualizarTabelaEstoque()"><i class="fa fa-warehouse"></i> Estoque Atual</button>
      <button onclick="showSection('limites');atualizarTabelaLimites()"><i class="fa fa-sliders-h"></i> Estoque M√≠n/M√°x</button>
      <button onclick="showSection('financeiro');atualizarPainelFinanceiro()"><i class="fa fa-coins"></i> Financeiro</button>
      <button onclick="showSection('relatorios')"><i class="fa fa-file-excel"></i> Relat√≥rios</button>
      <button onclick="showSection('usuarios');atualizarTabelaUsuarios()"><i class="fa fa-users"></i> Usu√°rios e Perfis</button>
    </aside>

	 <main>  
      <section id="boasVindas" class="section active" style="text-align:center; padding:100px 20px;">
        <h1 style="color:#003b88;">üëã Bem-vindo(a) <span id="nomeUsuarioBemVindo"></span>!</h1>
        <h2 style="color:#0d6efd;">ao Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h2>
        <p style="margin-top:20px; color:#555;">Use o menu lateral para iniciar suas atividades.</p>
      </section>

      <section id="dashboard" class="section">
        <h2>üìä Dashboard do Sistema</h2>
        <div class="input-row">
            <input type="date" id="dashInicio" style="flex:1"/>
            <input type="date" id="dashFim" style="flex:1"/>
        </div>
        <div class="dash-container input-row" style="gap:20px; justify-content:space-between; align-items:flex-start;">
          
          <div class="dash-card" style="flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <h3>üìà Resumo Geral</h3>
            <div id="resumoGeral"></div>
          </div>
          
          <div class="dash-card" style="flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <h3>‚ö†Ô∏è Estoque Cr√≠tico</h3>
            <ul id="listaEstoqueCritico" style="list-style:none; padding:0;"></ul>
          </div>
          
          <div class="dash-card" style="flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <h3>üïí Pr√≥ximos do Vencimento</h3>
            <ul id="listaProximosVencer" style="list-style:none; padding:0;"></ul>
          </div>
          
          <div class="dash-card" style="flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <h3>üì¶ Mais Utilizados (Sa√≠das)</h3>
            <ul id="listaMaisSaidas" style="list-style:none; padding:0;"></ul>
          </div>

        </div>
      </section>
 
      <section id="cadastro" class="section">
        <h2><i class="fa fa-box"></i> Cadastro de Produtos</h2>

        <div class="input-row" style="margin-bottom:10px;gap:8px;">
          <input id="produtoNome" type="text" placeholder="Nome do produto" class="flex" />

          <select id="produtoCategoria">
            <option value="">Selecione a categoria</option>
            <option>Material de Uso e Consumo</option>
            <option>Copa e Cozinha</option>
            <option>Escrit√≥rio</option>
            <option>Implante e Componentes</option>
            <option>Insumo Dental</option>
            <option>Insumo Laborat√≥rio</option>
            <option>Medicamentos</option>
            <option>Material de Limpeza</option>
          </select>
          <select id="produtoEmbalagem">
            <option value="">Selecione o tipo de embalagem</option>
            <option>Ampola</option>
            <option>Caixa</option>
            <option>Fardo</option>
            <option>Frasco</option>
            <option>Garrafa</option>
            <option>Gramas</option>
            <option>Litro</option>
            <option>Pacote</option>
            <option>Pe√ßa</option>
            <option>Quilogramas (KG)</option>
            <option>Saco</option>
            <option>Unidade</option>
          </select>
          <input id="produtoQtdEmbalagem" type="number" placeholder="Qtd por embalagem" style="width:140px" />
		      <input id="produtoCodigoBarras" type="text" placeholder="üì∑C√≥digo de Barras (opcional)" style="width:220px" />

          <input id="produtoFoto" type="file" accept="image/*" />
          <button onclick="cadastrarProduto()"><i class="fa fa-save"></i> Cadastrar</button>
        </div>

        <div style="margin-bottom:10px;">
          <input id="filtroProduto" type="text" placeholder="üîç Filtrar por nome ou categoria" style="width:98%" oninput="filtrarProdutos()" />
        </div>

        <div class="table-wrap">
          <table id="tabelaProdutos">
            <thead>
              <tr>
                <th>#</th>
                <th>Foto</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Embalagem</th>
                <th>Qtd/Emb.</th>
				        <th>C√≥d. Barras</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="entrada" class="section">
        <h2><i class="fa fa-arrow-down"></i> Entrada de Materiais</h2>
        <div class="input-row" style="margin-bottom:10px;gap:8px;">
            <input id="entradaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" style="min-width:200px;" oninput="buscarProdutoPorCodigo('entrada')" />
            <input id="entradaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" oninput="atualizarSetorAutomatico('entrada')" list="listaProdutosEntrada"/>
            <datalist id="listaProdutosEntrada"></datalist>
            <input id="entradaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
            <input id="entradaValor" type="number" placeholder="Valor Unit√°rio (R$)" step="0.01" style="width:150px" />
            <input id="entradaData" type="date" style="width:160px" />
            <input id="entradaNota" type="text" placeholder="Nota Fiscal" />
            <input id="entradaFornecedor" type="text" placeholder="Fornecedor" />
            <input id="entradaCNPJ" type="text" placeholder="CNPJ" />
            <input id="entradaLote" type="text" placeholder="Lote" />
            <input id="entradaValidade" type="date" placeholder="Validade" />

            <select id="entradaSetor">
              <option value="">Selecione o Setor Utilizado</option>
              <option>Limpeza da Cl√≠nica</option>
              <option>Laborat√≥rio</option>
              <option>Escrit√≥rio</option>
              <option>Copa e Cozinha</option>
              <option>Cl√≠nico Geral</option>
              <option>Centro Cir√∫rgico</option>
            </select>

            <button onclick="registrarEntrada()"><i class="fa fa-save"></i> Registrar Entrada</button>
        </div>

        <div style="margin-bottom:10px;">
          <input id="filtroEntrada" type="text" placeholder="üîç Buscar por produto, fornecedor ou NF" style="width:98%" oninput="filtrarEntradas()" />
        </div>

        <div class="table-wrap">
          <table id="tabelaEntradas">
            <thead>
              <tr>
                <th>#</th>
                <th>Produto</th>
                <th>C√≥digo de Barras</th>
                <th>Qtd</th>
                <th>Valor (R$)</th>
                <th>Data</th>
                <th>NF</th>
                <th>Fornecedor</th>
                <th>CNPJ</th>
                <th>Lote</th>
                <th>Validade</th>
                <th>Setor</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="saida" class="section">
        <h2><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</h2>

        <div class="input-row" style="margin-bottom:10px;gap:8px;">
          <input id="saidaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" oninput="buscarProdutoPorCodigo('saida')" />
          <input id="saidaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" oninput="atualizarSetorAutomatico('saida')" list="listaProdutosSaida" />
          <datalist id="listaProdutosSaida"></datalist>
          <input id="saidaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
          <input id="saidaResponsavel" type="text" placeholder="Respons√°vel" />
          <input id="saidaObservacao" type="text" placeholder="Observa√ß√£o (opcional)" />
          <select id="saidaSetor">
            <option value="">Selecione o Setor</option>
            <option>Limpeza da Cl√≠nica</option>
            <option>Laborat√≥rio</option>
            <option>Escrit√≥rio</option>
            <option>Copa e Cozinha</option>
            <option>Cl√≠nico Geral</option>
            <option>Centro Cir√∫rgico</option>
          </select>
          <input id="saidaData" type="date" style="width:160px" />
          <button onclick="registrarSaida()"><i class="fa fa-save"></i> Registrar Sa√≠da</button>
        </div>

        <div style="margin-bottom:10px;">
          <input id="filtroSaida" type="text" placeholder="üîç Buscar por produto, setor ou respons√°vel" style="width:98%" oninput="filtrarSaidas()" />
        </div>

        <div class="table-wrap">
          <table id="tabelaSaidas">
            <thead>
              <tr>
                <th>#</th>
                <th>Produto</th>
                <th>C√≥digo de Barras</th>
                <th>Qtd</th>
                <th>Data</th>
                <th>Setor</th>
                <th>Respons√°vel</th>
                <th>Observa√ß√£o</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="estoque" class="section">
        <h2><i class="fa fa-warehouse"></i> Estoque Atual</h2>
        <div class="input-row">
          <input id="filtroEstoque" type="text" placeholder="üîç Buscar produto ou categoria" style="flex:1" oninput="filtrarEstoque()" />
          <select id="filtroCategoriaEstoque" onchange="atualizarTabelaEstoque()">
            <option value="">Todas as Categorias</option>
            <option>Material de Uso e Consumo</option>
            <option>Copa e Cozinha</option>
            <option>Escrit√≥rio</option>
            <option>Implante e Componentes</option>
            <option>Insumo Dental</option>
            <option>Insumo Laborat√≥rio</option>
            <option>Medicamentos</option>
            <option>Material de Limpeza</option>
          </select>
          <button onclick="atualizarTabelaEstoque()"><i class="fa fa-sync-alt"></i> Atualizar</button>
        </div>
        
        <div class="table-wrap">
          <table id="tabelaEstoque">
            <thead>
              <tr>
                <th>#</th>
                <th>Foto</th>
                <th>Nome</th>
                <th>C√≥d. Barras</th>
                <th>Categoria</th>
                <th>Embalagem</th>
                <th>Qtd/Emb.</th>
                <th>Estoque Atual</th>
                <th>Valor M√©dio (R$)</th>
                <th>Validade Mais Pr√≥xima</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="limites" class="section">
        <h2><i class="fa fa-sliders-h"></i> Limites de Estoque (M√≠n/M√°x)</h2>
        <div class="input-row">
            <input id="filtroTextoLimites" type="text" placeholder="üîç Buscar produto ou categoria" style="flex:1" oninput="atualizarTabelaLimites()" />
            <select id="filtroCategoriaLimites" onchange="atualizarTabelaLimites()">
                <option value="">Todas as Categorias</option>
                <option>Material de Uso e Consumo</option>
                <option>Copa e Cozinha</option>
                <option>Escrit√≥rio</option>
                <option>Implante e Componentes</option>
                <option>Insumo Dental</option>
                <option>Insumo Laborat√≥rio</option>
                <option>Medicamentos</option>
                <option>Material de Limpeza</option>
            </select>
            <button onclick="gerarListaCompra()"><i class="fa fa-shopping-cart"></i> Gerar Lista de Compra</button>
            <button onclick="limparListaCompra()"><i class="fa fa-eraser"></i> Limpar Lista</button>
        </div>

        <div class="table-wrap">
          <table id="tabelaLimites">
              <thead>
                  <tr>
                      <th>#</th>
                      <th>Produto</th>
                      <th>C√≥d. Barras</th>
                      <th>Qtd. Atual</th>
                      <th style="width:100px;">M√≠nimo</th>
                      <th style="width:100px;">M√°ximo</th>
                      <th>Status</th>
                      <th>Recomenda√ß√£o</th>
                      <th>A√ß√µes</th>
                  </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                  <tr>
                      <td colspan="9" id="resumoLimites" style="text-align:right; font-weight:bold;"></td>
                  </tr>
              </tfoot>
          </table>
        </div>

        <div id="listaCompraContainer" style="display:none; margin-top:20px;">
          <h3><i class="fa fa-shopping-cart"></i> Lista de Compra Gerada</h3>
          <div class="table-wrap" style="max-height:400px; overflow-y:auto; overflow-x:auto; border:1px solid #ccc;">
            <table id="tabelaListaCompra" class="tabela-padrao">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Produto</th>
                  <th>C√≥digo de Barras</th>
                  <th>Categoria</th>
                  <th>Qtd Atual</th>
                  <th>M√≠nimo</th>
                  <th>Recomendado Comprar</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="6" style="text-align:right; font-weight:bold;">Total de Itens:</td>
                  <td id="totalItensCompra" style="font-weight:bold;">0</td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div style="margin-top:10px;">
            <button onclick="exportarListaExcel()"> <i class="fa fa-file-excel"></i> Exportar para Excel </button>
            <button onclick="gerarPedidoPDF()"> <i class="fa fa-file-pdf"></i> Gerar Pedido de Or√ßamento (PDF) </button>
          </div>
        </div>

      </section>

      <section id="financeiro" class="section">
          <h2><i class="fa fa-coins"></i> Painel Financeiro</h2>
          <div class="input-row" style="justify-content:space-between; gap:20px; margin-bottom: 20px;">
              <div style="flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                  <h3>C√°lculo: √öltima Entrada</h3>
                  <p id="valorUltimaEntrada" style="font-size:20px; color:var(--azul-escuro);">R$ 0,00</p>
              </div>
              <div style="flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                  <h3>C√°lculo: Custo M√©dio Ponderado</h3>
                  <p id="valorCustoMedio" style="font-size:20px; color:var(--azul-escuro);">R$ 0,00</p>
              </div>
              <div style="flex:1; background:#0d6efd; color:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                  <h3>Valor Total do Estoque (M√©dia)</h3>
                  <p id="valorEstoqueAtualPainel" style="font-size:24px; font-weight:bold;">R$ 0,00</p>
              </div>
          </div>

          <div class="table-wrap">
              <table id="tabelaFinanceiro">
                  <thead>
                      <tr>
                          <th>#</th>
                          <th>Fornecedor</th>
                          <th>Nota Fiscal</th>
                          <th>Valor da Nota (Entradas)</th>
                          <th>Valor de Sa√≠da (Custo)</th>
                          <th>Valor Residual (Estoque)</th>
                      </tr>
                  </thead>
                  <tbody></tbody>
              </table>
          </div>
      </section>

      <section id="relatorios" class="section">
        <h2><i class="fa fa-file-excel"></i> Relat√≥rios e Exporta√ß√£o</h2>
        <p>Selecione um per√≠odo e o tipo de relat√≥rio para exporta√ß√£o.</p>

        <div class="input-row">
            <input type="date" id="dataInicioRelatorio" style="width:160px;" />
            <input type="date" id="dataFimRelatorio" style="width:160px;" />
            <button onclick="gerarRelatorio()"><i class="fa fa-file-excel"></i> Gerar Relat√≥rio de Entradas (Excel)</button>
            <button onclick="gerarRelatorioSaida()"><i class="fa fa-file-excel"></i> Gerar Relat√≥rio de Sa√≠das (Excel)</button>
        </div>
        
        <div class="input-row">
            <button onclick="definirPeriodoRapido('7dias')">√öltimos 7 dias</button>
            <button onclick="definirPeriodoRapido('30dias')">√öltimos 30 dias</button>
            <button onclick="definirPeriodoRapido('mes')">M√™s Atual</button>
            <button onclick="limparPeriodo()">Limpar</button>
        </div>

        <div style="background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <p>Os relat√≥rios s√£o gerados em formato Excel (.csv) e incluem todos os dados das tabelas correspondentes ao per√≠odo selecionado.</p>
        </div>

      </section>

      <section id="usuarios" class="section">
          <h2><i class="fa fa-users"></i> Gerenciar Usu√°rios e Perfis</h2>
          <div style="display:flex;flex-wrap:wrap;gap:8px; margin-bottom: 15px;">
              <input id="usuarioNome" type="text" placeholder="Nome Completo" />
              <input id="usuarioCPF" type="text" placeholder="CPF (opcional)" />
              <input id="usuarioEmail" type="email" placeholder="E-mail (Login)" />
              <input id="usuarioSenha" type="password" placeholder="Senha" />
              <select id="usuarioPerfil">
                  <option value="administrador">Administrador</option>
                  <option value="gerente">Gerente</option>
                  <option value="simples1">Visualiza√ß√£o (Financeiro Bloqueado)</option>
                  <option value="simples2">Apenas Visualiza√ß√£o (Tudo Bloqueado)</option>
              </select>
              <button onclick="salvarUsuario()"><i class="fa fa-user-plus"></i> Salvar Usu√°rio</button>
          </div>

          <div class="table-wrap">
              <table id="tabelaUsuarios">
                  <thead>
                      <tr>
                          <th>#</th>
                          <th>Nome</th>
                          <th>E-mail (Login)</th>
                          <th>Perfil</th>
                          <th>A√ß√µes</th>
                      </tr>
                  </thead>
                  <tbody></tbody>
              </table>
          </div>
      </section>

    </main>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCxhDaVIiLuNCagXOkyOSYC0El8KzbGfDw",
      authDomain: "oralunicestoque.firebaseapp.com",
      projectId: "oralunicestoque",
      storageBucket: "oralunicestoque.firebasestorage.app",
      messagingSenderId: "660233908877",
      appId: "1:660233908877:web:2a6c9cd10b056b41bde8c4"
    };

    // Inicializa√ß√£o
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    window.database = database; // Torna o database acess√≠vel globalmente
    window.auth = auth; // Torna o auth acess√≠vel globalmente

    // Fun√ß√£o auxiliar para buscar perfil no Realtime Database
    async function buscarPerfilUsuario(uid) {
        try {
            const userRef = ref(database, 'usuarios/' + uid);
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                return snapshot.val().perfil || 'simples2'; // Retorna o perfil
            }
        } catch (error) {
            console.error("Erro ao buscar perfil:", error);
        }
        return 'simples2'; // Perfil padr√£o em caso de erro
    }


    // === LOGIN CORRIGIDO (Firebase) ===
    window.fazerLogin = async function() {
      const usuarioEl = document.getElementById("usuario");
      const senhaEl = document.getElementById("senha");
      const usuario = usuarioEl.value.trim();
      const senha = senhaEl.value.trim();

      if (!usuario || !senha) {
        alert("Preencha usu√°rio (e-mail) e senha!");
        return;
      }
      
      const email = usuario; // Assume que o usu√°rio digitar√° o e-mail completo
      
      // Limpa campos ap√≥s tentar login
      usuarioEl.value = "";
      senhaEl.value = "";

      try {
        const cred = await signInWithEmailAndPassword(auth, email, senha);
        // O onAuthStateChanged vai ser disparado e cuidar da interface.
        console.log("Login OK! UID:", cred.user.uid);
      } catch (error) {
        console.error(error.code, error.message);
        alert(`Erro de login: ${error.code.replace('auth/', '').toUpperCase()}`);
      }
    };

    // Fun√ß√£o que manipula a interface ap√≥s login/logout
    window.mostrarSistema = async function(user) {
        const login = document.getElementById("login");
        const appDiv = document.getElementById("mainApp");
        const userName = document.getElementById("userName");
        const perfilBadge = document.getElementById("perfilBadge");
        const nomeBemVindo = document.getElementById("nomeUsuarioBemVindo");
        
        // 1. Busca o perfil (esta fun√ß√£o est√° na parte principal do JS)
        if (typeof buscarUsuarioPorEmail === "function") {
            const userData = buscarUsuarioPorEmail(user.email);
            const perfil = userData?.perfil || 'simples2'; 
            window.usuarioLogado = { email: user.email, perfil: perfil, logado: true };
            perfilBadge.textContent = "Perfil: " + perfil.toUpperCase();
            
            if (typeof aplicarPermissoes === "function") aplicarPermissoes();

        } else {
            window.usuarioLogado = { email: user.email, perfil: 'simples2', logado: true };
        }
        
        // 2. Atualiza a interface
        const nomeUsuario = user.email?.split("@")[0] || "Usu√°rio";
        userName.innerText = nomeUsuario;
        if (nomeBemVindo) nomeBemVindo.textContent = nomeUsuario;

        login.style.display = "none";
        appDiv.style.display = "block";
        
        // Exibe a se√ß√£o inicial (Boas-vindas)
        showSection('boasVindas');

        // 3. Carrega e atualiza os dados
        if (typeof carregarDadosDoFirebase === "function") await carregarDadosDoFirebase();
        if (typeof ordenarListasAlfabeticamente === "function") ordenarListasAlfabeticamente();
        if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
        if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
    }

    // === MONITORAR LOGIN ===
    onAuthStateChanged(auth, (user) => {
      if (user) {
        window.mostrarSistema(user);
      } else {
        const login = document.getElementById("login");
        const appDiv = document.getElementById("mainApp");
        login.style.display = "flex";
        appDiv.style.display = "none";
      }
    });

    // === LOGOUT ===
    window.logout = async function() {
      await signOut(auth);
      // O onAuthStateChanged cuida do resto
      alert("Sess√£o encerrada!");
    };
  </script>

 
  <script>
    // Vari√°veis Globais de Dados (acess√≠veis a todas as fun√ß√µes abaixo)
    let entradas = JSON.parse(localStorage.getItem("entradas")) || [];
    let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
    let saidas = JSON.parse(localStorage.getItem("saidas")) || [];
    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
    let estoqueMinMax = JSON.parse(localStorage.getItem("estoqueMinMax")) || {}; // Para limites

    // Vari√°vel para armazenar o objeto de usu√°rio logado (definida no bloco Firebase)
    window.usuarioLogado = window.usuarioLogado || { perfil: 'simples2' };

    // ==========================================================
    // FUN√á√ïES GERAIS E DE NAVEGA√á√ÉO
    // ==========================================================
    function showSection(id){
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("active");
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        // Inicializa as tabelas ao carregar, se as fun√ß√µes existirem.
        if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
        if (typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
        if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
        if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
        if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
        if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();
        if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
        if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
    });

    function mostrarImagemAmpliada(src) {
        const modal = document.getElementById("imagemAmpliada");
        const img = modal.querySelector("img");
        img.src = src;
        modal.style.display = "flex";
    }

    function formatarTextoPadrao(texto) {
        if (!texto) return "";
        let padronizado = texto.trim().toLowerCase();
        // Capitaliza a primeira letra de cada palavra (exceto preposi√ß√µes curtas, se necess√°rio)
        return padronizado.split(" ").map(word => {
            if (word.length > 0) {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }
            return "";
        }).join(" ");
    }

    /* üî∏ Aplica automaticamente ao sair do campo de texto */
    document.addEventListener("blur", (e) => {
        const el = e.target;
        if (el.tagName === "INPUT" && el.type === "text") {
            // Ignora campos que n√£o devem ser alterados
            if (el.id.toLowerCase().includes("cnpj") || el.id.toLowerCase().includes("email") || el.id.toLowerCase().includes("login") || el.id.toLowerCase().includes("cpf")) return;
            el.value = formatarTextoPadrao(el.value);
        }
    }, true);
    
    function limparCampos(secaoId) {
      const secao = document.getElementById(secaoId);
      if (!secao) return;
      secao.querySelectorAll("input, select").forEach(el => {
        if (el.type === "file") {
          el.value = "";
        } else if (el.tagName === "SELECT") {
          el.selectedIndex = 0;
        } else {
          el.value = "";
        }
      });
    }

    function destacarErro(el, msg) {
        el.style.border = "2px solid red";
        el.focus();
        alert(`‚ö†Ô∏è ${msg}`);
    }

    function buscarProdutoPorCodigo(secao) {
        const codigoBarras = document.getElementById(`${secao}CodigoBarras`).value.trim();
        const produtoInput = document.getElementById(`${secao}Produto`);
        
        if (!codigoBarras) {
            produtoInput.value = "";
            return;
        }

        const produto = produtos.find(p => p.codigoBarras === codigoBarras);

        if (produto) {
            produtoInput.value = produto.nome;
            produtoInput.readOnly = true;
            document.getElementById(`${secao}CodigoBarras`).style.border = "1px solid green";
        } else {
            produtoInput.value = "";
            produtoInput.readOnly = false;
            document.getElementById(`${secao}CodigoBarras`).style.border = "1px solid red";
            // alert("Produto n√£o encontrado pelo c√≥digo de barras.");
        }
    }

    function buscarCodigoBarrasDoProduto(nome) {
        const produto = produtos.find(p => (p.nome || "").toLowerCase() === nome.toLowerCase());
        return produto ? produto.codigoBarras : "";
    }

    // ==========================================================
    // FIREBASE - SALVAMENTO DE DADOS (Fun√ß√µes MOCK)
    // ==========================================================
    // NOTE: Estas fun√ß√µes simulam o salvamento no Firebase e usam localStorage como fallback.
    
    async function salvarDados(nomeColecao, dados) {
      if (window.database) {
          try {
              // Simula o salvamento no Firebase (substituir pela l√≥gica real)
              // const dbRef = ref(window.database, nomeColecao);
              // await set(dbRef, dados);
              // console.log(`Dados de ${nomeColecao} salvos no Firebase (Simulado).`);
              
              // Fallback LocalStorage (para testes offline)
              localStorage.setItem(nomeColecao, JSON.stringify(dados));
          } catch (error) {
              console.error(`Erro ao salvar ${nomeColecao} no Firebase:`, error);
              // Fallback LocalStorage (para testes offline)
              localStorage.setItem(nomeColecao, JSON.stringify(dados));
          }
      } else {
          // Apenas LocalStorage
          localStorage.setItem(nomeColecao, JSON.stringify(dados));
      }
    }
    
    async function carregarDadosDoFirebase() {
        // Simula o carregamento do Firebase ou usa localStorage
        if (window.database) {
            try {
                // const produtosRef = ref(window.database, 'produtos');
                // const snapshot = await get(produtosRef);
                // if (snapshot.exists()) {
                //     produtos = snapshot.val() || [];
                // }
                // ... carregar entradas, saidas, etc.

                // Apenas LocalStorage (para manter o estado atual do seu c√≥digo)
                produtos = JSON.parse(localStorage.getItem("produtos")) || [];
                entradas = JSON.parse(localStorage.getItem("entradas")) || [];
                saidas = JSON.parse(localStorage.getItem("saidas")) || [];
                usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
                estoqueMinMax = JSON.parse(localStorage.getItem("estoqueMinMax")) || {};

            } catch (error) {
                console.error("Erro ao carregar dados do Firebase:", error);
            }
        } else {
            // Apenas LocalStorage
            produtos = JSON.parse(localStorage.getItem("produtos")) || [];
            entradas = JSON.parse(localStorage.getItem("entradas")) || [];
            saidas = JSON.parse(localStorage.getItem("saidas")) || [];
            usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
            estoqueMinMax = JSON.parse(localStorage.getItem("estoqueMinMax")) || {};
        }
    }


    // ==========================================================
    // PERMISS√ïES
    // ==========================================================
    function aplicarPermissoes() {
        const perfil = window.usuarioLogado?.perfil || 'simples2';
        const botoes = document.querySelectorAll("#sidebar button");
        botoes.forEach((b) => (b.style.display = "block")); // Mostra todos por padr√£o

        // Oculta se√ß√µes no menu
        if (perfil === "simples1") {
            ocultarBotoes(["financeiro", "usuarios"]);
        } else if (perfil === "simples2") {
            ocultarBotoes([ "cadastro", "entrada", "saida", "limites", "financeiro", "usuarios", ]);
        }
        
        // Bloqueia bot√µes de a√ß√£o (Salvar, Editar, Excluir, Registrar)
        const isSimples2 = perfil === "simples2";
        document.querySelectorAll("button").forEach((btn) => {
            const t = btn.textContent.toLowerCase();
            const isAction = t.includes("salvar") || t.includes("editar") || t.includes("excluir") || t.includes("registrar") || t.includes("cadastrar");
            
            if (isSimples2 && isAction) {
                btn.disabled = true;
                btn.style.opacity = "0.6";
                btn.style.cursor = "not-allowed";
            } else if (!isSimples2 && isAction) {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            }
        });
    }

    function ocultarBotoes(lista) {
        lista.forEach((id) => {
            // Busca o bot√£o no sidebar pelo atributo onclick que cont√©m o ID
            const botao = document.querySelector(`#sidebar button[onclick*="showSection('${id}')"]`);
            if (botao) botao.style.display = "none";
        });
    }

    // ==========================================================
    // CADASTRO DE PRODUTOS
    // ==========================================================
    async function cadastrarProduto() {
        limparErros("cadastro");
        const nomeEl = document.getElementById("produtoNome");
        const categoriaEl = document.getElementById("produtoCategoria");
        const embalagemEl = document.getElementById("produtoEmbalagem");
        const qtdEl = document.getElementById("produtoQtdEmbalagem");
        const fotoInput = document.getElementById("produtoFoto");
        const codigoBarrasEl = document.getElementById("produtoCodigoBarras");
        
        const codigoBarras = codigoBarrasEl ? codigoBarrasEl.value.trim() : "";
        const nome = nomeEl.value.trim();

        // Valida√ß√µes
        if (!nome) return destacarErro(nomeEl, "Informe o nome do produto!");
        if (!categoriaEl?.value.trim()) return destacarErro(categoriaEl, "Selecione a categoria do produto!");
        if (!embalagemEl?.value.trim()) return destacarErro(embalagemEl, "Selecione o tipo de embalagem!");
        if (!qtdEl?.value || Number(qtdEl.value) <= 0) return destacarErro(qtdEl, "Informe a quantidade por embalagem!");
        if (!fotoInput?.files || !fotoInput.files[0]) return destacarErro(fotoInput, "√â obrigat√≥rio inserir uma foto do produto!");

        // Verifica duplicidades
        const nomeNormalizado = nome.toLowerCase();
        const produtoDuplicado = produtos.some((p) => (p.nome || "").trim().toLowerCase() === nomeNormalizado);
        if (produtoDuplicado) return destacarErro(nomeEl, `J√° existe um produto cadastrado com o nome "${nome}".`);
        
        if (codigoBarras) {
            const existeCodigo = produtos.some((p) => p.codigoBarras === codigoBarras);
            if (existeCodigo) return destacarErro(codigoBarrasEl, "J√° existe um produto cadastrado com este c√≥digo de barras!");
        }

        const categoria = categoriaEl.value.trim();
        const embalagem = embalagemEl.value.trim();
        const qtdEmbalagem = qtdEl.value;

        // Leitura de imagem e salvamento
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const foto = e.target.result;

                produtos.push({
                    nome,
                    categoria,
                    embalagem,
                    qtdEmbalagem,
                    foto,
                    quantidade: 0,
                    codigoBarras: codigoBarras || "",
                    minimo: 0,
                    maximo: 0
                });

                await salvarDados("produtos", produtos);
                
                atualizarTabelaProdutos();
                ordenarListasAlfabeticamente();
                atualizarSelectProdutos();

                alert("Produto cadastrado com sucesso!");

                // Limpa os campos ap√≥s salvar
                limparCampos("cadastro");

                resolve(true);
            };

            reader.readAsDataURL(fotoInput.files[0]);
        });
    }

    function atualizarTabelaProdutos() {
        const tbody = document.querySelector("#tabelaProdutos tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        
        const filtroTexto = document.getElementById("filtroProduto")?.value.toLowerCase() || "";
        
        produtos.forEach((p, i) => {
            const textoBusca = `${p.nome} ${p.categoria} ${p.codigoBarras}`.toLowerCase();
            if (filtroTexto && !textoBusca.includes(filtroTexto)) return;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${ p.foto && p.foto.startsWith("data:") ? `<img src="${p.foto}" class="thumb" onclick="mostrarImagemAmpliada('${p.foto}')">` : "-" }</td>
                <td>${p.nome}</td>
                <td>${p.categoria}</td>
                <td>${p.embalagem}</td>
                <td>${p.qtdEmbalagem}</td>
                <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
                <td>
                    <button onclick="editarProduto(${i})"><i class="fa fa-edit"></i></button>
                    <button class="btnExcluir" onclick="excluirProduto(${i})"><i class="fa fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function editarProduto(i) {
        // Implementa√ß√£o da fun√ß√£o editar produto (completa-se com modal de edi√ß√£o, etc.)
        alert(`Abrir formul√°rio de edi√ß√£o para: ${produtos[i].nome}`);
    }

    function excluirProduto(i) {
        if (!confirm(`Tem certeza que deseja excluir o produto "${produtos[i].nome}" e todos os seus registros de entrada/sa√≠da?`)) return;

        const nomeProdutoExcluido = produtos[i].nome;

        // Remove das listas de transa√ß√£o
        entradas = entradas.filter(e => e.produto !== nomeProdutoExcluido);
        saidas = saidas.filter(s => s.produto !== nomeProdutoExcluido);
        
        // Remove da lista de produtos
        produtos.splice(i, 1);

        salvarDados("produtos", produtos);
        salvarDados("entradas", entradas);
        salvarDados("saidas", saidas);

        atualizarTabelaProdutos();
        atualizarTabelaEntradas();
        atualizarTabelaSaidas();
        atualizarTabelaEstoque();
        atualizarTabelaLimites();
        atualizarSelectProdutos();

        alert("Produto e registros de transa√ß√£o exclu√≠dos com sucesso!");
    }

    function filtrarProdutos() {
        atualizarTabelaProdutos();
    }
    
    function limparErros(secaoId) {
        document.querySelectorAll(`#${secaoId} input, #${secaoId} select`).forEach(el => {
            el.style.border = "1px solid #ccc";
        });
    }

    // ==========================================================
    // ENTRADA DE MATERIAIS
    // ==========================================================

    function registrarEntrada() {
        limparErros("entrada");
        
        const produtoEl = document.getElementById("entradaProduto");
        const qtdEl = document.getElementById("entradaQuantidade");
        const valorEl = document.getElementById("entradaValor");
        const dataEl = document.getElementById("entradaData");
        const notaEl = document.getElementById("entradaNota");
        const fornecedorEl = document.getElementById("entradaFornecedor");
        const cnpjEl = document.getElementById("entradaCNPJ");
        const loteEl = document.getElementById("entradaLote");
        const validadeEl = document.getElementById("entradaValidade");
        const setorEl = document.getElementById("entradaSetor");
        const codigoBarrasEl = document.getElementById("entradaCodigoBarras");

        // Valida√ß√£o
        if (!produtoEl.value.trim()) return destacarErro(produtoEl, "Informe o nome do produto!");
        if (!qtdEl.value || Number(qtdEl.value) <= 0) return destacarErro(qtdEl, "Informe a quantidade!");
        if (!valorEl.value || Number(valorEl.value) <= 0) return destacarErro(valorEl, "Informe o valor unit√°rio!");
        if (!dataEl.value) return destacarErro(dataEl, "Selecione a data!");
        if (!notaEl.value.trim()) return destacarErro(notaEl, "Informe a nota fiscal!");
        if (!fornecedorEl.value.trim()) return destacarErro(fornecedorEl, "Informe o fornecedor!");
        if (!loteEl.value.trim()) return destacarErro(loteEl, "Informe o n√∫mero do lote!");
        if (!validadeEl.value) return destacarErro(validadeEl, "Selecione a validade!");
        if (!setorEl.value.trim()) return destacarErro(setorEl, "Selecione o setor!");
        
        // Verifica se o produto est√° cadastrado
        const produtoEstoque = produtos.find(p => (p.nome || "").trim().toLowerCase() === produtoEl.value.trim().toLowerCase());
        if (!produtoEstoque) {
            alert(`Produto "${produtoEl.value.trim()}" n√£o encontrado no cadastro. Cadastre-o primeiro.`);
            produtoEl.focus();
            return false;
        }

        // Monta o objeto da nova entrada
        const novaEntrada = { 
            produto: produtoEstoque.nome, // Usa o nome padronizado
            codigoBarras: codigoBarrasEl.value.trim(),
            qtd: Number(qtdEl.value), 
            valor: Number(valorEl.value), 
            data: dataEl.value, 
            nota: notaEl.value.trim(), 
            fornecedor: fornecedorEl.value.trim(), 
            cnpj: cnpjEl.value.trim(), 
            lote: loteEl.value.trim(), 
            validade: validadeEl.value, 
            setor: setorEl.value 
        };

        // Adiciona √† lista de entradas
        entradas.push(novaEntrada);
        salvarDados("entradas", entradas);

        // Atualiza a quantidade em estoque do produto
        produtoEstoque.quantidade = (Number(produtoEstoque.quantidade) || 0) + novaEntrada.qtd;
        salvarDados("produtos", produtos);

        atualizarTabelaEntradas();
        atualizarTabelaEstoque();
        atualizarTabelaLimites();
        atualizarPainelFinanceiro();
        alert("Entrada registrada com sucesso!");

        limparCampos("entrada");
        
        // Permite reescrever o campo produto ap√≥s limpar
        produtoEl.readOnly = false;
        codigoBarrasEl.value = "";
        
        return true;
    }

    function atualizarTabelaEntradas() {
        const tbody = document.querySelector("#tabelaEntradas tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        
        const filtroTexto = document.getElementById("filtroEntrada")?.value.toLowerCase() || "";
        
        // Ordena por data (mais recente primeiro)
        const entradasOrdenadas = [...entradas].sort((a, b) => new Date(b.data) - new Date(a.data));
        
        entradasOrdenadas.forEach((e, i) => {
            const textoBusca = `${e.produto} ${e.fornecedor} ${e.nota} ${e.setor}`.toLowerCase();
            if (filtroTexto && !textoBusca.includes(filtroTexto)) return;
            
            const codigoBarras = buscarCodigoBarrasDoProduto(e.produto);

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${e.produto || "-"}</td>
                <td style="font-size:12px; color:#555;">${codigoBarras || "-"}</td>
                <td>${e.qtd || 0}</td>
                <td>${(e.valor !== undefined && e.valor !== null) ? Number(e.valor).toFixed(2) : "0.00"}</td>
                <td>${e.data || "-"}</td>
                <td>${e.nota || "-"}</td>
                <td>${e.fornecedor || "-"}</td>
                <td>${e.cnpj || "-"}</td>
                <td>${e.lote || "-"}</td>
                <td>${e.validade || "-"}</td>
                <td>${e.setor || "-"}</td>
                <td>
                    <button onclick="editarEntrada('${e.nota}')"><i class="fa fa-edit"></i></button>
                    <button class="btnExcluir" onclick="excluirEntrada('${e.nota}')"><i class="fa fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function filtrarEntradas() {
        atualizarTabelaEntradas();
    }

    function editarEntrada(nota) {
        alert("Fun√ß√£o de edi√ß√£o de entrada desativada. Exclua e registre novamente para manter a consist√™ncia do estoque.");
    }
    
    function excluirEntrada(nota) {
        if (!confirm(`Excluir a entrada com Nota Fiscal ${nota}? A quantidade ser√° removida do estoque.`)) return;

        const entrada = entradas.find(e => e.nota === nota);
        if (!entrada) return alert("Entrada n√£o encontrada!");

        // 1. Reverte o estoque
        const produtoEstoque = produtos.find(p => p.nome === entrada.produto);
        if (produtoEstoque) {
            produtoEstoque.quantidade = Math.max(0, (Number(produtoEstoque.quantidade) || 0) - entrada.qtd);
            salvarDados("produtos", produtos);
        }

        // 2. Remove a entrada
        entradas = entradas.filter(e => e.nota !== nota);
        salvarDados("entradas", entradas);

        atualizarTabelaEntradas();
        atualizarTabelaEstoque();
        atualizarTabelaLimites();
        atualizarPainelFinanceiro();
        alert("Entrada exclu√≠da com sucesso! Estoque atualizado.");
    }

    // ==========================================================
    // SA√çDA DE MATERIAIS
    // ==========================================================

    function registrarSaida() {
        limparErros("saida");
        
        const produtoEl = document.getElementById("saidaProduto");
        const qtdEl = document.getElementById("saidaQuantidade");
        const responsavelEl = document.getElementById("saidaResponsavel");
        const observacaoEl = document.getElementById("saidaObservacao");
        const setorEl = document.getElementById("saidaSetor");
        const dataEl = document.getElementById("saidaData");
        const codigoBarrasEl = document.getElementById("saidaCodigoBarras");
        
        // Valida√ß√£o
        if (!produtoEl.value.trim()) return destacarErro(produtoEl, "Informe o nome do produto!");
        if (!qtdEl.value || Number(qtdEl.value) <= 0) return destacarErro(qtdEl, "Informe a quantidade da sa√≠da (maior que zero)!");
        if (!setorEl.value.trim()) return destacarErro(setorEl, "Selecione o setor!");
        if (!dataEl.value) return destacarErro(dataEl, "Selecione a data da sa√≠da!");
        if (!responsavelEl.value.trim()) return destacarErro(responsavelEl, "Informe o respons√°vel pela sa√≠da!");
        
        const produto = produtoEl.value.trim();
        const qtd = Number(qtdEl.value);
        
        // Verifica exist√™ncia e estoque
        const produtoEstoque = produtos.find(p => (p.nome || "").trim().toLowerCase() === produto.toLowerCase());
        
        if (!produtoEstoque) {
            alert(`Produto "${produto}" n√£o encontrado no cadastro.`);
            return false;
        }

        const qtdAtual = Number(produtoEstoque.quantidade) || 0;
        if (qtd > qtdAtual) {
            alert(`Estoque insuficiente. Quantidade atual: ${qtdAtual} | Sa√≠da solicitada: ${qtd}`);
            return false;
        }

        // Monta o objeto da nova sa√≠da
        const novaSaida = { 
            produto: produtoEstoque.nome, // Usa o nome padronizado
            codigoBarras: codigoBarrasEl.value.trim(),
            qtd: qtd, 
            data: dataEl.value, 
            setor: setorEl.value,
            responsavel: responsavelEl.value.trim(), 
            observacao: observacaoEl.value.trim()
        };

        // Adiciona √† lista de sa√≠das
        saidas.push(novaSaida);
        salvarDados("saidas", saidas);

        // Atualiza a quantidade em estoque do produto
        produtoEstoque.quantidade = qtdAtual - novaSaida.qtd;
        salvarDados("produtos", produtos);

        atualizarTabelaSaidas();
        atualizarTabelaEstoque();
        atualizarTabelaLimites();
        atualizarPainelFinanceiro();
        alert("Sa√≠da registrada com sucesso!");

        limparCampos("saida");
        produtoEl.readOnly = false;
        codigoBarrasEl.value = "";
        
        return true;
    }

    function atualizarTabelaSaidas() {
        const tbody = document.querySelector("#tabelaSaidas tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        
        const filtroTexto = document.getElementById("filtroSaida")?.value.toLowerCase() || "";
        
        // Ordena por data (mais recente primeiro)
        const saidasOrdenadas = [...saidas].sort((a, b) => new Date(b.data) - new Date(a.data));
        
        saidasOrdenadas.forEach((s, i) => {
            const textoBusca = `${s.produto} ${s.setor} ${s.responsavel}`.toLowerCase();
            if (filtroTexto && !textoBusca.includes(filtroTexto)) return;

            const codigoBarras = buscarCodigoBarrasDoProduto(s.produto);
            
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${s.produto || "-"}</td>
                <td style="font-size:12px; color:#555;">${codigoBarras || "-"}</td>
                <td>${s.qtd || 0}</td>
                <td>${s.data || "-"}</td>
                <td>${s.setor || "-"}</td>
                <td>${s.responsavel || "-"}</td>
                <td>${s.observacao || "-"}</td>
                <td>
                    <button onclick="editarSaida(${i})"><i class="fa fa-edit"></i></button>
                    <button class="btnExcluir" onclick="excluirSaida(${i})"><i class="fa fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function editarSaida(i) {
        alert("Fun√ß√£o de edi√ß√£o de sa√≠da desativada. Exclua e registre novamente para manter a consist√™ncia do estoque.");
    }
    
    function excluirSaida(i) {
        if (!confirm(`Excluir a sa√≠da de ${saidas[i].qtd} de ${saidas[i].produto}? A quantidade ser√° adicionada de volta ao estoque.`)) return;

        const saida = saidas[i];
        if (!saida) return;

        // 1. Reverte o estoque
        const produtoEstoque = produtos.find(p => p.nome === saida.produto);
        if (produtoEstoque) {
            produtoEstoque.quantidade = (Number(produtoEstoque.quantidade) || 0) + saida.qtd;
            salvarDados("produtos", produtos);
        }

        // 2. Remove a sa√≠da
        saidas.splice(i, 1);
        salvarDados("saidas", saidas);

        atualizarTabelaSaidas();
        atualizarTabelaEstoque();
        atualizarTabelaLimites();
        atualizarPainelFinanceiro();
        alert("Sa√≠da exclu√≠da com sucesso! Estoque atualizado.");
    }
    
    function filtrarSaidas() {
        atualizarTabelaSaidas();
    }
    
    function atualizarSelectProdutos() {
        // Ordena a lista de produtos
        produtos.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
        
        const datalistEntrada = document.getElementById("listaProdutosEntrada");
        const datalistSaida = document.getElementById("listaProdutosSaida");
        
        if (datalistEntrada) datalistEntrada.innerHTML = "";
        if (datalistSaida) datalistSaida.innerHTML = "";

        produtos.forEach(p => {
            const option = `<option value="${p.nome}"></option>`;
            if (datalistEntrada) datalistEntrada.insertAdjacentHTML('beforeend', option);
            if (datalistSaida) datalistSaida.insertAdjacentHTML('beforeend', option);
        });
    }

    // ==========================================================
    // ESTOQUE ATUAL
    // ==========================================================
    function atualizarTabelaEstoque() {
        const tbody = document.querySelector("#tabelaEstoque tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        
        const filtroTexto = document.getElementById("filtroEstoque")?.value.toLowerCase() || "";
        const filtroCategoria = document.getElementById("filtroCategoriaEstoque")?.value.toLowerCase() || "";
        
        const produtosFiltrados = produtos.filter(p => {
            const nome = (p.nome || "").toLowerCase();
            const categoria = (p.categoria || "").toLowerCase();
            const codBarras = (p.codigoBarras || "").toLowerCase();
            
            const textoBusca = `${nome} ${categoria} ${codBarras}`;
            const passaFiltroTexto = !filtroTexto || textoBusca.includes(filtroTexto);
            const passaFiltroCategoria = !filtroCategoria || categoria === filtroCategoria;
            
            return passaFiltroTexto && passaFiltroCategoria;
        });
        
        produtosFiltrados.forEach((p, i) => {
            const qtd = Number(p.quantidade) || 0;
            const entradasProduto = entradas.filter(e => e.produto === p.nome);
            
            // 1. Custo M√©dio
            const totalQtdEntradas = entradasProduto.reduce((s, e) => s + Number(e.qtd || 0), 0);
            const totalValorEntradas = entradasProduto.reduce((s, e) => s + (Number(e.qtd || 0) * Number(e.valor || 0)), 0);
            const custoMedio = totalQtdEntradas > 0 ? totalValorEntradas / totalQtdEntradas : 0;
            
            // 2. Validade Mais Pr√≥xima
            let validadeMaisProxima = "N/A";
            const validades = entradasProduto.map(e => new Date(e.validade)).filter(d => !isNaN(d));
            if (validades.length > 0) {
                const maisProxima = new Date(Math.min(...validades));
                validadeMaisProxima = maisProxima.toISOString().split('T')[0];
            }
            
            // Determina a cor da validade
            let validadeCor = "";
            if (validadeMaisProxima !== "N/A") {
                const diasParaVencer = Math.ceil((new Date(validadeMaisProxima) - new Date()) / (1000 * 60 * 60 * 24));
                if (diasParaVencer <= 30) validadeCor = "red";
                else if (diasParaVencer <= 90) validadeCor = "orange";
            }
            
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${ p.foto && p.foto.startsWith("data:") ? `<img src="${p.foto}" class="thumb" onclick="mostrarImagemAmpliada('${p.foto}')">` : "-" }</td>
                <td>${p.nome}</td>
                <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
                <td>${p.categoria}</td>
                <td>${p.embalagem}</td>
                <td>${p.qtdEmbalagem}</td>
                <td style="font-weight:bold; color:${qtd <= 0 ? 'red' : 'green'};">${qtd}</td>
                <td>R$ ${custoMedio.toFixed(2)}</td>
                <td style="color:${validadeCor}; font-weight:bold;">${validadeMaisProxima}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function filtrarEstoque() {
        atualizarTabelaEstoque();
    }

    // ==========================================================
    // ESTOQUE M√çNIMO/M√ÅXIMO
    // ==========================================================

    function atualizarTabelaLimites() {
        const tbody = document.querySelector("#tabelaLimites tbody");
        const resumo = document.getElementById("resumoLimites");
        if (!tbody || !resumo) return;
        
        tbody.innerHTML = "";
        let total = 0, abaixo = 0, dentro = 0, acima = 0;
        
        const filtroTexto = document.getElementById("filtroTextoLimites")?.value.toLowerCase() || "";
        const filtroCategoria = document.getElementById("filtroCategoriaLimites")?.value.toLowerCase() || "";
        
        const produtosFiltrados = produtos.filter(p => {
            const nome = (p.nome || "").toLowerCase();
            const categoria = (p.categoria || "").toLowerCase();
            const codBarras = (p.codigoBarras || "").toLowerCase();
            
            const textoBusca = `${nome} ${categoria} ${codBarras}`;
            const passaFiltroTexto = !filtroTexto || textoBusca.includes(filtroTexto);
            const passaFiltroCategoria = !filtroCategoria || (p.categoria || "").toLowerCase() === filtroCategoria;
            
            return passaFiltroTexto && passaFiltroCategoria;
        });

        if (!produtosFiltrados.length) {
            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:#777;">Nenhum produto encontrado.</td></tr>`;
            resumo.innerHTML = `üßæ Total de Produtos: 0 | ‚ö†Ô∏è Abaixo do M√≠nimo: 0 | ‚úÖ Dentro do Limite: 0 | üì¶ Acima do M√°ximo: 0`;
            return;
        }

        produtosFiltrados.forEach((p, i) => {
            const minimo = Number(p.minimo) || 0;
            const maximo = Number(p.maximo) || 0;
            const qtd = Number(p.quantidade) || 0;
            
            total++;
            let statusTexto = "‚úÖ Dentro do limite";
            let statusCor = "green";
            let recomendacao = "OK";
            
            if (qtd < minimo) {
                statusTexto = "‚ö†Ô∏è Abaixo do m√≠nimo";
                statusCor = "red";
                recomendacao = `Comprar ${minimo - qtd} unidade(s)`;
                abaixo++;
            } else if (maximo && qtd > maximo) {
                statusTexto = "üì¶ Acima do m√°ximo";
                statusCor = "orange";
                recomendacao = "Reduzir estoque"; 
                acima++;
            } else {
                dentro++;
            }

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${p.nome}</td>
                <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
                <td style="font-weight:bold;">${qtd}</td>
                <td><input type="number" id="min-${i}" value="${minimo}" style="width:80px; text-align:center;"></td>
                <td><input type="number" id="max-${i}" value="${maximo}" style="width:80px; text-align:center;"></td>
                <td style="color:${statusCor}; font-weight:bold;">${statusTexto}</td>
                <td style="font-style:italic;">${recomendacao}</td>
                <td>
                    <button onclick="salvarLimites(${i}, '${p.nome}')"><i class="fa fa-save"></i> Salvar</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        resumo.innerHTML = `üßæ Total de Produtos: ${total} | <span style="color:red">‚ö†Ô∏è Abaixo do M√≠nimo: ${abaixo}</span> | <span style="color:green">‚úÖ Dentro do Limite: ${dentro}</span> | <span style="color:orange">üì¶ Acima do M√°ximo: ${acima}</span>`;
    }

    function salvarLimites(i, nomeProduto) {
        const min = +document.getElementById(`min-${i}`).value;
        const max = +document.getElementById(`max-${i}`).value;
        
        if (isNaN(min) || isNaN(max) || min < 0 || max < 0) {
            alert("Por favor, insira valores v√°lidos (n√∫meros positivos) para os limites.");
            return;
        }
        
        if (min > max && max !== 0) {
            alert("O valor m√≠nimo n√£o pode ser maior que o valor m√°ximo.");
            return;
        }
        
        const produtoIndex = produtos.findIndex(p => p.nome === nomeProduto);
        if (produtoIndex === -1) return;

        produtos[produtoIndex].minimo = min;
        produtos[produtoIndex].maximo = max;
        
        salvarDados("produtos", produtos);
        atualizarTabelaLimites();
        atualizarDashboard();
        alert("Limites salvos com sucesso!");
    }
    
    function gerarListaCompra() {
        const container = document.getElementById("listaCompraContainer");
        const tabela = document.getElementById("tabelaListaCompra");
        const tbody = tabela ? tabela.querySelector("tbody") : null;
        const totalSpan = document.getElementById("totalItensCompra");
        
        if (!container || !tabela || !tbody || !totalSpan) {
            console.error("‚ö†Ô∏è Elementos da lista de compra n√£o encontrados no DOM.");
            return;
        }
        
        // Limpa lista anterior
        tbody.innerHTML = "";
        totalSpan.textContent = "0";

        // Filtro de categoria (se existir)
        const filtroCategoria = (document.getElementById("filtroCategoriaLimites")?.value || "").toLowerCase();
        
        // Filtra produtos abaixo do m√≠nimo
        const produtosAbaixo = produtos.filter(p => {
            const categoria = (p.categoria || "").toLowerCase();
            const qtd = Number(p.quantidade) || 0;
            const minimo = Number(p.minimo) || 0;
            
            if (filtroCategoria && filtroCategoria !== "" && categoria !== filtroCategoria) return false;
            
            return qtd < minimo && minimo > 0;
        });

        if (!produtosAbaixo.length) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:green;">‚úÖ Nenhum produto abaixo do m√≠nimo que requeira compra.</td></tr>`;
            container.style.display = "block";
            return;
        }

        // Monta tabela com os valores corretos de ‚ÄúRecomendado Comprar‚Äù
        let totalItens = 0;
        produtosAbaixo.forEach((p, i) => {
            const qtdAtual = Number(p.quantidade) || 0;
            const minimo = Number(p.minimo) || 0;
            const recomendado = minimo - qtdAtual;
            
            totalItens += recomendado;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${p.nome}</td>
                <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
                <td>${p.categoria}</td>
                <td>${qtdAtual}</td>
                <td>${minimo}</td>
                <td style="font-weight:bold; color:red;">${recomendado}</td>
            `;
            tbody.appendChild(row);
        });

        totalSpan.textContent = totalItens;
        container.style.display = "block";
    }

    function limparListaCompra() {
        const tbody = document.querySelector("#tabelaListaCompra tbody");
        const totalSpan = document.getElementById("totalItensCompra");
        const container = document.getElementById("listaCompraContainer");
        
        if (tbody) tbody.innerHTML = "";
        if (totalSpan) totalSpan.textContent = "0";
        if (container) container.style.display = "none";
        
        atualizarTabelaLimites();
    }
    
    // Fun√ß√µes de exporta√ß√£o (Exportar para Excel e Gerar Pedido PDF - dependem de libs externas)
    // As bibliotecas JS PDF e XLSX j√° est√£o importadas no final do HTML

    function exportarListaExcel() {
        const tabela = document.getElementById("tabelaListaCompra");
        if (!tabela || !tabela.querySelector('tbody tr')) {
            return alert("‚ö†Ô∏è Nenhuma lista de compra gerada para exportar!");
        }

        const wb = XLSX.utils.table_to_book(tabela, { sheet: "Lista de Compra" });
        XLSX.writeFile(wb, "Lista_de_Compra_OralUnic.xlsx");
    }

    async function gerarPedidoPDF() {
        // Assume que a lib jspdf.umd.min.js j√° foi carregada
        if (typeof window.jspdf === 'undefined') {
            return alert("‚ö†Ô∏è Biblioteca jsPDF n√£o carregada. N√£o √© poss√≠vel gerar o PDF.");
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const nomeSolicitante = window.usuarioLogado?.email?.split('@')[0] || "Usu√°rio";
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        const larguraPagina = doc.internal.pageSize.getWidth();

        // T√≠tulo e Informa√ß√µes
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("ORAL UNIC CAMPO GRANDE", larguraPagina / 2, 20, { align: "center" });
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text("Pedido de Or√ßamento / Lista de Compra", larguraPagina / 2, 28, { align: "center" });
        doc.setFontSize(10);
        doc.text(`Data: ${dataAtual}`, 14, 38);
        doc.text(`Solicitante: ${nomeSolicitante}`, 14, 44);
        
        // Tabela
        const tabela = document.getElementById("tabelaListaCompra");
        const linhas = [...tabela.querySelectorAll("tbody tr")].filter(tr => tr.textContent.trim() !== '0');
        
        if (linhas.length === 0) {
            return alert("‚ö†Ô∏è Nenhum item na lista de compra para gerar o PDF.");
        }
        
        const dadosTabela = [
            ['#', 'Produto', 'Categoria', 'Qtd. Atual', 'M√≠nimo', 'Recomendado Comprar']
        ];
        
        linhas.forEach(tr => {
            const cols = tr.querySelectorAll("td");
            // Pega as colunas na ordem correta (pulando C√≥d. Barras)
            dadosTabela.push([
                cols[0].innerText, // #
                cols[1].innerText, // Produto
                cols[3].innerText, // Categoria
                cols[4].innerText, // Qtd Atual
                cols[5].innerText, // M√≠nimo
                cols[6].innerText, // Recomendado Comprar
            ]);
        });
        
        doc.autoTable({
            startY: 50,
            head: [dadosTabela[0]],
            body: dadosTabela.slice(1),
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [0, 59, 136] }, // Azul Escuro
            margin: { left: 14, right: 14 },
            didDrawPage: function(data) {
                // Footer
                let str = "P√°gina " + doc.internal.getNumberOfPages();
                doc.setFontSize(8);
                doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
            }
        });

        doc.save(`Pedido_Orcamento_${dataAtual}.pdf`);
    }

    // ==========================================================
    // FINANCEIRO
    // ==========================================================
    function atualizarPainelFinanceiro() {
        let qtdTotal = 0;
        let valorTotalUltimaEntrada = 0;
        let valorTotalCustoMedio = 0;

        produtos.forEach(p => {
            const entradasDoProduto = entradas.filter(e => e.produto === p.nome);
            
            if (entradasDoProduto.length === 0) return;

            // 1. Custo √öltima Entrada
            const ultimaEntrada = entradasDoProduto[entradasDoProduto.length - 1];
            const valorUltimo = Number(ultimaEntrada.valor || 0);

            // 2. Custo M√©dio Ponderado
            const totalQtdEntradas = entradasDoProduto.reduce((s, e) => s + Number(e.qtd || 0), 0);
            const totalValorEntradas = entradasDoProduto.reduce((s, e) => s + (Number(e.qtd || 0) * Number(e.valor || 0)), 0);
            const custoMedio = totalQtdEntradas > 0 ? totalValorEntradas / totalQtdEntradas : 0;
            
            const qtdAtual = Number(p.quantidade || 0);
            
            qtdTotal += qtdAtual;
            valorTotalUltimaEntrada += qtdAtual * valorUltimo;
            valorTotalCustoMedio += qtdAtual * custoMedio;
        });

        // Atualiza os novos indicadores
        document.getElementById("valorUltimaEntrada").textContent = `R$ ${valorTotalUltimaEntrada.toFixed(2)}`;
        document.getElementById("valorCustoMedio").textContent = `R$ ${valorTotalCustoMedio.toFixed(2)}`;
        
        // M√©dia simples entre os dois
        const valorTotalEstoqueAtualPainel = (valorTotalUltimaEntrada + valorTotalCustoMedio) / 2; 
        document.getElementById("valorEstoqueAtualPainel").textContent = `R$ ${valorTotalEstoqueAtualPainel.toFixed(2)}`;
        
        // Tabela Financeira (Agrupado por Fornecedor/Nota)
        const agrupadas = {};
        
        // Agrupa entradas e calcula valor de nota
        entradas.forEach(e => {
            const fornecedor = e.fornecedor || "Fornecedor n√£o informado";
            const nota = e.nota || "Sem Nota Fiscal";
            const chave = `${fornecedor}_${nota}`;
            if (!agrupadas[chave]) {
                agrupadas[chave] = { fornecedor, nota, valorNota: 0, valorSaida: 0 };
            }
            agrupadas[chave].valorNota += (e.valor || 0) * (e.qtd || 0);
        });
        
        // Calcula valor de sa√≠da (custo)
        saidas.forEach(s => {
            // Busca a entrada mais relevante ou a primeira entrada do produto para estimar o custo
            const entrada = entradas.find(e => e.produto === s.produto); 
            if (!entrada) return;
            
            const fornecedor = entrada.fornecedor || "Fornecedor n√£o informado";
            const nota = entrada.nota || "Sem Nota Fiscal";
            const chave = `${fornecedor}_${nota}`;
            
            // Assume que o custo da sa√≠da √© o valor da entrada (simplificado)
            const valorSaida = s.qtd * (entrada.valor || 0);
            
            if (agrupadas[chave]) {
                agrupadas[chave].valorSaida += valorSaida;
            }
        });
        
        const tabelaFinanceiro = document.getElementById("tabelaFinanceiro").querySelector("tbody");
        tabelaFinanceiro.innerHTML = "";
        let i = 1;
        
        for (const chave in agrupadas) {
            const g = agrupadas[chave];
            const valorResidual = g.valorNota - g.valorSaida; // Simplifica√ß√£o
            
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i++}</td>
                <td>${g.fornecedor}</td>
                <td>${g.nota}</td>
                <td style="color:green; font-weight:bold;">R$ ${g.valorNota.toFixed(2)}</td>
                <td style="color:red; font-weight:bold;">R$ ${g.valorSaida.toFixed(2)}</td>
                <td style="font-weight:bold;">R$ ${valorResidual.toFixed(2)}</td>
            `;
            tabelaFinanceiro.appendChild(row);
        }
    }


    // ==========================================================
    // RELAT√ìRIOS
    // ==========================================================
    
    function definirPeriodoRapido(periodo) {
        const hoje = new Date();
        let inicio = new Date(hoje);
        const fim = hoje.toISOString().split('T')[0];
        
        switch (periodo) {
            case '7dias':
                inicio.setDate(hoje.getDate() - 7);
                break;
            case '30dias':
                inicio.setDate(hoje.getDate() - 30);
                break;
            case 'mes':
                inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                break;
        }

        document.getElementById("dataInicioRelatorio").value = inicio.toISOString().split('T')[0];
        document.getElementById("dataFimRelatorio").value = fim;
    }

    function limparPeriodo() {
        document.getElementById("dataInicioRelatorio").value = "";
        document.getElementById("dataFimRelatorio").value = "";
    }
    
    // Gera CSV de Entradas
    function gerarRelatorio() {
        const inicio = document.getElementById("dataInicioRelatorio").value;
        const fim = document.getElementById("dataFimRelatorio").value;

        if (!inicio || !fim) return alert("‚ö†Ô∏è Selecione uma data de in√≠cio e fim para gerar o relat√≥rio!");
        
        const dataInicio = new Date(inicio);
        const dataFim = new Date(fim);
        if (dataInicio > dataFim) return alert("‚ùå A data inicial n√£o pode ser maior que a final!");
        
        const dados = entradas.filter(e => {
            const data = new Date(e.data);
            return data >= dataInicio && data <= dataFim;
        });

        if (dados.length === 0) return alert("Nenhuma entrada encontrada para o per√≠odo selecionado.");

        const cabecalho = ["Produto", "Qtd", "Valor Unit√°rio (R$)", "Data", "Nota Fiscal", "Fornecedor", "CNPJ", "Lote", "Validade", "Setor"];
        let csv = [cabecalho.join(";")];
        
        dados.forEach(e => {
            const linha = [
                e.produto,
                e.qtd,
                e.valor.toFixed(2),
                e.data,
                e.nota,
                e.fornecedor,
                e.cnpj,
                e.lote,
                e.validade,
                e.setor
            ];
            csv.push(linha.join(";"));
        });

        exportarCSV(csv.join("\n"), `Relatorio_Entradas_${inicio}_a_${fim}.csv`);
    }

    // Gera CSV de Sa√≠das
    function gerarRelatorioSaida() {
        const inicio = document.getElementById("dataInicioRelatorio").value;
        const fim = document.getElementById("dataFimRelatorio").value;

        if (!inicio || !fim) return alert("‚ö†Ô∏è Selecione uma data de in√≠cio e fim para gerar o relat√≥rio!");
        
        const dataInicio = new Date(inicio);
        const dataFim = new Date(fim);
        if (dataInicio > dataFim) return alert("‚ùå A data inicial n√£o pode ser maior que a final!");
        
        const dados = saidas.filter(s => {
            const data = new Date(s.data);
            return data >= dataInicio && data <= dataFim;
        });

        if (dados.length === 0) return alert("Nenhuma sa√≠da encontrada para o per√≠odo selecionado.");

        const cabecalho = ["Produto", "Qtd", "Data", "Setor", "Respons√°vel", "Observa√ß√£o"];
        let csv = [cabecalho.join(";")];
        
        dados.forEach(s => {
            const linha = [
                s.produto,
                s.qtd,
                s.data,
                s.setor,
                s.responsavel,
                s.observacao
            ];
            csv.push(linha.join(";"));
        });

        exportarCSV(csv.join("\n"), `Relatorio_Saidas_${inicio}_a_${fim}.csv`);
    }

    // Fun√ß√£o de exporta√ß√£o de CSV
    function exportarCSV(csvContent, filename) {
        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=ISO-8859-1;" });
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // ==========================================================
    // DASHBOARD
    // ==========================================================
    function atualizarDashboard() {
        const listaProximosVencer = document.getElementById("listaProximosVencer");
        const listaMaisSaidas = document.getElementById("listaMaisSaidas");
        const listaEstoqueCritico = document.getElementById("listaEstoqueCritico");
        const resumoGeral = document.getElementById("resumoGeral");
        
        listaProximosVencer.innerHTML = "";
        listaMaisSaidas.innerHTML = "";
        listaEstoqueCritico.innerHTML = "";
        resumoGeral.innerHTML = "";
        
        // 1. Estoque Cr√≠tico
        const criticos = produtos.filter(p => {
            const qtd = Number(p.quantidade) || 0;
            const minimo = Number(p.minimo) || 0;
            return qtd < minimo && minimo > 0;
        }).slice(0, 5); // Apenas os 5 primeiros
        
        if (criticos.length > 0) {
            criticos.forEach(p => {
                listaEstoqueCritico.innerHTML += `<li>${p.nome}: <span style="color:red; font-weight:bold;">${p.quantidade} (M√≠n: ${p.minimo})</span></li>`;
            });
        } else {
            listaEstoqueCritico.innerHTML = `<li>‚úÖ Nenhum produto em estoque cr√≠tico.</li>`;
        }
        
        // 2. Pr√≥ximos do Vencimento
        let validadesProximas = [];
        entradas.forEach(e => {
            const diasParaVencer = Math.ceil((new Date(e.validade) - new Date()) / (1000 * 60 * 60 * 24));
            if (diasParaVencer > 0 && diasParaVencer <= 90) { // Pr√≥ximos 90 dias
                validadesProximas.push({ nome: e.produto, validade: e.validade, dias: diasParaVencer });
            }
        });
        
        validadesProximas.sort((a, b) => a.dias - b.dias); // Mais pr√≥ximos primeiro
        validadesProximas = validadesProximas.slice(0, 5);
        
        if (validadesProximas.length > 0) {
            validadesProximas.forEach(v => {
                const cor = v.dias <= 30 ? 'red' : 'orange';
                listaProximosVencer.innerHTML += `<li>${v.nome}: <span style="color:${cor}; font-weight:bold;">Vence em ${v.validade} (${v.dias} dias)</span></li>`;
            });
        } else {
            listaProximosVencer.innerHTML = `<li>‚úÖ Nenhum produto perto de vencer.</li>`;
        }

        // 3. Produtos Mais Utilizados (Top 5 Sa√≠das)
        const saidasPorProduto = saidas.reduce((acc, s) => {
            acc[s.produto] = (acc[s.produto] || 0) + s.qtd;
            return acc;
        }, {});
        
        const topSaidas = Object.entries(saidasPorProduto)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);
            
        if (topSaidas.length > 0) {
            topSaidas.forEach(([nome, qtd]) => {
                listaMaisSaidas.innerHTML += `<li>${nome}: <span style="font-weight:bold;">${qtd} sa√≠das</span></li>`;
            });
        } else {
            listaMaisSaidas.innerHTML = `<li>Nenhuma sa√≠da registrada.</li>`;
        }
        
        // 4. Resumo Geral
        const totalProdutosCadastrados = produtos.length;
        const totalEmEstoque = produtos.reduce((s, p) => s + (Number(p.quantidade) || 0), 0);
        const valorTotal = (Number(document.getElementById("valorEstoqueAtualPainel")?.textContent.replace('R$ ', '').replace(',', '.') || 0)).toFixed(2);
        
        resumoGeral.innerHTML = `
            <p><strong>Total de Produtos Cadastrados:</strong> ${totalProdutosCadastrados}</p>
            <p><strong>Total de Itens em Estoque:</strong> ${totalEmEstoque}</p>
            <p><strong>Valor Total do Estoque:</strong> R$ ${valorTotal}</p>
        `;
    }

    // ==========================================================
    // USU√ÅRIOS E PERFIS
    // ==========================================================
    function salvarUsuario() {
        limparErros("usuarios");
        const nomeEl = document.getElementById("usuarioNome");
        const cpfEl = document.getElementById("usuarioCPF");
        const emailEl = document.getElementById("usuarioEmail");
        const senhaEl = document.getElementById("usuarioSenha");
        const perfilEl = document.getElementById("usuarioPerfil");

        const nome = nomeEl.value.trim();
        const email = emailEl.value.trim().toLowerCase();
        const senha = senhaEl.value.trim();
        
        if (!nome) return destacarErro(nomeEl, "Informe o nome do usu√°rio!");
        if (!email) return destacarErro(emailEl, "Informe o e-mail (login) do usu√°rio!");
        if (!senha) return destacarErro(senhaEl, "Informe a senha do usu√°rio!");
        
        // Verifica duplicidade de email
        const duplicado = usuarios.some(u => u.email === email);
        if (duplicado) return destacarErro(emailEl, `J√° existe um usu√°rio cadastrado com o e-mail: ${email}`);

        usuarios.push({ 
            nome: nome, 
            cpf: cpfEl.value.trim(), 
            email: email, 
            senha: senha, 
            perfil: perfilEl.value 
        });
        
        salvarDados("usuarios", usuarios);
        
        limparCampos("usuarios");
        atualizarTabelaUsuarios();
        alert("Usu√°rio salvo com sucesso!");
    }

    function atualizarTabelaUsuarios() {
        const tbody = document.querySelector("#tabelaUsuarios tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        
        usuarios.forEach((u, i) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${u.nome}</td>
                <td>${u.email}</td>
                <td>${u.perfil.charAt(0).toUpperCase() + u.perfil.slice(1)}</td>
                <td>
                    <button onclick="editarUsuario(${i})"><i class="fa fa-edit"></i></button>
                    <button class="btnExcluir" onclick="excluirUsuario(${i})"><i class="fa fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function editarUsuario(i) {
        alert("Fun√ß√£o de edi√ß√£o de usu√°rio desativada. Exclua e registre novamente.");
    }

    function excluirUsuario(i) {
        if (!confirm(`Excluir o usu√°rio "${usuarios[i].nome}"?`)) return;
        
        usuarios.splice(i, 1);
        salvarDados("usuarios", usuarios);
        atualizarTabelaUsuarios();
        alert("Usu√°rio exclu√≠do com sucesso!");
    }
    
    function buscarUsuarioPorEmail(email) {
        return usuarios.find(u => u.email.toLowerCase() === email.toLowerCase());
    }

    // ==========================================================
    // ORDENA√á√ÉO
    // ==========================================================
    function ordenarListasAlfabeticamente() {
        // Produtos
        if (Array.isArray(produtos)) {
            produtos.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
            // J√° salvo dentro das fun√ß√µes CRUD
        }
        
        // Usu√°rios
        if (Array.isArray(usuarios)) {
            usuarios.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
            // J√° salvo dentro das fun√ß√µes CRUD
        }

        // Entradas e Sa√≠das (Geralmente ordenadas por data nas tabelas)
    }

    // ==========================================================
    // SINCRONIZA√á√ÉO E INICIALIZA√á√ÉO
    // ==========================================================
    document.addEventListener("DOMContentLoaded", () => {
        // Inicializa o estado das tabelas e selects
        ordenarListasAlfabeticamente();
        atualizarSelectProdutos();
        atualizarTabelaProdutos();
        atualizarTabelaEntradas();
        atualizarTabelaSaidas();
        atualizarTabelaEstoque();
        atualizarTabelaLimites();
        atualizarTabelaUsuarios();
        atualizarPainelFinanceiro();
        // A fun√ß√£o aplicarPermissoes √© chamada ap√≥s o login pelo onAuthStateChanged
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

</body>
</html>
